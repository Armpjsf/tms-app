[{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\analytics\\intelligence\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\analytics\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\analytics\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\analytics\\regional\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\jobs\\[id]\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":147,"column":45,"nodeType":"JSXOpeningElement","endLine":151,"endColumn":47,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":177,"column":53,"nodeType":"JSXOpeningElement","endLine":181,"endColumn":55,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":206,"column":33,"nodeType":"JSXOpeningElement","endLine":210,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\jobs\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\jobs\\create\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2286,2289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2286,2289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2307,2310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2307,2310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2329,2332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2329,2332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3224,3227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3224,3227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport Link from \"next/link\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { createJob, getJobCreationData } from \"@/app/planning/actions\"\nimport { \n  ArrowLeft, \n  Package,\n  User,\n  MapPin,\n  Truck,\n  Calendar,\n  Clock,\n  Building2,\n  Phone,\n  FileText,\n  Loader2,\n  CheckCircle2,\n  ChevronRight\n} from \"lucide-react\"\nimport { CustomerAutocomplete } from \"@/components/customer-autocomplete\"\n\n// Step indicator component\nfunction StepIndicator({ steps, currentStep }: { steps: string[], currentStep: number }) {\n  return (\n    <div className=\"flex items-center justify-between mb-8\">\n      {steps.map((step, index) => (\n        <div key={index} className=\"flex items-center flex-1\">\n          <div className=\"flex items-center gap-2\">\n            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all ${\n              index < currentStep \n                ? 'bg-emerald-500 text-white' \n                : index === currentStep \n                ? 'bg-blue-500 text-white ring-4 ring-blue-500/20' \n                : 'bg-slate-700 text-slate-400'\n            }`}>\n              {index < currentStep ? <CheckCircle2 className=\"w-4 h-4\" /> : index + 1}\n            </div>\n            <span className={`text-sm hidden md:block ${index <= currentStep ? 'text-white' : 'text-slate-500'}`}>\n              {step}\n            </span>\n          </div>\n          {index < steps.length - 1 && (\n            <div className={`flex-1 h-0.5 mx-4 ${index < currentStep ? 'bg-emerald-500' : 'bg-slate-700'}`} />\n          )}\n        </div>\n      ))}\n    </div>\n  )\n}\n\nexport default function CreateJobPage() {\n  const router = useRouter()\n  const [currentStep, setCurrentStep] = useState(0)\n  const [loading, setLoading] = useState(false)\n  \n  // Real data lists\n  const [lists, setLists] = useState<{\n    drivers: any[],\n    vehicles: any[],\n    customers: any[]\n  }>({ drivers: [], vehicles: [], customers: [] })\n\n  useEffect(() => {\n    getJobCreationData().then(data => {\n        console.log(\"Job Creation Data Loaded:\", data)\n        console.log(\"Customers Count:\", data.customers.length)\n        setLists(data)\n    })\n  }, [])\n\n  const steps = ['ข้อมูลงาน', 'ข้อมูลลูกค้า', 'มอบหมายงาน', 'ยืนยัน']\n  \n  const [formData, setFormData] = useState({\n    Job_ID: `JOB-${Date.now().toString().slice(-6)}`,\n    Plan_Date: new Date().toISOString().split('T')[0],\n    Plan_Time: '09:00',\n    Priority: 'Normal',\n    Customer_Name: '',\n    Customer_Phone: '',\n    Customer_Address: '',\n    Origin_Location: '',\n    Dest_Location: '',\n    Route_Name: '',\n    Driver_ID: '',\n    Driver_Name: '',\n    Vehicle_Plate: '',\n    Notes: '',\n    Cargo_Type: '',\n    Weight: ''\n  })\n\n  // Autofill customer data when selected\n  const handleCustomerSelect = (customer: any) => {\n    setFormData(prev => ({\n      ...prev,\n      Customer_Name: customer.Customer_Name,\n      Customer_Phone: customer.Phone || customer.Customer_Phone || '',\n      Customer_Address: customer.Address || customer.Customer_Address || '',\n      // Master Customers doesn't have location defaults, but we keep it safe\n      Origin_Location: customer.Origin_Location || '', \n      Dest_Location: customer.Dest_Location || '' \n    }))\n  }\n\n  const handleDriverChange = (driverId: string) => {\n    const driver = lists.drivers.find(d => d.Driver_ID === driverId)\n    updateForm('Driver_ID', driverId)\n    if (driver) {\n      updateForm('Driver_Name', driver.Driver_Name || '')\n      // Auto-select vehicle if driver has one assigned and current is empty\n      if (driver.Vehicle_Plate && !formData.Vehicle_Plate) {\n        updateForm('Vehicle_Plate', driver.Vehicle_Plate)\n      }\n    }\n  }\n\n  const updateForm = (field: string, value: string) => {\n    setFormData(prev => ({ ...prev, [field]: value }))\n  }\n\n  const handleSubmit = async () => {\n    setLoading(true)\n    try {\n      const result = await createJob({\n        Job_ID: formData.Job_ID,\n        Plan_Date: formData.Plan_Date, // You might want to combine with Time\n        Customer_Name: formData.Customer_Name,\n        Route_Name: `${formData.Origin_Location} - ${formData.Dest_Location}`, // Auto-generate route name\n        Driver_ID: formData.Driver_ID,\n        Vehicle_Plate: formData.Vehicle_Plate,\n        Job_Status: 'New'\n      })\n\n      if (result.success) {\n        router.push('/planning')\n      } else {\n        alert('เกิดข้อผิดพลาด: ' + result.message)\n      }\n    } catch (e) {\n      console.error(e)\n      alert('เกิดข้อผิดพลาด กรุณาลองใหม่')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const nextStep = () => currentStep < steps.length - 1 && setCurrentStep(prev => prev + 1)\n  const prevStep = () => currentStep > 0 && setCurrentStep(prev => prev - 1)\n\n  return (\n    <>\n      {/* Header */}\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Link href=\"/planning\">\n          <Button variant=\"outline\" size=\"icon\" className=\"h-10 w-10 border-slate-700 bg-slate-900 hover:bg-slate-800\">\n            <ArrowLeft className=\"h-5 w-5 text-slate-400\" />\n          </Button>\n        </Link>\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">สร้างงานใหม่</h1>\n          <p className=\"text-sm text-slate-400\">กรอกข้อมูลเพื่อสร้างงานขนส่ง (เชื่อมต่อฐานข้อมูลจริง)</p>\n        </div>\n      </div>\n\n      {/* Steps */}\n      <StepIndicator steps={steps} currentStep={currentStep} />\n\n      {/* Step Content */}\n      <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\n        <CardContent className=\"p-6\">\n          \n          {/* Step 1: Job Info */}\n          {currentStep === 0 && (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <div className=\"w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center\">\n                  <Package className=\"w-5 h-5 text-blue-400\" />\n                </div>\n                <div>\n                  <h2 className=\"text-lg font-semibold text-white\">ข้อมูลงาน</h2>\n                  <p className=\"text-sm text-slate-400\">กำหนด Job ID และวันเวลาที่ต้องการ</p>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">Job ID</Label>\n                  <Input \n                    value={formData.Job_ID}\n                    onChange={(e) => updateForm('Job_ID', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">ความเร่งด่วน</Label>\n                  <Select value={formData.Priority} onValueChange={(val) => updateForm('Priority', val)}>\n                    <SelectTrigger className=\"bg-slate-800 border-slate-700 text-white\">\n                      <SelectValue placeholder=\"เลือกความเร่งด่วน\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Normal\">ปกติ</SelectItem>\n                      <SelectItem value=\"High\">เร่งด่วน</SelectItem>\n                      <SelectItem value=\"Urgent\">ด่วนมาก</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300 flex items-center gap-2\">\n                    <Calendar className=\"w-4 h-4\" /> วันที่\n                  </Label>\n                  <Input \n                    type=\"date\"\n                    value={formData.Plan_Date}\n                    onChange={(e) => updateForm('Plan_Date', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300 flex items-center gap-2\">\n                    <Clock className=\"w-4 h-4\" /> เวลา\n                  </Label>\n                  <Input \n                    type=\"time\"\n                    value={formData.Plan_Time}\n                    onChange={(e) => updateForm('Plan_Time', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">ประเภทสินค้า</Label>\n                  <Input \n                    placeholder=\"เช่น เอกสาร, อาหาร, วัสดุก่อสร้าง\"\n                    value={formData.Cargo_Type}\n                    onChange={(e) => updateForm('Cargo_Type', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">น้ำหนัก (kg)</Label>\n                  <Input \n                    type=\"number\"\n                    placeholder=\"0\"\n                    value={formData.Weight}\n                    onChange={(e) => updateForm('Weight', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 2: Customer Info */}\n          {currentStep === 1 && (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <div className=\"w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center\">\n                  <User className=\"w-5 h-5 text-emerald-400\" />\n                </div>\n                <div>\n                  <h2 className=\"text-lg font-semibold text-white\">ข้อมูลลูกค้า</h2>\n                  <p className=\"text-sm text-slate-400\">ข้อมูลผู้รับสินค้าและที่อยู่</p>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300 flex items-center gap-2\">\n                    <Building2 className=\"w-4 h-4\" /> ชื่อลูกค้า / บริษัท\n                  </Label>\n                  <CustomerAutocomplete \n                    value={formData.Customer_Name}\n                    onChange={(val) => updateForm('Customer_Name', val)}\n                    customers={lists.customers}\n                    onSelect={handleCustomerSelect}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300 flex items-center gap-2\">\n                    <Phone className=\"w-4 h-4\" /> เบอร์โทรศัพท์\n                  </Label>\n                  <Input \n                    placeholder=\"08X-XXX-XXXX\"\n                    value={formData.Customer_Phone}\n                    onChange={(e) => updateForm('Customer_Phone', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-slate-300 flex items-center gap-2\">\n                  <MapPin className=\"w-4 h-4\" /> ที่อยู่จัดส่ง\n                </Label>\n                <Textarea \n                  placeholder=\"กรอกที่อยู่เต็ม...\"\n                  value={formData.Customer_Address}\n                  onChange={(e) => updateForm('Customer_Address', e.target.value)}\n                  className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500 min-h-[100px]\"\n                />\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">ต้นทาง</Label>\n                  <Input \n                    placeholder=\"สถานที่รับสินค้า\"\n                    value={formData.Origin_Location}\n                    onChange={(e) => updateForm('Origin_Location', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">ปลายทาง</Label>\n                  <Input \n                    placeholder=\"สถานที่ส่งสินค้า\"\n                    value={formData.Dest_Location}\n                    onChange={(e) => updateForm('Dest_Location', e.target.value)}\n                    className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 3: Assignment */}\n          {currentStep === 2 && (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <div className=\"w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center\">\n                  <Truck className=\"w-5 h-5 text-indigo-400\" />\n                </div>\n                <div>\n                  <h2 className=\"text-lg font-semibold text-white\">มอบหมายงาน</h2>\n                  <p className=\"text-sm text-slate-400\">เลือกคนขับและรถที่จะใช้</p>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">คนขับ</Label>\n                  <Select value={formData.Driver_ID} onValueChange={handleDriverChange}>\n                    <SelectTrigger className=\"bg-slate-800 border-slate-700 text-white\">\n                      <SelectValue placeholder=\"เลือกคนขับ\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {lists.drivers.map(d => (\n                        <SelectItem key={d.Driver_ID} value={d.Driver_ID}>\n                          {d.Driver_Name} ({d.Mobile_No})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-slate-300\">ทะเบียนรถ</Label>\n                  <Select value={formData.Vehicle_Plate} onValueChange={(val) => updateForm('Vehicle_Plate', val)}>\n                    <SelectTrigger className=\"bg-slate-800 border-slate-700 text-white\">\n                      <SelectValue placeholder=\"เลือกทะเบียนรถ\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {lists.vehicles.map(v => (\n                        <SelectItem key={v.vehicle_plate} value={v.vehicle_plate}>\n                          {v.vehicle_plate} ({v.vehicle_type})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-slate-300 flex items-center gap-2\">\n                  <FileText className=\"w-4 h-4\" /> หมายเหตุ\n                </Label>\n                <Textarea \n                  placeholder=\"รายละเอียดเพิ่มเติม...\"\n                  value={formData.Notes}\n                  onChange={(e) => updateForm('Notes', e.target.value)}\n                  className=\"bg-slate-800 border-slate-700 text-white placeholder:text-slate-500 min-h-[100px]\"\n                />\n              </div>\n            </div>\n          )}\n\n          {/* Step 4: Confirmation */}\n          {currentStep === 3 && (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <div className=\"w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center\">\n                  <CheckCircle2 className=\"w-5 h-5 text-amber-400\" />\n                </div>\n                <div>\n                  <h2 className=\"text-lg font-semibold text-white\">ยืนยันข้อมูล</h2>\n                  <p className=\"text-sm text-slate-400\">ตรวจสอบข้อมูลก่อนสร้างงาน</p>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Card className=\"bg-slate-800/50 border-slate-700\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm text-slate-400\">ข้อมูลงาน</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm\">\n                    <p><span className=\"text-slate-400\">Job ID:</span> <span className=\"text-white font-medium\">{formData.Job_ID}</span></p>\n                    <p><span className=\"text-slate-400\">วันที่:</span> <span className=\"text-white\">{formData.Plan_Date} {formData.Plan_Time}</span></p>\n                    <p><span className=\"text-slate-400\">ประเภท:</span> <span className=\"text-white\">{formData.Cargo_Type || '-'}</span></p>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-slate-800/50 border-slate-700\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm text-slate-400\">ลูกค้า</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm\">\n                    <p><span className=\"text-slate-400\">ชื่อ:</span> <span className=\"text-white\">{formData.Customer_Name || '-'}</span></p>\n                    <p><span className=\"text-slate-400\">โทร:</span> <span className=\"text-white\">{formData.Customer_Phone || '-'}</span></p>\n                    <p><span className=\"text-slate-400\">เส้นทาง:</span> <span className=\"text-white\">{formData.Origin_Location || '-'} → {formData.Dest_Location || '-'}</span></p>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-slate-800/50 border-slate-700 md:col-span-2\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm text-slate-400\">มอบหมาย</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"flex gap-8 text-sm\">\n                    <p><span className=\"text-slate-400\">คนขับ:</span> <span className=\"text-white\">{formData.Driver_Name || 'ยังไม่ระบุ'}</span></p>\n                    <p><span className=\"text-slate-400\">รถ:</span> <span className=\"text-white\">{formData.Vehicle_Plate || 'ยังไม่ระบุ'}</span></p>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          )}\n\n          {/* Navigation */}\n          <div className=\"flex justify-between mt-8 pt-6 border-t border-slate-700\">\n            <Button variant=\"outline\" onClick={prevStep} disabled={currentStep === 0} className=\"border-slate-700\">\n              ย้อนกลับ\n            </Button>\n            \n            {currentStep < steps.length - 1 ? (\n              <Button onClick={nextStep} className=\"bg-blue-600 hover:bg-blue-700\">\n                ถัดไป <ChevronRight className=\"w-4 h-4 ml-1\" />\n              </Button>\n            ) : (\n              <Button onClick={handleSubmit} disabled={loading} className=\"bg-gradient-to-r from-emerald-500 to-green-600\">\n                {loading && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\n                สร้างงาน\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\jobs\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\vehicles\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\admin\\vehicles\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'superAdmin' is assigned a value but never used.","line":23,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = 'force-dynamic'\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport Link from \"next/link\"\r\nimport { \r\n  getOperationalStats,\r\n  getSubcontractorPerformance,\r\n  getDriverLeaderboard,\r\n} from \"@/lib/supabase/analytics\"\r\nimport { DriverLeaderboard } from \"@/components/analytics/driver-leaderboard\"\r\nimport { SubcontractorPerformance } from \"@/components/analytics/subcontractor-performance\"\r\nimport { Truck, Users, Fuel, TrendingUp, ArrowLeft, Activity } from \"lucide-react\"\r\nimport { MonthFilter } from \"@/components/analytics/month-filter\"\r\n\r\nimport { isSuperAdmin } from \"@/lib/permissions\"\r\n\r\nexport default async function FleetDashboardPage(props: { searchParams: Promise<{ [key: string]: string | undefined }> }) {\r\n  const searchParams = await props.searchParams\r\n  const startDate = searchParams.startDate\r\n  const endDate = searchParams.endDate\r\n  const branchId = searchParams.branch\r\n  const superAdmin = await isSuperAdmin()\r\n\r\n  const [opStats, subPerf, driverRank] = await Promise.all([\r\n    getOperationalStats(branchId),\r\n    getSubcontractorPerformance(startDate, endDate, branchId),\r\n    getDriverLeaderboard(startDate, endDate, branchId)\r\n  ])\r\n\r\n  return (\r\n    <div className=\"space-y-10 pb-20\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-6 border-b border-slate-800 pb-8\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <Link href=\"/admin/analytics\">\r\n            <Button variant=\"outline\" size=\"icon\" className=\"border-slate-700 bg-slate-900\">\r\n               <ArrowLeft className=\"h-5 w-5 text-slate-400\" />\r\n            </Button>\r\n          </Link>\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold text-white tracking-tight\">Fleet & Efficiency</h1>\r\n            <p className=\"text-slate-500\">Asset Optimization & Driver Performance</p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-3 bg-slate-900 border border-slate-800 p-2 rounded-xl\">\r\n            {/* Branch Filter removed (Global Header) */}\r\n            <MonthFilter />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Fleet Utilization Hero */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n          <Card className=\"lg:col-span-2 bg-gradient-to-br from-indigo-900/20 to-slate-900 border-indigo-500/20 shadow-2xl overflow-hidden relative group\">\r\n              <div className=\"absolute top-0 right-0 w-64 h-64 bg-indigo-500/5 rounded-full blur-3xl group-hover:bg-indigo-500/10 transition-all\"></div>\r\n              <CardHeader>\r\n                  <CardTitle className=\"text-white flex items-center gap-3\">\r\n                      <Activity className=\"text-indigo-400\" size={20} />\r\n                      Fleet Utilization Health\r\n                  </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-10\">\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8\">\r\n                      <div className=\"space-y-2\">\r\n                          <p className=\"text-sm font-bold text-slate-500 uppercase tracking-widest\">Active Ratio</p>\r\n                          <div className=\"flex items-baseline gap-2\">\r\n                              <span className=\"text-5xl font-black text-white\">{opStats.fleet.utilization.toFixed(1)}%</span>\r\n                              <span className=\"text-xs text-emerald-400 font-bold flex items-center gap-0.5\"><TrendingUp size={12} /> Target 85%</span>\r\n                          </div>\r\n                          <div className=\"w-full bg-slate-800 rounded-full h-2 mt-4\">\r\n                              <div className=\"bg-indigo-500 h-full rounded-full shadow-[0_0_10px_rgba(99,102,241,0.5)]\" style={{ width: `${opStats.fleet.utilization}%` }} />\r\n                          </div>\r\n                      </div>\r\n                      <div className=\"space-y-2 lg:border-l lg:border-slate-800 lg:pl-8\">\r\n                          <p className=\"text-sm font-bold text-slate-500 uppercase tracking-widest\">On-Time Success</p>\r\n                          <p className=\"text-5xl font-black text-emerald-400 leading-none\">{opStats.fleet.onTimeDelivery.toFixed(1)}%</p>\r\n                          <p className=\"text-[10px] text-slate-500 mt-2 font-bold\">Based on Actual vs Plan Delivery</p>\r\n                      </div>\r\n                      <div className=\"space-y-2 lg:border-l lg:border-slate-800 lg:pl-8\">\r\n                          <p className=\"text-sm font-bold text-slate-500 uppercase tracking-widest\">Active Vehicles</p>\r\n                          <p className=\"text-5xl font-black text-blue-400 leading-none\">{opStats.fleet.active}</p>\r\n                          <p className=\"text-[10px] text-slate-500 mt-2 font-bold\">Currently in transit: {opStats.fleet.total - opStats.fleet.active} idle</p>\r\n                      </div>\r\n                  </div>\r\n              </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"bg-slate-900 border-slate-800 shadow-xl\">\r\n              <CardHeader>\r\n                  <CardTitle className=\"text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2\">\r\n                      <Truck size={16} className=\"text-orange-400\" /> Crew Mix (Jobs)\r\n                  </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                  <SubcontractorPerformance data={subPerf} />\r\n              </CardContent>\r\n          </Card>\r\n      </div>\r\n\r\n      {/* Driver Performance & Fuel */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-5 gap-8\">\r\n          <Card className=\"lg:col-span-3 bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl\">\r\n              <CardHeader>\r\n                  <CardTitle className=\"text-white flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Users className=\"text-emerald-400\" size={18} /> Driver Yield Leaderboard\r\n                      </div>\r\n                      <span className=\"text-[10px] text-slate-500 font-bold uppercase tracking-widest\">Top 10 Performance</span>\r\n                  </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                  <DriverLeaderboard data={driverRank} />\r\n              </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"lg:col-span-2 bg-slate-900/50 border-slate-800 shadow-xl self-start\">\r\n              <CardHeader>\r\n                  <CardTitle className=\"text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2\">\r\n                      <Fuel size={16} className=\"text-amber-500\" /> Average Fuel Efficiency\r\n                  </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"flex flex-col items-center justify-center pt-6 pb-12\">\r\n                  <div className=\"relative\">\r\n                      <div className=\"text-[80px] font-black text-white leading-none tracking-tighter\">{opStats.fleet.fuelEfficiency.toFixed(1)}</div>\r\n                      <div className=\"absolute -right-12 bottom-2 text-xl font-bold text-slate-600\">KM/L</div>\r\n                  </div>\r\n                  <div className=\"mt-8 flex gap-1 w-full max-w-[200px]\">\r\n                      {[1,2,3,4,5,6,7,8].map(i => (\r\n                          <div key={i} className={`h-1.5 flex-1 rounded-full ${i <= (opStats.fleet.fuelEfficiency / 2) ? 'bg-amber-500' : 'bg-slate-800'}`} />\r\n                      ))}\r\n                  </div>\r\n                  <p className=\"text-[10px] text-slate-500 mt-4 uppercase font-bold tracking-widest text-center\">Efficiency Rating: {opStats.fleet.fuelEfficiency > 10 ? 'EXCELLENT' : 'AVERAGE'}</p>\r\n              </CardContent>\r\n          </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\auth\\logout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\debug\\branches\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\notifications\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\oauth\\callback\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[944,947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[944,947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse, NextRequest } from \"next/server\"\r\nimport { getOAuth2Client } from \"@/lib/google-drive\"\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\nexport async function GET(request: NextRequest) {\r\n  const searchParams = request.nextUrl.searchParams\r\n  const code = searchParams.get('code')\r\n\r\n  if (!code) {\r\n    return NextResponse.json({ error: \"No code provided\" }, { status: 400 })\r\n  }\r\n\r\n  try {\r\n    const oAuth2Client = getOAuth2Client()\r\n    const { tokens } = await oAuth2Client.getToken(code)\r\n    \r\n    // Display the Refresh Token to the user\r\n    return NextResponse.json({\r\n        success: true,\r\n        message: \"Authentication Successful!\",\r\n        REFRESH_TOKEN: tokens.refresh_token || \"No refresh token returned (Did you already authorize?)\",\r\n        NOTE: \"Please copy the REFRESH_TOKEN above and send it to the developer (me) to complete the setup.\",\r\n        full_tokens: tokens\r\n    })\r\n\r\n  } catch (error: any) {\r\n    console.error(\"OAuth Error:\", error)\r\n    return NextResponse.json({ error: error.message }, { status: 500 })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\oauth\\login\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\api\\test-drive\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1168,1171],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1168,1171],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\r\nimport { uploadFileByFolderId, getOrCreateFolder, ROOT_FOLDER_ID } from \"@/lib/google-drive\"\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\nexport async function GET() {\r\n  const steps = []\r\n  try {\r\n    steps.push(\"1. Starting Drive Test...\")\r\n    steps.push(`2. Using Root Folder ID: ${ROOT_FOLDER_ID}`)\r\n\r\n    // 1. Try to create a test folder\r\n    steps.push(\"3. Attempting to get/create 'TEST_CONNECTIVITY' folder...\")\r\n    const folderId = await getOrCreateFolder(\"TEST_CONNECTIVITY\", ROOT_FOLDER_ID)\r\n    steps.push(`4. Folder 'TEST_CONNECTIVITY' resolved (ID: ${folderId})`)\r\n\r\n    // 2. Try to upload a file\r\n    steps.push(\"5. Creating test file buffer...\")\r\n    const buffer = Buffer.from(\"Hello TMS, this is a test connection file.\", \"utf-8\")\r\n    \r\n    steps.push(\"6. Uploading 'test_file.txt'...\")\r\n    const result = await uploadFileByFolderId(buffer, \"test_file.txt\", \"text/plain\", folderId)\r\n    \r\n    steps.push(`7. Upload Success! File ID: ${result.fileId}`)\r\n    steps.push(`8. View Link: ${result.webViewLink}`)\r\n\r\n    return NextResponse.json({ success: true, logs: steps, result })\r\n\r\n  } catch (error: any) {\r\n    console.error(\"Test Drive Error:\", error)\r\n    steps.push(`ERROR: ${error.message}`)\r\n    if (error.response) {\r\n        steps.push(`API Error: ${JSON.stringify(error.response.data)}`)\r\n    }\r\n    return NextResponse.json({ success: false, logs: steps, error: error.message }, { status: 500 })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\customer\\client-page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":157,"column":25,"nodeType":"JSXOpeningElement","endLine":161,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  Receipt,\r\n  Download,\r\n  Calendar,\r\n  Building2,\r\n  FileText,\r\n  Search,\r\n  Printer,\r\n  CheckCircle2,\r\n  Clock,\r\n  Banknote,\r\n  Percent,\r\n  Loader2,\r\n  History,\r\n  Eye\r\n} from \"lucide-react\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport { Job } from \"@/lib/supabase/jobs\"\r\nimport { createBillingNote } from \"@/lib/supabase/billing\"\r\n\r\nimport { CompanyProfile } from \"@/lib/supabase/settings\"\r\nimport { Customer } from \"@/lib/supabase/customers\"\r\n\r\nconst WITHHOLDING_TAX_RATE = 0.01 // 1%\r\n\r\ninterface CustomerBillingClientProps {\r\n    initialJobs: Job[]\r\n    companyProfile: CompanyProfile | null\r\n    customers: Customer[]\r\n}\r\n\r\nexport default function CustomerBillingClient({ initialJobs, companyProfile, customers }: CustomerBillingClientProps) {\r\n  const router = useRouter()\r\n  const [dateFrom, setDateFrom] = useState(\"\")\r\n  const [dateTo, setDateTo] = useState(\"\")\r\n  const [selectedCustomer, setSelectedCustomer] = useState(\"\")\r\n  const [selectedItems, setSelectedItems] = useState<string[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  // Get unique customers\r\n  const uniqueCustomerNames = [...new Set(initialJobs.filter(j=>j.Customer_Name).map(item => item.Customer_Name!))]\r\n\r\n  // Filter data (Client-side filtering for now)\r\n  const filteredData = initialJobs.filter(item => {\r\n    if (selectedCustomer && item.Customer_Name !== selectedCustomer) return false\r\n    if (dateFrom && item.Plan_Date && item.Plan_Date < dateFrom) return false\r\n    if (dateTo && item.Plan_Date && item.Plan_Date > dateTo) return false\r\n    return true\r\n  })\r\n\r\n  // Calculate totals\r\n  // Status \"Completed\" or \"Delivered\" are considered \"Pending Billing\" effectively until we have a real Billing Status\r\n  const pendingItems = filteredData\r\n  const pendingTotal = pendingItems.reduce((sum, i) => sum + (i.Price_Cust_Total || 0), 0)\r\n  \r\n  // Selected items calculations\r\n  const selectedData = filteredData.filter(i => selectedItems.includes(i.Job_ID))\r\n  const selectedSubtotal = selectedData.reduce((sum, i) => sum + (i.Price_Cust_Total || 0), 0)\r\n  const selectedWithholding = Math.round(selectedSubtotal * WITHHOLDING_TAX_RATE)\r\n  const selectedNetTotal = selectedSubtotal - selectedWithholding\r\n\r\n  const toggleItem = (jobId: string) => {\r\n    setSelectedItems(prev => \r\n      prev.includes(jobId) ? prev.filter(id => id !== jobId) : [...prev, jobId]\r\n    )\r\n  }\r\n\r\n  const selectAll = () => {\r\n    const pendingIds = pendingItems.map(i => i.Job_ID)\r\n    setSelectedItems(pendingIds)\r\n  }\r\n\r\n  const clearSelection = () => {\r\n    setSelectedItems([])\r\n  }\r\n\r\n  const handleCreateBilling = async () => {\r\n    if (selectedItems.length === 0) return\r\n    if (!selectedCustomer) {\r\n        alert(\"กรุณาเลือกลูกค้าก่อนสร้างใบวางบิล\")\r\n        return\r\n    }\r\n\r\n    if (!confirm(`ยืนยันการสร้างใบวางบิลสำหรับ ${selectedItems.length} รายการ?`)) return\r\n\r\n    setLoading(true)\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0]\r\n        // Default Due Date = Today + 30 days\r\n        const dueDateObj = new Date()\r\n        dueDateObj.setDate(dueDateObj.getDate() + 30)\r\n        const dueDate = dueDateObj.toISOString().split('T')[0]\r\n\r\n        const result = await createBillingNote(\r\n            selectedItems, \r\n            selectedCustomer, // Assuming only one customer is selected/filtered\r\n            today,\r\n            dueDate\r\n        )\r\n\r\n        if (result.success) {\r\n            alert(`สร้างใบวางบิลเลขที่ ${result.id} สำเร็จ!`)\r\n            setSelectedItems([])\r\n            router.refresh() // Reload data to remove billed items (logic needs to handle excluding billed items)\r\n        } else {\r\n            alert(`เกิดข้อผิดพลาด: ${result.error}`)\r\n        }\r\n    } catch (e) {\r\n        console.error(e)\r\n        alert(\"เกิดข้อผิดพลาดในการสร้างใบวางบิล\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  const [showPreview, setShowPreview] = useState(false)\r\n\r\n  // ... (previous state existing) ...\r\n\r\n  const handlePrint = () => {\r\n    window.print()\r\n  }\r\n\r\n  // Preview Component (Reused for Print and Dialog)\r\n  const InvoicePreview = () => {\r\n    // Find customer details (Case-insensitive match)\r\n    const customerInfo = customers.find(c => \r\n        c.Customer_Name?.trim().toLowerCase() === selectedCustomer?.trim().toLowerCase()\r\n    )\r\n\r\n    return (\r\n    <div className=\"p-8 bg-white text-black max-w-[210mm] mx-auto min-h-[297mm] relative\">\r\n        {/* Document Border (Optional, for visual) */}\r\n        <div className=\"absolute inset-0 border border-slate-300 pointer-events-none print:hidden\"></div>\r\n\r\n        {/* Header Section */}\r\n        <div className=\"flex justify-between items-start mb-6\">\r\n            {/* Left: Logo & Company Info */}\r\n            <div className=\"flex flex-col gap-4 max-w-[60%]\">\r\n                {companyProfile?.logo_url && (\r\n                    <div>\r\n                        <img \r\n                            src={companyProfile.logo_url} \r\n                            alt=\"Company Logo\" \r\n                            className=\"h-24 w-auto object-contain\" \r\n                        />\r\n                    </div>\r\n                )}\r\n                <div className=\"text-sm\">\r\n                    {companyProfile ? (\r\n                        <>\r\n                            <h2 className=\"font-bold text-lg\">{companyProfile.company_name}</h2>\r\n                            {companyProfile.company_name_en && (\r\n                                <p className=\"text-slate-600 font-medium\">{companyProfile.company_name_en}</p>\r\n                            )}\r\n                            <p className=\"mt-2 text-slate-700\">{companyProfile.address}</p>\r\n                            <div className=\"flex gap-4 mt-1\">\r\n                                <p><span className=\"font-semibold\">Tax ID:</span> {companyProfile.tax_id}</p>\r\n                                {companyProfile.phone && <p><span className=\"font-semibold\">Tel:</span> {companyProfile.phone}</p>}\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <p className=\"text-slate-400\">Loading company info...</p>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Right: Document Title */}\r\n            <div className=\"text-right\">\r\n                <h1 className=\"text-4xl font-bold text-slate-900 tracking-wide\">ใบวางบิล</h1>\r\n                <p className=\"text-slate-500 text-lg font-medium tracking-widest uppercase mt-1\">Billing Note</p>\r\n                <div className=\"mt-4\">\r\n                     <span className=\"px-3 py-1 bg-slate-100 rounded text-xs font-mono border border-slate-200\">\r\n                        ORIGINAL (ต้นฉบับ)\r\n                     </span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <hr className=\"border-slate-300 mb-6\" />\r\n\r\n        {/* Info Grid: Buyer & Details */}\r\n        <div className=\"grid grid-cols-2 gap-8 mb-8\">\r\n            {/* Buyer Info */}\r\n            <div className=\"border border-slate-200 rounded p-4 bg-slate-50/50\">\r\n                <h3 className=\"font-bold text-slate-800 border-b border-slate-200 pb-2 mb-2\">ลูกค้า (Customer)</h3>\r\n                <p className=\"font-semibold text-lg\">{selectedCustomer}</p>\r\n                {customerInfo ? (\r\n                    <div className=\"text-sm text-slate-600 mt-2 space-y-1\">\r\n                        <p>{customerInfo.Address || '-'}</p>\r\n                        <p><span className=\"font-semibold\">Tax ID:</span> {customerInfo.Tax_ID || '-'}</p>\r\n                        {customerInfo.Phone && <p><span className=\"font-semibold\">Tel:</span> {customerInfo.Phone}</p>}\r\n                        {/* Use Branch_ID if previously added to type, else omit */}\r\n                        {customerInfo.Branch_ID && <p><span className=\"font-semibold\">Branch:</span> {customerInfo.Branch_ID}</p>} \r\n                    </div>\r\n                ) : (\r\n                    <p className=\"text-sm text-red-400 mt-2 italic\">* ไม่พบข้อมูลลูกค้าในระบบ Master</p>\r\n                )}\r\n            </div>\r\n\r\n            {/* Document Details */}\r\n            <div className=\"border border-slate-200 rounded p-4\">\r\n                 <div className=\"space-y-3 text-sm\">\r\n                    <div className=\"flex justify-between border-b border-slate-100 pb-2\">\r\n                        <span className=\"text-slate-500\">เลขที่เอกสาร (No.):</span>\r\n                        <span className=\"font-mono font-bold\">- (Draft)</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-slate-100 pb-2\">\r\n                        <span className=\"text-slate-500\">วันที่ (Date):</span>\r\n                        <span className=\"font-medium\">{new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-slate-100 pb-2\">\r\n                        <span className=\"text-slate-500\">เครดิต (Credit Days):</span>\r\n                        <span className=\"font-medium\">30 Days</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                        <span className=\"text-slate-500\">ผู้ทำรายการ (Prepared By):</span>\r\n                        <span className=\"font-medium\">Admin</span>\r\n                    </div>\r\n                 </div>\r\n            </div>\r\n        </div>\r\n\r\n        {/* Table */}\r\n        <div className=\"mb-8\">\r\n            <table className=\"w-full text-sm border-collapse\">\r\n                <thead>\r\n                    <tr className=\"bg-slate-100 text-slate-700 border-y-2 border-slate-300\">\r\n                        <th className=\"py-3 px-4 text-center font-bold w-16\">ลำดับ<br/><span className=\"text-xs font-normal\">No.</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">รายละเอียด<br/><span className=\"text-xs font-normal\">Description</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">วันที่<br/><span className=\"text-xs font-normal\">Date</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">เส้นทาง<br/><span className=\"text-xs font-normal\">Route</span></th>\r\n                        <th className=\"py-3 px-4 text-right font-bold w-32\">จำนวนเงิน<br/><span className=\"text-xs font-normal\">Amount</span></th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    {selectedData.map((item, index) => (\r\n                        <tr key={item.Job_ID} className=\"border-b border-slate-200\">\r\n                            <td className=\"py-3 px-4 text-center text-slate-500\">{index + 1}</td>\r\n                            <td className=\"py-3 px-4 font-medium text-slate-800\">\r\n                                ค่าขนส่ง (Job: {item.Job_ID})\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-slate-600\">\r\n                                {item.Plan_Date ? new Date(item.Plan_Date).toLocaleDateString('th-TH') : '-'}\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-slate-600 text-xs\">\r\n                                {item.Route_Name || '-'}\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-right font-medium text-slate-800\">\r\n                                {item.Price_Cust_Total?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                            </td>\r\n                        </tr>\r\n                    ))}\r\n                    {/* Fill empty rows to maintain height if needed, or just standard spacing */}\r\n                    {Array.from({ length: Math.max(0, 5 - selectedData.length) }).map((_, i) => (\r\n                         <tr key={`empty-${i}`} className=\"border-b border-slate-100 h-10\">\r\n                            <td colSpan={5}></td>\r\n                         </tr>\r\n                    ))}\r\n                </tbody>\r\n                <tfoot>\r\n                    <tr>\r\n                        <td colSpan={3} rowSpan={3} className=\"pt-4 pr-8 align-top\">\r\n                            <div className=\"border border-slate-300 bg-slate-50 p-3 rounded text-xs text-slate-500\">\r\n                                <p className=\"font-bold mb-1\">หมายเหตุ (Remarks):</p>\r\n                                <p>- กรุณาตรวจสอบความถูกต้องของเอกสาร</p>\r\n                                <p>- ชำระเงินโดยการโอนเข้าบัญชีบริษัท</p>\r\n                            </div>\r\n                        </td>\r\n                        <td className=\"py-2 px-4 text-right font-bold text-slate-600\">รวมเป็นเงิน</td>\r\n                        <td className=\"py-2 px-4 text-right font-bold text-slate-800\">{selectedSubtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                    </tr>\r\n                    <tr>\r\n                        <td className=\"py-2 px-4 text-right text-slate-600 text-sm\">หัก ณ ที่จ่าย 1%</td>\r\n                        <td className=\"py-2 px-4 text-right text-red-500 font-medium\">-{selectedWithholding.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                    </tr>\r\n                    <tr className=\"bg-slate-50 border-t-2 border-slate-300 border-b-2\">\r\n                        <td className=\"py-3 px-4 text-right font-bold text-slate-900 text-lg\">ยอดสุทธิ</td>\r\n                        <td className=\"py-3 px-4 text-right font-bold text-emerald-700 text-lg decoration-double underline\">\r\n                            {selectedNetTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                        </td>\r\n                    </tr>\r\n                </tfoot>\r\n            </table>\r\n        </div>\r\n\r\n        {/* Footer Signatures */}\r\n        <div className=\"flex justify-between mt-16 text-sm text-slate-600 pb-8\">\r\n            <div className=\"text-center w-1/3\">\r\n                <div className=\"border-b border-slate-400 mb-2 h-8 w-3/4 mx-auto\"></div>\r\n                <p className=\"font-bold\">ผู้รับวางบิล</p>\r\n                <p className=\"text-xs\">(Received By)</p>\r\n                <div className=\"mt-4 text-xs\">วันที่ (Date): _____/_____/_______</div>\r\n            </div>\r\n            <div className=\"text-center w-1/3\">\r\n                <div className=\"border-b border-slate-400 mb-2 h-8 w-3/4 mx-auto\"></div>\r\n                <p className=\"font-bold\">ผู้วางบิล / ผู้มีอำนาจลงนาม</p>\r\n                <p className=\"text-xs\">(Authorized Signature)</p>\r\n                <div className=\"mt-4 text-xs\">วันที่ (Date): _____/_____/_______</div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n  )}\r\n\r\n  return (\r\n    <>\r\n    <div className=\"print:hidden\">\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n            <Receipt className=\"text-emerald-400\" />\r\n            สรุปวางบิลลูกค้า\r\n          </h1>\r\n          <p className=\"text-sm text-slate-400 mt-1\">สร้างเอกสารสรุปสำหรับวางบิลลูกค้า (หัก ณ ที่จ่าย 1%)</p>\r\n        </div>\r\n        <Button \r\n            variant=\"outline\" \r\n            className=\"border-slate-700 text-slate-300 gap-2\"\r\n            onClick={() => router.push('/billing/customer/history')}\r\n        >\r\n            <History className=\"w-4 h-4\" /> ประวัติการวางบิล\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800 mb-6\">\r\n        {/* ... (Existing Filters Content) ... */}\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm\">ลูกค้า</Label>\r\n              <select\r\n                value={selectedCustomer}\r\n                onChange={(e) => setSelectedCustomer(e.target.value)}\r\n                className=\"w-full h-10 px-3 rounded-md bg-slate-800 border border-slate-700 text-white\"\r\n              >\r\n                <option value=\"\">เลือกลูกค้า...</option>\r\n                {uniqueCustomerNames.map(c => (\r\n                  <option key={c} value={c}>{c}</option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm flex items-center gap-1\">\r\n                <Calendar className=\"w-3 h-3\" /> วันที่เริ่มต้น\r\n              </Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateFrom}\r\n                onChange={(e) => setDateFrom(e.target.value)}\r\n                className=\"bg-slate-800 border-slate-700 text-white\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm\">วันที่สิ้นสุด</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateTo}\r\n                onChange={(e) => setDateTo(e.target.value)}\r\n                className=\"bg-slate-800 border-slate-700 text-white\"\r\n              />\r\n            </div>\r\n            <div className=\"flex items-end\">\r\n              <Button variant=\"outline\" className=\"border-slate-700 w-full text-slate-300\">\r\n                <Search className=\"w-4 h-4 mr-2\" /> ค้นหา\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Summary Stats */}\r\n      {/* ... (Existing Summary Stats Content) ... */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6\">\r\n        <Card className=\"bg-amber-500/10 border-amber-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center\">\r\n              <Clock className=\"w-6 h-6 text-amber-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-amber-400\">{pendingItems.length}</p>\r\n              <p className=\"text-xs text-slate-400\">รอวางบิล</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-blue-500/10 border-blue-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center\">\r\n              <Banknote className=\"w-6 h-6 text-blue-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-blue-400\">฿{pendingTotal.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">ยอดรอวางบิล</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-emerald-500/10 border-emerald-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-emerald-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-emerald-400\">฿{selectedSubtotal.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">ยอดที่เลือก ({selectedItems.length} รายการ)</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-purple-500/10 border-purple-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center\">\r\n              <Percent className=\"w-6 h-6 text-purple-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-purple-400\">฿{selectedWithholding.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">หัก ณ ที่จ่าย 1%</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Selected Summary Box */}\r\n      {selectedItems.length > 0 && (\r\n        <Card className=\"bg-gradient-to-r from-emerald-500/10 to-blue-500/10 border-emerald-500/30 mb-6\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n              <div className=\"flex items-center gap-6\">\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">ยอดรวม</p>\r\n                  <p className=\"text-white font-bold text-lg\">฿{selectedSubtotal.toLocaleString()}</p>\r\n                </div>\r\n                <div className=\"text-slate-500\">-</div>\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">หัก ณ ที่จ่าย 1%</p>\r\n                  <p className=\"text-red-400 font-bold text-lg\">฿{selectedWithholding.toLocaleString()}</p>\r\n                </div>\r\n                <div className=\"text-slate-500\">=</div>\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">ยอดสุทธิ</p>\r\n                  <p className=\"text-emerald-400 font-bold text-xl\">฿{selectedNetTotal.toLocaleString()}</p>\r\n                </div>\r\n              </div>\r\n              <Button onClick={clearSelection} variant=\"ghost\" className=\"text-slate-400 hover:text-white\">\r\n                ล้างการเลือก\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Table */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800\">\r\n        <CardHeader className=\"flex flex-row items-center justify-between pb-4\">\r\n          <CardTitle className=\"text-white\">รายการงาน</CardTitle>\r\n          <div className=\"flex gap-2\">\r\n            <Button variant=\"outline\" size=\"sm\" onClick={selectAll} className=\"border-slate-700 text-slate-300\">\r\n              เลือกทั้งหมด\r\n            </Button>\r\n            <Dialog open={showPreview} onOpenChange={setShowPreview}>\r\n                <DialogTrigger asChild>\r\n                    <Button \r\n                        size=\"sm\" \r\n                        variant=\"outline\" \r\n                        className=\"border-slate-700 text-slate-300\"\r\n                        disabled={selectedItems.length === 0}\r\n                    >\r\n                        <Eye className=\"w-4 h-4 mr-2\" /> ดูตัวอย่าง\r\n                    </Button>\r\n                </DialogTrigger>\r\n                <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto bg-white p-0\">\r\n                    <DialogHeader className=\"p-4 border-b\">\r\n                        <DialogTitle className=\"text-slate-900\">ตัวอย่างใบวางบิล</DialogTitle>\r\n                    </DialogHeader>\r\n                    <div className=\"p-6\">\r\n                        <InvoicePreview />\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            <Button \r\n                size=\"sm\" \r\n                className=\"bg-emerald-600 hover:bg-emerald-700\" \r\n                disabled={selectedItems.length === 0 || loading}\r\n                onClick={handleCreateBilling}\r\n            >\r\n              {loading ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <FileText className=\"w-4 h-4 mr-2\" />}\r\n              สร้างใบวางบิล\r\n            </Button>\r\n            <Button \r\n                size=\"sm\" \r\n                variant=\"outline\" \r\n                className=\"border-slate-700 text-slate-300\" \r\n                disabled={selectedItems.length === 0}\r\n                onClick={handlePrint}\r\n            >\r\n              <Printer className=\"w-4 h-4 mr-2\" /> พิมพ์\r\n            </Button>\r\n            <Button size=\"sm\" variant=\"outline\" className=\"border-slate-700 text-slate-300\" disabled={selectedItems.length === 0}>\r\n              <Download className=\"w-4 h-4 mr-2\" /> Export\r\n            </Button>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* ... (Existing Table Content) ... */}\r\n           <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b border-slate-800\">\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">\r\n                    <input \r\n                      type=\"checkbox\" \r\n                      className=\"rounded bg-slate-800 border-slate-700\"\r\n                      checked={selectedItems.length === pendingItems.length && pendingItems.length > 0}\r\n                      onChange={selectAll}\r\n                    />\r\n                  </th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">Job ID</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">ลูกค้า</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">วันที่</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">เส้นทาง</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">ค่าขนส่ง</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">รวม</th>\r\n                  <th className=\"text-center py-3 px-4 text-slate-400 font-medium text-sm\">สถานะ</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {filteredData.map((item) => (\r\n                  <tr key={item.Job_ID} className=\"border-b border-slate-800/50 hover:bg-slate-800/30\">\r\n                    <td className=\"py-3 px-4\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"rounded bg-slate-800 border-slate-700\"\r\n                        checked={selectedItems.includes(item.Job_ID)}\r\n                        onChange={() => toggleItem(item.Job_ID)}\r\n                      />\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-white font-medium\">{item.Job_ID}</td>\r\n                    <td className=\"py-3 px-4 text-slate-300 flex items-center gap-2\">\r\n                       <Building2 className=\"w-4 h-4 text-slate-500\" />\r\n                      {item.Customer_Name || '-'}\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-slate-400\">{item.Plan_Date ? new Date(item.Plan_Date).toLocaleDateString('th-TH') : '-'}</td>\r\n                    <td className=\"py-3 px-4 text-slate-300\">{item.Route_Name || '-'}</td>\r\n                    <td className=\"py-3 px-4 text-right text-emerald-400\">\r\n                      ฿{(item.Price_Cust_Total || 0).toLocaleString()}\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-right text-white font-medium\">\r\n                      ฿{(item.Price_Cust_Total || 0).toLocaleString()}\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-center\">\r\n                      <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400\">\r\n                        รอวางบิล\r\n                      </span>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n                {filteredData.length === 0 && (\r\n                  <tr>\r\n                    <td colSpan={8} className=\"text-center py-8 text-slate-500\">\r\n                      <div className=\"flex flex-col items-center gap-2\">\r\n                         <FileText className=\"w-8 h-8 opacity-50\" />\r\n                         <p>ไม่พบรายการที่ต้องวางบิล</p>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                )}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n    </div>\r\n\r\n    {/* Hidden Print Area */}\r\n    <div className=\"hidden print:block fixed inset-0 bg-white z-[9999] p-8\">\r\n        <InvoicePreview />\r\n    </div>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\customer\\history\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":65,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":83,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":101,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport Link from \"next/link\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Receipt,\r\n  ArrowLeft,\r\n  Printer,\r\n  Search,\r\n  Calendar,\r\n  Undo2,\r\n  CheckCircle2,\r\n  Mail,\r\n  CloudSync\r\n} from \"lucide-react\"\r\nimport { getBillingNotes, BillingNote, updateBillingNoteStatus, recallBillingNote } from \"@/lib/supabase/billing\"\r\nimport { toast } from \"sonner\"\r\nimport { isSuperAdmin } from \"@/lib/permissions\"\r\nimport { BillingActions } from \"@/components/billing/billing-actions\"\r\nimport { manualSyncInvoice } from \"@/app/settings/accounting/actions\"\r\n\r\nexport default function CustomerBillingHistory() {\r\n  const router = useRouter()\r\n  const [notes, setNotes] = useState<BillingNote[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [isAdmin, setIsAdmin] = useState(false)\r\n  const [processingId, setProcessingId] = useState<string | null>(null)\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n    checkAdmin()\r\n  }, [])\r\n\r\n  const checkAdmin = async () => {\r\n    const adminStatus = await isSuperAdmin()\r\n    setIsAdmin(adminStatus)\r\n  }\r\n\r\n  const loadData = async () => {\r\n    try {\r\n        const data = await getBillingNotes()\r\n        setNotes(data)\r\n    } catch (error) {\r\n        console.error(\"Failed to load billing history\", error)\r\n        toast.error(\"โหลดข้อมูลไม่สำเร็จ\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSyncToAccounting = async (id: string) => {\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await manualSyncInvoice(id)\r\n        if (res.success) {\r\n            toast.success(\"ส่งข้อมูลไประบบบัญชีสำเร็จ\")\r\n        } else {\r\n            toast.error(res.message || \"เกิดข้อผิดพลาดในการเชื่อมต่อ\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const handleMarkAsPaid = async (id: string) => {\r\n    if (!confirm(\"ยืนยันการเปลี่ยนสถานะเป็น 'ชำระเงินแล้ว'?\")) return\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await updateBillingNoteStatus(id, \"Paid\")\r\n        if (res.success) {\r\n            toast.success(\"อัปเดตสถานะเรียบร้อย\")\r\n            loadData()\r\n        } else {\r\n            toast.error(res.error || \"เกิดข้อผิดพลาด\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const handleRecall = async (id: string) => {\r\n    if (!confirm(\"⚠️ คำเตือน: คุณกำลังจะดึงรายการบิลนี้กลับไปแก้ไข\\\\n\\\\nเอกสารนี้จะถูกลบ และรายการงานในบิลจะกลับไปสถานะ 'รอวางบิล'\\\\nยืนยันการดำเนินการ?\")) return\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await recallBillingNote(id)\r\n        if (res.success) {\r\n            toast.success(\"ดึงรายการกลับสำเร็จ\")\r\n            loadData()\r\n        } else {\r\n            toast.error(res.error || \"เกิดข้อผิดพลาด\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const filteredNotes = notes.filter(n => \r\n    n.Billing_Note_ID.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    n.Customer_Name.toLowerCase().includes(searchTerm.toLowerCase())\r\n  )\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch(status) {\r\n        case 'Paid':\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20\">ชำระแล้ว</span>\r\n        case 'Pending':\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20\">รอดำเนินการ</span>\r\n        default:\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-blue-500/10 text-blue-400 border border-blue-500/20\">{status}</span>\r\n    }\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n            <Receipt className=\"text-emerald-400\" />\r\n            ประวัติการวางบิลลูกค้า\r\n          </h1>\r\n          <p className=\"text-sm text-slate-400 mt-1\">รายการใบวางบิลที่สร้างแล้วทั้งหมด</p>\r\n        </div>\r\n        <Button \r\n            variant=\"outline\" \r\n            className=\"border-slate-700 text-slate-300\"\r\n            onClick={() => router.back()}\r\n        >\r\n            <ArrowLeft className=\"w-4 h-4 mr-2\" /> ย้อนกลับ\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800 mb-6\">\r\n        <CardContent className=\"p-4\">\r\n            <div className=\"flex gap-4\">\r\n                <div className=\"relative flex-1\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500\" />\r\n                    <input \r\n                        type=\"text\" \r\n                        placeholder=\"ค้นหาเลขที่เอกสาร หรือ ชื่อลูกค้า...\" \r\n                        className=\"w-full h-10 pl-10 pr-4 rounded-md bg-slate-800 border border-slate-700 text-white focus:outline-none focus:border-emerald-500\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n            </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Table */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800\">\r\n        <CardHeader>\r\n            <CardTitle className=\"text-white text-lg\">รายการใบวางบิล ({filteredNotes.length})</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b border-slate-800\">\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">เลขที่เอกสาร</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">วันที่ทำรายการ</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">ลูกค้า</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">ยอดเงิน</th>\r\n                  <th className=\"text-center py-3 px-4 text-slate-400 font-medium text-sm\">สถานะ</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">จัดการ</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {loading ? (\r\n                    <tr>\r\n                        <td colSpan={6} className=\"text-center py-8 text-slate-500\">กำลังโหลด...</td>\r\n                    </tr>\r\n                ) : filteredNotes.length === 0 ? (\r\n                    <tr>\r\n                        <td colSpan={6} className=\"text-center py-8 text-slate-500\">ไม่พบข้อมูล</td>\r\n                    </tr>\r\n                ) : (\r\n                    filteredNotes.map((item) => (\r\n                    <tr key={item.Billing_Note_ID} className=\"border-b border-slate-800/50 hover:bg-slate-800/30\">\r\n                        <td className=\"py-3 px-4 text-emerald-400 font-mono\">{item.Billing_Note_ID}</td>\r\n                        <td className=\"py-3 px-4 text-slate-400 flex items-center gap-2\">\r\n                             <Calendar className=\"w-3 h-3\" />\r\n                             {new Date(item.Created_At).toLocaleDateString('th-TH')}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-white font-medium\">{item.Customer_Name}</td>\r\n                        <td className=\"py-3 px-4 text-right text-white\">\r\n                            ฿{item.Total_Amount.toLocaleString()}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-center\">\r\n                            {getStatusBadge(item.Status)}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-right\">\r\n                            <div className=\"flex justify-end gap-1\">\r\n                                {item.Status !== 'Paid' && (\r\n                                    <Button \r\n                                        size=\"sm\" \r\n                                        variant=\"ghost\" \r\n                                        className=\"text-emerald-400 hover:text-emerald-300 hover:bg-emerald-500/10\"\r\n                                        onClick={() => handleMarkAsPaid(item.Billing_Note_ID)}\r\n                                        disabled={processingId === item.Billing_Note_ID}\r\n                                        title=\"ทำจ่ายแล้ว\"\r\n                                    >\r\n                                        <CheckCircle2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                )}\r\n                                \r\n                                <BillingActions \r\n                                    billingNoteId={item.Billing_Note_ID}\r\n                                    customerName={item.Customer_Name}\r\n                                    customerEmail={item.Customer_Email}\r\n                                    hidePrint={true}\r\n                                    // Custom trigger since we use it in a table\r\n                                    trigger={\r\n                                        <Button \r\n                                            size=\"sm\" \r\n                                            variant=\"ghost\" \r\n                                            className=\"text-blue-400 hover:text-blue-300\"\r\n                                            title=\"ส่งอีเมล\"\r\n                                        >\r\n                                            <Mail className=\"w-4 h-4\" />\r\n                                        </Button>\r\n                                    }\r\n                                />\r\n\r\n                                <Button \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\" \r\n                                    className=\"text-indigo-400 hover:text-indigo-300\"\r\n                                    onClick={() => handleSyncToAccounting(item.Billing_Note_ID)}\r\n                                    disabled={processingId === item.Billing_Note_ID}\r\n                                    title=\"ส่งไประบบบัญชี\"\r\n                                >\r\n                                    <CloudSync className=\"w-4 h-4\" />\r\n                                </Button>\r\n\r\n                                <Link href={`/billing/print/${item.Billing_Note_ID}`} target=\"_blank\">\r\n                                    <Button \r\n                                        size=\"sm\" \r\n                                        variant=\"ghost\" \r\n                                        className=\"text-slate-400 hover:text-white\"\r\n                                        title=\"พิมพ์\"\r\n                                    >\r\n                                        <Printer className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                </Link>\r\n\r\n                                {isAdmin && (\r\n                                    <Button \r\n                                        size=\"sm\" \r\n                                        variant=\"ghost\" \r\n                                        className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10\"\r\n                                        onClick={() => handleRecall(item.Billing_Note_ID)}\r\n                                        disabled={processingId === item.Billing_Note_ID}\r\n                                        title=\"ดึงรายการกลับ (Recall)\"\r\n                                    >\r\n                                        <Undo2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        </td>\r\n                    </tr>\r\n                    ))\r\n                )}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\customer\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\driver\\client-page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":235,"column":25,"nodeType":"JSXOpeningElement","endLine":239,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  Wallet,\r\n  Download,\r\n  Calendar,\r\n  Truck,\r\n  User,\r\n  FileText,\r\n  Search,\r\n  Printer,\r\n  CheckCircle2,\r\n  Clock,\r\n  Banknote,\r\n  Percent,\r\n  Loader2,\r\n  FileDown,\r\n  History,\r\n  Eye\r\n} from \"lucide-react\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport { Job } from \"@/lib/supabase/jobs\"\r\nimport { Driver } from \"@/lib/supabase/drivers\"\r\nimport { createDriverPayment } from \"@/lib/supabase/billing\"\r\n\r\nimport { CompanyProfile } from \"@/lib/supabase/settings\"\r\nimport { Subcontractor } from \"@/types/subcontractor\"\r\n\r\nconst WITHHOLDING_TAX_RATE = 0.01 // 1%\r\n\r\ninterface DriverPaymentClientProps {\r\n  initialJobs: Job[]\r\n  drivers: Driver[]\r\n  companyProfile: CompanyProfile | null\r\n  subcontractors: Subcontractor[]\r\n}\r\n\r\nexport default function DriverPaymentClient({ initialJobs, drivers, companyProfile, subcontractors }: DriverPaymentClientProps) {\r\n  const router = useRouter()\r\n  const [dateFrom, setDateFrom] = useState(\"\")\r\n  const [dateTo, setDateTo] = useState(\"\")\r\n  const [paymentModel, setPaymentModel] = useState<'individual' | 'subcontractor'>('individual')\r\n  const [selectedEntityId, setSelectedEntityId] = useState(\"\")\r\n  const [selectedItems, setSelectedItems] = useState<string[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [showPreview, setShowPreview] = useState(false)\r\n\r\n  // Selected items calculations\r\n\r\n  // Filter data (Client-side)\r\n  const filteredData = initialJobs.filter(item => {\r\n    // Determine if this job belongs to the selected entity\r\n    if (paymentModel === 'individual') {\r\n        if (selectedEntityId && item.Driver_Name !== selectedEntityId) return false\r\n    } else {\r\n        // For subcontractor mode, we need to know which subcontractor the driver belongs to\r\n        const driver = drivers.find(d => d.Driver_Name === item.Driver_Name)\r\n        if (selectedEntityId && driver?.Sub_ID !== selectedEntityId) return false\r\n    }\r\n\r\n    if (dateFrom && item.Plan_Date && item.Plan_Date < dateFrom) return false\r\n    if (dateTo && item.Plan_Date && item.Plan_Date > dateTo) return false\r\n    return true\r\n  })\r\n\r\n  // Calculate totals\r\n  const pendingItems = filteredData\r\n  const pendingTotal = pendingItems.reduce((sum, i) => sum + (i.Cost_Driver_Total || 0), 0)\r\n  \r\n  // Selected items calculations\r\n  const selectedData = filteredData.filter(i => selectedItems.includes(i.Job_ID))\r\n  const selectedSubtotal = selectedData.reduce((sum, i) => sum + (i.Cost_Driver_Total || 0), 0)\r\n  const selectedWithholding = Math.round(selectedSubtotal * WITHHOLDING_TAX_RATE)\r\n  const selectedNetTotal = selectedSubtotal - selectedWithholding\r\n\r\n  const toggleItem = (jobId: string) => {\r\n    setSelectedItems(prev => \r\n      prev.includes(jobId) ? prev.filter(id => id !== jobId) : [...prev, jobId]\r\n    )\r\n  }\r\n\r\n  const selectAll = () => {\r\n    const pendingIds = pendingItems.map(i => i.Job_ID)\r\n    setSelectedItems(pendingIds)\r\n  }\r\n\r\n  const clearSelection = () => {\r\n    setSelectedItems([])\r\n  }\r\n\r\n  const handleCreatePayment = async () => {\r\n    if (selectedItems.length === 0) return\r\n    if (!selectedEntityId) {\r\n        alert(paymentModel === 'individual' ? \"กรุณาเลือกคนขับก่อนสร้างใบสรุปจ่าย\" : \"กรุณาเลือกบริษัทรถร่วมก่อนสร้างใบสรุปจ่าย\")\r\n        return\r\n    }\r\n\r\n    if (!confirm(`ยืนยันการสร้างใบสรุปจ่ายสำหรับ ${selectedItems.length} รายการ?`)) return\r\n\r\n    setLoading(true)\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0]\r\n\r\n        const result = await createDriverPayment(\r\n            selectedItems, \r\n            paymentModel === 'individual' \r\n                ? selectedEntityId \r\n                : (subcontractors.find(s => s.Sub_ID === selectedEntityId)?.Sub_Name || selectedEntityId), \r\n            today\r\n        )\r\n\r\n        if (result.success) {\r\n            alert(`สร้างใบสรุปจ่ายเลขที่ ${result.id} สำเร็จ!`)\r\n            setSelectedItems([])\r\n            router.refresh() \r\n        } else {\r\n            alert(`เกิดข้อผิดพลาด: ${result.error}`)\r\n        }\r\n    } catch (e) {\r\n        console.error(e)\r\n        alert(\"เกิดข้อผิดพลาดในการสร้างใบสรุปจ่าย\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleExportSCB = () => {\r\n    if (selectedItems.length === 0) return\r\n\r\n    // 1. Get selected job objects\r\n    const jobsToExport = initialJobs.filter(j => selectedItems.includes(j.Job_ID))\r\n\r\n    // 2. Group by Payment Entity\r\n    const lines = [\"Bank Code,Account No,Amount,Beneficiary Name,Ref1,Ref2\"]\r\n    const missingBankEntities: string[] = []\r\n\r\n    if (paymentModel === 'individual') {\r\n        const jobsByDriver: Record<string, Job[]> = {}\r\n        jobsToExport.forEach(job => {\r\n            const dName = job.Driver_Name || 'Unknown'\r\n            if (!jobsByDriver[dName]) jobsByDriver[dName] = []\r\n            jobsByDriver[dName].push(job)\r\n        })\r\n\r\n        Object.entries(jobsByDriver).forEach(([driverName, p_jobs]) => {\r\n            const driverInfo = drivers.find(d => d.Driver_Name === driverName)\r\n            if (!driverInfo?.Bank_Account_No) {\r\n                missingBankEntities.push(driverName)\r\n                return\r\n            }\r\n            const subtotal = p_jobs.reduce((sum, j) => sum + (j.Cost_Driver_Total || 0), 0)\r\n            const withholding = Math.round(subtotal * WITHHOLDING_TAX_RATE)\r\n            const netTotal = subtotal - withholding\r\n            lines.push(`${driverInfo.Bank_Name || 'SCB'},${driverInfo.Bank_Account_No},${netTotal.toFixed(2)},${driverInfo.Bank_Account_Name || driverName},Salary,${new Date().toISOString().split('T')[0]}`)\r\n        })\r\n    } else {\r\n        // Subcontractor grouping\r\n        const jobsBySub: Record<string, Job[]> = {}\r\n        jobsToExport.forEach(job => {\r\n            const driver = drivers.find(d => d.Driver_Name === job.Driver_Name)\r\n            const subId = driver?.Sub_ID || 'Independent'\r\n            if (!jobsBySub[subId]) jobsBySub[subId] = []\r\n            jobsBySub[subId].push(job)\r\n        })\r\n\r\n        Object.entries(jobsBySub).forEach(([subId, p_jobs]) => {\r\n            const subInfo = subcontractors.find(s => s.Sub_ID === subId)\r\n            if (!subInfo?.Bank_Account_No) {\r\n                missingBankEntities.push(subInfo?.Sub_Name || subId)\r\n                return\r\n            }\r\n            const subtotal = p_jobs.reduce((sum, j) => sum + (j.Cost_Driver_Total || 0), 0)\r\n            const withholding = Math.round(subtotal * WITHHOLDING_TAX_RATE)\r\n            const netTotal = subtotal - withholding\r\n            lines.push(`${subInfo.Bank_Name || 'SCB'},${subInfo.Bank_Account_No},${netTotal.toFixed(2)},${subInfo.Bank_Account_Name || subInfo.Sub_Name},Salary,${new Date().toISOString().split('T')[0]}`)\r\n        })\r\n    }\r\n\r\n    if (missingBankEntities.length > 0) {\r\n        alert(`ไม่สามารถ Export รายการเหล่านี้ได้เนื่องจากไม่มีเลขบัญชี:\\n${missingBankEntities.join(\", \")}\\n\\n(รายการอื่นๆ จะถูก Export ตามปกติ)`)\r\n        if (lines.length === 1) return // header only, nothing to export\r\n    }\r\n\r\n    const csvContent = \"data:text/csv;charset=utf-8,\" + lines.join(\"\\n\")\r\n    const encodedUri = encodeURI(csvContent)\r\n    const link = document.createElement(\"a\")\r\n    link.setAttribute(\"href\", encodedUri)\r\n    link.setAttribute(\"download\", `SCB_Bulk_Export_${new Date().toISOString().split('T')[0]}.csv`)\r\n    document.body.appendChild(link)\r\n    link.click()\r\n    document.body.removeChild(link)\r\n  }\r\n\r\n  const handlePrint = () => {\r\n    window.print()\r\n  }\r\n\r\n  // Preview Component\r\n  const PaymentPreview = () => {\r\n    // Find info\r\n    const entityInfo = paymentModel === 'individual' \r\n        ? drivers.find(d => d.Driver_Name === selectedEntityId)\r\n        : subcontractors.find(s => s.Sub_ID === selectedEntityId)\r\n    \r\n    const entityName = paymentModel === 'individual'\r\n        ? selectedEntityId\r\n        : subcontractors.find(s => s.Sub_ID === selectedEntityId)?.Sub_Name || selectedEntityId\r\n\r\n    const today = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})\r\n\r\n    return (\r\n    <div className=\"p-8 bg-white text-black max-w-[210mm] mx-auto min-h-[297mm] relative\">\r\n        {/* Document Border (Optional, for visual) */}\r\n        <div className=\"absolute inset-0 border border-slate-300 pointer-events-none print:hidden\"></div>\r\n\r\n        {/* Header Section */}\r\n        <div className=\"flex justify-between items-start mb-6\">\r\n            {/* Left: Logo & Company Info */}\r\n            <div className=\"flex flex-col gap-4 max-w-[60%]\">\r\n                {companyProfile?.logo_url && (\r\n                    <div>\r\n                        <img \r\n                            src={companyProfile.logo_url} \r\n                            alt=\"Company Logo\" \r\n                            className=\"h-24 w-auto object-contain\" \r\n                        />\r\n                    </div>\r\n                )}\r\n                <div className=\"text-sm\">\r\n                    {companyProfile ? (\r\n                        <>\r\n                            <h2 className=\"font-bold text-lg\">{companyProfile.company_name}</h2>\r\n                            {companyProfile.company_name_en && (\r\n                                <p className=\"text-slate-600 font-medium\">{companyProfile.company_name_en}</p>\r\n                            )}\r\n                            <p className=\"mt-2 text-slate-700\">{companyProfile.address}</p>\r\n                            <div className=\"flex gap-4 mt-1\">\r\n                                <p><span className=\"font-semibold\">Tax ID:</span> {companyProfile.tax_id}</p>\r\n                            </div>\r\n                        </>\r\n                    ) : (\r\n                        <p className=\"text-slate-400\">Loading company info...</p>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Right: Document Title */}\r\n            <div className=\"text-right\">\r\n                <h1 className=\"text-4xl font-bold text-slate-900 tracking-wide\">ใบสำคัญจ่าย</h1>\r\n                <p className=\"text-slate-500 text-lg font-medium tracking-widest uppercase mt-1\">Payment Voucher</p>\r\n                <div className=\"mt-4\">\r\n                     <span className=\"px-3 py-1 bg-slate-100 rounded text-xs font-mono border border-slate-200\">\r\n                        ORIGINAL (ต้นฉบับ)\r\n                     </span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <hr className=\"border-slate-300 mb-6\" />\r\n\r\n        {/* Info Grid: Payer & Payee */}\r\n        <div className=\"grid grid-cols-2 gap-8 mb-8\">\r\n            {/* Payer Info (Company) */}\r\n            <div className=\"border border-slate-200 rounded p-4 bg-slate-50/50\">\r\n                 <h3 className=\"font-bold text-slate-800 border-b border-slate-200 pb-2 mb-2\">ผู้ทำจ่าย (Payer)</h3>\r\n                 {companyProfile ? (\r\n                    <div className=\"text-sm text-slate-600 mt-2 space-y-1\">\r\n                        <p className=\"font-semibold text-lg text-slate-900\">{companyProfile.company_name}</p>\r\n                        <p>{companyProfile.address}</p>\r\n                        <p><span className=\"font-semibold\">Tax ID:</span> {companyProfile.tax_id}</p>\r\n                    </div>\r\n                 ) : (\r\n                    <p className=\"text-sm text-slate-400\">Loading...</p>\r\n                 )}\r\n            </div>\r\n\r\n            {/* Payee Info (Driver) */}\r\n            <div className=\"border border-slate-200 rounded p-4\">\r\n                <h3 className=\"font-bold text-slate-800 border-b border-slate-200 pb-2 mb-2\">ผู้รับเงิน (Payee)</h3>\r\n                <p className=\"font-semibold text-lg text-slate-900\">{entityName}</p>\r\n                {entityInfo ? (\r\n                     <div className=\"text-sm text-slate-600 mt-2 space-y-1\">\r\n                        {entityInfo.Bank_Name && entityInfo.Bank_Account_No ? (\r\n                            <>\r\n                                <p><span className=\"font-semibold\">Bank:</span> {entityInfo.Bank_Name}</p>\r\n                                <p><span className=\"font-semibold\">Account No:</span> {entityInfo.Bank_Account_No} <span className=\"text-xs text-slate-400\">({entityInfo.Bank_Account_Name})</span></p>\r\n                            </>\r\n                        ) : (\r\n                            <p className=\"text-amber-600 italic\">* ไม่พบข้อมูลบัญชีธนาคาร</p>\r\n                        )}\r\n                     </div>\r\n                ) : (\r\n                    <p className=\"text-sm text-red-400 mt-2 italic\">* ไม่พบข้อมูลผู้รับเงินในระบบ</p>\r\n                )}\r\n            </div>\r\n        </div>\r\n\r\n        {/* Document Details Row */}\r\n        <div className=\"flex justify-between items-center mb-6 text-sm bg-slate-50 p-3 rounded border border-slate-200\">\r\n             <div>\r\n                <span className=\"text-slate-500 mr-2\">เลขที่เอกสาร (No.):</span>\r\n                <span className=\"font-mono font-bold\">- (Draft)</span>\r\n             </div>\r\n             <div>\r\n                <span className=\"text-slate-500 mr-2\">วันที่ (Date):</span>\r\n                <span className=\"font-medium\">{today}</span>\r\n             </div>\r\n             <div>\r\n                <span className=\"text-slate-500 mr-2\">วิธีการชำระ (Payment Method):</span>\r\n                <span className=\"font-medium\">Bank Transfer</span>\r\n             </div>\r\n        </div>\r\n\r\n        {/* Table */}\r\n        <div className=\"mb-8\">\r\n            <table className=\"w-full text-sm border-collapse\">\r\n                <thead>\r\n                    <tr className=\"bg-slate-100 text-slate-700 border-y-2 border-slate-300\">\r\n                        <th className=\"py-3 px-4 text-center font-bold w-16\">ลำดับ<br/><span className=\"text-xs font-normal\">No.</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">รายละเอียด<br/><span className=\"text-xs font-normal\">Description</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">วันที่<br/><span className=\"text-xs font-normal\">Date</span></th>\r\n                        <th className=\"py-3 px-4 text-left font-bold\">เส้นทาง<br/><span className=\"text-xs font-normal\">Route</span></th>\r\n                        <th className=\"py-3 px-4 text-right font-bold w-32\">จำนวนเงิน<br/><span className=\"text-xs font-normal\">Amount</span></th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    {selectedData.map((item, index) => (\r\n                        <tr key={item.Job_ID} className=\"border-b border-slate-200\">\r\n                            <td className=\"py-3 px-4 text-center text-slate-500\">{index + 1}</td>\r\n                            <td className=\"py-3 px-4 font-medium text-slate-800\">\r\n                                ค่าเที่ยววิ่ง (Job: {item.Job_ID})\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-slate-600\">\r\n                                {item.Plan_Date ? new Date(item.Plan_Date).toLocaleDateString('th-TH') : '-'}\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-slate-600 text-xs\">\r\n                                {item.Route_Name || '-'}\r\n                            </td>\r\n                            <td className=\"py-3 px-4 text-right font-medium text-slate-800\">\r\n                                {item.Cost_Driver_Total?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                            </td>\r\n                        </tr>\r\n                    ))}\r\n                    {Array.from({ length: Math.max(0, 5 - selectedData.length) }).map((_, i) => (\r\n                         <tr key={`empty-${i}`} className=\"border-b border-slate-100 h-10\">\r\n                            <td colSpan={5}></td>\r\n                         </tr>\r\n                    ))}\r\n                </tbody>\r\n                <tfoot>\r\n                     <tr>\r\n                        <td colSpan={3} rowSpan={3} className=\"pt-4 pr-8 align-top\">\r\n                            <div className=\"border border-slate-300 bg-slate-50 p-3 rounded text-xs text-slate-500\">\r\n                                <p className=\"font-bold mb-1\">หมายเหตุ (Remarks):</p>\r\n                                <p>- ยอดเงินนี้รวมค่าแรงและค่าพาหนะแล้ว</p>\r\n                            </div>\r\n                        </td>\r\n                        <td className=\"py-2 px-4 text-right font-bold text-slate-600\">รวมเป็นเงิน</td>\r\n                        <td className=\"py-2 px-4 text-right font-bold text-slate-800\">{selectedSubtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                    </tr>\r\n                    <tr>\r\n                        <td className=\"py-2 px-4 text-right text-slate-600 text-sm\">หัก ณ ที่จ่าย 1%</td>\r\n                        <td className=\"py-2 px-4 text-right text-red-500 font-medium\">-{selectedWithholding.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                    </tr>\r\n                    <tr className=\"bg-slate-50 border-t-2 border-slate-300 border-b-2\">\r\n                        <td className=\"py-3 px-4 text-right font-bold text-slate-900 text-lg\">ยอดสุทธิ</td>\r\n                        <td className=\"py-3 px-4 text-right font-bold text-indigo-700 text-lg decoration-double underline\">\r\n                            {selectedNetTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                        </td>\r\n                    </tr>\r\n                </tfoot>\r\n            </table>\r\n        </div>\r\n\r\n         {/* Footer Signatures */}\r\n        <div className=\"flex justify-between mt-16 text-sm text-slate-600 pb-8\">\r\n             <div className=\"text-center w-1/3\">\r\n                <div className=\"border-b border-slate-400 mb-2 h-8 w-3/4 mx-auto\"></div>\r\n                <p className=\"font-bold\">ผู้รับเงิน</p>\r\n                <p className=\"text-xs\">(Payee)</p>\r\n                <div className=\"mt-4 text-xs\">วันที่ (Date): _____/_____/_______</div>\r\n            </div>\r\n            <div className=\"text-center w-1/3\">\r\n                <div className=\"border-b border-slate-400 mb-2 h-8 w-3/4 mx-auto\"></div>\r\n                <p className=\"font-bold\">ผู้จ่ายเงิน / ผู้มีอำนาจลงนาม</p>\r\n                <p className=\"text-xs\">(Payer / Authorized Signature)</p>\r\n                <div className=\"mt-4 text-xs\">วันที่ (Date): _____/_____/_______</div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <>\r\n    <div className=\"print:hidden\">\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n            <Wallet className=\"text-indigo-400\" />\r\n            สรุปจ่ายรถ\r\n          </h1>\r\n          <p className=\"text-sm text-slate-400 mt-1\">สร้างเอกสารสรุปการทำจ่ายให้คนขับ (หัก ณ ที่จ่าย 1%)</p>\r\n        </div>\r\n        <Button \r\n            variant=\"outline\" \r\n            className=\"border-slate-700 text-slate-300 gap-2\"\r\n            onClick={() => router.push('/billing/driver/history')}\r\n        >\r\n            <History className=\"w-4 h-4\" /> ประวัติการจ่าย\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800 mb-6\">\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 items-end\">\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm\">รูปแบบการจ่าย</Label>\r\n              <select\r\n                value={paymentModel}\r\n                onChange={(e) => {\r\n                    setPaymentModel(e.target.value as 'individual' | 'subcontractor')\r\n                    setSelectedEntityId(\"\")\r\n                }}\r\n                className=\"w-full h-10 px-3 rounded-md bg-slate-800 border border-slate-700 text-white\"\r\n              >\r\n                <option value=\"individual\">คนขับรายบุคคล (Individual)</option>\r\n                <option value=\"subcontractor\">บริษัทรถร่วม (Subcontractor)</option>\r\n              </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm\">{paymentModel === 'individual' ? 'เลือกคนขับ' : 'เลือกบริษัทรถร่วม'}</Label>\r\n              <select\r\n                value={selectedEntityId || \"\"}\r\n                onChange={(e) => setSelectedEntityId(e.target.value)}\r\n                className=\"w-full h-10 px-3 rounded-md bg-slate-800 border border-slate-700 text-white\"\r\n              >\r\n                <option value=\"\">ทั้งหมด</option>\r\n                {paymentModel === 'individual' ? (\r\n                    drivers.map(d => (\r\n                        <option key={d.Driver_Name || \"\"} value={d.Driver_Name || \"\"}>{d.Driver_Name}</option>\r\n                    ))\r\n                ) : (\r\n                    subcontractors.map(s => (\r\n                        <option key={s.Sub_ID} value={s.Sub_ID}>{s.Sub_Name}</option>\r\n                    ))\r\n                )}\r\n              </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm flex items-center gap-1\">\r\n                <Calendar className=\"w-3 h-3\" /> วันที่เริ่มต้น\r\n              </Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateFrom}\r\n                onChange={(e) => setDateFrom(e.target.value)}\r\n                className=\"bg-slate-800 border-slate-700 text-white\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"text-slate-400 text-sm\">วันที่สิ้นสุด</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateTo}\r\n                onChange={(e) => setDateTo(e.target.value)}\r\n                className=\"bg-slate-800 border-slate-700 text-white\"\r\n              />\r\n            </div>\r\n            <div className=\"flex items-end\">\r\n              <Button variant=\"outline\" className=\"border-slate-700 w-full text-slate-300\">\r\n                <Search className=\"w-4 h-4 mr-2\" /> ค้นหา\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Summary Stats */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6\">\r\n        <Card className=\"bg-amber-500/10 border-amber-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center\">\r\n              <Clock className=\"w-6 h-6 text-amber-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-amber-400\">{pendingItems.length}</p>\r\n              <p className=\"text-xs text-slate-400\">รอจ่าย</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-indigo-500/10 border-indigo-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-indigo-500/20 flex items-center justify-center\">\r\n              <Banknote className=\"w-6 h-6 text-indigo-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-indigo-400\">฿{pendingTotal.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">ยอดรอจ่าย</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-emerald-500/10 border-emerald-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center\">\r\n              <CheckCircle2 className=\"w-6 h-6 text-emerald-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-emerald-400\">฿{selectedSubtotal.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">ยอดที่เลือก ({selectedItems.length} รายการ)</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-purple-500/10 border-purple-500/20\">\r\n          <CardContent className=\"p-4 flex items-center gap-4\">\r\n            <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center\">\r\n              <Percent className=\"w-6 h-6 text-purple-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-2xl font-bold text-purple-400\">฿{selectedWithholding.toLocaleString()}</p>\r\n              <p className=\"text-xs text-slate-400\">หัก ณ ที่จ่าย 1%</p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Selected Summary Box */}\r\n      {selectedItems.length > 0 && (\r\n        <Card className=\"bg-gradient-to-r from-indigo-500/10 to-purple-500/10 border-indigo-500/30 mb-6\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-4\">\r\n              <div className=\"flex items-center gap-6\">\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">ยอดรวม</p>\r\n                  <p className=\"text-white font-bold text-lg\">฿{selectedSubtotal.toLocaleString()}</p>\r\n                </div>\r\n                <div className=\"text-slate-500\">-</div>\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">หัก ณ ที่จ่าย 1%</p>\r\n                  <p className=\"text-red-400 font-bold text-lg\">฿{selectedWithholding.toLocaleString()}</p>\r\n                </div>\r\n                <div className=\"text-slate-500\">=</div>\r\n                <div>\r\n                  <p className=\"text-slate-400 text-xs\">ยอดจ่ายสุทธิ</p>\r\n                  <p className=\"text-indigo-400 font-bold text-xl\">฿{selectedNetTotal.toLocaleString()}</p>\r\n                </div>\r\n              </div>\r\n              <Button onClick={clearSelection} variant=\"ghost\" className=\"text-slate-400 hover:text-white\">\r\n                ล้างการเลือก\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Table */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800\">\r\n        <CardHeader className=\"flex flex-row items-center justify-between pb-4\">\r\n          <CardTitle className=\"text-white\">รายการงาน</CardTitle>\r\n          <div className=\"flex gap-2\">\r\n            <Button variant=\"outline\" size=\"sm\" onClick={selectAll} className=\"border-slate-700 text-slate-300\">\r\n              เลือกทั้งหมด\r\n            </Button>\r\n            <Dialog open={showPreview} onOpenChange={setShowPreview}>\r\n                <DialogTrigger asChild>\r\n                    <Button \r\n                        size=\"sm\" \r\n                        variant=\"outline\" \r\n                        className=\"border-slate-700 text-slate-300\"\r\n                        disabled={selectedItems.length === 0}\r\n                    >\r\n                        <Eye className=\"w-4 h-4 mr-2\" /> ดูตัวอย่าง\r\n                    </Button>\r\n                </DialogTrigger>\r\n                <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto bg-white p-0\">\r\n                    <DialogHeader className=\"p-4 border-b\">\r\n                        <DialogTitle className=\"text-slate-900\">ตัวอย่างใบสำคัญจ่าย</DialogTitle>\r\n                    </DialogHeader>\r\n                    <div className=\"p-6\">\r\n                        <PaymentPreview />\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            <Button \r\n                size=\"sm\" \r\n                className=\"bg-indigo-600 hover:bg-indigo-700\" \r\n                disabled={selectedItems.length === 0 || loading}\r\n                onClick={handleCreatePayment}\r\n            >\r\n              {loading ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <FileText className=\"w-4 h-4 mr-2\" />}\r\n              สร้างใบสรุปจ่าย\r\n            </Button>\r\n            <Button \r\n                size=\"sm\" \r\n                variant=\"outline\" \r\n                className=\"border-slate-700 text-slate-300\" \r\n                disabled={selectedItems.length === 0 || loading}\r\n                onClick={handleExportSCB}\r\n            >\r\n              <FileDown className=\"w-4 h-4 mr-2\" /> Export SCB\r\n            </Button>\r\n            <Button \r\n                size=\"sm\" \r\n                variant=\"outline\" \r\n                className=\"border-slate-700 text-slate-300\" \r\n                disabled={selectedItems.length === 0}\r\n                onClick={handlePrint}\r\n            >\r\n              <Printer className=\"w-4 h-4 mr-2\" /> พิมพ์\r\n            </Button>\r\n            <Button size=\"sm\" variant=\"outline\" className=\"border-slate-700 text-slate-300\" disabled={selectedItems.length === 0}>\r\n              <Download className=\"w-4 h-4 mr-2\" /> Export\r\n            </Button>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b border-slate-800\">\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">\r\n                    <input \r\n                      type=\"checkbox\" \r\n                      className=\"rounded bg-slate-800 border-slate-700\"\r\n                      checked={selectedItems.length === pendingItems.length && pendingItems.length > 0}\r\n                      onChange={selectAll}\r\n                    />\r\n                  </th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">Job ID</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">คนขับ</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">ทะเบียนรถ</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">วันที่</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">เส้นทาง</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">ค่าขนส่ง</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">รวม</th>\r\n                  <th className=\"text-center py-3 px-4 text-slate-400 font-medium text-sm\">สถานะ</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {filteredData.map((item) => (\r\n                  <tr key={item.Job_ID} className=\"border-b border-slate-800/50 hover:bg-slate-800/30\">\r\n                    <td className=\"py-3 px-4\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        className=\"rounded bg-slate-800 border-slate-700\"\r\n                        checked={selectedItems.includes(item.Job_ID)}\r\n                        onChange={() => toggleItem(item.Job_ID)}\r\n                      />\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-white font-medium\">{item.Job_ID}</td>\r\n                    <td className=\"py-3 px-4 text-slate-300\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <User className=\"w-4 h-4 text-slate-500\" />\r\n                        {item.Driver_Name || '-'}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-slate-300\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Truck className=\"w-4 h-4 text-slate-500\" />\r\n                        {item.Vehicle_Plate || '-'}\r\n                      </div>\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-slate-400\">{item.Plan_Date ? new Date(item.Plan_Date).toLocaleDateString('th-TH') : '-'}</td>\r\n                    <td className=\"py-3 px-4 text-slate-300\">{item.Route_Name || '-'}</td>\r\n                    <td className=\"py-3 px-4 text-right text-indigo-400\">\r\n                      ฿{(item.Cost_Driver_Total || 0).toLocaleString()}\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-right text-white font-medium\">\r\n                      ฿{(item.Cost_Driver_Total || 0).toLocaleString()}\r\n                    </td>\r\n                    <td className=\"py-3 px-4 text-center\">\r\n                      <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400\">\r\n                        รอจ่าย\r\n                      </span>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n    </div>\r\n\r\n    {/* Hidden Print Area */}\r\n    <div className=\"hidden print:block fixed inset-0 bg-white z-[9999] p-8\">\r\n        <PaymentPreview />\r\n    </div>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\driver\\history\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":64,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":82,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":100,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":100,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Wallet,\r\n  ArrowLeft,\r\n  Printer,\r\n  Search,\r\n  Calendar,\r\n  FileDown,\r\n  CheckCircle2,\r\n  Undo2,\r\n  Loader2,\r\n  CloudSync\r\n} from \"lucide-react\"\r\nimport { getDriverPayments, DriverPayment, updateDriverPaymentStatus, recallDriverPayment, getDriverPaymentByIdWithJobs } from \"@/lib/supabase/billing\"\r\nimport { isSuperAdmin } from \"@/lib/permissions\"\r\nimport { toast } from \"sonner\"\r\nimport { manualSyncBill } from \"@/app/settings/accounting/actions\"\r\n\r\nexport default function DriverPaymentHistory() {\r\n  const router = useRouter()\r\n  const [payments, setPayments] = useState<DriverPayment[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [isAdmin, setIsAdmin] = useState(false)\r\n  const [processingId, setProcessingId] = useState<string | null>(null)\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n    checkAdmin()\r\n  }, [])\r\n\r\n  const checkAdmin = async () => {\r\n    const adminStatus = await isSuperAdmin()\r\n    setIsAdmin(adminStatus)\r\n  }\r\n\r\n  const loadData = async () => {\r\n    try {\r\n        const data = await getDriverPayments()\r\n        setPayments(data)\r\n    } catch (error) {\r\n        console.error(\"Failed to load driver payments history\", error)\r\n        toast.error(\"โหลดข้อมูลไม่สำเร็จ\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSyncToAccounting = async (id: string) => {\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await manualSyncBill(id)\r\n        if (res.success) {\r\n            toast.success(\"ส่งข้อมูลไประบบบัญชีสำเร็จ\")\r\n        } else {\r\n            toast.error(res.message || \"เกิดข้อผิดพลาดในการเชื่อมต่อ\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const handleMarkAsPaid = async (id: string) => {\r\n    if (!confirm(\"ยืนยันการเปลี่ยนสถานะเป็น 'จ่ายเงินรวมแล้ว'?\")) return\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await updateDriverPaymentStatus(id, \"Paid\")\r\n        if (res.success) {\r\n            toast.success(\"อัปเดตสถานะเรียบร้อย\")\r\n            loadData()\r\n        } else {\r\n            toast.error(res.error || \"เกิดข้อผิดพลาด\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const handleRecall = async (id: string) => {\r\n    if (!confirm(\"⚠️ คำเตือน: คุณกำลังจะดึงรายการจ่ายเงินนี้กลับไปแก้ไข\\\\n\\\\nเอกสารสรุปนี้จะถูกลบ และรายการงานจะกลับไปสถานะ 'รอจ่ายเงิน'\\\\nยืนยันการดำเนินการ?\")) return\r\n    setProcessingId(id)\r\n    try {\r\n        const res = await recallDriverPayment(id)\r\n        if (res.success) {\r\n            toast.success(\"ดึงรายการกลับสำเร็จ\")\r\n            loadData()\r\n        } else {\r\n            toast.error(res.error || \"เกิดข้อผิดพลาด\")\r\n        }\r\n    } catch (e) {\r\n        toast.error(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const handlePrint = (id: string) => {\r\n    window.open(`/billing/driver/print/${id}`, '_blank')\r\n  }\r\n\r\n  const handleExportSCB = async (id: string) => {\r\n    setProcessingId(id)\r\n    try {\r\n        const data = await getDriverPaymentByIdWithJobs(id)\r\n        if (!data) throw new Error(\"Could not fetch details\")\r\n\r\n        const { payment, jobs, bankInfo } = data\r\n        const WITHHOLDING_TAX_RATE = 0.01\r\n\r\n        if (!bankInfo.Bank_Account_No) {\r\n            toast.error(\"ไม่สามารถ Export ได้เนื่องจากคนขับไม่มีเลขบัญชี\")\r\n            return\r\n        }\r\n\r\n        const subtotal = jobs.reduce((sum, j) => sum + (j.Cost_Driver_Total || 0), 0)\r\n        const withholding = Math.round(subtotal * WITHHOLDING_TAX_RATE)\r\n        const netTotal = subtotal - withholding\r\n\r\n        // Format for SCB Mass Payout (Simple CSV)\r\n        const lines = [\r\n            \"Bank Code,Account No,Amount,Beneficiary Name,Ref1,Ref2\",\r\n            `${bankInfo.Bank_Name || 'SCB'},${bankInfo.Bank_Account_No},${netTotal.toFixed(2)},${bankInfo.Bank_Account_Name || payment.Driver_Name},Salary,${payment.Driver_Payment_ID}`\r\n        ]\r\n\r\n        const csvContent = \"data:text/csv;charset=utf-8,\\uFEFF\" + lines.join(\"\\n\") // Add BOM for Excel Thai support\r\n        const encodedUri = encodeURI(csvContent)\r\n        const link = document.createElement(\"a\")\r\n        link.setAttribute(\"href\", encodedUri)\r\n        link.setAttribute(\"download\", `SCB_Export_${payment.Driver_Payment_ID}.csv`)\r\n        document.body.appendChild(link)\r\n        link.click()\r\n        document.body.removeChild(link)\r\n\r\n        toast.success(\"เตรียมไฟล์ Export เรียบร้อย\")\r\n    } catch (e) {\r\n        console.error(e)\r\n        toast.error(\"Export ไม่สำเร็จ\")\r\n    } finally {\r\n        setProcessingId(null)\r\n    }\r\n  }\r\n\r\n  const filteredPayments = payments.filter(p => \r\n    p.Driver_Payment_ID.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    p.Driver_Name.toLowerCase().includes(searchTerm.toLowerCase())\r\n  )\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch(status) {\r\n        case 'Paid':\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20\">จ่ายเงินแล้ว</span>\r\n        case 'Pending':\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20\">รอดำเนินการ</span>\r\n        default:\r\n            return <span className=\"px-2 py-1 rounded-full text-xs font-medium bg-blue-500/10 text-blue-400 border border-blue-500/20\">{status}</span>\r\n    }\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n            <Wallet className=\"text-indigo-400\" />\r\n            ประวัติการจ่ายเงินคนขับ\r\n          </h1>\r\n          <p className=\"text-sm text-slate-400 mt-1\">รายการใบสรุปจ่ายที่สร้างแล้วทั้งหมด</p>\r\n        </div>\r\n        <Button \r\n            variant=\"outline\" \r\n            className=\"border-slate-700 text-slate-300\"\r\n            onClick={() => router.back()}\r\n        >\r\n            <ArrowLeft className=\"w-4 h-4 mr-2\" /> ย้อนกลับ\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800 mb-6\">\r\n        <CardContent className=\"p-4\">\r\n            <div className=\"flex gap-4\">\r\n                <div className=\"relative flex-1\">\r\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500\" />\r\n                    <input \r\n                        type=\"text\" \r\n                        placeholder=\"ค้นหาเลขที่เอกสาร หรือ ชื่อคนขับ...\" \r\n                        className=\"w-full h-10 pl-10 pr-4 rounded-md bg-slate-800 border border-slate-700 text-white focus:outline-none focus:border-indigo-500\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n            </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Table */}\r\n      <Card className=\"bg-slate-900/50 border-slate-800\">\r\n        <CardHeader>\r\n            <CardTitle className=\"text-white text-lg\">รายการใบสรุปจ่าย ({filteredPayments.length})</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b border-slate-800\">\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">เลขที่เอกสาร</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">วันที่ทำรายการ</th>\r\n                  <th className=\"text-left py-3 px-4 text-slate-400 font-medium text-sm\">คนขับ</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">ยอดเงิน</th>\r\n                  <th className=\"text-center py-3 px-4 text-slate-400 font-medium text-sm\">สถานะ</th>\r\n                  <th className=\"text-right py-3 px-4 text-slate-400 font-medium text-sm\">จัดการ</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {loading ? (\r\n                    <tr>\r\n                        <td colSpan={6} className=\"text-center py-8 text-slate-500\">กำลังโหลด...</td>\r\n                    </tr>\r\n                ) : filteredPayments.length === 0 ? (\r\n                    <tr>\r\n                        <td colSpan={6} className=\"text-center py-8 text-slate-500\">ไม่พบข้อมูล</td>\r\n                    </tr>\r\n                ) : (\r\n                    filteredPayments.map((item) => (\r\n                    <tr key={item.Driver_Payment_ID} className=\"border-b border-slate-800/50 hover:bg-slate-800/30\">\r\n                        <td className=\"py-3 px-4 text-indigo-400 font-mono\">{item.Driver_Payment_ID}</td>\r\n                        <td className=\"py-3 px-4 text-slate-400 flex items-center gap-2\">\r\n                             <Calendar className=\"w-3 h-3\" />\r\n                             {new Date(item.Created_At).toLocaleDateString('th-TH')}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-white font-medium\">{item.Driver_Name}</td>\r\n                        <td className=\"py-3 px-4 text-right text-white\">\r\n                            ฿{item.Total_Amount.toLocaleString()}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-center\">\r\n                            {getStatusBadge(item.Status)}\r\n                        </td>\r\n                        <td className=\"py-3 px-4 text-right\">\r\n                             <div className=\"flex justify-end gap-1\">\r\n                                {item.Status !== 'Paid' && (\r\n                                    <Button \r\n                                        size=\"sm\" \r\n                                        variant=\"ghost\" \r\n                                        className=\"text-emerald-400 hover:text-emerald-300 hover:bg-emerald-500/10\"\r\n                                        onClick={() => handleMarkAsPaid(item.Driver_Payment_ID)}\r\n                                        disabled={processingId === item.Driver_Payment_ID}\r\n                                        title=\"ชำระเงินแล้ว\"\r\n                                    >\r\n                                        <CheckCircle2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                )}\r\n\r\n                                <Button \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\" \r\n                                    className=\"text-indigo-400 hover:text-indigo-300\"\r\n                                    onClick={() => handleSyncToAccounting(item.Driver_Payment_ID)}\r\n                                    disabled={processingId === item.Driver_Payment_ID}\r\n                                    title=\"ส่งไประบบบัญชี\"\r\n                                >\r\n                                    <CloudSync className=\"w-4 h-4\" />\r\n                                </Button>\r\n \r\n                                <Button \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\" \r\n                                    className=\"text-slate-400 hover:text-white\" \r\n                                    title=\"Export SCB\"\r\n                                    onClick={() => handleExportSCB(item.Driver_Payment_ID)}\r\n                                    disabled={processingId === item.Driver_Payment_ID}\r\n                                >\r\n                                    {processingId === item.Driver_Payment_ID ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <FileDown className=\"w-4 h-4\" />}\r\n                                </Button>\r\n                                <Button \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\" \r\n                                    className=\"text-slate-400 hover:text-white\" \r\n                                    title=\"พิมพ์\"\r\n                                    onClick={() => handlePrint(item.Driver_Payment_ID)}\r\n                                >\r\n                                    <Printer className=\"w-4 h-4\" />\r\n                                </Button>\r\n\r\n                                {isAdmin && (\r\n                                    <Button \r\n                                        size=\"sm\" \r\n                                        variant=\"ghost\" \r\n                                        className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10\"\r\n                                        onClick={() => handleRecall(item.Driver_Payment_ID)}\r\n                                        disabled={processingId === item.Driver_Payment_ID}\r\n                                        title=\"ดึงรายการกลับ (Recall)\"\r\n                                    >\r\n                                        <Undo2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        </td>\r\n                    </tr>\r\n                    ))\r\n                )}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\driver\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\driver\\print\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1299,1302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1299,1302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1376,1379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1376,1379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":65,"column":33,"nodeType":"JSXOpeningElement","endLine":69,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8514,8517],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8514,8517],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { getDriverPaymentByIdWithJobs } from \"@/lib/supabase/billing\"\r\nimport { notFound } from \"next/navigation\"\r\nimport { AutoPrint } from \"@/components/utils/auto-print\"\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\ntype Props = {\r\n    params: Promise<{ id: string }>\r\n}\r\n\r\nexport default async function DriverPaymentPrintPage(props: Props) {\r\n    const params = await props.params;\r\n    const { id } = params\r\n    const data = await getDriverPaymentByIdWithJobs(id)\r\n\r\n    if (!data) {\r\n        return notFound()\r\n    }\r\n\r\n    const { payment, jobs, company, bankInfo } = data\r\n    const WITHHOLDING_TAX_RATE = 0.01\r\n\r\n    // Calculate totals to ensure consistency\r\n    const subtotal = jobs.reduce((sum, job) => {\r\n        const base = job.Cost_Driver_Total || 0\r\n        let extra = 0\r\n        try {\r\n            if (job.extra_costs_json) {\r\n                let costs = job.extra_costs_json\r\n                if (typeof costs === 'string') {\r\n                    try { costs = JSON.parse(costs) } catch {}\r\n                }\r\n                if (typeof costs === 'string') {\r\n                    try { costs = JSON.parse(costs) } catch {}\r\n                }\r\n                \r\n                if (Array.isArray(costs)) {\r\n                    extra = costs\r\n                        .filter((c: any) => c.cost_driver > 0)\r\n                        .reduce((acc: number, c: any) => acc + (Number(c.cost_driver) || 0), 0)\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error calculating extra costs\", e)\r\n        }\r\n        return sum + base + extra\r\n    }, 0)\r\n\r\n    const withholding = Math.round(subtotal * WITHHOLDING_TAX_RATE)\r\n    const netTotal = subtotal - withholding\r\n\r\n    return (\r\n        <div className=\"bg-white min-h-screen p-4 text-black print:p-0\">\r\n            <AutoPrint />\r\n            \r\n            <div id=\"printable-content\" className=\"max-w-[210mm] mx-auto bg-white p-6 print:w-full print:max-w-none print:px-10 print:py-4 relative\">\r\n                \r\n                {/* Header Section */}\r\n                <div className=\"flex justify-between items-start mb-4\">\r\n                    {/* Left: Logo & Company Info */}\r\n                    <div className=\"flex flex-col gap-2 max-w-[60%]\">\r\n                        {company?.logo_url && (\r\n                            <div>\r\n                                <img \r\n                                    src={company.logo_url} \r\n                                    alt=\"Company Logo\" \r\n                                    className=\"h-16 w-auto object-contain\" \r\n                                />\r\n                            </div>\r\n                        )}\r\n                        <div className=\"text-xs\">\r\n                            {company ? (\r\n                                <>\r\n                                    <h2 className=\"font-bold text-base\">{company.company_name}</h2>\r\n                                    {company.company_name_en && (\r\n                                        <p className=\"text-slate-600 font-medium\">{company.company_name_en}</p>\r\n                                    )}\r\n                                    <p className=\"mt-1 text-slate-700 leading-tight\">{company.address}</p>\r\n                                    <div className=\"flex gap-4 mt-1\">\r\n                                        <p><span className=\"font-semibold\">Tax ID:</span> {company.tax_id}</p>\r\n                                    </div>\r\n                                </>\r\n                            ) : (\r\n                                <p className=\"text-slate-400\">Loading company info...</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Right: Document Title */}\r\n                    <div className=\"text-right\">\r\n                        <h1 className=\"text-3xl font-bold text-slate-900 tracking-wide\">ใบสำคัญจ่าย</h1>\r\n                        <p className=\"text-slate-500 text-base font-medium tracking-widest uppercase\">Payment Voucher</p>\r\n                        <div className=\"mt-2\">\r\n                             <span className=\"px-2 py-0.5 bg-slate-100 rounded text-[10px] font-mono border border-slate-200\">\r\n                                ORIGINAL (ต้นฉบับ)\r\n                             </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <hr className=\"border-slate-300 mb-4\" />\r\n\r\n                {/* Info Grid: Payer & Payee */}\r\n                <div className=\"grid grid-cols-2 gap-4 mb-4\">\r\n                    {/* Payer Info (Company) */}\r\n                    <div className=\"border border-slate-200 rounded p-3 bg-slate-50/50\">\r\n                         <h3 className=\"font-bold text-xs text-slate-800 border-b border-slate-200 pb-1 mb-1\">ผู้ทำจ่าย (Payer)</h3>\r\n                         {company ? (\r\n                            <div className=\"text-[11px] text-slate-600 space-y-0.5\">\r\n                                <p className=\"font-semibold text-sm text-slate-900\">{company.company_name}</p>\r\n                                <p className=\"leading-tight\">{company.address}</p>\r\n                                <p><span className=\"font-semibold\">Tax ID:</span> {company.tax_id} {company.phone && <span>โทร: {company.phone}</span>}</p>\r\n                            </div>\r\n                         ) : (\r\n                            <p className=\"text-xs text-slate-400\">Loading...</p>\r\n                         )}\r\n                    </div>\r\n\r\n                    {/* Payee Info (Driver) */}\r\n                    <div className=\"border border-slate-200 rounded p-3\">\r\n                        <h3 className=\"font-bold text-xs text-slate-800 border-b border-slate-200 pb-1 mb-1\">ผู้รับเงิน (Payee)</h3>\r\n                        <p className=\"font-semibold text-sm text-slate-900\">{payment.Driver_Name}</p>\r\n                        <div className=\"text-[11px] text-slate-600 space-y-0.5\">\r\n                            {bankInfo.Bank_Account_No ? (\r\n                                <>\r\n                                    <p><span className=\"font-semibold\">Bank:</span> {bankInfo.Bank_Name}</p>\r\n                                    <p><span className=\"font-semibold\">Account No:</span> {bankInfo.Bank_Account_No} <span className=\"text-[10px] text-slate-400\">({bankInfo.Bank_Account_Name})</span></p>\r\n                                </>\r\n                            ) : (\r\n                                <p className=\"text-amber-600 italic\">* ไม่พบข้อมูลบัญชีธนาคาร</p>\r\n                            )}\r\n                         </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Document Details Row */}\r\n                <div className=\"flex justify-between items-center mb-4 text-[11px] bg-slate-50 p-2 rounded border border-slate-200\">\r\n                     <div>\r\n                        <span className=\"text-slate-500 mr-2\">เลขที่เอกสาร (No.):</span>\r\n                        <span className=\"font-mono font-bold text-sm tracking-tight\">{payment.Driver_Payment_ID}</span>\r\n                     </div>\r\n                     <div>\r\n                        <span className=\"text-slate-500 mr-2\">วันที่ (Date):</span>\r\n                        <span className=\"font-medium\">{new Date(payment.Payment_Date).toLocaleDateString('th-TH')}</span>\r\n                     </div>\r\n                     <div>\r\n                        <span className=\"text-slate-500 mr-2\">วิธีการชำระ (Payment Method):</span>\r\n                        <span className=\"font-medium\">Bank Transfer</span>\r\n                     </div>\r\n                </div>\r\n\r\n                {/* Table */}\r\n                <div className=\"mb-4\">\r\n                    <table className=\"w-full text-[12px] border-collapse\">\r\n                        <thead>\r\n                            <tr className=\"bg-slate-100 text-slate-700 border-y-2 border-slate-300\">\r\n                                <th className=\"py-2 px-3 text-center font-bold w-12\">No.</th>\r\n                                <th className=\"py-2 px-3 text-left font-bold\">รายการ (Description)</th>\r\n                                <th className=\"py-2 px-3 text-center font-bold w-24\">วันที่ (Date)</th>\r\n                                <th className=\"py-2 px-3 text-right font-bold w-32\">จำนวนเงิน (Amount)</th>\r\n                            </tr>\r\n                        </thead>\r\n                        {jobs.map((item, index) => {\r\n                                let extraCosts: any[] = []\r\n                                try {\r\n                                    if (item.extra_costs_json) {\r\n                                        let parsed = item.extra_costs_json\r\n                                        if (typeof parsed === 'string') {\r\n                                            try { parsed = JSON.parse(parsed) } catch {}\r\n                                        }\r\n                                        if (typeof parsed === 'string') {\r\n                                            try { parsed = JSON.parse(parsed) } catch {}\r\n                                        }\r\n                                        if (Array.isArray(parsed)) {\r\n                                            extraCosts = parsed.filter(c => c.cost_driver > 0)\r\n                                        }\r\n                                    }\r\n                                } catch {}\r\n\r\n                                return (\r\n                                    <tbody key={item.Job_ID} className=\"border-b border-slate-200\">\r\n                                        <tr>\r\n                                            <td className=\"py-2 px-3 text-center text-slate-500 align-top\">{index + 1}</td>\r\n                                            <td className=\"py-2 px-3\">\r\n                                                <div className=\"font-bold text-slate-800\">ค่าเที่ยววิ่ง (Job: {item.Job_ID})</div>\r\n                                                <div className=\"text-[10px] text-slate-500\">{item.Route_Name}</div>\r\n                                            </td>\r\n                                            <td className=\"py-2 px-3 text-center text-slate-600 align-top\">\r\n                                                {item.Plan_Date ? new Date(item.Plan_Date).toLocaleDateString('th-TH') : '-'}\r\n                                            </td>\r\n                                            <td className=\"py-2 px-3 text-right font-bold text-slate-800 align-top\">\r\n                                                {item.Cost_Driver_Total?.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n                                            </td>\r\n                                        </tr>\r\n                                        {extraCosts.map((extra, i) => (\r\n                                            <tr key={`${item.Job_ID}-extra-${i}`} className=\"text-slate-600 bg-slate-50/30\">\r\n                                                <td></td>\r\n                                                <td className=\"py-1 px-3\">\r\n                                                    <div className=\"text-[11px] border-l-2 border-slate-300 pl-2\">\r\n                                                        {extra.type}\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td className=\"py-1 px-3 text-center\">-</td>\r\n                                                <td className=\"py-1 px-3 text-right\">\r\n                                                    {Number(extra.cost_driver).toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                )\r\n                            })}\r\n                            <tbody className=\"border-t border-slate-300\">\r\n                                {Array.from({ length: Math.max(0, 1 - jobs.length) }).map((_, i) => (\r\n                                    <tr key={`empty-${i}`} className=\"border-b border-slate-100 h-8\">\r\n                                        <td colSpan={4}></td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        <tfoot>\r\n                             <tr>\r\n                                <td colSpan={2} rowSpan={3} className=\"pt-2 pr-4 align-top\">\r\n                                    <div className=\"border border-slate-300 bg-slate-50 p-2 rounded text-[10px] text-slate-500\">\r\n                                        <p className=\"font-bold mb-0.5\">หมายเหตุ (Remarks):</p>\r\n                                        <p>- ยอดเงินนี้รวมค่าแรงและค่าพาหนะแล้ว</p>\r\n                                        <p>- Auto-generated Payment Voucher</p>\r\n                                    </div>\r\n                                </td>\r\n                                <td className=\"py-1 px-3 text-right font-bold text-slate-600\">รวมเป็นเงิน</td>\r\n                                <td className=\"py-1 px-3 text-right font-bold text-slate-800\">{subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                            </tr>\r\n                            <tr>\r\n                                <td className=\"py-1 px-3 text-right text-slate-600 text-[11px]\">หัก ณ ที่จ่าย 1%</td>\r\n                                <td className=\"py-1 px-3 text-right text-red-500 font-medium\">-{withholding.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                            </tr>\r\n                            <tr className=\"bg-slate-50 border-t-2 border-slate-300 border-b-2\">\r\n                                <td className=\"py-2 px-3 text-right font-bold text-slate-900 text-base\">ยอดสุทธิ</td>\r\n                                <td className=\"py-2 px-3 text-right font-bold text-indigo-700 text-base decoration-double underline\">\r\n                                    {netTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                                </td>\r\n                            </tr>\r\n                        </tfoot>\r\n                    </table>\r\n                </div>\r\n\r\n                 {/* Footer Signatures */}\r\n                <div className=\"flex justify-between mt-8 text-[11px] text-slate-600 pb-4 break-inside-avoid\">\r\n                     <div className=\"text-center w-[45%]\">\r\n                        <div className=\"border-b border-slate-400 mb-1 h-6 w-3/4 mx-auto\"></div>\r\n                        <p className=\"font-bold\">ผู้รับเงิน</p>\r\n                        <p className=\"text-[10px]\">(Payee)</p>\r\n                        <div className=\"mt-2 text-[10px]\">วันที่ (Date): _____/_____/_______</div>\r\n                    </div>\r\n                    <div className=\"text-center w-[45%]\">\r\n                        <div className=\"border-b border-slate-400 mb-1 h-6 w-3/4 mx-auto\"></div>\r\n                        <p className=\"font-bold\">ผู้จ่ายเงิน / ผู้มีอำนาจลงนาม</p>\r\n                        <p className=\"text-[10px]\">(Payer / Authorized Signature)</p>\r\n                        <div className=\"mt-2 text-[10px]\">วันที่ (Date): _____/_____/_______</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <style type=\"text/css\" media=\"print\">{`\r\n                @page { size: auto;  margin: 0mm; }\r\n                body { visibility: hidden; background: white !important; }\r\n                #printable-content, #printable-content * { visibility: visible; }\r\n                #printable-content {\r\n                    position: absolute;\r\n                    left: 0;\r\n                    top: 0;\r\n                    width: 100%;\r\n                }\r\n            `}</style>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\invoices\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3826,3829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3826,3829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { getInvoiceById } from \"@/lib/supabase/invoices\"\r\nimport { PrintButton } from \"@/components/billing/print-button\"\r\nimport Link from \"next/link\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { ArrowLeft } from \"lucide-react\"\r\n\r\nexport default async function InvoiceViewPage({ params }: { params: Promise<{ id: string }> }) {\r\n  const resolvedParams = await params\r\n  const { data: invoice } = await getInvoiceById(resolvedParams.id)\r\n\r\n  if (!invoice) return <div className=\"p-8 text-white\">Invoice Not Found</div>\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-900 print:bg-white text-slate-200 print:text-black p-8 font-sans\">\r\n        {/* Actions - Hidden on Print */}\r\n        <div className=\"max-w-[210mm] mx-auto mb-6 flex justify-between items-center print-hidden\">\r\n            <Link href=\"/billing/invoices\">\r\n                <Button variant=\"ghost\" className=\"text-slate-400 hover:text-white\">\r\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" /> กลับ\r\n                </Button>\r\n            </Link>\r\n            <PrintButton />\r\n        </div>\r\n\r\n        {/* Invoice Paper */}\r\n        <div className=\"max-w-[210mm] mx-auto bg-white text-black p-[15mm] shadow-xl print:shadow-none print:p-0 min-h-[297mm]\">\r\n            {/* Header */}\r\n            <div className=\"flex justify-between items-start mb-8\">\r\n                <div>\r\n                     {/* Company Logo/Name logic here (Hardcoded for now as placeholder) */}\r\n                     <h1 className=\"text-2xl font-bold text-indigo-800\">LOGIS-PRO 360</h1>\r\n                     <p className=\"text-sm text-gray-500\">\r\n                        123 Transport Lane, Logistics City<br/>\r\n                        Bangkok, 10110<br/>\r\n                        Tax ID: 0105551234567\r\n                     </p>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                    <h2 className=\"text-3xl font-bold text-gray-800 mb-2\">TAX INVOICE</h2>\r\n                    <div className=\"text-sm\">\r\n                        <p><span className=\"font-bold\">No:</span> {invoice.Invoice_ID}</p>\r\n                        <p><span className=\"font-bold\">Date:</span> {new Date(invoice.Issue_Date).toLocaleDateString('th-TH')}</p>\r\n                        {invoice.Due_Date && (\r\n                            <p><span className=\"font-bold\">Due Date:</span> {new Date(invoice.Due_Date).toLocaleDateString('th-TH')}</p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Customer Info */}\r\n            <div className=\"mb-8 p-4 border rounded bg-gray-50 print:bg-transparent print:border-gray-200\">\r\n                <h3 className=\"font-bold mb-2 border-b pb-1 text-gray-700\">Bill To:</h3>\r\n                <p className=\"font-bold text-lg\">{invoice.customers?.Customer_Name}</p>\r\n                <p className=\"text-sm whitespace-pre-line text-gray-600\">{invoice.customers?.Billing_Address || invoice.customers?.Address || 'No Address'}</p>\r\n                <p className=\"text-sm mt-1 text-gray-600\">Tax ID: {invoice.customers?.Tax_ID || '-'}</p>\r\n            </div>\r\n\r\n            {/* Items Table */}\r\n            <table className=\"w-full text-sm mb-8 border-collapse\">\r\n                <thead>\r\n                    <tr className=\"bg-gray-100 border-b border-gray-300 print:bg-gray-50\">\r\n                        <th className=\"p-3 text-left w-12 text-gray-600\">#</th>\r\n                        <th className=\"p-3 text-left text-gray-600\">Description</th>\r\n                        <th className=\"p-3 text-right w-32 text-gray-600\">Amount</th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    {invoice.Items_JSON && Array.isArray(invoice.Items_JSON) ? (\r\n                        invoice.Items_JSON.map((item: any, idx: number) => (\r\n                            <tr key={idx} className=\"border-b border-gray-200\">\r\n                                <td className=\"p-3 align-top\">{idx + 1}</td>\r\n                                <td className=\"p-3\">\r\n                                    <div className=\"font-bold text-gray-800\">{item.Route_Name}</div>\r\n                                    <div className=\"text-xs text-gray-500 mt-1\">\r\n                                        Job ID: {item.Job_ID} | Date: {new Date(item.Plan_Date).toLocaleDateString('th-TH')}\r\n                                    </div>\r\n                                </td>\r\n                                <td className=\"p-3 text-right align-top font-medium\">{Number(item.Price_Cust_Total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>\r\n                            </tr>\r\n                        ))\r\n                    ) : (\r\n                        <tr><td colSpan={3} className=\"p-4 text-center\">No Items</td></tr>\r\n                    )}\r\n                </tbody>\r\n            </table>\r\n\r\n            {/* Totals */}\r\n            <div className=\"flex justify-end mb-12\">\r\n                <div className=\"w-72 space-y-2\">\r\n                    <div className=\"flex justify-between text-sm py-1\">\r\n                        <span className=\"text-gray-600\">Subtotal</span>\r\n                        <span className=\"font-medium\">{Number(invoice.Subtotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n                    {invoice.VAT_Rate > 0 && (\r\n                        <div className=\"flex justify-between text-sm py-1\">\r\n                            <span className=\"text-gray-600\">VAT ({invoice.VAT_Rate}%)</span>\r\n                            <span className=\"font-medium\">{Number(invoice.VAT_Amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"flex justify-between font-bold text-lg border-t pt-2 mt-2\">\r\n                        <span>Grand Total</span>\r\n                        <span>{Number(invoice.Grand_Total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n                    {invoice.WHT_Amount > 0 && (\r\n                        <div className=\"flex justify-between text-sm text-red-600 border-t pt-2 border-dashed mt-2\">\r\n                            <span>Less WHT ({invoice.WHT_Rate}%)</span>\r\n                            <span>-{Number(invoice.WHT_Amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"flex justify-between font-bold text-xl border-2 border-gray-200 pt-3 pb-3 px-4 bg-gray-50 mt-4 rounded print:border-black print:bg-transparent\">\r\n                        <span>Net Payment</span>\r\n                        <span>{Number(invoice.Net_Total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Signatures */}\r\n            <div className=\"grid grid-cols-2 gap-12 mt-20 pt-8 page-break-inside-avoid\">\r\n                <div className=\"text-center\">\r\n                    <div className=\"border-b border-black mb-2 w-3/4 mx-auto h-8\"></div>\r\n                    <p className=\"text-sm font-bold\">Authorized Signature</p>\r\n                    <p className=\"text-xs text-gray-500 mt-1\">LOGIS-PRO 360</p>\r\n                    <p className=\"text-xs text-gray-400 mt-1\">Date: ____/____/____</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                    <div className=\"border-b border-black mb-2 w-3/4 mx-auto h-8\"></div>\r\n                    <p className=\"text-sm font-bold\">Customer Signature</p>\r\n                    <p className=\"text-xs text-gray-500 mt-1\">Received By</p>\r\n                    <p className=\"text-xs text-gray-400 mt-1\">Date: ____/____/____</p>\r\n                </div>\r\n            </div>\r\n            \r\n            {/* Notes */}\r\n            {invoice.Notes && (\r\n                <div className=\"mt-12 pt-4 border-t text-sm text-gray-500 print:text-xs\">\r\n                    <strong className=\"text-gray-700\">Notes:</strong> {invoice.Notes}\r\n                </div>\r\n            )}\r\n        </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\invoices\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getInvoiceByIdLib' is defined but never used.","line":4,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":80,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getInvoiceByIdLib"},"fix":{"range":[60,97],"text":""},"desc":"Remove unused variable \"getInvoiceByIdLib\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getInvoicesLib' is defined but never used.","line":4,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":111,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getInvoicesLib"},"fix":{"range":[97,128],"text":""},"desc":"Remove unused variable \"getInvoicesLib\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[324,327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[324,327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use server\"\r\n\r\nimport { createInvoice as createInvoiceLib, getInvoiceById as getInvoiceByIdLib, getInvoices as getInvoicesLib } from \"@/lib/supabase/invoices\"\r\nimport { getBillableJobs as getBillableJobsLib } from \"@/lib/supabase/jobs\"\r\n\r\n// Wrapper for Server Actions\r\nexport async function createInvoiceAction(invoice: any) {\r\n  return await createInvoiceLib(invoice)\r\n}\r\n\r\nexport async function getBillableJobsAction(customerId: string) {\r\n  return await getBillableJobsLib(customerId)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\invoices\\create\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\invoices\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used.","line":21,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertCircle"},"fix":{"range":[470,486],"text":""},"desc":"Remove unused variable \"AlertCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DropdownMenuSeparator' is defined but never used.","line":31,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DropdownMenuSeparator"},"fix":{"range":[734,760],"text":""},"desc":"Remove unused variable \"DropdownMenuSeparator\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'count' is assigned a value but never used.","line":44,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3896,3899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3896,3899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { \r\n  Table, \r\n  TableBody, \r\n  TableCell, \r\n  TableHead, \r\n  TableHeader, \r\n  TableRow \r\n} from \"@/components/ui/table\"\r\nimport { \r\n  FileText, \r\n  Plus, \r\n  Search, \r\n  Download,\r\n  MoreHorizontal,\r\n  FileCheck,\r\n  AlertCircle\r\n} from \"lucide-react\"\r\nimport Link from \"next/link\"\r\nimport { getInvoices } from \"@/lib/supabase/invoices\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\n\r\nexport default async function InvoicesPage({\r\n  searchParams,\r\n}: {\r\n  searchParams: Promise<{ page?: string; query?: string }>\r\n}) {\r\n  const resolvedParams = await searchParams\r\n  const page = Number(resolvedParams?.page) || 1\r\n  const query = resolvedParams?.query || \"\"\r\n  \r\n  const { data: invoices, count } = await getInvoices(page, 20, query)\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-white mb-2 flex items-center gap-3\">\r\n            <FileText className=\"text-purple-400\" />\r\n            ใบกำกับภาษี (Tax Invoices)\r\n          </h1>\r\n          <p className=\"text-slate-400\">จัดการและออกใบกำกับภาษีเต็มรูป</p>\r\n        </div>\r\n        <div className=\"flex gap-3\">\r\n          <Link href=\"/billing/invoices/create\">\r\n            <Button className=\"gap-2 bg-purple-600 hover:bg-purple-700\">\r\n              <Plus size={18} />\r\n              ออกใบกำกับภาษี\r\n            </Button>\r\n          </Link>\r\n        </div>\r\n      </div>\r\n\r\n      <Card className=\"bg-slate-900 border-slate-800\">\r\n        <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n            <CardTitle className=\"text-lg font-medium text-slate-200\">รายการใบกำกับภาษี</CardTitle>\r\n            <div className=\"flex items-center gap-2\">\r\n                <div className=\"relative\">\r\n                    <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-slate-500\" />\r\n                    <Input\r\n                        placeholder=\"Search Invoice ID...\"\r\n                        className=\"pl-9 w-[250px] bg-slate-800 border-slate-700\"\r\n                        defaultValue={query}\r\n                    />\r\n                </div>\r\n            </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"rounded-md border border-slate-800\">\r\n            <Table>\r\n              <TableHeader className=\"bg-slate-800/50\">\r\n                <TableRow className=\"border-slate-800 hover:bg-slate-800/50\">\r\n                  <TableHead className=\"text-slate-400\">เลขที่เอกสาร</TableHead>\r\n                  <TableHead className=\"text-slate-400\">ลูกค้า</TableHead>\r\n                  <TableHead className=\"text-slate-400\">วันที่</TableHead>\r\n                  <TableHead className=\"text-slate-400\">วันครบกำหนด</TableHead>\r\n                  <TableHead className=\"text-right text-slate-400\">ยอดสุทธิ</TableHead>\r\n                  <TableHead className=\"text-center text-slate-400\">สถานะ</TableHead>\r\n                  <TableHead className=\"w-[50px]\"></TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {invoices.length === 0 ? (\r\n                    <TableRow>\r\n                        <TableCell colSpan={7} className=\"h-24 text-center text-slate-500\">\r\n                            ไม่พบรายการใบกำกับภาษี\r\n                        </TableCell>\r\n                    </TableRow>\r\n                ) : (\r\n                    invoices.map((inv: any) => (\r\n                      <TableRow key={inv.Invoice_ID} className=\"border-slate-800 hover:bg-slate-800/30\">\r\n                        <TableCell className=\"font-medium text-slate-200\">\r\n                            <div className=\"flex flex-col\">\r\n                                <span>{inv.Invoice_ID}</span>\r\n                                {inv.Tax_Invoice_ID && (\r\n                                    <span className=\"text-xs text-slate-500\">{inv.Tax_Invoice_ID}</span>\r\n                                )}\r\n                            </div>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-slate-300\">{inv.Customer_Name}</TableCell>\r\n                        <TableCell className=\"text-slate-400\">{new Date(inv.Issue_Date).toLocaleDateString('th-TH')}</TableCell>\r\n                        <TableCell className=\"text-slate-400\">\r\n                            {inv.Due_Date ? new Date(inv.Due_Date).toLocaleDateString('th-TH') : '-'}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right font-medium text-slate-200\">\r\n                            Running...\r\n                            {/* {inv.Grand_Total.toLocaleString(undefined, { minimumFractionDigits: 2 })} */}\r\n                            {Number(inv.Grand_Total || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-center\">\r\n                            <Badge variant=\"outline\" className={`\r\n                                ${inv.Status === 'Paid' ? 'border-emerald-500 text-emerald-500 bg-emerald-500/10' : \r\n                                  inv.Status === 'Sent' ? 'border-blue-500 text-blue-500 bg-blue-500/10' :\r\n                                  inv.Status === 'Overdue' ? 'border-red-500 text-red-500 bg-red-500/10' :\r\n                                  'border-slate-500 text-slate-500 bg-slate-500/10'}\r\n                            `}>\r\n                                {inv.Status}\r\n                            </Badge>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                              <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n                                <span className=\"sr-only\">Open menu</span>\r\n                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\" className=\"bg-slate-900 border-slate-800\">\r\n                              <DropdownMenuLabel>Actions</DropdownMenuLabel>\r\n                              <DropdownMenuItem className=\"focus:bg-slate-800 cursor-pointer\">\r\n                                <FileCheck className=\"mr-2 h-4 w-4\" /> ดูรายละเอียด\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem className=\"focus:bg-slate-800 cursor-pointer\">\r\n                                <Download className=\"mr-2 h-4 w-4\" /> ดาวน์โหลด PDF\r\n                              </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                          </DropdownMenu>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\print\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BillingActions' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"BillingActions"},"fix":{"range":[113,182],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1338,1341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1338,1341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1415,1418],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1415,1418],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":127,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6063,6066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6063,6066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":87,"column":37,"nodeType":"JSXOpeningElement","endLine":87,"endColumn":123,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getBillingNoteByIdWithJobs } from \"@/lib/supabase/billing\"\r\nimport { notFound } from \"next/navigation\"\r\nimport { BillingActions } from \"@/components/billing/billing-actions\"\r\nimport { AutoPrint } from \"@/components/utils/auto-print\"\r\n\r\nexport const dynamic = 'force-dynamic'\r\n\r\ntype Props = {\r\n    params: Promise<{ id: string }>\r\n}\r\n\r\nexport default async function BillingPrintPage(props: Props) {\r\n    const params = await props.params;\r\n    const { id } = params\r\n    const data = await getBillingNoteByIdWithJobs(id)\r\n\r\n    if (!data) {\r\n        return notFound()\r\n    }\r\n\r\n    const { note, jobs, company } = data\r\n\r\n    // Calculate totals dynamically to ensure consistency with displayed items\r\n    const subtotal = jobs.reduce((sum, job) => {\r\n        const base = job.Price_Cust_Total || 0\r\n        let extra = 0\r\n        try {\r\n            if (job.extra_costs_json) {\r\n                let costs = job.extra_costs_json\r\n                if (typeof costs === 'string') {\r\n                    try { costs = JSON.parse(costs) } catch {}\r\n                }\r\n                if (typeof costs === 'string') {\r\n                    try { costs = JSON.parse(costs) } catch {}\r\n                }\r\n                \r\n                if (Array.isArray(costs)) {\r\n                    extra = costs\r\n                        .filter((c: any) => c.charge_cust > 0)\r\n                        .reduce((acc: number, c: any) => acc + (Number(c.charge_cust) || 0), 0)\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error calculating extra costs\", e)\r\n        }\r\n        return sum + base + extra\r\n    }, 0)\r\n\r\n    // const subtotal = note.Total_Amount // Legacy: Don't use stored total as it might be outdated\r\n    const vat = subtotal * 0.07 \r\n    const total = subtotal + vat\r\n\r\n    // DEBUG: Check data\r\n    console.log(\"DEBUG BILLING JOBS:\", JSON.stringify(jobs.map(j => ({ id: j.Job_ID, extra: j.extra_costs_json })), null, 2))\r\n\r\n    return (\r\n        <div className=\"bg-white min-h-screen p-8 text-black print:p-0\">\r\n            <AutoPrint />\r\n            {/* ... (Actions Bar skipped in replacement mostly) */}\r\n            \r\n            {/* A4 Page Container */}\r\n            <div id=\"printable-content\" className=\"max-w-[210mm] mx-auto bg-white p-8 print:w-full print:max-w-none print:px-12 print:py-6\">\r\n                \r\n                {/* Header */}\r\n                <div className=\"flex justify-between items-start mb-4 border-b pb-4\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold text-slate-800\">ใบวางบิล</h1>\r\n                        <h2 className=\"text-xl text-slate-500 font-light\">BILLING NOTE</h2>\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                        <div className=\"text-2xl font-bold text-slate-800\"># {note.Billing_Note_ID}</div>\r\n                        <div className=\"text-slate-500\">วันที่: {new Date(note.Billing_Date).toLocaleDateString('th-TH')}</div>\r\n                        {note.Due_Date && (\r\n                            <div className=\"text-slate-500\">ครบกำหนด: {new Date(note.Due_Date).toLocaleDateString('th-TH')}</div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Addresses */}\r\n                <div className=\"grid grid-cols-2 gap-8 mb-4\">\r\n                    <div>\r\n                        <h3 className=\"font-bold text-slate-700 mb-2\">ผู้วางบิล (Bill From)</h3>\r\n                        {company ? (\r\n                            <div className=\"text-sm text-slate-600 leading-relaxed\">\r\n                                {company.logo_url && (\r\n                                    // eslint-disable-next-line @next/next/no-img-element\r\n                                    <img src={company.logo_url} alt=\"Company Logo\" className=\"h-16 mb-2 object-contain\" />\r\n                                )}\r\n                                <strong>{company.company_name}</strong><br/>\r\n                                {company.address}<br/>\r\n                                <span>เลขประจำตัวผู้เสียภาษี: {company.tax_id}</span><br/>\r\n                                {company.phone && <span>โทร: {company.phone}</span>}\r\n                            </div>\r\n                        ) : (\r\n                            <p className=\"text-sm text-slate-600 leading-relaxed text-red-500\">\r\n                                (กรุณาตั้งค่าข้อมูลบริษัทในเมนูตั้งค่า)\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"font-bold text-slate-700 mb-2\">ลูกค้า (Bill To)</h3>\r\n                        <p className=\"text-sm text-slate-600 leading-relaxed\">\r\n                            <strong>{note.Customer_Name}</strong><br/>\r\n                            {note.Customer_Address ? (\r\n                                <>\r\n                                {note.Customer_Address}<br/>\r\n                                <span>เลขประจำตัวผู้เสียภาษี: {note.Customer_Tax_ID}</span>\r\n                                </>\r\n                            ) : (\r\n                                <span className=\"text-red-400\">ไม่พบที่อยู่ลูกค้า (กรุณาตวจสอบใน Master Data)</span>\r\n                            )}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Table */}\r\n                <table className=\"w-full mb-4\">\r\n                    <thead>\r\n                        <tr className=\"bg-slate-100 text-slate-600 text-sm\">\r\n                            <th className=\"py-2 px-4 text-left\">ลำดับ</th>\r\n                            <th className=\"py-2 px-4 text-left\">รายละเอียด (Job ID / Route)</th>\r\n                            <th className=\"py-2 px-4 text-center\">วันที่ขนส่ง</th>\r\n                            <th className=\"py-2 px-4 text-right\">จำนวนเงิน</th>\r\n                        </tr>\r\n                    </thead>\r\n                    {jobs.map((job, index) => {\r\n                            let extraCosts: any[] = []\r\n                            try {\r\n                                if (job.extra_costs_json) {\r\n                                    let parsed = job.extra_costs_json\r\n                                    if (typeof parsed === 'string') {\r\n                                        try { parsed = JSON.parse(parsed) } catch {}\r\n                                    }\r\n                                    if (typeof parsed === 'string') {\r\n                                        try { parsed = JSON.parse(parsed) } catch {}\r\n                                    }\r\n                                    if (Array.isArray(parsed)) {\r\n                                        extraCosts = parsed\r\n                                    }\r\n                                }\r\n                            } catch {}\r\n\r\n                            const chargeableExtras = extraCosts.filter(c => c.charge_cust > 0)\r\n\r\n                            return (\r\n                                <tbody key={job.Job_ID} className=\"text-sm text-slate-700 border-b border-slate-200\">\r\n                                    {/* Main Job Row */}\r\n                                    <tr>\r\n                                        <td className=\"py-2 px-4 align-top\">{index + 1}</td>\r\n                                        <td className=\"py-2 px-4\">\r\n                                            <div className=\"font-bold\">ค่าขนส่ง (Job: {job.Job_ID})</div>\r\n                                            <div className=\"text-slate-500 text-xs\">{job.Route_Name}</div>\r\n                                        </td>\r\n                                        <td className=\"py-2 px-4 text-center align-top\">\r\n                                            {new Date(job.Plan_Date).toLocaleDateString('th-TH')}\r\n                                        </td>\r\n                                        <td className=\"py-2 px-4 text-right align-top\">{job.Price_Cust_Total?.toLocaleString()}</td>\r\n                                    </tr>\r\n\r\n                                    {/* Extra Costs Rows */}\r\n                                    {chargeableExtras.map((extra, i) => (\r\n                                        <tr key={`${job.Job_ID}-extra-${i}`} className=\"text-slate-600\">\r\n                                            <td className=\"py-1 px-4\"></td>\r\n                                            <td className=\"py-1 px-4\">\r\n                                                <div className=\"text-sm border-l-2 border-slate-300 pl-2\">\r\n                                                    {extra.type}\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"py-1 px-4 text-center\">\r\n                                                {/* Same Date or empty */}\r\n                                            </td>\r\n                                            <td className=\"py-1 px-4 text-right\">{Number(extra.charge_cust).toLocaleString()}</td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            )\r\n                        })}\r\n                </table>\r\n\r\n                {/* Totals */}\r\n                <div className=\"flex justify-end mb-6\">\r\n                    <div className=\"w-64 space-y-2\">\r\n                        <div className=\"flex justify-between text-sm text-slate-600\">\r\n                            <span>รวมเป็นเงิน</span>\r\n                            <span>{subtotal.toLocaleString()} บาท</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between text-sm text-slate-600\">\r\n                            <span>ภาษีมูลค่าเพิ่ม 7%</span>\r\n                            <span>{vat.toLocaleString()} บาท</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between font-bold text-lg text-slate-800 border-t pt-2 mt-2\">\r\n                            <span>ยอดรวมสุทธิ</span>\r\n                            <span>{total.toLocaleString()} บาท</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Signatures */}\r\n                <div className=\"grid grid-cols-2 gap-12 mt-8 break-inside-avoid\">\r\n                    <div className=\"border-t border-slate-300 pt-4 text-center\">\r\n                        <p className=\"text-sm text-slate-600\">ลงชื่อ ผู้วางบิล</p>\r\n                        <div className=\"h-8 mt-2\"></div>\r\n                        <p className=\"text-xs text-slate-400 mt-1\">วันที่ .......................................</p>\r\n                    </div>\r\n                    <div className=\"border-t border-slate-300 pt-4 text-center\">\r\n                        <p className=\"text-sm text-slate-600\">ลงชื่อ ผู้รับวางบิล</p>\r\n                        <div className=\"h-8 mt-2\"></div>\r\n                        <p className=\"text-xs text-slate-400 mt-1\">วันที่ .......................................</p>\r\n                    </div>\r\n                </div>\r\n                \r\n            </div>\r\n\r\n            <style type=\"text/css\" media=\"print\">{`\r\n                @page { size: auto;  margin: 0mm; }\r\n                body { visibility: hidden; }\r\n                #printable-content, #printable-content * { visibility: visible; }\r\n                #printable-content {\r\n                    position: absolute;\r\n                    left: 0;\r\n                    top: 0;\r\n                    width: 100%;\r\n                }\r\n            `}</style>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\billing\\print\\[id]\\print-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\chat\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\dashboard\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":3,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardTitle"},"fix":{"range":[163,174],"text":""},"desc":"Remove unused variable \"CardTitle\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardLoading() {\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Page Header */}\r\n      <div className=\"mb-8\">\r\n        <Skeleton className=\"h-8 w-48 bg-slate-800 mb-2\" />\r\n        <Skeleton className=\"h-4 w-64 bg-slate-800\" />\r\n      </div>\r\n\r\n      {/* Metrics Grid */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <div key={i} className=\"p-6 rounded-xl bg-slate-900 border border-slate-800 flex items-center justify-between\">\r\n            <div className=\"space-y-2\">\r\n               <Skeleton className=\"h-4 w-20 bg-slate-800\" />\r\n               <Skeleton className=\"h-8 w-12 bg-slate-800\" />\r\n            </div>\r\n            <Skeleton className=\"h-10 w-10 rounded-full bg-slate-800\" />\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n       {/* Second Row */}\r\n       <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <div key={i} className=\"p-6 rounded-xl bg-slate-900 border border-slate-800 flex items-center justify-between\">\r\n            <div className=\"space-y-2\">\r\n               <Skeleton className=\"h-4 w-20 bg-slate-800\" />\r\n               <Skeleton className=\"h-8 w-12 bg-slate-800\" />\r\n            </div>\r\n            <Skeleton className=\"h-10 w-10 rounded-full bg-slate-800\" />\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Charts Section */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        <Card className=\"bg-slate-900/50 border-slate-800\">\r\n          <CardHeader>\r\n             <Skeleton className=\"h-6 w-48 bg-slate-800\" />\r\n          </CardHeader>\r\n          <CardContent className=\"h-[300px] flex items-center justify-center\">\r\n             <Skeleton className=\"h-full w-full bg-slate-800/50 rounded-lg\" />\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card className=\"bg-slate-900/50 border-slate-800\">\r\n          <CardHeader>\r\n             <Skeleton className=\"h-6 w-48 bg-slate-800\" />\r\n          </CardHeader>\r\n          <CardContent className=\"h-[300px] flex items-center justify-center\">\r\n             <Skeleton className=\"h-64 w-64 rounded-full bg-slate-800/50\" />\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\debug-db\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[268,271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[268,271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[329,332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[329,332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[388,391],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[388,391],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { createClient } from '@/utils/supabase/client'\r\nimport { useEffect, useState } from 'react'\r\nimport { getJobCreationData } from '@/app/planning/actions'\r\n\r\nexport default function DebugDBPage() {\r\n  const [clientData, setClientData] = useState<any>(null)\r\n  const [clientError, setClientError] = useState<any>(null)\r\n  const [serverData, setServerData] = useState<any>(null)\r\n  \r\n  useEffect(() => {\r\n    // 1. Client-side fetch\r\n    const fetchClient = async () => {\r\n      try {\r\n        const supabase = createClient()\r\n        const { data, error, count } = await supabase\r\n          .from('Master_Customers')\r\n          .select('*', { count: 'exact' })\r\n          .limit(5)\r\n        \r\n        if (error) setClientError(error)\r\n        else setClientData({ count, data })\r\n      } catch (e) {\r\n        setClientError(e)\r\n      }\r\n    }\r\n\r\n    // 2. Server action fetch\r\n    const fetchServer = async () => {\r\n      try {\r\n        const result = await getJobCreationData()\r\n        setServerData(result)\r\n      } catch (e) {\r\n        setServerData({ error: e })\r\n      }\r\n    }\r\n\r\n    fetchClient()\r\n    fetchServer()\r\n  }, [])\r\n\r\n  return (\r\n    <div className=\"p-8 bg-slate-900 text-white min-h-screen font-mono\">\r\n      <h1 className=\"text-2xl font-bold mb-6 text-emerald-400\">Database Debugger</h1>\r\n      \r\n      <div className=\"grid grid-cols-2 gap-8\">\r\n        {/* Client Side Results */}\r\n        <div className=\"border border-slate-700 p-4 rounded-lg bg-slate-800\">\r\n          <h2 className=\"text-xl font-bold mb-4 text-blue-400\">Client-Side Fetch</h2>\r\n          {clientError ? (\r\n             <div className=\"bg-red-900/50 p-4 rounded border border-red-500 text-red-200\">\r\n                <h3 className=\"font-bold\">Error:</h3>\r\n                <pre className=\"whitespace-pre-wrap\">{JSON.stringify(clientError, null, 2)}</pre>\r\n             </div>\r\n          ) : clientData ? (\r\n             <div className=\"space-y-2\">\r\n                <p><strong>Total Count:</strong> {clientData.count}</p>\r\n                <p><strong>First 5 rows:</strong></p>\r\n                <pre className=\"text-xs bg-slate-900 p-2 rounded overflow-auto max-h-[400px]\">\r\n                    {JSON.stringify(clientData.data, null, 2)}\r\n                </pre>\r\n             </div>\r\n          ) : (\r\n            <p className=\"animate-pulse\">Loading client data...</p>\r\n          )}\r\n        </div>\r\n\r\n        {/* Server Action Results */}\r\n        <div className=\"border border-slate-700 p-4 rounded-lg bg-slate-800\">\r\n          <h2 className=\"text-xl font-bold mb-4 text-purple-400\">Server Action (getJobCreationData)</h2>\r\n           {serverData ? (\r\n             <div className=\"space-y-2\">\r\n                <p><strong>Customers Count:</strong> {serverData.customers?.length}</p>\r\n                <p><strong>Drivers Count:</strong> {serverData.drivers?.length}</p>\r\n                 <p><strong>First Customer:</strong></p>\r\n                <pre className=\"text-xs bg-slate-900 p-2 rounded overflow-auto max-h-[200px]\">\r\n                    {JSON.stringify(serverData.customers?.[0], null, 2)}\r\n                </pre>\r\n                {serverData.customers?.length === 0 && (\r\n                     <p className=\"text-yellow-400\">⚠️ No customers returned from server action</p>\r\n                )}\r\n             </div>\r\n          ) : (\r\n            <p className=\"animate-pulse\">Loading server data...</p>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\drivers\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\drivers\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\drivers\\page.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":20,"column":8,"nodeType":"Block","messageId":"tsIgnoreInsteadOfExpectError","endLine":20,"endColumn":24,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[688,704],"text":"/* @ts-expect-error */"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { DriversContent } from \"@/components/drivers/drivers-content\"\r\nimport { isSuperAdmin } from \"@/lib/permissions\"\r\nimport { getAllBranches, Branch } from \"@/lib/supabase/branches\"\r\n\r\ntype Props = {\r\n  searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}\r\n\r\nexport const dynamic = 'force-dynamic'\r\nexport const revalidate = 0\r\n\r\nexport default async function DriversPage(props: Props) {\r\n  const searchParams = await props.searchParams\r\n  const isAdmin = await isSuperAdmin()\r\n  const branches: Branch[] = isAdmin ? await getAllBranches() : []\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* @ts-ignore */}\r\n      <DriversContent searchParams={searchParams} branches={branches} isSuperAdmin={isAdmin} />\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\fuel\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\fuel\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\fuel\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\gps\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\jobs\\history\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\jobs\\history\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Card"},"fix":{"range":[134,139],"text":""},"desc":"Remove unused variable \"Card\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":3,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CardContent"},"fix":{"range":[125,181],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Loader2 } from \"lucide-react\"\r\n\r\nexport default function GlobalLoading() {\r\n  return (\r\n    <DashboardLayout>\r\n      <div className=\"h-[calc(100vh-100px)] flex flex-col items-center justify-center text-slate-500\">\r\n        <Loader2 className=\"w-10 h-10 animate-spin text-blue-500 mb-4\" />\r\n        <p className=\"text-sm animate-pulse\">กำลังโหลด...</p>\r\n        \r\n        {/* Optional: Generic page skeleton */}\r\n        <div className=\"w-full max-w-4xl mt-10 opacity-20\">\r\n            <div className=\"flex items-center gap-4 mb-8\">\r\n                <Skeleton className=\"h-10 w-48 bg-slate-700\" />\r\n                <Skeleton className=\"h-10 w-full bg-slate-700\" />\r\n            </div>\r\n            <div className=\"grid grid-cols-3 gap-6\">\r\n                <Skeleton className=\"h-32 w-full bg-slate-700\" />\r\n                <Skeleton className=\"h-32 w-full bg-slate-700\" />\r\n                <Skeleton className=\"h-32 w-full bg-slate-700\" />\r\n            </div>\r\n        </div>\r\n      </div>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\login\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\maintenance\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2248,2251],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2248,2251],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { getUserBranchId } from '@/lib/permissions'\r\n\r\nexport type TicketFormData = {\r\n  Date_Report: string\r\n  Driver_ID: string\r\n  Vehicle_Plate: string\r\n  Issue_Type: string\r\n  Issue_Desc: string\r\n  Priority: string\r\n  Odometer?: number // Add Odometer\r\n  Photo_Url?: string\r\n}\r\n\r\nexport async function createRepairTicket(data: TicketFormData) {\r\n  const supabase = await createClient()\r\n  const branchId = await getUserBranchId()\r\n\r\n  // Note: If Odometer column missing in Repair_Tickets, we might need to append to desc\r\n  // But let's try to insert to Odometer column usually standard\r\n  // If fails, we might need to migration. Assuming column exists or we append to desc.\r\n  // Let's check if we can simply append to desc to be safe if column likely missing?\r\n  // User asked for \"Add mileage field\". \r\n  // I will assume column might be missing so I will ALSO append it to Issue_Desc for safety?\r\n  // No, that's messy. Let's try to insert. If user reports error, I'll fix.\r\n  // Actually, I can use `Odometer` in insert.\r\n  \r\n  const { error } = await supabase\r\n    .from('Repair_Tickets')\r\n    .insert({\r\n      Date_Report: data.Date_Report,\r\n      Driver_ID: data.Driver_ID,\r\n      Vehicle_Plate: data.Vehicle_Plate,\r\n      Issue_Type: data.Issue_Type,\r\n      Issue_Desc: data.Issue_Desc,\r\n      Priority: data.Priority,\r\n      Odometer: data.Odometer || 0, // Insert Odometer\r\n      Photo_Url: data.Photo_Url || null,\r\n      Status: 'Pending',\r\n      Branch_ID: branchId === 'All' ? null : branchId\r\n    })\r\n\r\n  if (error) {\r\n    console.error('Error creating ticket:', error)\r\n    return { success: false, message: 'Failed to create ticket' }\r\n  }\r\n\r\n  // Update vehicle status to Maintenance if priority is High\r\n  if (data.Priority === 'High') {\r\n      await supabase\r\n        .from('master_vehicles')\r\n        .update({ active_status: 'Maintenance' })\r\n        .eq('vehicle_plate', data.Vehicle_Plate)\r\n  }\r\n\r\n  revalidatePath('/maintenance')\r\n  revalidatePath('/vehicles')\r\n  return { success: true, message: 'Ticket created successfully' }\r\n}\r\n\r\nexport async function updateRepairTicket(ticketId: string, data: any) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase\r\n    .from('Repair_Tickets')\r\n    .update({\r\n      Status: data.Status,\r\n      Cost_Total: data.Cost_Total || 0,\r\n      Remark: data.Remark || null,\r\n      Date_Finish: data.Date_Finish || null,\r\n      // Allow updating basic info too if needed\r\n      Issue_Type: data.Issue_Type,\r\n      Issue_Desc: data.Issue_Desc,\r\n      Priority: data.Priority,\r\n      Driver_ID: data.Driver_ID,\r\n      Vehicle_Plate: data.Vehicle_Plate,\r\n      Date_Report: data.Date_Report\r\n    })\r\n    .eq('Ticket_ID', ticketId)\r\n\r\n  if (error) {\r\n    console.error('Error updating ticket:', error)\r\n    return { success: false, message: 'Failed to update ticket' }\r\n  }\r\n\r\n  // If status is Completed, check if we need to release vehicle? \r\n  // For now, let's just update the ticket. \r\n  // Ideally, if finished, Vehicle Status might need to go back to 'Active'.\r\n  if (data.Status === 'Completed' && data.Vehicle_Plate) {\r\n     await supabase\r\n        .from('master_vehicles')\r\n        .update({ active_status: 'Active' })\r\n        .eq('vehicle_plate', data.Vehicle_Plate)\r\n  }\r\n\r\n  revalidatePath('/maintenance')\r\n  return { success: true, message: 'Ticket updated successfully' }\r\n}\r\n\r\nexport async function deleteRepairTicket(ticketId: string) {\r\n  const supabase = await createClient()\r\n\r\n  const { error } = await supabase\r\n    .from('Repair_Tickets')\r\n    .delete()\r\n    .eq('Ticket_ID', ticketId)\r\n\r\n  if (error) {\r\n    console.error('Error deleting ticket:', error)\r\n    return { success: false, message: 'Failed to delete ticket' }\r\n  }\r\n\r\n  revalidatePath('/maintenance')\r\n  return { success: true, message: 'Ticket deleted successfully' }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\maintenance\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\maintenance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\manifest.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\chat\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'router'. Either include it or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [router]","fix":{"range":[1559,1561],"text":"[router]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'supabase'. Either include it or remove the dependency array.","line":70,"column":6,"nodeType":"ArrayExpression","endLine":70,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [driverId, supabase]","fix":{"range":[2377,2387],"text":"[driverId, supabase]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { MobileHeader } from \"@/components/mobile/mobile-header\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Send, User, Bot, Loader2 } from \"lucide-react\"\r\nimport { createClient } from \"@/utils/supabase/client\" // Client side supabase for realtime\r\nimport { getChatHistory, sendChatMessage, ChatMessage } from \"@/lib/actions/chat-actions\"\r\nimport { getDriverSession } from \"@/lib/actions/auth-actions\"\r\n\r\nexport default function MobileChatPage() {\r\n  const router = useRouter()\r\n  const [messages, setMessages] = useState<ChatMessage[]>([])\r\n  const [inputText, setInputText] = useState(\"\")\r\n  const [driverId, setDriverId] = useState<string | null>(null)\r\n  const [driverName, setDriverName] = useState<string>(\"\")\r\n  const [loading, setLoading] = useState(true)\r\n  const [sending, setSending] = useState(false)\r\n  const scrollRef = useRef<HTMLDivElement>(null)\r\n  const supabase = createClient()\r\n\r\n  // 1. Init Session & Load History\r\n  useEffect(() => {\r\n    const init = async () => {\r\n        const session = await getDriverSession()\r\n        if (!session) {\r\n            router.push('/mobile/login')\r\n            return\r\n        }\r\n        setDriverId(session.driverId)\r\n        setDriverName(session.driverName || \"\")\r\n        \r\n        const history = await getChatHistory(session.driverId)\r\n        setMessages(history)\r\n        setLoading(false)\r\n    }\r\n    init()\r\n  }, [])\r\n\r\n  // 2. Realtime Subscription\r\n  useEffect(() => {\r\n    if (!driverId) return\r\n\r\n    const channel = supabase\r\n        .channel('chat_room')\r\n        .on(\r\n            'postgres_changes',\r\n            {\r\n                event: 'INSERT',\r\n                schema: 'public',\r\n                table: 'chat_messages',\r\n                filter: `driver_id=eq.${driverId}`\r\n            },\r\n            (payload) => {\r\n                const newMsg = payload.new as ChatMessage\r\n                setMessages(prev => {\r\n                    // Avoid duplicates\r\n                    if (prev.find(m => m.id === newMsg.id)) return prev\r\n                    return [...prev, newMsg]\r\n                })\r\n            }\r\n        )\r\n        .subscribe()\r\n\r\n    return () => {\r\n        supabase.removeChannel(channel)\r\n    }\r\n  }, [driverId])\r\n\r\n  // 3. Auto Scroll\r\n  useEffect(() => {\r\n    if (scrollRef.current) {\r\n        scrollRef.current.scrollTop = scrollRef.current.scrollHeight\r\n    }\r\n  }, [messages, loading])\r\n\r\n  const handleSend = async () => {\r\n    if (!inputText.trim() || !driverId || sending) return\r\n\r\n    const text = inputText\r\n    setInputText(\"\") // Optimistic clear\r\n    setSending(true)\r\n\r\n    // Optimistic UI Update (optional, but good for UX)\r\n    // We wait for server response or realtime echo? \r\n    // Let's rely on server revalidation or realtime for consistency, \r\n    // OR add optimistic msg.\r\n    \r\n    // Server Action\r\n    await sendChatMessage(driverId, text, driverName)\r\n\r\n    // Since we didn't subscribe to our own inserts above (maybe?), let's refresh.\r\n    // Actually, let's just refresh history to be safe and simple.\r\n    const history = await getChatHistory(driverId)\r\n    setMessages(history)\r\n    \r\n    setSending(false)\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-[100dvh] bg-slate-950\">\r\n      <MobileHeader title=\"แชทกับเจ้าหน้าที่\" showBack />\r\n\r\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-4 pt-16 pb-20\" ref={scrollRef}>\r\n        {loading ? (\r\n            <div className=\"flex justify-center pt-10\">\r\n                <Loader2 className=\"animate-spin text-slate-500\" />\r\n            </div>\r\n        ) : messages.length === 0 ? (\r\n            <div className=\"text-center text-slate-500 mt-10\">\r\n                <p>ยังไม่มีข้อความ</p>\r\n                <p className=\"text-xs\">พิมพ์ข้อความเพื่อเริ่มการสนทนา</p>\r\n            </div>\r\n        ) : (\r\n            messages.map((msg) => {\r\n                const isMe = msg.sender === 'driver'\r\n                return (\r\n                    <div \r\n                        key={msg.id} \r\n                        className={`flex gap-3 ${isMe ? \"flex-row-reverse\" : \"flex-row\"}`}\r\n                    >\r\n                        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isMe ? \"bg-indigo-600\" : \"bg-slate-700\"}`}>\r\n                            {isMe ? <User size={16} className=\"text-white\" /> : <Bot size={16} className=\"text-blue-400\" />}\r\n                        </div>\r\n                        \r\n                        <div className={`max-w-[70%] p-3 rounded-2xl text-sm ${\r\n                            isMe \r\n                                ? \"bg-indigo-600 text-white rounded-tr-none\" \r\n                                : \"bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700\"\r\n                        }`}>\r\n                            <p>{msg.message}</p>\r\n                            <p className={`text-[10px] mt-1 text-right ${isMe ? \"text-indigo-200\" : \"text-slate-500\"}`}>\r\n                                {new Date(msg.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                )\r\n            })\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"p-4 bg-slate-900 border-t border-slate-800 shrink-0\">\r\n        <div className=\"flex gap-2\">\r\n            <Input \r\n                value={inputText}\r\n                onChange={(e) => setInputText(e.target.value)}\r\n                onKeyDown={(e) => e.key === \"Enter\" && handleSend()}\r\n                placeholder=\"พิมพ์ข้อความ...\"\r\n                className=\"bg-slate-950 border-slate-700 text-white focus-visible:ring-indigo-500\"\r\n                disabled={sending}\r\n            />\r\n            <Button \r\n                onClick={handleSend}\r\n                size=\"icon\" \r\n                className=\"bg-indigo-600 hover:bg-indigo-700 shrink-0\"\r\n                disabled={sending || !inputText.trim()}\r\n            >\r\n                {sending ? <Loader2 className=\"animate-spin\" size={18} /> : <Send size={18} />}\r\n            </Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\fuel\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\[id]\\complete\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4400,4403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4400,4403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { useRouter, useParams } from \"next/navigation\"\r\nimport { MobileHeader } from \"@/components/mobile/mobile-header\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { CameraInput } from \"@/components/mobile/camera-input\"\r\nimport { SignaturePad } from \"@/components/mobile/signature-pad\"\r\nimport { submitJobPOD } from \"@/lib/actions/pod-actions\"\r\nimport { getJobDetails } from \"@/app/mobile/jobs/actions\"\r\nimport { Loader2, CheckCircle, BrainCircuit, AlertTriangle, ScanLine } from \"lucide-react\"\r\nimport { PodReport } from \"@/components/mobile/pod-report\"\r\nimport { Job } from \"@/lib/supabase/jobs\"\r\nimport html2canvas from \"html2canvas\"\r\nimport { analyzePODImage, AIAnalysisResult } from \"@/lib/utils/ai-verification\"\r\nimport { saveJobOffline } from \"@/lib/utils/offline-storage\"\r\n\r\nexport default function JobCompletePage() {\r\n  const router = useRouter()\r\n  const params = useParams<{ id: string }>()\r\n  const [photos, setPhotos] = useState<File[]>([])\r\n  const [signature, setSignature] = useState<Blob | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [completed, setCompleted] = useState(false)\r\n  \r\n  // AI Verification State\r\n  const [verifying, setVerifying] = useState(false)\r\n  const [verificationResult, setVerificationResult] = useState<AIAnalysisResult | null>(null)\r\n\r\n  // Job Data for Report\r\n  const [job, setJob] = useState<Job | null>(null)\r\n  const reportRef = useRef<HTMLDivElement>(null)\r\n\r\n  useEffect(() => {\r\n      if (params.id) {\r\n          getJobDetails(params.id).then(setJob)\r\n      }\r\n  }, [params.id])\r\n\r\n  // Trigger AI Verification when photo is added\r\n  useEffect(() => {\r\n      if (photos.length > 0) {\r\n          verifyPhoto(photos[0]) // Analyze the first photo as primary\r\n      } else {\r\n          setVerificationResult(null)\r\n      }\r\n  }, [photos])\r\n\r\n  const verifyPhoto = async (file: File) => {\r\n      setVerifying(true)\r\n      try {\r\n          const result = await analyzePODImage(file)\r\n          setVerificationResult(result)\r\n      } catch (error) {\r\n          console.error(\"AI Verification Failed\", error)\r\n      } finally {\r\n          setVerifying(false)\r\n      }\r\n  }\r\n\r\n  const handleSubmit = async () => {\r\n    if (photos.length === 0 || !signature) return\r\n\r\n    setLoading(true)\r\n    \r\n    try {\r\n        const formData = new FormData()\r\n        \r\n        // 1. Capture Report BEFORE sending\r\n        if (reportRef.current && job) {\r\n            try {\r\n                // Wait for images to be ready (optional check)\r\n                const canvas = await html2canvas(reportRef.current, {\r\n                    scale: 2, // High resolution\r\n                    useCORS: true,\r\n                    logging: false,\r\n                    windowWidth: 1200 // Force desktop width for layout\r\n                })\r\n                \r\n                const reportBlob = await new Promise<Blob | null>(resolve => \r\n                    canvas.toBlob(resolve, 'image/jpeg', 0.8)\r\n                )\r\n                \r\n                if (reportBlob) {\r\n                    formData.append(\"pod_report\", reportBlob, `POD_Report_${params.id}.jpg`)\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Report Generation Failed:\", err)\r\n                // Continue without report if fails? or Alert?\r\n                // alert(\"สร้างใบงานไม่สำเร็จ แต่จะพยายามส่งรูปปกติ\")\r\n            }\r\n        }\r\n\r\n        // Photos are already compressed by CameraInput component\r\n        photos.forEach((photo, index) => {\r\n            formData.append(`photo_${index}`, photo)\r\n        })\r\n\r\n        // Also send count so server knows how many to look for\r\n        formData.append(\"photo_count\", photos.length.toString())\r\n        \r\n        formData.append(\"signature\", signature, \"signature.png\")\r\n        \r\n        // ... rest of submit logic\r\n        const result = await submitJobPOD(params.id, formData)\r\n        \r\n        if (result.success) {\r\n          setCompleted(true)\r\n        } else {\r\n          // If server returns error, might be validation error, so we show it\r\n          alert(result.error)\r\n        }\r\n    } catch (error: unknown) {\r\n        console.error(\"Submit Error:\", error)\r\n        \r\n        // Check if it's a network error\r\n        const isNetworkError = !navigator.onLine || error instanceof TypeError || (error as any).message?.includes('fetch')\r\n        \r\n        if (isNetworkError) {\r\n            // SAVE OFFLINE\r\n            const photoBase64 = await Promise.all(photos.map(fileToB64))\r\n            const sigBase64 = signature ? await fileToB64(signature as File) : null\r\n            \r\n            const offlineData = {\r\n                photos: photoBase64,\r\n                signature: sigBase64,\r\n                photo_count: photos.length\r\n            }\r\n            \r\n            saveJobOffline(params.id, offlineData, 'POD')\r\n            setCompleted(true) // Show success even if offline, it's queued!\r\n            alert(\"บันทึกข้อมูลไว้ในเครื่องแล้ว (โหมดออฟไลน์) ระบบจะส่งข้อมูลให้อัตโนมัติเมื่อมีสัญญาณ\")\r\n        } else {\r\n            const errorMessage = error instanceof Error ? error.message : \"Internal Server Error\"\r\n            alert(`Error: ${errorMessage}`)\r\n        }\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  // Helper to convert File to base64 for offline storage\r\n  const fileToB64 = (file: File | Blob): Promise<string> => {\r\n      return new Promise((resolve, reject) => {\r\n          const reader = new FileReader()\r\n          reader.readAsDataURL(file)\r\n          reader.onload = () => resolve(reader.result as string)\r\n          reader.onerror = error => reject(error)\r\n      })\r\n  }\r\n\r\n  if (completed) {\r\n      return (\r\n          <div className=\"min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center space-y-4\">\r\n              <div className=\"w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-500 animate-in zoom-in duration-300\">\r\n                  <CheckCircle size={48} />\r\n              </div>\r\n              <h1 className=\"text-2xl font-bold text-white\">ส่งงานสำเร็จ!</h1>\r\n              <p className=\"text-slate-400\">ขอบคุณสำหรับการทำงาน</p>\r\n              <Button \r\n                onClick={() => router.push(\"/mobile/dashboard\")}\r\n                className=\"w-full bg-emerald-600 hover:bg-emerald-700\"\r\n              >\r\n                  กลับหน้าหลัก\r\n              </Button>\r\n          </div>\r\n      )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-950 pb-24 pt-16 px-4\">\r\n      <MobileHeader title=\"ส่งงาน (POD)\" showBack />\r\n\r\n      {/* Hidden Report Container */}\r\n      {job && (\r\n          <div className=\"fixed left-[-9999px] top-0\">\r\n             <PodReport \r\n                ref={reportRef} \r\n                job={job} \r\n                photos={photos.map(f => URL.createObjectURL(f))} \r\n                signature={signature ? URL.createObjectURL(signature) : null} \r\n             />\r\n          </div>\r\n      )}\r\n\r\n      <div className=\"space-y-6\">\r\n        <section>\r\n            <h2 className=\"text-white font-medium mb-2\">1. ถ่ายรูปสินค้า</h2>\r\n            <CameraInput onImagesChange={setPhotos} maxImages={5} />\r\n            \r\n            {/* AI Verification Feedback */}\r\n            {photos.length > 0 && (\r\n                <div className=\"mt-3 bg-slate-900 border border-slate-800 rounded-lg p-3\">\r\n                    {verifying ? (\r\n                        <div className=\"flex items-center gap-3 text-purple-400 animate-pulse\">\r\n                            <ScanLine className=\"animate-spin-slow\" size={20} />\r\n                            <span className=\"text-sm\">กำลังตรวจสอบคุณภาพรูปภาพ (AI)...</span>\r\n                        </div>\r\n                    ) : verificationResult ? (\r\n                        <div>\r\n                             <div className=\"flex items-center justify-between mb-2\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <BrainCircuit size={16} className={verificationResult.isValid ? \"text-emerald-400\" : \"text-amber-400\"} />\r\n                                    <span className={`text-sm font-bold ${verificationResult.isValid ? \"text-emerald-400\" : \"text-amber-400\"}`}>\r\n                                        AI Score: {verificationResult.score}/100\r\n                                    </span>\r\n                                </div>\r\n                                {verificationResult.isValid && <CheckCircle size={16} className=\"text-emerald-500\" />}\r\n                             </div>\r\n                             \r\n                             {!verificationResult.isValid && (\r\n                                <div className=\"space-y-1\">\r\n                                    {verificationResult.issues.map((issue, i) => (\r\n                                        <div key={i} className=\"flex items-center gap-2 text-xs text-red-400\">\r\n                                            <AlertTriangle size={12} />\r\n                                            {issue}\r\n                                        </div>\r\n                                    ))}\r\n                                    <p className=\"text-xs text-slate-500 mt-1 pl-5\">แนะนำให้ถ่ายใหม่อีกครั้งเพื่อความชัดเจน</p>\r\n                                </div>\r\n                             )}\r\n                        </div>\r\n                    ) : null}\r\n                </div>\r\n            )}\r\n        </section>\r\n\r\n        <section>\r\n            <h2 className=\"text-white font-medium mb-2\">2. ลายเซ็นผู้รับ</h2>\r\n            <SignaturePad onSave={setSignature} />\r\n        </section>\r\n\r\n        <div className=\"space-y-3\">\r\n            <Button \r\n                onClick={handleSubmit}\r\n                disabled={loading}\r\n                className={`w-full h-14 font-bold text-lg shadow-lg transition-all ${\r\n                    photos.length > 0 && signature \r\n                        ? \"bg-gradient-to-r from-blue-600 to-indigo-600 shadow-blue-500/20 text-white\" \r\n                        : \"bg-slate-800 text-slate-400 cursor-not-allowed\"\r\n                }`}\r\n            >\r\n                {loading ? <Loader2 className=\"animate-spin\" /> : \"ยืนยันการส่งงาน\"}\r\n            </Button>\r\n            \r\n            {/* Validation Feedback */}\r\n            <div className=\"text-center space-y-1\">\r\n                {photos.length === 0 && (\r\n                    <p className=\"text-xs text-red-400 animate-pulse\">* กรุณาถ่ายรูปสินค้าอย่างน้อย 1 รูป</p>\r\n                )}\r\n                {!signature && (\r\n                    <p className=\"text-xs text-red-400 animate-pulse\">* กรุณาลงลายเซ็นผู้รับ</p>\r\n                )}\r\n            </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\[id]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Camera' is defined but never used.","line":7,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Camera"},"fix":{"range":[379,387],"text":""},"desc":"Remove unused variable \"Camera\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckSquare' is defined but never used.","line":7,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":71,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckSquare"},"fix":{"range":[387,400],"text":""},"desc":"Remove unused variable \"CheckSquare\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDriverSession } from \"@/lib/actions/auth-actions\"\r\nimport { redirect } from \"next/navigation\"\r\nimport { getJobById } from \"@/lib/supabase/jobs\"\r\nimport { MobileHeader } from \"@/components/mobile/mobile-header\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { MapPin, Phone, User, Package, Navigation, Camera, CheckSquare } from \"lucide-react\"\r\nimport { JobActionButton } from \"@/components/mobile/job-action-button\"\r\n\r\ntype Props = {\r\n  params: Promise<{ id: string }>\r\n}\r\n\r\nexport default async function JobDetailPage(props: Props) {\r\n  const params = await props.params;\r\n  const session = await getDriverSession()\r\n  if (!session) redirect(\"/login\")\r\n\r\n  const job = await getJobById(params.id)\r\n\r\n  if (!job) {\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-950 flex items-center justify-center text-slate-500\">\r\n            ไม่พบข้อมูลงาน\r\n        </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-950 pb-24 pt-16\">\r\n      <MobileHeader title={`งาน #${job.Job_ID.slice(-4)}`} showBack />\r\n\r\n      <div className=\"px-4 space-y-4\">\r\n        {/* Status Banner */}\r\n        <div className={`p-4 rounded-xl flex items-center justify-between ${\r\n             job.Job_Status === 'Completed' ? 'bg-emerald-500/10 border border-emerald-500/20' : \r\n             job.Job_Status === 'In Progress' ? 'bg-blue-500/10 border border-blue-500/20' :\r\n             'bg-slate-800 border border-slate-700'\r\n        }`}>\r\n            <div>\r\n                <p className=\"text-slate-400 text-xs uppercase tracking-wider\">Status</p>\r\n                <p className={`font-bold ${\r\n                    job.Job_Status === 'Completed' ? 'text-emerald-400' : \r\n                    job.Job_Status === 'In Progress' ? 'text-blue-400' :\r\n                    'text-white'\r\n                }`}>{job.Job_Status}</p>\r\n            </div>\r\n            {job.Job_Status !== 'Completed' && (\r\n                <Button size=\"sm\" className=\"bg-blue-600 hover:bg-blue-700 gap-2\">\r\n                    <Navigation size={16} /> นำทาง\r\n                </Button>\r\n            )}\r\n        </div>\r\n\r\n        {/* Customer Info */}\r\n        <Card className=\"bg-slate-900 border-white/10\">\r\n            <CardContent className=\"p-4 space-y-4\">\r\n                <div className=\"flex items-start gap-4\">\r\n                    <div className=\"w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center\">\r\n                        <User className=\"text-slate-400\" />\r\n                    </div>\r\n                    <div>\r\n                        <h3 className=\"text-white font-bold text-lg\">{job.Customer_Name}</h3>\r\n                        <p className=\"text-slate-400 text-sm\">Customer ID: {job.Customer_ID}</p>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div className=\"h-px bg-slate-800\" />\r\n                \r\n                <div className=\"space-y-3\">\r\n                     <div className=\"flex items-start gap-3\">\r\n                        <MapPin className=\"text-orange-500 mt-1\" size={18} />\r\n                        <div>\r\n                            <p className=\"text-slate-500 text-xs\">ปลายทาง</p>\r\n                            <p className=\"text-slate-200 text-sm\">{job.Dest_Location || job.Route_Name}</p>\r\n                        </div>\r\n                     </div>\r\n                     <div className=\"flex items-start gap-3\">\r\n                        <Phone className=\"text-emerald-500 mt-1\" size={18} />\r\n                        <div>\r\n                            <p className=\"text-slate-500 text-xs\">เบอร์ติดต่อ</p>\r\n                            <p className=\"text-slate-200 text-sm text-blue-400 underline\">02-xxx-xxxx</p>\r\n                        </div>\r\n                     </div>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n\r\n        {/* Cargo Info */}\r\n        <Card className=\"bg-slate-900 border-white/10\">\r\n             <CardContent className=\"p-4\">\r\n                <h4 className=\"text-white font-medium mb-3 flex items-center gap-2\">\r\n                    <Package size={18} className=\"text-indigo-400\" /> \r\n                    รายการสินค้า\r\n                </h4>\r\n                <div className=\"bg-slate-950 rounded-lg p-3 space-y-2\">\r\n                    <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-slate-300\">สินค้าทั่วไป (General)</span>\r\n                        <span className=\"text-white font-medium\">10 กล่อง</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between text-sm\">\r\n                        <span className=\"text-slate-300\">น้ำหนักรวม</span>\r\n                        <span className=\"text-white font-medium\">150 Kg</span>\r\n                    </div>\r\n                </div>\r\n             </CardContent>\r\n        </Card>\r\n      \r\n      \r\n        {/* Action Button */}\r\n        <JobActionButton job={job} />\r\n\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\[id]\\pickup\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3133,3136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3133,3136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { useRouter, useParams } from \"next/navigation\"\r\nimport { MobileHeader } from \"@/components/mobile/mobile-header\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { CameraInput } from \"@/components/mobile/camera-input\"\r\nimport { SignaturePad } from \"@/components/mobile/signature-pad\"\r\nimport { PickupReport } from \"@/components/mobile/pickup-report\"\r\nimport { submitJobPickup } from \"@/lib/actions/pod-actions\"\r\nimport { getJobDetails } from \"@/app/mobile/jobs/actions\"\r\nimport { Job } from \"@/lib/supabase/jobs\"\r\nimport { Loader2, Box } from \"lucide-react\"\r\nimport html2canvas from \"html2canvas\"\r\n\r\nexport default function JobPickupPage() {\r\n  const router = useRouter()\r\n  const params = useParams<{ id: string }>()\r\n  const [photos, setPhotos] = useState<File[]>([])\r\n  const [signature, setSignature] = useState<Blob | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  \r\n  // Job Data for Report\r\n  const [job, setJob] = useState<Job | null>(null)\r\n  const reportRef = useRef<HTMLDivElement>(null)\r\n\r\n  useEffect(() => {\r\n    if (params.id) {\r\n        getJobDetails(params.id).then(setJob)\r\n    }\r\n  }, [params.id])\r\n\r\n  const handleSubmit = async () => {\r\n    if (photos.length === 0 || !signature) return\r\n\r\n    setLoading(true)\r\n    \r\n    try {\r\n        const formData = new FormData()\r\n        \r\n        // 1. Capture Report BEFORE sending\r\n        if (reportRef.current && job) {\r\n            try {\r\n                const canvas = await html2canvas(reportRef.current, {\r\n                    scale: 2,\r\n                    useCORS: true,\r\n                    logging: false,\r\n                    windowWidth: 1200\r\n                })\r\n                \r\n                const reportBlob = await new Promise<Blob | null>(resolve => \r\n                    canvas.toBlob(resolve, 'image/jpeg', 0.8)\r\n                )\r\n                \r\n                if (reportBlob) {\r\n                    formData.append(\"pickup_report\", reportBlob, `Pickup_Report_${params.id}.jpg`)\r\n                }\r\n            } catch (err) {\r\n                console.error(\"Pickup Report Generation Failed:\", err)\r\n            }\r\n        }\r\n\r\n        // 2. Append Photos\r\n        photos.forEach((photo, index) => {\r\n            formData.append(`photo_${index}`, photo)\r\n        })\r\n        formData.append(\"photo_count\", photos.length.toString())\r\n        \r\n        // 3. Append Signature\r\n        formData.append(\"signature\", signature, \"signature.png\")\r\n        \r\n        const result = await submitJobPickup(params.id, formData)\r\n        \r\n        if (result.success) {\r\n          if (result.warning) {\r\n            alert(result.warning) // Upload failed but status updated\r\n          }\r\n          router.push(\"/mobile/dashboard\")\r\n        } else {\r\n          alert(result.error)\r\n          setLoading(false)\r\n        }\r\n    } catch (error: unknown) {\r\n        console.error(\"Pickup Submit Error:\", error)\r\n        \r\n        // Check if it's a network error\r\n        const isNetworkError = !navigator.onLine || error instanceof TypeError || (error as any).message?.includes('fetch')\r\n        \r\n        if (isNetworkError) {\r\n             const { saveJobOffline } = await import(\"@/lib/utils/offline-storage\")\r\n             \r\n             // Convert to base64 for storage\r\n             const photoBase64 = await Promise.all(photos.map(fileToB64))\r\n             const sigBase64 = signature ? await fileToB64(signature as File) : null\r\n             \r\n             // Capture report if possible (already handled in formData step above, but we need raw blobs)\r\n             // For simplicity, we just save the photos and signature\r\n             const offlineData = {\r\n                 photos: photoBase64,\r\n                 signature: sigBase64,\r\n                 photo_count: photos.length\r\n             }\r\n             \r\n             saveJobOffline(params.id, offlineData, 'PICKUP')\r\n             alert(\"โหมดออฟไลน์: บันทึกรับสินค้าลงเครื่องแล้ว ระบบจะส่งข้อมูลเมื่อมีสัญญาณ\")\r\n             router.push(\"/mobile/dashboard\")\r\n        } else {\r\n            alert(\"เกิดข้อผิดพลาดในการส่งข้อมูล\")\r\n            setLoading(false)\r\n        }\r\n    }\r\n  }\r\n\r\n  // Helper to convert File to base64 for offline storage\r\n  const fileToB64 = (file: File | Blob): Promise<string> => {\r\n      return new Promise((resolve, reject) => {\r\n          const reader = new FileReader()\r\n          reader.readAsDataURL(file)\r\n          reader.onload = () => resolve(reader.result as string)\r\n          reader.onerror = error => reject(error)\r\n      })\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-950 pb-24 pt-16 px-4\">\r\n      <MobileHeader title=\"รับสินค้า (Pickup)\" showBack />\r\n\r\n      {/* Hidden Report Container for html2canvas */}\r\n      {job && (\r\n          <div className=\"fixed left-[-9999px] top-0\">\r\n             <PickupReport \r\n                ref={reportRef} \r\n                job={job} \r\n                photos={photos.map(f => URL.createObjectURL(f))} \r\n                signature={signature ? URL.createObjectURL(signature) : null} \r\n             />\r\n          </div>\r\n      )}\r\n\r\n      <div className=\"space-y-6\">\r\n        <section className=\"space-y-4\">\r\n             <div className=\"flex items-center gap-3 text-white\">\r\n                <div className=\"w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-500\">\r\n                    <Box size={20} />\r\n                </div>\r\n                <div>\r\n                    <h2 className=\"font-bold\">ยืนยันการรับสินค้า</h2>\r\n                    <p className=\"text-sm text-slate-400\">ถ่ายรูปสินค้าเพื่อยืนยันสภาพก่อนขนส่ง</p>\r\n                </div>\r\n             </div>\r\n\r\n            <CameraInput onImagesChange={setPhotos} maxImages={10} />\r\n        </section>\r\n\r\n        <section>\r\n            <h2 className=\"text-white font-medium mb-2\">2. ลายเซ็นผู้ส่งของ</h2>\r\n            <SignaturePad onSave={setSignature} />\r\n        </section>\r\n\r\n        <Button \r\n            onClick={handleSubmit}\r\n            disabled={photos.length === 0 || !signature || loading}\r\n            className={`w-full h-14 font-bold text-lg shadow-lg transition-all ${\r\n                photos.length > 0 && signature \r\n                    ? \"bg-gradient-to-r from-amber-600 to-orange-600 shadow-amber-500/20 text-white\" \r\n                    : \"bg-slate-800 text-slate-400 cursor-not-allowed\"\r\n            }`}\r\n        >\r\n            {loading ? <Loader2 className=\"animate-spin\" /> : \"ยืนยันการรับสินค้า / ออกเดินทาง\"}\r\n        </Button>\r\n      </div>\r\n\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'location' is defined but never used.","line":6,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":78}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\n\r\nexport async function updateJobStatus(jobId: string, status: string, location?: string) {\r\n  const supabase = await createClient()\r\n\r\n  // 1. Update Job Status\r\n  const { error } = await supabase\r\n    .from('Jobs_Main')\r\n    .update({ \r\n        Job_Status: status,\r\n        // Optional: Update actual timestamps based on status if needed\r\n        // e.g. Actual_Pickup_Time when Arrived Pickup, etc.\r\n    })\r\n    .eq('Job_ID', jobId)\r\n\r\n  if (error) {\r\n    console.error('Error updating job status:', error)\r\n    return { success: false, message: 'Failed to update status' }\r\n  }\r\n\r\n  // 2. Log History/Tracking (Optional but recommended)\r\n  // For now, we assume simple status update is enough\r\n\r\n  revalidatePath(`/mobile/jobs/${jobId}`)\r\n  revalidatePath('/mobile/jobs')\r\n  revalidatePath('/monitoring') // Update live ops\r\n  \r\n  return { success: true, message: 'Status updated successfully' }\r\n}\r\n\r\nimport { getJobById } from \"@/lib/supabase/jobs\"\r\n\r\nexport async function getJobDetails(jobId: string) {\r\n    const job = await getJobById(jobId)\r\n    return job\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\jobs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\maintenance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\map\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\map\\page.tsx:25:7\n  23 |   useEffect(() => {\n  24 |     if (!navigator.geolocation) {\n> 25 |       setLocationError('Geolocation is not supported')\n     |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  26 |       setIsLoading(false)\n  27 |       return\n  28 |     }","line":25,"column":7,"nodeType":null,"endLine":25,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport dynamic from 'next/dynamic'\nimport { useState, useEffect } from 'react'\nimport { MapPin, Navigation, ExternalLink } from \"lucide-react\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\n\nconst LeafletMap = dynamic(() => import('@/components/maps/leaflet-map'), {\n  ssr: false,\n  loading: () => (\n    <div className=\"h-64 bg-slate-800 rounded-lg flex items-center justify-center\">\n      <div className=\"text-slate-400 animate-pulse\">Loading Map...</div>\n    </div>\n  )\n})\n\nexport default function MobileMapPage() {\n  const [currentPosition, setCurrentPosition] = useState<[number, number] | null>(null)\n  const [locationError, setLocationError] = useState<string | null>(null)\n  const [isLoading, setIsLoading] = useState(true)\n\n  useEffect(() => {\n    if (!navigator.geolocation) {\n      setLocationError('Geolocation is not supported')\n      setIsLoading(false)\n      return\n    }\n\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        setCurrentPosition([position.coords.latitude, position.coords.longitude])\n        setIsLoading(false)\n      },\n      (error) => {\n        setLocationError(error.message)\n        setIsLoading(false)\n      },\n      { enableHighAccuracy: true }\n    )\n\n    // Watch position for updates\n    const watchId = navigator.geolocation.watchPosition(\n      (position) => {\n        setCurrentPosition([position.coords.latitude, position.coords.longitude])\n      },\n      undefined,\n      { enableHighAccuracy: true }\n    )\n\n    return () => navigator.geolocation.clearWatch(watchId)\n  }, [])\n\n  const openGoogleMaps = () => {\n    if (currentPosition) {\n      const url = `https://www.google.com/maps?q=${currentPosition[0]},${currentPosition[1]}`\n      window.open(url, '_blank')\n    }\n  }\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <h1 className=\"text-xl font-bold text-white\">Navigation</h1>\n      \n      {/* Map */}\n      <Card className=\"bg-slate-900 border-slate-800 overflow-hidden\">\n        {isLoading ? (\n          <div className=\"h-64 flex items-center justify-center bg-slate-800\">\n            <p className=\"text-slate-400 animate-pulse\">Getting your location...</p>\n          </div>\n        ) : locationError ? (\n          <div className=\"h-64 flex items-center justify-center bg-slate-800\">\n            <p className=\"text-red-400\">Error: {locationError}</p>\n          </div>\n        ) : currentPosition ? (\n          <LeafletMap \n            currentPosition={currentPosition}\n            showCurrentPosition={true}\n            height=\"256px\"\n            zoom={15}\n          />\n        ) : null}\n      </Card>\n\n      {/* Current Location Card */}\n      <Card className=\"bg-slate-900 border-slate-800\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm text-slate-400 flex items-center gap-2\">\n            <MapPin className=\"w-4 h-4 text-blue-400\" />\n            Current Location\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {currentPosition ? (\n            <>\n              <p className=\"text-white font-medium\">ตำแหน่งปัจจุบัน</p>\n              <p className=\"text-xs text-slate-500 mt-1\">\n                Lat: {currentPosition[0].toFixed(6)}, Lng: {currentPosition[1].toFixed(6)}\n              </p>\n            </>\n          ) : (\n            <p className=\"text-slate-500\">กำลังระบุตำแหน่ง...</p>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Actions */}\n      <div className=\"space-y-2\">\n        <Button \n          className=\"w-full bg-blue-600 hover:bg-blue-700\"\n          onClick={openGoogleMaps}\n          disabled={!currentPosition}\n        >\n          <ExternalLink className=\"w-4 h-4 mr-2\" />\n          Open in Google Maps\n        </Button>\n      </div>\n\n      {/* Next Destination */}\n      <Card className=\"bg-slate-900 border-slate-800\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm text-slate-400 flex items-center gap-2\">\n            <Navigation className=\"w-4 h-4 text-emerald-400\" />\n            Next Destination\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-white font-medium\">ไม่มีงานวันนี้</p>\n          <p className=\"text-xs text-slate-500 mt-1\">รอรับงานจากระบบ</p>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\profile\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\scan\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\sos\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":7,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[287,295],"text":""},"desc":"Remove unused variable \"MapPin\"."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\sos\\page.tsx:54:9\n  52 |         )\n  53 |     } else {\n> 54 |         setAddress(\"อุปกรณ์ไม่รองรับ GPS\")\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  55 |         setLoading(false)\n  56 |     }\n  57 |   }, [])","line":54,"column":9,"nodeType":null,"endLine":54,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { MobileHeader } from \"@/components/mobile/mobile-header\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Phone, AlertTriangle, ShieldAlert, Ambulance, MapPin, ExternalLink } from \"lucide-react\"\r\nimport { getCompanyProfile, CompanyProfile } from \"@/lib/supabase/settings\"\r\n\r\nexport default function MobileSOSPage() {\r\n  const [profile, setProfile] = useState<CompanyProfile | null>(null)\r\n  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null)\r\n  const [address, setAddress] = useState<string>(\"กำลังค้นหาพิกัด...\")\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    // 1. Fetch Company Profile for Phone Number\r\n    const fetchProfile = async () => {\r\n        try {\r\n            const data = await getCompanyProfile()\r\n            setProfile(data)\r\n        } catch (error) {\r\n            console.error(error)\r\n        }\r\n    }\r\n    fetchProfile()\r\n\r\n    // 2. Get Geolocation\r\n    if (\"geolocation\" in navigator) {\r\n        navigator.geolocation.getCurrentPosition(\r\n            async (position) => {\r\n                const { latitude, longitude } = position.coords\r\n                setLocation({ lat: latitude, lng: longitude })\r\n                setAddress(`${latitude.toFixed(6)}, ${longitude.toFixed(6)}`)\r\n                setLoading(false)\r\n                \r\n                // Optional: Reverse Geocoding API could go here\r\n                try {\r\n                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)\r\n                    const data = await res.json()\r\n                    if (data.display_name) {\r\n                        setAddress(data.display_name)\r\n                    }\r\n                } catch {}\r\n            },\r\n            (error) => {\r\n                console.error(\"GPS Error:\", error)\r\n                setAddress(\"ไม่สามารถระบุพิกัดได้\")\r\n                setLoading(false)\r\n            },\r\n            { enableHighAccuracy: true, timeout: 10000 }\r\n        )\r\n    } else {\r\n        setAddress(\"อุปกรณ์ไม่รองรับ GPS\")\r\n        setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  const handleCall = (number?: string) => {\r\n    if (number) window.location.href = `tel:${number}`\r\n  }\r\n\r\n  const openMap = () => {\r\n    if (location) {\r\n        window.open(`https://www.google.com/maps?q=${location.lat},${location.lng}`, '_blank')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-950 pb-24 pt-16 px-4\">\r\n      <MobileHeader title=\"ขอความช่วยเหลือ (SOS)\" showBack />\r\n\r\n      <div className=\"space-y-6 text-center\">\r\n        \r\n        <div className=\"py-6 animate-pulse\">\r\n            <div className=\"w-24 h-24 mx-auto bg-red-500/20 rounded-full flex items-center justify-center border-4 border-red-500/50 shadow-[0_0_30px_rgba(239,68,68,0.4)]\">\r\n                <ShieldAlert size={48} className=\"text-red-500\" />\r\n            </div>\r\n        </div>\r\n\r\n        <div className=\"space-y-2\">\r\n            <h1 className=\"text-2xl font-bold text-white\">ฉุกเฉิน / อุบัติเหตุ</h1>\r\n            <p className=\"text-slate-400\">\r\n                กดปุ่มด้านล่างเพื่อโทรออกทันที\r\n            </p>\r\n        </div>\r\n\r\n        <div className=\"grid gap-4\">\r\n            <Button \r\n                onClick={() => handleCall(profile?.phone || \"021234567\")} \r\n                className=\"h-20 text-lg font-bold bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 flex flex-col items-center justify-center gap-1\"\r\n            >\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Phone size={24} />\r\n                    <span>ติดต่อแอดมิน / หัวหน้างาน</span>\r\n                </div>\r\n                <span className=\"text-xs font-normal opacity-80\">\r\n                    {profile?.phone || \"02-123-4567\"}\r\n                </span>\r\n            </Button>\r\n\r\n            <Button \r\n                onClick={() => handleCall(\"191\")}\r\n                className=\"h-20 text-lg font-bold bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/20 flex flex-col items-center justify-center gap-1\"\r\n            >\r\n                <div className=\"flex items-center gap-2\">\r\n                    <AlertTriangle size={24} />\r\n                    <span>แจ้งเหตุด่วน (ตำรวจ)</span>\r\n                </div>\r\n                <span className=\"text-xs font-normal opacity-80\">191</span>\r\n            </Button>\r\n\r\n            <Button \r\n                onClick={() => handleCall(\"1669\")}\r\n                className=\"h-20 text-lg font-bold bg-amber-600 hover:bg-amber-700 shadow-lg shadow-amber-500/20 flex flex-col items-center justify-center gap-1\"\r\n            >\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Ambulance size={24} />\r\n                    <span>เรียกรถพยาบาล</span>\r\n                </div>\r\n                <span className=\"text-xs font-normal opacity-80\">1669</span>\r\n            </Button>\r\n            \r\n             <Button \r\n                onClick={() => handleCall(\"1554\")}\r\n                variant=\"outline\"\r\n                className=\"h-16 text-slate-300 border-slate-700 hover:bg-slate-800\"\r\n            >\r\n                หน่วยกู้ภัย (1554)\r\n            </Button>\r\n        </div>\r\n\r\n        <Card className=\"bg-slate-900 border-slate-800 mt-8 text-left\">\r\n            <CardContent className=\"p-4\">\r\n                <div className=\"flex justify-between items-start mb-2\">\r\n                    <h3 className=\"text-slate-200 font-medium flex items-center gap-2\">\r\n                        <div className={`w-2 h-2 rounded-full ${loading ? \"bg-yellow-500\" : \"bg-emerald-500\"} animate-pulse`} />\r\n                        พิกัดปัจจุบันของคุณ\r\n                    </h3>\r\n                    {location && (\r\n                        <Button variant=\"ghost\" size=\"sm\" onClick={openMap} className=\"h-6 text-indigo-400 p-0 hover:text-indigo-300\">\r\n                            <ExternalLink size={14} className=\"mr-1\" /> เปิดแผนที่\r\n                        </Button>\r\n                    )}\r\n                </div>\r\n                \r\n                <p className=\"text-slate-400 text-sm break-words\">\r\n                    {loading ? \"กำลังระบุตำแหน่ง...\" : address}\r\n                </p>\r\n                \r\n                {location && (\r\n                     <p className=\"text-xs text-slate-500 mt-1 font-mono\">\r\n                        {location.lat.toFixed(6)}, {location.lng.toFixed(6)}\r\n                    </p>\r\n                )}\r\n\r\n                <p className=\"text-[10px] text-slate-600 mt-2\">\r\n                    *พิกัดจะถูกส่งให้แอดมินอัตโนมัติเมื่อกดโทรออก\r\n                </p>\r\n            </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\mobile\\vehicle-check\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\monitoring\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\planning\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\planning\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\pod\\page.tsx","messages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":62,"column":13,"nodeType":"JSXOpeningElement","endLine":62,"endColumn":58},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":120,"column":27,"nodeType":"JSXOpeningElement","endLine":120,"endColumn":83}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = 'force-dynamic'\r\n\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { \r\n  FileText, \r\n  Search,\r\n  Download,\r\n  Image,\r\n  PenTool,\r\n  CheckCircle2,\r\n  Clock,\r\n  AlertCircle,\r\n} from \"lucide-react\"\r\nimport { getAllPODs, getPODStats } from \"@/lib/supabase/pod\"\r\n\r\nexport default async function PODPage() {\r\n  const [{ data: pods }, stats] = await Promise.all([\r\n    getAllPODs(1, 50),\r\n    getPODStats(),\r\n  ])\r\n\r\n  const statusConfig: Record<string, { label: string; color: string; icon: React.ReactNode }> = {\r\n    Delivered: { label: \"ส่งแล้ว\", color: \"text-emerald-400 bg-emerald-500/20\", icon: <CheckCircle2 size={14} /> },\r\n    Complete: { label: \"เสร็จสิ้น\", color: \"text-emerald-400 bg-emerald-500/20\", icon: <CheckCircle2 size={14} /> },\r\n    \"In Transit\": { label: \"กำลังส่ง\", color: \"text-amber-400 bg-amber-500/20\", icon: <Clock size={14} /> },\r\n    \"Picked Up\": { label: \"รับแล้ว\", color: \"text-blue-400 bg-blue-500/20\", icon: <Clock size={14} /> },\r\n    Failed: { label: \"ล้มเหลว\", color: \"text-red-400 bg-red-500/20\", icon: <AlertCircle size={14} /> },\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Page Header */}\r\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-white mb-2 flex items-center gap-3\">\r\n            <FileText className=\"text-indigo-400\" />\r\n            จัดการ POD\r\n          </h1>\r\n          <p className=\"text-slate-400\">Proof of Delivery - หลักฐานการจัดส่ง</p>\r\n        </div>\r\n        <Button size=\"lg\" className=\"gap-2\">\r\n          <Download size={20} />\r\n          ดาวน์โหลดรายงาน\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Stats */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\r\n        <div className=\"rounded-xl p-4 bg-indigo-500/10 border border-indigo-500/20\">\r\n          <p className=\"text-2xl font-bold text-indigo-400\">{stats.total}</p>\r\n          <p className=\"text-xs text-slate-400\">งานวันนี้</p>\r\n        </div>\r\n        <div className=\"rounded-xl p-4 bg-emerald-500/10 border border-emerald-500/20\">\r\n          <p className=\"text-2xl font-bold text-emerald-400\">{stats.complete}</p>\r\n          <p className=\"text-xs text-slate-400\">ส่งสำเร็จ</p>\r\n        </div>\r\n        <div className=\"rounded-xl p-4 bg-blue-500/10 border border-blue-500/20\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Image size={16} className=\"text-blue-400\" />\r\n            <p className=\"text-2xl font-bold text-blue-400\">{stats.withPhoto}</p>\r\n          </div>\r\n          <p className=\"text-xs text-slate-400\">มีรูปถ่าย</p>\r\n        </div>\r\n        <div className=\"rounded-xl p-4 bg-purple-500/10 border border-purple-500/20\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <PenTool size={16} className=\"text-purple-400\" />\r\n            <p className=\"text-2xl font-bold text-purple-400\">{stats.withSignature}</p>\r\n          </div>\r\n          <p className=\"text-xs text-slate-400\">มีลายเซ็น</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Search */}\r\n      <div className=\"mb-6\">\r\n        <div className=\"relative\">\r\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" size={18} />\r\n          <Input placeholder=\"ค้นหา Job ID, ลูกค้า, คนขับ...\" className=\"pl-10 h-11\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* POD Table */}\r\n      <Card variant=\"glass\">\r\n        <CardContent className=\"p-0\">\r\n          {pods.length === 0 ? (\r\n            <div className=\"text-center py-12 text-slate-500\">\r\n              ไม่พบข้อมูล POD\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead>\r\n                  <tr className=\"border-b border-white/10\">\r\n                    <th className=\"text-left p-4 text-xs font-medium text-slate-400 uppercase\">Job ID</th>\r\n                    <th className=\"text-left p-4 text-xs font-medium text-slate-400 uppercase\">วันที่</th>\r\n                    <th className=\"text-left p-4 text-xs font-medium text-slate-400 uppercase\">ลูกค้า</th>\r\n                    <th className=\"text-left p-4 text-xs font-medium text-slate-400 uppercase\">คนขับ</th>\r\n                    <th className=\"text-center p-4 text-xs font-medium text-slate-400 uppercase\">รูปถ่าย</th>\r\n                    <th className=\"text-center p-4 text-xs font-medium text-slate-400 uppercase\">ลายเซ็น</th>\r\n                    <th className=\"text-left p-4 text-xs font-medium text-slate-400 uppercase\">สถานะ</th>\r\n                    <th className=\"text-right p-4 text-xs font-medium text-slate-400 uppercase\">Actions</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {pods.map((pod) => (\r\n                    <tr \r\n                      key={pod.Job_ID} \r\n                      className=\"border-b border-white/5 hover:bg-white/5 transition-colors\"\r\n                    >\r\n                      <td className=\"p-4\">\r\n                        <span className=\"text-indigo-400 font-medium text-sm\">{pod.Job_ID}</span>\r\n                      </td>\r\n                      <td className=\"p-4 text-sm text-slate-300\">{pod.Plan_Date || \"-\"}</td>\r\n                      <td className=\"p-4 text-sm text-white\">{pod.Customer_Name || \"-\"}</td>\r\n                      <td className=\"p-4 text-sm text-slate-300\">{pod.Driver_Name || \"-\"}</td>\r\n                      <td className=\"p-4 text-center\">\r\n                        {pod.Photo_Proof_Url ? (\r\n                          <Image size={18} className=\"mx-auto text-emerald-400\" />\r\n                        ) : (\r\n                          <span className=\"text-slate-500\">-</span>\r\n                        )}\r\n                      </td>\r\n                      <td className=\"p-4 text-center\">\r\n                        {pod.Signature_Url ? (\r\n                          <PenTool size={18} className=\"mx-auto text-purple-400\" />\r\n                        ) : (\r\n                          <span className=\"text-slate-500\">-</span>\r\n                        )}\r\n                      </td>\r\n                      <td className=\"p-4\">\r\n                        <span className={`flex items-center gap-1 w-fit px-2 py-0.5 rounded-full text-xs font-medium ${\r\n                          statusConfig[pod.Job_Status]?.color || 'text-slate-400 bg-slate-500/20'\r\n                        }`}>\r\n                          {statusConfig[pod.Job_Status]?.icon}\r\n                          {statusConfig[pod.Job_Status]?.label || pod.Job_Status}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"p-4 text-right\">\r\n                        <Button variant=\"ghost\" size=\"sm\">ดูรายละเอียด</Button>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\reports\\actions.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[471,474],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[471,474],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\reports\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":4,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[140,152],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":4,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardTitle"},"fix":{"range":[152,163],"text":""},"desc":"Remove unused variable \"CardTitle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[250,265],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = 'force-dynamic'\r\n\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { \r\n  BarChart3, \r\n  Package,\r\n  Fuel,\r\n  Wrench,\r\n  TrendingUp,\r\n  Users,\r\n  Truck,\r\n} from \"lucide-react\"\r\nimport { getAllJobs } from \"@/lib/supabase/jobs\"\r\nimport { getDriverStats } from \"@/lib/supabase/drivers\"\r\nimport { getVehicleStats } from \"@/lib/supabase/vehicles\"\r\nimport { getTodayFuelStats } from \"@/lib/supabase/fuel\"\r\nimport { getRepairTicketStats } from \"@/lib/supabase/maintenance\"\r\nimport { ReportBuilder } from \"@/components/reports/report-builder\"\r\n\r\nexport default async function ReportsPage() {\r\n  const [{ count: jobCount }, driverStats, vehicleStats, fuelStats, maintenanceStats] = await Promise.all([\r\n    getAllJobs(1, 1),\r\n    getDriverStats(),\r\n    getVehicleStats(),\r\n    getTodayFuelStats(),\r\n    getRepairTicketStats(),\r\n  ])\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Page Header */}\r\n      <div className=\"mb-8\">\r\n        <h1 className=\"text-3xl font-bold text-foreground mb-2 flex items-center gap-3\">\r\n          <BarChart3 className=\"text-cyan-400\" />\r\n          รายงาน\r\n        </h1>\r\n        <p className=\"text-muted-foreground\">สร้างและดาวน์โหลดรายงานด้วยตัวกรองแบบ Interactive</p>\r\n      </div>\r\n\r\n      {/* Quick Stats Overview */}\r\n      <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4 mb-8\">\r\n        <Card className=\"bg-card/50 border-border\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Package size={20} className=\"mx-auto text-indigo-400 mb-2\" />\r\n            <p className=\"text-2xl font-bold text-foreground\">{jobCount}</p>\r\n            <p className=\"text-xs text-muted-foreground\">งานทั้งหมด</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-card/50 border-border\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Users size={20} className=\"mx-auto text-blue-400 mb-2\" />\r\n            <p className=\"text-2xl font-bold text-foreground\">{driverStats.total}</p>\r\n            <p className=\"text-xs text-muted-foreground\">คนขับ ({driverStats.active} Active)</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-card/50 border-border\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Truck size={20} className=\"mx-auto text-purple-400 mb-2\" />\r\n            <p className=\"text-2xl font-bold text-foreground\">{vehicleStats.total}</p>\r\n            <p className=\"text-xs text-muted-foreground\">รถ ({vehicleStats.active} Active)</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-card/50 border-border\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Fuel size={20} className=\"mx-auto text-emerald-400 mb-2\" />\r\n            <p className=\"text-2xl font-bold text-foreground\">฿{fuelStats.totalAmount.toLocaleString()}</p>\r\n            <p className=\"text-xs text-muted-foreground\">ค่าน้ำมันวันนี้</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card className=\"bg-card/50 border-border\">\r\n          <CardContent className=\"p-4 text-center\">\r\n            <Wrench size={20} className=\"mx-auto text-amber-400 mb-2\" />\r\n            <p className=\"text-2xl font-bold text-foreground\">{maintenanceStats.pending}</p>\r\n            <p className=\"text-xs text-muted-foreground\">รอดำเนินการ</p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Interactive Report Builder */}\r\n      <ReportBuilder />\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\routes\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":21,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Link"},"fix":{"range":[477,486],"text":""},"desc":"Remove unused variable \"Link\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used.","line":53,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2576,2579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2576,2579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  MapPin,\r\n  Plus,\r\n  Search,\r\n  Edit,\r\n  Trash2,\r\n  Save,\r\n  X,\r\n  Loader2,\r\n  Navigation,\r\n  Globe,\r\n  FileSpreadsheet,\r\n  Link,\r\n  Ruler,\r\n  Building2,\r\n} from \"lucide-react\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { \r\n  getAllRoutes, \r\n  createRoute, \r\n  updateRoute, \r\n  deleteRoute, \r\n  createBulkRoutes,\r\n  getUniqueLocations,\r\n  Route,\r\n} from \"@/lib/supabase/routes\"\r\nimport { ExcelImport } from \"@/components/ui/excel-import\"\r\nimport { LocationAutocomplete } from \"@/components/location-autocomplete\"\r\nimport { useBranch } from \"@/components/providers/branch-provider\"\r\n\r\nexport default function RoutesPage() {\r\n  const { selectedBranch, branches, isAdmin } = useBranch()\r\n  \r\n  const [routes, setRoutes] = useState<Route[]>([])\r\n  const [locations, setLocations] = useState<string[]>([])\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  \r\n  const [isDialogOpen, setIsDialogOpen] = useState(false)\r\n  const [editingRoute, setEditingRoute] = useState<Route | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [saving, setSaving] = useState(false)\r\n  \r\n  const [formData, setFormData] = useState<Partial<Route>>({\r\n    Route_Name: \"\",\r\n    Origin: \"\",\r\n    Map_Link_Origin: \"\",\r\n    Destination: \"\",\r\n    Map_Link_Destination: \"\",\r\n    Distance_KM: null,\r\n    Branch_ID: \"\"\r\n  })\r\n\r\n  // Re-fetch when branch changes globally\r\n  const fetchData = useCallback(async () => {\r\n    setLoading(true)\r\n    const [routesData, locationsData] = await Promise.all([\r\n      getAllRoutes(1, 100, searchQuery, selectedBranch),\r\n      getUniqueLocations()\r\n    ])\r\n    \r\n    setRoutes(routesData.data)\r\n    setLocations(locationsData)\r\n    setLoading(false)\r\n  }, [searchQuery, selectedBranch]) \r\n\r\n  useEffect(() => {\r\n    fetchData()\r\n  }, [fetchData])\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      fetchData()\r\n    }, 500)\r\n    return () => clearTimeout(timer)\r\n  }, [searchQuery, selectedBranch, fetchData])\r\n\r\n  const updateForm = (field: keyof Route, value: any) => {\r\n    setFormData(prev => ({ ...prev, [field]: value }))\r\n  }\r\n\r\n  const resetForm = () => {\r\n    setFormData({\r\n        Route_Name: \"\",\r\n        Origin: \"\",\r\n        Map_Link_Origin: \"\",\r\n        Destination: \"\",\r\n        Map_Link_Destination: \"\",\r\n        Distance_KM: null,\r\n        // Auto-select branch if strictly one is selected\r\n        Branch_ID: (selectedBranch && selectedBranch !== \"All\") ? selectedBranch : \"\"\r\n    })\r\n    setEditingRoute(null)\r\n  }\r\n\r\n  const handleOpenDialog = (route?: Route) => {\r\n    if (route) {\r\n      setEditingRoute(route)\r\n      setFormData(route)\r\n    } else {\r\n      resetForm()\r\n    }\r\n    setIsDialogOpen(true)\r\n  }\r\n\r\n  const handleSave = async () => {\r\n    if (!formData.Route_Name) {\r\n      alert(\"กรุณาระบุชื่อเส้นทาง\")\r\n      return\r\n    }\r\n\r\n    setSaving(true)\r\n    try {\r\n      if (editingRoute) {\r\n        // Update\r\n        const result = await updateRoute(editingRoute.Route_Name, formData)\r\n        if (!result.success) throw result.error\r\n      } else {\r\n        // Create\r\n        const result = await createRoute(formData)\r\n        if (!result.success) throw result.error\r\n      }\r\n      \r\n      setIsDialogOpen(false)\r\n      resetForm()\r\n      fetchData()\r\n    } catch (e) {\r\n      console.error(e)\r\n      alert(\"เกิดข้อผิดพลาดในการบันทึก\")\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const handleDelete = async (routeName: string) => {\r\n    if (confirm(`ยืนยันลบเส้นทาง \"${routeName}\"?`)) {\r\n      await deleteRoute(routeName)\r\n      fetchData()\r\n    }\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex flex-col gap-4 mb-6\">\r\n        <div className=\"flex justify-between items-center\">\r\n            <div>\r\n            <h1 className=\"text-2xl font-bold text-white flex items-center gap-3\">\r\n                <Navigation className=\"text-blue-400\" />\r\n                จัดการเส้นทาง (Routes)\r\n            </h1>\r\n            <p className=\"text-sm text-slate-400 mt-1\">กำหนดจุดรับ-ส่งสินค้า GPS และระยะทาง</p>\r\n            </div>\r\n            <div className=\"flex gap-2\">\r\n                <ExcelImport \r\n                    trigger={\r\n                        <Button variant=\"outline\" className=\"gap-2 border-slate-700 hover:bg-slate-800\">\r\n                            <FileSpreadsheet size={16} /> \r\n                            นำเข้า Excel\r\n                        </Button>\r\n                    }\r\n                    title=\"นำเข้าเส้นทาง\"\r\n                    onImport={createBulkRoutes}\r\n                    templateData={[\r\n                        { Route_Name: \"เส้นทาง A\", Origin: \"จุด A\", Destination: \"จุด B\", Distance_KM: \"10.5\", Map_Link_Origin: \"https://...\", Map_Link_Destination: \"https://...\", Branch_ID: \"HQ\" }\r\n                    ]}\r\n                    templateFilename=\"template_routes.xlsx\"\r\n                />\r\n                <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\r\n            <DialogTrigger asChild>\r\n                <Button onClick={() => handleOpenDialog()} className=\"bg-blue-600 hover:bg-blue-700\">\r\n                <Plus className=\"w-4 h-4 mr-2\" /> เพิ่มเส้นทาง\r\n                </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"bg-slate-900 border-slate-800 max-w-lg\">\r\n                <DialogHeader>\r\n                <DialogTitle className=\"text-white\">\r\n                    {editingRoute ? \"แก้ไขเส้นทาง\" : \"เพิ่มเส้นทางใหม่\"}\r\n                </DialogTitle>\r\n                </DialogHeader>\r\n                \r\n                <div className=\"space-y-4 mt-4\">\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400\">ชื่อเส้นทาง * (ไม่สามารถซ้ำได้)</Label>\r\n                    <Input\r\n                    value={formData.Route_Name || \"\"}\r\n                    onChange={(e) => updateForm(\"Route_Name\", e.target.value)}\r\n                    placeholder=\"เช่น เส้นทาง A, คลังสินค้า B\"\r\n                    className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    disabled={!!editingRoute} // Disable renaming if it is PK\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400 flex items-center gap-1\">\r\n                        <Building2 className=\"w-3 h-3\" /> สาขา (Branch)\r\n                    </Label>\r\n                    <Select \r\n                        value={formData.Branch_ID || \"\"} \r\n                        onValueChange={(value) => updateForm(\"Branch_ID\", value)}\r\n                    >\r\n                        <SelectTrigger className=\"bg-slate-800 border-slate-700 text-white\">\r\n                        <SelectValue placeholder=\"เลือกสาขา\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent className=\"bg-slate-800 border-slate-700 text-white\">\r\n                        {branches.map(b => (\r\n                            <SelectItem key={b.Branch_ID} value={b.Branch_ID}>\r\n                            {b.Branch_Name} ({b.Branch_ID})\r\n                            </SelectItem>\r\n                        ))}\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400\">ต้นทาง</Label>\r\n                    <LocationAutocomplete\r\n                        value={formData.Origin || \"\"}\r\n                        onChange={(val) => updateForm(\"Origin\", val)}\r\n                        locations={locations}\r\n                        placeholder=\"ระบุต้นทาง\"\r\n                        className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400\">ลิ้งค์แผนที่ต้นทาง</Label>\r\n                    <Input\r\n                        value={formData.Map_Link_Origin || \"\"}\r\n                        onChange={(e) => updateForm(\"Map_Link_Origin\", e.target.value)}\r\n                        placeholder=\"https://maps.google.com/...\"\r\n                        className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400\">ปลายทาง</Label>\r\n                    <LocationAutocomplete\r\n                        value={formData.Destination || \"\"}\r\n                        onChange={(val) => updateForm(\"Destination\", val)}\r\n                        locations={locations}\r\n                        placeholder=\"ระบุปลายทาง\"\r\n                        className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400\">ลิ้งค์แผนที่ปลายทาง</Label>\r\n                    <Input\r\n                        value={formData.Map_Link_Destination || \"\"}\r\n                        onChange={(e) => updateForm(\"Map_Link_Destination\", e.target.value)}\r\n                        placeholder=\"https://maps.google.com/...\"\r\n                        className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-400 flex items-center gap-1\">\r\n                        <Ruler className=\"w-3 h-3\" /> ระยะทาง (กม.)\r\n                    </Label>\r\n                    <Input\r\n                        type=\"number\"\r\n                        value={formData.Distance_KM || \"\"}\r\n                        onChange={(e) => updateForm(\"Distance_KM\", parseFloat(e.target.value))}\r\n                        placeholder=\"0.0\"\r\n                        className=\"bg-slate-800 border-slate-700 text-white\"\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"flex gap-3 pt-4\">\r\n                    <Button onClick={handleSave} disabled={saving} className=\"flex-1 bg-blue-600 hover:bg-blue-700\">\r\n                    {saving ? <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> : <Save className=\"w-4 h-4 mr-2\" />}\r\n                    บันทึก\r\n                    </Button>\r\n                    <Button variant=\"outline\" onClick={() => setIsDialogOpen(false)} className=\"flex-1 border-slate-700\">\r\n                    <X className=\"w-4 h-4 mr-2\" /> ยกเลิก\r\n                    </Button>\r\n                </div>\r\n                </div>\r\n            </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n        </div>\r\n\r\n        {/* Filters Row */}\r\n        <div className=\"flex gap-4 items-center\">\r\n            \r\n            <div className=\"flex-1 relative\">\r\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500\" />\r\n                <Input\r\n                    value={searchQuery}\r\n                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                    placeholder=\"ค้นหาชื่อเส้นทาง...\"\r\n                    className=\"pl-10 bg-slate-900 border-slate-800 text-white h-10\"\r\n                />\r\n            </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Routes Grid */}\r\n      {loading ? (\r\n        <div className=\"text-slate-400 text-center py-12 flex items-center justify-center gap-2\">\r\n            <Loader2 className=\"animate-spin\" /> กำลังโหลดข้อมูล...\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n          {routes.map((route) => (\r\n            <Card key={route.Route_Name} className=\"bg-slate-900/50 border-slate-800 hover:border-slate-700 transition-colors\">\r\n              <CardContent className=\"p-5\">\r\n                <div className=\"flex items-start justify-between mb-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"w-10 h-10 rounded-lg bg-blue-500/10 border border-blue-500/20 flex items-center justify-center\">\r\n                      <MapPin className=\"w-5 h-5 text-blue-400\" />\r\n                    </div>\r\n                    <div>\r\n                      <h3 className=\"font-bold text-white\">{route.Route_Name}</h3>\r\n                      {route.Distance_KM !== null && (\r\n                         <div className=\"flex items-center gap-1 text-xs text-slate-400 mt-1\">\r\n                            <Ruler className=\"w-3 h-3\" /> {route.Distance_KM} กม.\r\n                         </div>\r\n                      )}\r\n                      {route.Branch_ID && (\r\n                         <div className=\"flex items-center gap-1 text-xs text-slate-500 mt-1\">\r\n                            <Building2 className=\"w-3 h-3\" /> {branches.find(b => b.Branch_ID === route.Branch_ID)?.Branch_Name || route.Branch_ID}\r\n                         </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2 text-sm mb-4\">\r\n                    {(route.Origin || route.Destination) && (\r\n                        <div className=\"flex flex-col gap-2 text-slate-300 bg-slate-950/50 p-3 rounded\">\r\n                            <div className=\"flex flex-col gap-1\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <span className=\"w-2 h-2 rounded-full bg-emerald-500\"></span>\r\n                                    <span className=\"text-xs text-slate-400\">ต้นทาง:</span>\r\n                                </div>\r\n                                <div className=\"pl-4 flex items-center gap-2 justify-between\">\r\n                                    <span>{route.Origin || \"-\"}</span>\r\n                                    {route.Map_Link_Origin && (\r\n                                        <a href={route.Map_Link_Origin} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-400 hover:text-blue-300\">\r\n                                            <Globe size={14} />\r\n                                        </a>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                            \r\n                            <div className=\"border-t border-slate-800/50 my-1\"></div>\r\n\r\n                            <div className=\"flex flex-col gap-1\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <span className=\"w-2 h-2 rounded-full bg-red-500\"></span>\r\n                                    <span className=\"text-xs text-slate-400\">ปลายทาง:</span>\r\n                                </div>\r\n                                <div className=\"pl-4 flex items-center gap-2 justify-between\">\r\n                                    <span>{route.Destination || \"-\"}</span>\r\n                                    {route.Map_Link_Destination && (\r\n                                        <a href={route.Map_Link_Destination} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-400 hover:text-blue-300\">\r\n                                            <Globe size={14} />\r\n                                        </a>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex gap-2 pt-3 border-t border-slate-800\">\r\n                  <Button \r\n                    variant=\"outline\" \r\n                    size=\"sm\" \r\n                    className=\"flex-1 border-slate-700\"\r\n                    onClick={() => handleOpenDialog(route)}\r\n                  >\r\n                    <Edit className=\"w-4 h-4 mr-1\" /> แก้ไข\r\n                  </Button>\r\n                  <Button \r\n                    variant=\"outline\" \r\n                    size=\"sm\" \r\n                    className=\"border-slate-700 text-red-400 hover:text-red-300 hover:bg-red-500/10\"\r\n                    onClick={() => handleDelete(route.Route_Name)}\r\n                  >\r\n                    <Trash2 className=\"w-4 h-4\" />\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          ))}\r\n          \r\n          {routes.length === 0 && (\r\n            <div className=\"col-span-full text-center py-12\">\r\n              <MapPin className=\"w-12 h-12 text-slate-600 mx-auto mb-4\" />\r\n              <p className=\"text-slate-500\">ไม่พบข้อมูลเส้นทาง</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\accounting\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\accounting\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'router'. Either include it or remove the dependency array.","line":52,"column":6,"nodeType":"ArrayExpression","endLine":52,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [router]","fix":{"range":[2074,2076],"text":"[router]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { CloudSync, RefreshCcw, CheckCircle2, XCircle, ArrowLeft, Save, Loader2, Key, Building2 } from \"lucide-react\"\r\nimport { checkAccountingConnection, saveAccountingSettings } from \"@/app/settings/accounting/actions\"\r\nimport { getSetting } from \"@/lib/supabase/system_settings\"\r\nimport { hasPermission } from \"@/lib/permissions\"\r\n\r\nexport default function AccountingSettingsPage() {\r\n  const router = useRouter()\r\n  const [checking, setChecking] = useState(false)\r\n  const [saving, setSaving] = useState(false)\r\n  const [status, setStatus] = useState<'idle' | 'connected' | 'failed'>('idle')\r\n  const [errorMsg, setErrorMsg] = useState<string | null>(null)\r\n  \r\n  const [apiKey, setApiKey] = useState(\"\")\r\n  const [companyId, setCompanyId] = useState(\"1\")\r\n  const [userEmail, setUserEmail] = useState(\"\")\r\n  const [loading, setLoading] = useState(true)\r\n  const [canManage, setCanManage] = useState(false)\r\n\r\n  useEffect(() => {\r\n    async function loadSettings() {\r\n      // Check permissions\r\n      const [viewAllowed, manageAllowed] = await Promise.all([\r\n        hasPermission('billing_view'),\r\n        hasPermission('settings_company')\r\n      ])\r\n\r\n      if (!viewAllowed && !manageAllowed) {\r\n        router.push('/')\r\n        return\r\n      }\r\n\r\n      setCanManage(manageAllowed)\r\n\r\n      const savedKey = await getSetting('akaunting_api_key', \"\")\r\n      const savedCompany = await getSetting('akaunting_company_id', \"1\")\r\n      const savedEmail = await getSetting('akaunting_user_email', \"\")\r\n      setApiKey(savedKey)\r\n      setCompanyId(savedCompany)\r\n      setUserEmail(savedEmail)\r\n      setLoading(false)\r\n    }\r\n    loadSettings()\r\n  }, [])\r\n\r\n  const handleSaveSettings = async () => {\r\n    if (!canManage) return\r\n    setSaving(true)\r\n    const result = await saveAccountingSettings(apiKey, companyId, userEmail)\r\n    setSaving(false)\r\n    if (result.success) {\r\n      alert(\"บันทึกการตั้งค่าเรียบร้อยแล้ว\")\r\n      setStatus('idle') // Reset status after save to encourage re-test\r\n    } else {\r\n      alert(\"ไม่สามารถบันทึกการตั้งค่าได้: \" + result.message)\r\n    }\r\n  }\r\n\r\n  const handleCheckConnection = async () => {\r\n    setChecking(true)\r\n    setErrorMsg(null)\r\n    const result = await checkAccountingConnection()\r\n    setChecking(false)\r\n    if (result.success && result.connected) {\r\n        setStatus('connected')\r\n    } else {\r\n        setStatus('failed')\r\n        setErrorMsg(result.message || \"Unknown connection error\")\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <DashboardLayout>\r\n        <div className=\"flex items-center justify-center h-64\">\r\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\r\n        </div>\r\n      </DashboardLayout>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      <div className=\"mb-6\">\r\n        <Button \r\n            variant=\"ghost\" \r\n            className=\"mb-4 pl-0 hover:bg-transparent hover:text-foreground\" \r\n            onClick={() => router.back()}\r\n        >\r\n          <ArrowLeft className=\"mr-2\" size={20} />\r\n          กลับไปตั้งค่า\r\n        </Button>\r\n        <h1 className=\"text-3xl font-bold text-foreground mb-2 flex items-center gap-3\">\r\n          <CloudSync className=\"text-indigo-400\" />\r\n          การเชื่อมต่อระบบบัญชี (Akaunting)\r\n        </h1>\r\n        <p className=\"text-muted-foreground\">จัดการการเชื่อมต่อและตรวจสอบสถานะกับ Akaunting Cloud</p>\r\n      </div>\r\n\r\n      <div className=\"grid gap-6 max-w-4xl\">\r\n        {/* Credentials Card */}\r\n        <Card className=\"bg-card border-border\">\r\n            <CardHeader>\r\n                <CardTitle className=\"text-foreground flex items-center gap-2\">\r\n                    <Key className=\"w-5 h-5 text-primary\" />\r\n                    การตั้งค่าสิทธิ์เข้าถึง (Credentials)\r\n                </CardTitle>\r\n                <CardDescription>ระบุ API Key และ Company ID จากระบบ Akaunting ของคุณ</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"apiKey\">Akaunting API Key</Label>\r\n                    <Input \r\n                        id=\"apiKey\"\r\n                        type=\"password\"\r\n                        placeholder=\"ป้อน API Key ของคุณที่นี่...\"\r\n                        value={apiKey}\r\n                        onChange={(e) => setApiKey(e.target.value)}\r\n                        className=\"bg-muted border-border text-foreground\"\r\n                        disabled={!canManage}\r\n                    />\r\n                    <p className=\"text-[10px] text-muted-foreground\">หาได้จากหน้า User Profile &gt; API Token ใน Akaunting</p>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"userEmail\">Akaunting User Email</Label>\r\n                    <Input \r\n                        id=\"userEmail\"\r\n                        type=\"email\"\r\n                        placeholder=\"admin@example.com\"\r\n                        value={userEmail}\r\n                        onChange={(e) => setUserEmail(e.target.value)}\r\n                        className=\"bg-muted border-border text-foreground\"\r\n                        disabled={!canManage}\r\n                    />\r\n                    <p className=\"text-[10px] text-muted-foreground\">ใช้อีเมลเดียวกับที่ใช้ล็อกอิน Akaunting (จำเป็นสำหรับบางแผนการใช้งาน)</p>\r\n                </div>\r\n                \r\n                <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"companyId\" className=\"flex items-center gap-2\">\r\n                         <Building2 className=\"w-4 h-4\" /> Company ID\r\n                    </Label>\r\n                    <Input \r\n                        id=\"companyId\"\r\n                        placeholder=\"1\"\r\n                        value={companyId}\r\n                        onChange={(e) => setCompanyId(e.target.value)}\r\n                        className=\"bg-muted border-border text-foreground max-w-[150px]\"\r\n                        disabled={!canManage}\r\n                    />\r\n                    <p className=\"text-[10px] text-muted-foreground\">ปกติจะเป็น 1 หากคุณมีบริษัทเดียวในระบบ</p>\r\n                </div>\r\n\r\n                {canManage && (\r\n                <div className=\"pt-2\">\r\n                    <Button \r\n                        onClick={handleSaveSettings} \r\n                        disabled={saving}\r\n                        className=\"gap-2\"\r\n                    >\r\n                        {saving ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Save className=\"w-4 h-4\" />}\r\n                        บันทึกการตั้งค่า\r\n                    </Button>\r\n                </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n\r\n        {/* Status Card */}\r\n        <Card className=\"bg-card border-border\">\r\n            <CardHeader>\r\n                <CardTitle className=\"text-foreground\">สถานะการเชื่อมต่อ</CardTitle>\r\n                <CardDescription>ตรวจสอบว่า TMS สามารถส่งข้อมูลไปยัง Akaunting ได้ปกติหรือไม่</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n                <div className=\"flex items-center justify-between p-4 bg-muted/50 rounded-lg border border-border\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"p-2 bg-indigo-500/10 rounded-lg\">\r\n                            <CloudSync className=\"h-6 w-6 text-indigo-400\" />\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-sm font-medium text-foreground\">Akaunting Cloud</p>\r\n                            <p className=\"text-xs text-muted-foreground\">Auto-sync: Enabled</p>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div className=\"flex items-center gap-4\">\r\n                        {status === 'connected' && (\r\n                            <div className=\"flex items-center gap-1.5 text-xs font-medium text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded-full border border-emerald-500/20\">\r\n                                <CheckCircle2 className=\"h-3.5 w-3.5\" /> Connected\r\n                            </div>\r\n                        )}\r\n                        {status === 'failed' && (\r\n                            <div className=\"flex items-center gap-1.5 text-xs font-medium text-rose-500 bg-rose-500/10 px-2 py-1 rounded-full border border-rose-500/20\">\r\n                                <XCircle className=\"h-3.5 w-3.5\" /> Connection Failed\r\n                            </div>\r\n                        )}\r\n                        \r\n                        <Button \r\n                            variant=\"outline\" \r\n                            size=\"sm\" \r\n                            className=\"border-border text-foreground hover:bg-muted\"\r\n                            onClick={handleCheckConnection}\r\n                            disabled={checking || !apiKey}\r\n                        >\r\n                            {checking ? <RefreshCcw className=\"h-4 w-4 animate-spin mr-2\" /> : <RefreshCcw className=\"h-4 w-4 mr-2\" />}\r\n                            Test Connection\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n\r\n                {status === 'failed' && errorMsg && (\r\n                    <div className=\"p-3 bg-rose-500/10 border border-rose-500/20 rounded-lg\">\r\n                        <p className=\"text-xs font-bold text-rose-500 uppercase mb-1\">Error Details:</p>\r\n                        <p className=\"text-sm text-rose-400 font-mono italic\">{errorMsg}</p>\r\n                    </div>\r\n                )}\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"p-4 bg-muted/30 rounded-lg border border-border/50\">\r\n                        <p className=\"text-xs text-muted-foreground uppercase tracking-wider font-semibold mb-1\">Invoice Sync (Customer)</p>\r\n                        <p className=\"text-sm font-medium text-foreground\">ทำงานร่วมกับ Billing Note</p>\r\n                    </div>\r\n                    <div className=\"p-4 bg-muted/30 rounded-lg border border-border/50\">\r\n                        <p className=\"text-xs text-muted-foreground uppercase tracking-wider font-semibold mb-1\">Bill Sync (Driver Cost)</p>\r\n                        <p className=\"text-sm font-medium text-foreground\">ทำงานร่วมกับ Driver Payment</p>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div className=\"bg-amber-500/10 border border-amber-500/20 rounded-lg p-4\">\r\n                    <p className=\"text-sm text-amber-500 flex items-center gap-2\">\r\n                        💡 ข้อมูลจะถูกส่งโดยอัตโนมัติเมื่อมีการสร้างเอกสารในระบบ TMS\r\n                    </p>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n      </div>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\api\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\backup\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\company\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":146,"column":17,"nodeType":"JSXOpeningElement","endLine":146,"endColumn":98,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\customers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\expense-types\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\expense-types\\page.tsx:32:5\n  30 |\n  31 |   useEffect(() => {\n> 32 |     loadData()\n     |     ^^^^^^^^ Avoid calling setState() directly within an effect\n  33 |   }, [loadData])\n  34 |\n  35 |   const handleAdd = async () => {","line":32,"column":5,"nodeType":null,"endLine":32,"endColumn":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { getExpenseTypes, addExpenseType, updateExpenseType, deleteExpenseType, ExpenseType } from \"@/lib/supabase/master-data\"\r\nimport {\r\n  Coins,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  Save,\r\n  X,\r\n  GripVertical\r\n} from \"lucide-react\"\r\n\r\nexport default function ExpenseTypesPage() {\r\n  const [expenseTypes, setExpenseTypes] = useState<ExpenseType[]>([])\r\n  const [editingId, setEditingId] = useState<string | null>(null)\r\n  const [newType, setNewType] = useState({ name: \"\", default_amount: 0 })\r\n  const [showAddForm, setShowAddForm] = useState(false)\r\n\r\n  const loadData = useCallback(async () => {\r\n    const data = await getExpenseTypes()\r\n    setExpenseTypes(data)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [loadData])\r\n\r\n  const handleAdd = async () => {\r\n    if (!newType.name.trim()) return\r\n    await addExpenseType(newType.name, newType.default_amount)\r\n    setNewType({ name: \"\", default_amount: 0 })\r\n    setShowAddForm(false)\r\n    loadData()\r\n  }\r\n\r\n  const handleUpdate = async (id: string, updates: Partial<ExpenseType>) => {\r\n    // Optimistic update for inputs\r\n    setExpenseTypes(prev => prev.map(et => et.id === id ? { ...et, ...updates } : et))\r\n  }\r\n\r\n  const saveUpdate = async (id: string) => {\r\n    const item = expenseTypes.find(e => e.id === id)\r\n    if (item) {\r\n        await updateExpenseType(id, { name: item.name, default_amount: item.default_amount })\r\n    }\r\n    setEditingId(null)\r\n  }\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (confirm(\"ยืนยันลบประเภทค่าใช้จ่ายนี้?\")) {\r\n      await deleteExpenseType(id)\r\n      loadData()\r\n    }\r\n  }\r\n\r\n  const handleToggleActive = async (id: string, currentStatus: boolean) => {\r\n    await updateExpenseType(id, { is_active: !currentStatus })\r\n    loadData()\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-foreground flex items-center gap-3\">\r\n            <Coins className=\"text-amber-500\" />\r\n            ประเภทค่าใช้จ่าย\r\n          </h1>\r\n          <p className=\"text-sm text-muted-foreground mt-1\">จัดการหัวข้อค่าใช้จ่ายสำหรับใช้ในการสร้างงาน</p>\r\n        </div>\r\n        <Button onClick={() => setShowAddForm(true)} className=\"bg-amber-600 hover:bg-amber-700 text-white font-bold shadow-md\">\r\n          <Plus className=\"w-4 h-4 mr-2\" /> เพิ่มประเภท\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Add Form */}\r\n      {showAddForm && (\r\n        <Card className=\"bg-card border-border shadow-md mb-6\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"grid grid-cols-12 gap-4 items-end\">\r\n              <div className=\"col-span-5 space-y-2\">\r\n                <Label className=\"text-muted-foreground\">ชื่อประเภท</Label>\r\n                <Input\r\n                  value={newType.name}\r\n                  onChange={(e) => setNewType({ ...newType, name: e.target.value })}\r\n                  placeholder=\"เช่น ค่าทางด่วน\"\r\n                  className=\"bg-card border-border text-foreground\"\r\n                />\r\n              </div>\r\n              <div className=\"col-span-4 space-y-2\">\r\n                <Label className=\"text-muted-foreground\">จำนวนเริ่มต้น (ไม่บังคับ)</Label>\r\n                <div className=\"relative\">\r\n                  <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">฿</span>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={newType.default_amount}\r\n                    onChange={(e) => setNewType({ ...newType, default_amount: Number(e.target.value) })}\r\n                    className=\"pl-8 bg-card border-border text-foreground\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"col-span-3 flex gap-2\">\r\n                <Button onClick={handleAdd} className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold\">\r\n                  <Save className=\"w-4 h-4 mr-1\" /> บันทึก\r\n                </Button>\r\n                <Button variant=\"outline\" onClick={() => setShowAddForm(false)} className=\"border-border text-foreground\">\r\n                  <X className=\"w-4 h-4\" />\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* List */}\r\n      <Card className=\"bg-card border-border shadow-sm\">\r\n        <CardHeader className=\"border-b border-border\">\r\n          <CardTitle className=\"text-foreground\">รายการประเภทค่าใช้จ่าย</CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <div className=\"divide-y divide-border\">\r\n            {expenseTypes.map((et) => (\r\n              <div \r\n                key={et.id} \r\n                className={`p-4 flex items-center gap-4 hover:bg-muted/50 transition-colors ${\r\n                  !et.is_active ? 'opacity-50 grayscale' : ''\r\n                }`}\r\n              >\r\n                <div className=\"text-muted-foreground/30 cursor-move\">\r\n                  <GripVertical className=\"w-5 h-5\" />\r\n                </div>\r\n\r\n                {editingId === et.id ? (\r\n                  <>\r\n                    <div className=\"flex-1\">\r\n                      <Input\r\n                        value={et.name}\r\n                        onChange={(e) => handleUpdate(et.id, { name: e.target.value })}\r\n                        className=\"bg-card border-border text-foreground\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"w-32\">\r\n                      <div className=\"relative\">\r\n                        <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">฿</span>\r\n                        <Input\r\n                          type=\"number\"\r\n                          value={et.default_amount || 0}\r\n                          onChange={(e) => handleUpdate(et.id, { default_amount: Number(e.target.value) })}\r\n                          className=\"pl-8 bg-card border-border text-foreground\"\r\n                        />\r\n                      </div>\r\n                    </div>\r\n                    <Button size=\"sm\" onClick={() => saveUpdate(et.id)} className=\"bg-emerald-600 hover:bg-emerald-700 text-white\">\r\n                      <Save className=\"w-4 h-4\" />\r\n                    </Button>\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"text-foreground font-medium\">{et.name}</p>\r\n                    </div>\r\n                    <div className=\"w-32 text-muted-foreground font-mono\">\r\n                      {et.default_amount ? `฿${et.default_amount.toLocaleString()}` : '-'}\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <button\r\n                        onClick={() => handleToggleActive(et.id, et.is_active)}\r\n                        className={`px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${\r\n                          et.is_active \r\n                            ? 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400' \r\n                            : 'bg-muted text-muted-foreground'\r\n                        }`}\r\n                      >\r\n                        {et.is_active ? 'ใช้งาน' : 'ปิดใช้'}\r\n                      </button>\r\n                      <Button \r\n                        size=\"icon\" \r\n                        variant=\"ghost\" \r\n                        onClick={() => setEditingId(et.id)}\r\n                        className=\"text-muted-foreground hover:text-foreground hover:bg-muted\"\r\n                      >\r\n                        <Edit className=\"w-4 h-4\" />\r\n                      </Button>\r\n                      <Button \r\n                        size=\"icon\" \r\n                        variant=\"ghost\" \r\n                        onClick={() => handleDelete(et.id)}\r\n                        className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10\"\r\n                      >\r\n                        <Trash2 className=\"w-4 h-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            ))}\r\n\r\n            {expenseTypes.length === 0 && (\r\n              <div className=\"text-center py-12 text-muted-foreground italic\">\r\n                -- ยังไม่มีประเภทค่าใช้จ่าย --\r\n              </div>\r\n            )}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\profile\\debug\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\roles\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\subcontractors\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\theme\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\theme\\page.tsx:18:9\n  16 |     const stored = localStorage.getItem('theme') as Theme\n  17 |     if (stored) {\n> 18 |         setTheme(stored)\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  19 |     } else {\n  20 |         setTheme('system')\n  21 |     }","line":18,"column":9,"nodeType":null,"endLine":18,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { DashboardLayout } from \"@/components/layout/dashboard-layout\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Palette, ArrowLeft, Moon, Sun, Monitor } from \"lucide-react\"\r\nimport { useRouter } from \"next/navigation\"\r\n\r\ntype Theme = 'light' | 'dark' | 'system'\r\n\r\nexport default function ThemeSettingsPage() {\r\n  const router = useRouter()\r\n  const [theme, setTheme] = useState<Theme>('dark')\r\n\r\n  useEffect(() => {\r\n    const stored = localStorage.getItem('theme') as Theme\r\n    if (stored) {\r\n        setTheme(stored)\r\n    } else {\r\n        setTheme('system')\r\n    }\r\n  }, [])\r\n\r\n  const handleThemeChange = (newTheme: Theme) => {\r\n    setTheme(newTheme)\r\n    localStorage.setItem('theme', newTheme)\r\n    \r\n    if (newTheme === 'dark') {\r\n        document.documentElement.classList.add('dark')\r\n    } else if (newTheme === 'light') {\r\n        document.documentElement.classList.remove('dark')\r\n    } else {\r\n        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {\r\n            document.documentElement.classList.add('dark')\r\n        } else {\r\n            document.documentElement.classList.remove('dark')\r\n        }\r\n    }\r\n  }\r\n\r\n  return (\r\n    <DashboardLayout>\r\n      <div className=\"mb-6\">\r\n        <Button variant=\"ghost\" className=\"mb-4 pl-0 hover:bg-transparent hover:text-white\" onClick={() => router.back()}>\r\n          <ArrowLeft className=\"mr-2\" size={20} />\r\n          กลับไปตั้งค่า\r\n        </Button>\r\n        <h1 className=\"text-3xl font-bold text-white mb-2 flex items-center gap-3\">\r\n          <Palette className=\"text-purple-400\" />\r\n          ธีมและการแสดงผล\r\n        </h1>\r\n        <p className=\"text-slate-400\">ปรับแต่งหน้าตาการใช้งานตามความชอบ</p>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl\">\r\n         <div \r\n            className={`cursor-pointer transition-all border-2 rounded-xl overflow-hidden ${theme === 'light' ? 'border-indigo-500 bg-white/10' : 'border-slate-800 bg-slate-900/50 hover:border-slate-600'}`}\r\n            onClick={() => handleThemeChange('light')}\r\n         >\r\n            <div className=\"p-6 flex flex-col items-center text-center\">\r\n                <div className=\"w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center mb-4 text-slate-800\">\r\n                    <Sun size={32} />\r\n                </div>\r\n                <h3 className=\"text-white font-bold mb-1\">โหมดสว่าง</h3>\r\n                <p className=\"text-sm text-slate-400\">เหมาะสำหรับการใช้งานกลางแจ้ง</p>\r\n            </div>\r\n         </div>\r\n\r\n         <div \r\n            className={`cursor-pointer transition-all border-2 rounded-xl overflow-hidden ${theme === 'dark' ? 'border-indigo-500 bg-white/10' : 'border-slate-800 bg-slate-900/50 hover:border-slate-600'}`}\r\n            onClick={() => handleThemeChange('dark')}\r\n         >\r\n            <div className=\"p-6 flex flex-col items-center text-center\">\r\n                <div className=\"w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4 text-white\">\r\n                    <Moon size={32} />\r\n                </div>\r\n                <h3 className=\"text-white font-bold mb-1\">โหมดมืด</h3>\r\n                <p className=\"text-sm text-slate-400\">สบายตา และประหยัดพลังงาน</p>\r\n            </div>\r\n         </div>\r\n\r\n         <div \r\n            className={`cursor-pointer transition-all border-2 rounded-xl overflow-hidden ${theme === 'system' ? 'border-indigo-500 bg-white/10' : 'border-slate-800 bg-slate-900/50 hover:border-slate-600'}`}\r\n            onClick={() => handleThemeChange('system')}\r\n         >\r\n            <div className=\"p-6 flex flex-col items-center text-center\">\r\n                <div className=\"w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center mb-4 text-slate-300\">\r\n                    <Monitor size={32} />\r\n                </div>\r\n                <h3 className=\"text-white font-bold mb-1\">ตามระบบ</h3>\r\n                <p className=\"text-sm text-slate-400\">ปรับตามการตั้งค่าของอุปกรณ์</p>\r\n            </div>\r\n         </div>\r\n      </div>\r\n    </DashboardLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\settings\\vehicle-types\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTrigger' is defined but never used.","line":8,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":73,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DialogTrigger"},"fix":{"range":[332,347],"text":""},"desc":"Remove unused variable \"DialogTrigger\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Plus, Edit, Trash2, Loader2, ArrowLeft } from \"lucide-react\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { getVehicleTypes, createVehicleType, updateVehicleType, deleteVehicleType, VehicleType } from \"@/lib/actions/vehicle-type-actions\"\r\nimport Link from \"next/link\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport default function VehicleTypesPage() {\r\n  const [types, setTypes] = useState<VehicleType[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false)\r\n  const [currentType, setCurrentType] = useState<VehicleType | null>(null)\r\n  \r\n  // Form State\r\n  const [formData, setFormData] = useState({\r\n    type_name: '',\r\n    description: '',\r\n    active_status: 'Active'\r\n  })\r\n  const [isSubmitting, setIsSubmitting] = useState(false)\r\n\r\n  // Fetch Data\r\n  const fetchTypes = async () => {\r\n    setLoading(true)\r\n    const data = await getVehicleTypes()\r\n    setTypes(data)\r\n    setLoading(false)\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchTypes()\r\n  }, [])\r\n\r\n  // Handlers\r\n  const handleOpenCreate = () => {\r\n    setCurrentType(null)\r\n    setFormData({ type_name: '', description: '', active_status: 'Active' })\r\n    setIsDialogOpen(true)\r\n  }\r\n\r\n  const handleOpenEdit = (type: VehicleType) => {\r\n    setCurrentType(type)\r\n    setFormData({\r\n      type_name: type.type_name,\r\n      description: type.description || '',\r\n      active_status: type.active_status\r\n    })\r\n    setIsDialogOpen(true)\r\n  }\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setIsSubmitting(true)\r\n\r\n    try {\r\n      if (currentType) {\r\n        // Edit\r\n        const res = await updateVehicleType(currentType.type_id, formData)\r\n        if (res.success) {\r\n          toast.success(\"บันทึกข้อมูลเรียบร้อย\")\r\n          setIsDialogOpen(false)\r\n          fetchTypes()\r\n        } else {\r\n            toast.error(res.message)\r\n        }\r\n      } else {\r\n        // Create\r\n        const res = await createVehicleType(formData)\r\n        if (res.success) {\r\n            toast.success(\"เพิ่มข้อมูลเรียบร้อย\")\r\n            setIsDialogOpen(false)\r\n            fetchTypes()\r\n        } else {\r\n            toast.error(res.message)\r\n        }\r\n      }\r\n    } catch {\r\n        toast.error(\"เกิดข้อผิดพลาดในการบันทึก\")\r\n    } finally {\r\n      setIsSubmitting(false)\r\n    }\r\n  }\r\n\r\n  const handleDelete = async (id: number) => {\r\n    if (!confirm(\"ยืนยันการลบประเภทรถนี้?\")) return\r\n\r\n    const res = await deleteVehicleType(id)\r\n    if (res.success) {\r\n        toast.success(\"ลบข้อมูลเรียบร้อย\")\r\n        fetchTypes()\r\n    } else {\r\n        toast.error(res.message)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6 text-white max-w-4xl\">\r\n        <div className=\"flex items-center gap-4 mb-6\">\r\n            <Link href=\"/settings\">\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"hover:bg-white/10\">\r\n                    <ArrowLeft className=\"h-5 w-5\" />\r\n                </Button>\r\n            </Link>\r\n            <h1 className=\"text-2xl font-bold\">จัดการประเภทรถ (Vehicle Types)</h1>\r\n        </div>\r\n\r\n        <div className=\"flex justify-between items-center mb-6\">\r\n            <p className=\"text-slate-400\">กำหนดประเภทรถที่ใช้งานในระบบ</p>\r\n            <Button onClick={handleOpenCreate} className=\"bg-blue-600 hover:bg-blue-700 gap-2\">\r\n                <Plus size={16} /> เติ่มประเภทรถ\r\n            </Button>\r\n        </div>\r\n\r\n        {/* List */}\r\n        <div className=\"bg-slate-900 border border-slate-800 rounded-lg overflow-hidden\">\r\n            {loading ? (\r\n                <div className=\"p-8 text-center text-slate-500\">\r\n                    <Loader2 className=\"animate-spin h-8 w-8 mx-auto mb-2\" />\r\n                    กำลังโหลดข้อมูล...\r\n                </div>\r\n            ) : types.length === 0 ? (\r\n                <div className=\"p-8 text-center text-slate-500\">\r\n                    ไม่พบข้อมูลประเภทรถ\r\n                </div>\r\n            ) : (\r\n                <table className=\"w-full text-left\">\r\n                    <thead className=\"bg-slate-950 text-slate-400 text-sm uppercase\">\r\n                        <tr>\r\n                            <th className=\"px-6 py-3 font-medium\">ชื่อประเภท</th>\r\n                            <th className=\"px-6 py-3 font-medium\">รายละเอียด</th>\r\n                            <th className=\"px-6 py-3 font-medium\">สถานะ</th>\r\n                            <th className=\"px-6 py-3 font-medium text-right\">จัดการ</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y divide-slate-800\">\r\n                        {types.map((type) => (\r\n                            <tr key={type.type_id} className=\"hover:bg-slate-800/50 transition-colors\">\r\n                                <td className=\"px-6 py-4 font-medium\">{type.type_name}</td>\r\n                                <td className=\"px-6 py-4 text-slate-400\">{type.description || '-'}</td>\r\n                                <td className=\"px-6 py-4\">\r\n                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${\r\n                                        type.active_status === 'Active' \r\n                                        ? 'bg-emerald-500/10 text-emerald-400' \r\n                                        : 'bg-red-500/10 text-red-400'\r\n                                    }`}>\r\n                                        {type.active_status}\r\n                                    </span>\r\n                                </td>\r\n                                <td className=\"px-6 py-4 text-right flex justify-end gap-2\">\r\n                                    <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 text-blue-400 hover:text-blue-300 hover:bg-blue-500/10\" onClick={() => handleOpenEdit(type)}>\r\n                                        <Edit size={16} />\r\n                                    </Button>\r\n                                    <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8 text-red-400 hover:text-red-300 hover:bg-red-500/10\" onClick={() => handleDelete(type.type_id)}>\r\n                                        <Trash2 size={16} />\r\n                                    </Button>\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n            )}\r\n        </div>\r\n\r\n        {/* Create/Edit Dialog */}\r\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\r\n            <DialogContent className=\"sm:max-w-[425px] bg-slate-900 border-slate-800 text-white\">\r\n                <DialogHeader>\r\n                    <DialogTitle>{currentType ? 'แก้ไขประเภทรถ' : 'เพิ่มประเภทรถใหม่'}</DialogTitle>\r\n                </DialogHeader>\r\n                <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label>ชื่อประเภทรถ</Label>\r\n                        <Input \r\n                            value={formData.type_name}\r\n                            onChange={(e) => setFormData({...formData, type_name: e.target.value})}\r\n                            placeholder=\"เช่น 4-Wheel, 6-Wheel\"\r\n                            className=\"bg-slate-950 border-slate-800\"\r\n                            required\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label>รายละเอียด (ไม่บังคับ)</Label>\r\n                        <Input \r\n                            value={formData.description}\r\n                            onChange={(e) => setFormData({...formData, description: e.target.value})}\r\n                            placeholder=\"คำอธิบายเพิ่มเติม\"\r\n                            className=\"bg-slate-950 border-slate-800\"\r\n                        />\r\n                    </div>\r\n                    \r\n                    {currentType && (\r\n                        <div className=\"space-y-2\">\r\n                            <Label>สถานะ</Label>\r\n                            <select \r\n                                value={formData.active_status}\r\n                                onChange={(e) => setFormData({...formData, active_status: e.target.value})}\r\n                                className=\"flex h-10 w-full rounded-md border border-slate-800 bg-slate-950 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                            >\r\n                                <option value=\"Active\">Active (ใช้งาน)</option>\r\n                                <option value=\"Inactive\">Inactive (ยกเลิก)</option>\r\n                            </select>\r\n                        </div>\r\n                    )}\r\n\r\n                    <div className=\"flex justify-end gap-2 pt-4\">\r\n                        <Button type=\"button\" variant=\"ghost\" onClick={() => setIsDialogOpen(false)}>\r\n                            ยกเลิก\r\n                        </Button>\r\n                        <Button type=\"submit\" disabled={isSubmitting} className=\"bg-blue-600 hover:bg-blue-700\">\r\n                            {isSubmitting && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                            บันทึก\r\n                        </Button>\r\n                    </div>\r\n                </form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\sos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\track\\[jobId]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\track\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\vehicles\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1612,1615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1612,1615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1770,1773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1770,1773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1803,1806],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1803,1806],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4962,4965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4962,4965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { getUserBranchId, isSuperAdmin } from '@/lib/permissions'\r\n\r\nexport type VehicleFormData = {\r\n  vehicle_plate: string\r\n  vehicle_type: string\r\n  brand: string\r\n  model: string\r\n  active_status: string\r\n  current_mileage?: number\r\n  next_service_mileage?: number\r\n  Branch_ID?: string\r\n}\r\n\r\nexport async function createVehicle(data: VehicleFormData) {\r\n  const supabase = await createClient()\r\n  const userBranchId = await getUserBranchId()\r\n  const isAdmin = await isSuperAdmin()\r\n\r\n  const finalBranchId = (isAdmin && data.Branch_ID) ? data.Branch_ID : userBranchId\r\n  \r\n  console.log('[createVehicle] Attempting to create vehicle:', { \r\n      plate: data.vehicle_plate, \r\n      finalBranchId, \r\n      userBranchId,\r\n      isAdmin \r\n  })\r\n\r\n  const { error } = await supabase\r\n    .from('master_vehicles')\r\n    .insert({\r\n      vehicle_plate: data.vehicle_plate,\r\n      vehicle_type: data.vehicle_type,\r\n      brand: data.brand,\r\n      model: data.model,\r\n      active_status: 'Active',\r\n      current_mileage: data.current_mileage || 0,\r\n      next_service_mileage: data.next_service_mileage || 0,\r\n      branch_id: finalBranchId\r\n    })\r\n\r\n  if (error) {\r\n    console.error('[createVehicle] DB Error:', error)\r\n    return { success: false, message: 'Failed to create vehicle' }\r\n  }\r\n\r\n  console.log('[createVehicle] Success')\r\n  revalidatePath('/vehicles')\r\n  return { success: true, message: 'Vehicle created successfully' }\r\n}\r\n\r\nexport async function createBulkVehicles(vehicles: any[]) {\r\n  const supabase = await createClient()\r\n  const branchId = await getUserBranchId()\r\n\r\n  // Helper to normalize keys\r\n  const normalizeData = (row: any) => {\r\n    const normalized: any = {}\r\n    \r\n    // Helper to find value by possible keys (case-insensitive)\r\n    const getValue = (keys: string[]) => {\r\n      const rowKeys = Object.keys(row)\r\n      for (const key of keys) {\r\n        const foundKey = rowKeys.find(k => k.toLowerCase().replace(/\\s+/g, '') === key.toLowerCase().replace(/\\s+/g, ''))\r\n        if (foundKey && row[foundKey] !== undefined && row[foundKey] !== null) {\r\n          return row[foundKey]\r\n        }\r\n      }\r\n      return undefined\r\n    }\r\n\r\n    // Mapping rules\r\n    normalized.vehicle_plate = getValue(['vehicle_plate', 'plate', 'ทะเบียน', 'ทะเบียนรถ', 'license_plate', 'licenseplate'])\r\n    normalized.vehicle_type = getValue(['vehicle_type', 'type', 'ประเภท', 'ประเภทรถ', 'vehicletype']) || '4-Wheel'\r\n    normalized.brand = getValue(['brand', 'make', 'ยี่ห้อ'])\r\n    normalized.model = getValue(['model', 'รุ่น'])\r\n    normalized.active_status = getValue(['active_status', 'status', 'สถานะ']) || 'Active'\r\n    normalized.current_mileage = getValue(['current_mileage', 'mileage', 'เลขไมล์', 'currentmileage']) || 0\r\n    normalized.next_service_mileage = getValue(['next_service_mileage', 'next_service', 'เช็คระยะถัดไป', 'nextservicemileage', 'nextservice']) || 0\r\n    \r\n    // Keep internal fields\r\n    if (row.Branch_ID) normalized.Branch_ID = row.Branch_ID\r\n\r\n    return normalized\r\n  }\r\n\r\n  // Prepare data\r\n  const cleanData = vehicles.map(v => {\r\n    const data = normalizeData(v)\r\n    return {\r\n      vehicle_plate: data.vehicle_plate ? String(data.vehicle_plate).trim() : null,\r\n      vehicle_type: data.vehicle_type,\r\n      brand: data.brand,\r\n      model: data.model,\r\n      active_status: data.active_status,\r\n      current_mileage: Number(data.current_mileage) || 0,\r\n      next_service_mileage: Number(data.next_service_mileage) || 0,\r\n      branch_id: branchId\r\n    }\r\n  }).filter(v => v.vehicle_plate) // Filter out rows without active_status or vehicle_plate\r\n\r\n  // Deduplicate input data by vehicle_plate\r\n  const uniqueData = Array.from(new Map(cleanData.map(item => [item.vehicle_plate, item])).values())\r\n\r\n  console.log('[createBulkVehicles] Input:', vehicles.length, 'Clean:', cleanData.length, 'Unique:', uniqueData.length)\r\n\r\n  if (uniqueData.length === 0) {\r\n     return { success: false, message: 'ไม่พบข้อมูลที่ถูกต้อง (กรุณาตรวจสอบชื่อคอลัมน์ เช่น ทะเบียนรถ, ยี่ห้อ, รุ่น)' }\r\n  }\r\n\r\n  // Use upsert to handle duplicates (update existing or insert new)\r\n  const { error } = await supabase\r\n    .from('master_vehicles')\r\n    .upsert(uniqueData, { \r\n      onConflict: 'vehicle_plate',\r\n      ignoreDuplicates: false // Update if exists\r\n    })\r\n    .select()\r\n\r\n  if (error) {\r\n    console.error('Error bulk creating vehicles:', error)\r\n    return { success: false, message: `นำเข้าไม่สำเร็จ: ${error.message}` }\r\n  }\r\n\r\n  revalidatePath('/vehicles')\r\n  return { success: true, message: `นำเข้าข้อมูลสำเร็จ ${uniqueData.length} รายการ` }\r\n}\r\n\r\nexport async function updateVehicle(plate: string, data: Partial<VehicleFormData>) {\r\n  const supabase = await createClient()\r\n  const branchId = await getUserBranchId()\r\n  const isAdmin = await isSuperAdmin()\r\n\r\n    const updatePayload: any = {\r\n        vehicle_type: data.vehicle_type,\r\n        brand: data.brand,\r\n        model: data.model,\r\n        active_status: data.active_status,\r\n        current_mileage: data.current_mileage,\r\n        next_service_mileage: data.next_service_mileage\r\n    }\r\n\r\n    if (isAdmin && data.Branch_ID) {\r\n        updatePayload.branch_id = data.Branch_ID\r\n    }\r\n\r\n    let query = supabase\r\n      .from('master_vehicles')\r\n      .update(updatePayload)\r\n  \r\n  query = query.eq('vehicle_plate', plate)\r\n\r\n  if (branchId && !isAdmin) {\r\n      query = query.eq('branch_id', branchId)\r\n  }\r\n\r\n  const { error } = await query\r\n\r\n  if (error) {\r\n    console.error('Error updating vehicle:', error)\r\n    return { success: false, message: 'Failed to update vehicle' }\r\n  }\r\n\r\n  revalidatePath('/vehicles')\r\n  return { success: true, message: 'Vehicle updated successfully' }\r\n}\r\n\r\nexport async function deleteVehicle(plate: string) {\r\n  const supabase = await createClient()\r\n  const branchId = await getUserBranchId()\r\n  const isAdmin = await isSuperAdmin()\r\n\r\n  let query = supabase\r\n    .from('master_vehicles')\r\n    .delete()\r\n    .eq('vehicle_plate', plate)\r\n\r\n  if (branchId && !isAdmin) {\r\n      query = query.eq('branch_id', branchId)\r\n  }\r\n\r\n  const { error } = await query\r\n\r\n  if (error) {\r\n    console.error('Error deleting vehicle:', error)\r\n    return { success: false, message: 'Failed to delete vehicle' }\r\n  }\r\n\r\n  revalidatePath('/vehicles')\r\n  return { success: true, message: 'Vehicle deleted successfully' }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\vehicles\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\app\\vehicles\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\admin\\admin-job-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\admin\\loading-page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\billing-section.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'revenueVsPayout' is assigned a value but never used.","line":8,"column":64,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":79}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { BillingAnalytics } from \"@/lib/supabase/billing-analytics\"\r\nimport { DollarSign, Wallet, Percent, FileText, AlertCircle, Clock } from \"lucide-react\"\r\n\r\nexport function BillingSection({ data }: { data: BillingAnalytics }) {\r\n  const { accountsReceivable, accountsPayable, collectionRate, revenueVsPayout } = data\r\n  \r\n  // Max value for aging bars\r\n  const maxAging = Math.max(\r\n    accountsReceivable.aging['0-30'], \r\n    accountsReceivable.aging['31-60'], \r\n    accountsReceivable.aging['61-90'], \r\n    accountsReceivable.aging['90+']\r\n  ) || 1\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Section Header */}\r\n      <div className=\"flex items-center gap-3 text-indigo-400\">\r\n        <div className=\"p-2 bg-indigo-500/10 rounded-lg\">\r\n          <Wallet size={20} />\r\n        </div>\r\n        <h2 className=\"text-lg font-bold uppercase tracking-[0.2em]\">Billing & Accounts</h2>\r\n      </div>\r\n\r\n      {/* KPI Grid */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        {/* AR Card */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">ลูกหนี้คงค้าง (AR)</span>\r\n              <div className=\"p-2 bg-blue-500/10 rounded-full text-blue-400\">\r\n                <FileText size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">฿{accountsReceivable.totalOutstanding.toLocaleString()}</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">{accountsReceivable.invoiceCount} รายการค้างชำระ</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* AP Card */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">เจ้าหนี้คงค้าง (AP)</span>\r\n              <div className=\"p-2 bg-purple-500/10 rounded-full text-purple-400\">\r\n                <DollarSign size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">฿{accountsPayable.totalOutstanding.toLocaleString()}</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">{accountsPayable.paymentCount} รายการรอจ่าย</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Collection Rate */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">อัตราการเก็บเงิน</span>\r\n              <div className=\"p-2 bg-emerald-500/10 rounded-full text-emerald-400\">\r\n                <Percent size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">{collectionRate.toFixed(1)}%</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">เทียบกับยอดบิลทั้งหมด</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n         {/* Overdue Alert */}\r\n         <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">เกินกำหนด (90+ วัน)</span>\r\n              <div className=\"p-2 bg-red-500/10 rounded-full text-red-400\">\r\n                <AlertCircle size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-red-400\">฿{accountsReceivable.aging['90+'].toLocaleString()}</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">ต้องติดตามเร่งด่วน</p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Charts & Lists */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* AR Aging */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n           <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <Clock size={16} className=\"text-slate-400\" />\r\n               AR Aging Timeline\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-6 space-y-5\">\r\n              {Object.entries(accountsReceivable.aging).map(([range, amount]) => (\r\n                <div key={range} className=\"space-y-2\">\r\n                  <div className=\"flex justify-between text-sm\">\r\n                     <span className=\"text-slate-400\">{range} วัน</span>\r\n                     <span className=\"text-white font-medium\">฿{amount.toLocaleString()}</span>\r\n                  </div>\r\n                  <div className=\"h-2 w-full bg-slate-800 rounded-full overflow-hidden\">\r\n                     <div \r\n                        className={`h-full rounded-full transition-all duration-500 ${\r\n                            range === '90+' ? 'bg-red-500' :\r\n                            range === '61-90' ? 'bg-orange-500' :\r\n                            range === '31-60' ? 'bg-yellow-500' : 'bg-blue-500'\r\n                        }`}\r\n                        style={{ width: `${(amount / maxAging) * 100}%` }}\r\n                     />\r\n                  </div>\r\n                </div>\r\n              ))}\r\n           </CardContent>\r\n        </Card>\r\n\r\n        {/* Recent Unpaid */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n            <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <AlertCircle size={16} className=\"text-slate-400\" />\r\n               Top Overdue Invoices\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-0\">\r\n              <div className=\"divide-y divide-white/5\">\r\n                {accountsReceivable.recentUnpaid.length === 0 ? (\r\n                    <div className=\"py-8 text-center text-slate-500 text-sm\">ไม่มีรายการค้างชำระ</div>\r\n                ) : (\r\n                    accountsReceivable.recentUnpaid.map((inv) => (\r\n                        <div key={inv.id} className=\"py-4 flex items-center justify-between group\">\r\n                            <div>\r\n                                <div className=\"text-white font-medium text-sm group-hover:text-blue-400 transition-colors\">{inv.customer}</div>\r\n                                <div className=\"text-xs text-red-400 mt-1\">เกินกำหนด {inv.daysOverdue} วัน</div>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                                <div className=\"text-emerald-400 font-bold text-sm\">฿{inv.amount.toLocaleString()}</div>\r\n                                <div className=\"text-[10px] text-slate-500 mt-0.5\">{inv.id}</div>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n              </div>\r\n           </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\branch-performance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\cost-pie-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\customer-ranking.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\customer-route-section.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used.","line":4,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[135,147],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Building2, MapPin, TrendingUp, DollarSign } from \"lucide-react\"\r\n\r\ntype CustomerStat = {\r\n  name: string\r\n  revenue: number\r\n  jobCount: number\r\n}\r\n\r\ntype RouteStat = {\r\n  route: string\r\n  revenue: number\r\n  cost: number\r\n  count: number\r\n  margin: number // Percentage\r\n}\r\n\r\nexport function CustomerRouteSection({ \r\n  customers, \r\n  routes \r\n}: { \r\n  customers: CustomerStat[]\r\n  routes: RouteStat[] \r\n}) {\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Section Header */}\r\n      <div className=\"flex items-center gap-3 text-purple-400\">\r\n        <div className=\"p-2 bg-purple-500/10 rounded-lg\">\r\n          <MapPin size={20} />\r\n        </div>\r\n        <h2 className=\"text-lg font-bold uppercase tracking-[0.2em]\">Customer & Route Intelligence</h2>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Top Customers */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n           <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <Building2 size={16} className=\"text-purple-400\" />\r\n               Top Customers (Revenue)\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-0\">\r\n             <div className=\"divide-y divide-white/5\">\r\n                {customers.map((c, i) => (\r\n                    <div key={i} className=\"py-4 flex items-center justify-between group\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                             <div className={`w-8 h-8 rounded flex items-center justify-center text-sm font-bold text-white ${i < 3 ? 'bg-purple-500/20 text-purple-400' : 'bg-slate-800 text-slate-400'}`}>\r\n                                {i + 1}\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"text-white font-medium text-sm group-hover:text-purple-400 transition-colors\">{c.name}</div>\r\n                                <div className=\"text-xs text-slate-500 mt-0.5\">{c.jobCount} Jobs</div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                             <div className=\"text-white font-bold text-sm\">฿{c.revenue.toLocaleString()}</div>\r\n                             {/* <div className=\"text-[10px] text-slate-500 mt-0.5\">Revenue</div> */}\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n                {customers.length === 0 && (\r\n                     <div className=\"py-8 text-center text-slate-500 text-sm\">ไม่มีข้อมูลลูกค้า</div>\r\n                )}\r\n             </div>\r\n           </CardContent>\r\n        </Card>\r\n\r\n        {/* Route Profitability */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n           <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <TrendingUp size={16} className=\"text-emerald-400\" />\r\n               Route Profitability (Top 5)\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-0\">\r\n             <div className=\"divide-y divide-white/5\">\r\n                {routes.slice(0, 5).map((r, i) => (\r\n                    <div key={i} className=\"py-4 flex items-center justify-between\">\r\n                        <div>\r\n                            <div className=\"text-white font-medium text-sm\">{r.route}</div>\r\n                            <div className=\"flex items-center gap-2 mt-1\">\r\n                                <span className=\"text-[10px] bg-slate-800 px-1.5 rounded text-slate-400\">{r.count} trips</span>\r\n                                <span className=\"text-[10px] text-slate-500\">Cost: ฿{r.cost.toLocaleString()}</span>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                             <div className=\"text-emerald-400 font-bold text-sm\">{r.margin.toFixed(1)}% Margin</div>\r\n                             <div className=\"text-[10px] text-slate-500 mt-0.5\">Rev: ฿{r.revenue.toLocaleString()}</div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n                {routes.length === 0 && (\r\n                     <div className=\"py-8 text-center text-slate-500 text-sm\">ไม่มีข้อมูลเส้นทาง</div>\r\n                )}\r\n             </div>\r\n           </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\dashboard-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\driver-leaderboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Card"},"fix":{"range":[25,30],"text":""},"desc":"Remove unused variable \"Card\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":3,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardContent"},"fix":{"range":[29,42],"text":""},"desc":"Remove unused variable \"CardContent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":3,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[42,54],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardTitle' is defined but never used.","line":3,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":50,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CardTitle"},"fix":{"range":[16,95],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trophy' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Trophy"},"fix":{"range":[106,113],"text":""},"desc":"Remove unused variable \"Trophy\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Trophy, Star, TrendingUp } from \"lucide-react\"\r\n\r\ntype DriverPerformance = {\r\n  name: string\r\n  revenue: number\r\n  completedJobs: number\r\n  totalJobs: number\r\n  successRate: number\r\n}\r\n\r\nexport function DriverLeaderboard({ data }: { data: DriverPerformance[] }) {\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(amount)\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {data.map((driver, index) => (\r\n        <div \r\n            key={driver.name} \r\n            className=\"group relative flex items-center justify-between p-4 bg-slate-900/40 border border-slate-800 rounded-xl hover:border-emerald-500/30 transition-all overflow-hidden\"\r\n        >\r\n          {/* Rank indicator */}\r\n          <div className=\"absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-emerald-500/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n          \r\n          <div className=\"flex items-center gap-4\">\r\n            <div className={`flex items-center justify-center w-10 h-10 rounded-full font-black text-sm\r\n                ${index === 0 ? 'bg-amber-500/20 text-amber-500 border border-amber-500/20' : \r\n                  index === 1 ? 'bg-slate-300/10 text-slate-300 border border-slate-300/20' : \r\n                  index === 2 ? 'bg-orange-900/20 text-orange-500 border border-orange-500/20' : \r\n                  'bg-slate-800 text-slate-500'}`}\r\n            >\r\n              {index + 1}\r\n            </div>\r\n            <div>\r\n              <p className=\"font-bold text-white mb-0.5\">{driver.name}</p>\r\n              <div className=\"flex items-center gap-3 text-[10px] uppercase tracking-wider font-bold text-slate-500\">\r\n                <span className=\"flex items-center gap-1\"><Star size={10} className=\"text-amber-500\" /> {driver.successRate.toFixed(0)}% Success</span>\r\n                <span>•</span>\r\n                <span>{driver.completedJobs} / {driver.totalJobs} Jobs</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"text-right\">\r\n            <p className=\"text-lg font-black text-white\">{formatCurrency(driver.revenue)}</p>\r\n            <div className=\"flex items-center justify-end gap-1 text-[10px] uppercase font-bold text-emerald-400\">\r\n              <TrendingUp size={10} /> Yield Focus\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ))}\r\n      \r\n      {data.length === 0 && (\r\n        <div className=\"text-center p-8 text-slate-500 italic\">ไม่มีข้อมูลคนขับในช่วงเวลานี้</div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\driver-performance-summary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\efficiency-charts.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[368,371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[368,371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { \r\n    ScatterChart, \r\n    Scatter, \r\n    XAxis, \r\n    YAxis, \r\n    ZAxis,\r\n    CartesianGrid, \r\n    Tooltip, \r\n    ResponsiveContainer,\r\n    Cell\r\n} from 'recharts'\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Coins, Zap } from \"lucide-react\"\r\n\r\nexport function EfficiencyCharts({ data }: { data: any[] }) {\r\n  // Process data for correlation (Revenue vs Cost per Job)\r\n  const correlationData = data.filter(d => d.jobCount > 0).map(d => ({\r\n    name: d.date,\r\n    revenuePerJob: d.revenue / d.jobCount,\r\n    costPerJob: d.cost / d.jobCount,\r\n    jobCount: d.jobCount\r\n  }))\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n      {/* Revenue vs Cost Correlation */}\r\n      <Card className=\"bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl\">\r\n        <CardHeader className=\"border-b border-slate-800/50 bg-slate-900/40\">\r\n            <CardTitle className=\"text-white flex items-center gap-3 text-sm font-bold\">\r\n                <Coins className=\"text-yellow-400\" size={18} /> \r\n                <span>ประสิทธิภาพต้นทุนเฉลี่ยต่อชิ้น <span className=\"text-slate-500 font-normal text-xs ml-1\">(Cost vs Revenue per Job)</span></span>\r\n            </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"pt-6 h-[300px]\">\r\n          <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: -20 }}>\r\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#334155\" opacity={0.3} />\r\n              <XAxis \r\n                type=\"number\" \r\n                dataKey=\"costPerJob\" \r\n                name=\"ต้นทุนเฉลี่ย\" \r\n                unit=\"฿\" \r\n                stroke=\"#64748b\" \r\n                fontSize={10}\r\n                tickLine={false}\r\n              />\r\n              <YAxis \r\n                type=\"number\" \r\n                dataKey=\"revenuePerJob\" \r\n                name=\"รายได้เฉลี่ย\" \r\n                unit=\"฿\" \r\n                stroke=\"#64748b\" \r\n                fontSize={10}\r\n                tickLine={false}\r\n              />\r\n              <ZAxis type=\"number\" dataKey=\"jobCount\" range={[50, 400]} name=\"จำนวนงาน\" />\r\n              <Tooltip \r\n                cursor={{ strokeDasharray: '3 3' }} \r\n                contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '8px' }}\r\n              />\r\n              <Scatter name=\"Days\" data={correlationData} fill=\"#3b82f6\">\r\n                {correlationData.map((entry, index) => (\r\n                    <Cell key={`cell-${index}`} fill={entry.revenuePerJob > entry.costPerJob ? '#10b981' : '#ef4444'} fillOpacity={0.6} />\r\n                ))}\r\n              </Scatter>\r\n            </ScatterChart>\r\n          </ResponsiveContainer>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Summary KPI for Efficiency */}\r\n      <Card className=\"bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl border-l-4 border-l-indigo-500\">\r\n        <CardContent className=\"p-8 flex flex-col justify-center h-full space-y-6\">\r\n           <div className=\"flex items-center gap-4\">\r\n              <div className=\"p-4 bg-indigo-500/10 rounded-2xl text-indigo-400\">\r\n                  <Zap size={32} />\r\n              </div>\r\n              <div>\r\n                  <h3 className=\"text-slate-400 text-sm font-medium\">Efficiency Index</h3>\r\n                  <p className=\"text-2xl font-bold text-white\">Cost/Revenue Optimization</p>\r\n              </div>\r\n           </div>\r\n           \r\n           <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"bg-slate-800/40 p-4 rounded-xl border border-white/5\">\r\n                  <p className=\"text-[10px] text-slate-500 uppercase font-bold mb-1\">Avg Margin</p>\r\n                  <p className=\"text-xl font-bold text-emerald-400\">\r\n                    {((correlationData.reduce((acc, curr) => acc + (curr.revenuePerJob - curr.costPerJob), 0) / correlationData.length) / (correlationData.reduce((acc, curr) => acc + curr.revenuePerJob, 0) / correlationData.length) * 100).toFixed(1)}%\r\n                  </p>\r\n              </div>\r\n              <div className=\"bg-slate-800/40 p-4 rounded-xl border border-white/5\">\r\n                  <p className=\"text-[10px] text-slate-500 uppercase font-bold mb-1\">Cost Volatility</p>\r\n                  <p className=\"text-xl font-bold text-indigo-400\">Low</p>\r\n              </div>\r\n           </div>\r\n           \r\n           <p className=\"text-xs text-slate-500 leading-relaxed\">\r\n             การวิเคราะห์ความสัมพันธ์ระหว่างรายได้และต้นทุนแสดงให้เห็นว่าจุดคุ้มทุนของงานส่วนใหญ่อยู่ในเกณฑ์มาตรฐาน \r\n             ควรจับตามองวันที่จุดข้อมูลเป็นสีแดงเพื่อวิเคราะห์หาสาเหตุของต้นทุนที่สูงผิดปกติ\r\n           </p>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\export-all-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[225,228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[225,228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[253,256],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[253,256],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[283,286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[283,286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[311,314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[311,314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[339,342],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[339,342],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[364,367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[364,367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[395,398],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[395,398],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1370,1373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1370,1373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Download } from \"lucide-react\"\r\nimport { exportToCSV } from \"@/lib/utils/export\"\r\n\r\ninterface ExportAllButtonProps {\r\n    data: {\r\n        financials: any;\r\n        revenueTrend: any[];\r\n        topCustomers: any[];\r\n        statusDist: any[];\r\n        branchPerf: any[];\r\n        subPerf: any[];\r\n        [key: string]: any; // Allow additional modules\r\n    }\r\n}\r\n\r\nexport function ExportAllButton({ data }: ExportAllButtonProps) {\r\n    const handleExportAll = () => {\r\n        // Flatten various stats into a single report for convenience\r\n        // In a real scenario, we might want separate sheets in an Excel file,\r\n        // but for CSV we'll just download the most important one (Branch Performance)\r\n        // or trigger multiple downloads.\r\n        \r\n        // Let's trigger a download for the most detailed operational data: Branch Performance\r\n        exportToCSV(data.branchPerf, \"executive_monthly_report_branches\");\r\n        \r\n        // And maybe a summary one\r\n        const summary = [{\r\n            revenue: data.financials.revenue,\r\n            total_cost: data.financials.cost.total,\r\n            net_profit: data.financials.netProfit,\r\n            margin: `${data.financials.profitMargin.toFixed(2)}%`,\r\n            total_jobs: data.statusDist.reduce((sum: number, item: any) => sum + item.value, 0)\r\n        }];\r\n        exportToCSV(summary, \"executive_monthly_report_summary\");\r\n    };\r\n\r\n    return (\r\n        <Button \r\n            className=\"bg-emerald-600 hover:bg-emerald-500 text-white font-bold\"\r\n            onClick={handleExportAll}\r\n        >\r\n            <Download className=\"mr-2 h-4 w-4\" /> Export Monthly Report\r\n        </Button>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\export-card-wrapper.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[254,257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[254,257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Download } from \"lucide-react\"\r\nimport { exportToCSV } from \"@/lib/utils/export\"\r\nimport { ReactNode } from \"react\"\r\n\r\ninterface ExportCardWrapperProps {\r\n    data: Record<string, any>[];\r\n    filename: string;\r\n    children: ReactNode;\r\n}\r\n\r\nexport function ExportCardWrapper({ data, filename, children }: ExportCardWrapperProps) {\r\n    const handleExport = () => {\r\n        exportToCSV(data, filename);\r\n    };\r\n\r\n    return (\r\n        <div className=\"relative group\">\r\n            <div className=\"absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                <Button \r\n                    variant=\"ghost\" \r\n                    size=\"sm\" \r\n                    className=\"h-8 px-2 text-slate-400 hover:text-white hover:bg-slate-800\"\r\n                    onClick={handleExport}\r\n                >\r\n                    <Download className=\"h-4 w-4 mr-2\" />\r\n                    <span className=\"text-xs\">Export</span>\r\n                </Button>\r\n            </div>\r\n            {children}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\fuel-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\health-scorecards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\maintenance-section.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":5,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[206,216],"text":""},"desc":"Remove unused variable \"Calendar\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { MaintenanceScheduleData } from \"@/lib/supabase/maintenance-schedule\"\r\nimport { Wrench, AlertTriangle, Calendar, CheckCircle2, Truck } from \"lucide-react\"\r\n\r\nexport function MaintenanceSection({ data }: { data: MaintenanceScheduleData }) {\r\n  const { overdue, dueSoon, activeRepairs, completedThisMonth, totalCostThisMonth, vehicleHealthSummary } = data\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Section Header */}\r\n      <div className=\"flex items-center gap-3 text-rose-400\">\r\n        <div className=\"p-2 bg-rose-500/10 rounded-lg\">\r\n          <Wrench size={20} />\r\n        </div>\r\n        <h2 className=\"text-lg font-bold uppercase tracking-[0.2em]\">Maintenance & Fleet Health</h2>\r\n      </div>\r\n\r\n      {/* KPI Grid */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        {/* Active Repairs */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">กำลังซ่อมบำรุง</span>\r\n              <div className=\"p-2 bg-blue-500/10 rounded-full text-blue-400\">\r\n                <Wrench size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">{activeRepairs} คัน</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">อยู่ในอู่ซ่อม</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Overdue */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">เกินกำหนด (Overdue)</span>\r\n              <div className=\"p-2 bg-red-500/10 rounded-full text-red-400\">\r\n                <AlertTriangle size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-red-400\">{overdue.length} รายการ</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">ต้องดำเนินการทันที</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Completed This Month */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">ซ่อมเสร็จเดือนนี้</span>\r\n              <div className=\"p-2 bg-emerald-500/10 rounded-full text-emerald-400\">\r\n                <CheckCircle2 size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">{completedThisMonth} คัน</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">งานซ่อมบำรุงที่ปิดแล้ว</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Cost This Month */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n          <CardContent className=\"p-6\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <span className=\"text-slate-400 text-sm font-medium\">ค่าซ่อมเดือนนี้</span>\r\n              <div className=\"p-2 bg-rose-500/10 rounded-full text-rose-400\">\r\n                <Wrench size={16} />\r\n              </div>\r\n            </div>\r\n            <div className=\"text-2xl font-bold text-white\">฿{totalCostThisMonth.toLocaleString()}</div>\r\n            <p className=\"text-xs text-slate-500 mt-1\">รวมค่าอะไหล่และค่าแรง</p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Lists */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Alerts List (Overdue + Due Soon) */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n           <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <AlertTriangle size={16} className=\"text-slate-400\" />\r\n               การแจ้งเตือนและการนัดหมาย\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-0\">\r\n              <div className=\"divide-y divide-white/5\">\r\n                {[...overdue, ...dueSoon.slice(0, 5)].map((item, i) => (\r\n                    <div key={`${item.vehicle_plate}-${item.service_type}-${i}`} className=\"py-4 flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <div className={`w-8 h-8 rounded flex items-center justify-center text-[10px] font-bold text-white ${item.status === 'overdue' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}`}>\r\n                                {item.days_until <= 0 ? '!' : item.days_until}\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"text-white font-medium text-sm flex items-center gap-2\">\r\n                                  {item.vehicle_plate} \r\n                                  <span className=\"text-[10px] bg-slate-800 px-1.5 rounded text-slate-400\">{item.vehicle_type}</span>\r\n                                </div>\r\n                                <div className=\"text-xs text-slate-400 mt-0.5\">{item.service_type}</div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                             <div className={`text-sm font-bold ${item.status === 'overdue' ? 'text-red-400' : 'text-yellow-400'}`}>\r\n                                {item.status === 'overdue' ? 'เลยกำหนด' : 'อีก ' + item.days_until + ' วัน'}\r\n                             </div>\r\n                             <div className=\"text-[10px] text-slate-500 mt-0.5\">\r\n                                {new Date(item.due_date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })}\r\n                             </div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n                {overdue.length === 0 && dueSoon.length === 0 && (\r\n                     <div className=\"py-8 text-center text-slate-500 text-sm\">ไม่มีรายการแจ้งเตือน</div>\r\n                )}\r\n              </div>\r\n           </CardContent>\r\n        </Card>\r\n\r\n        {/* Vehicle Health (Most Repairs) */}\r\n        <Card className=\"bg-slate-900/50 border-slate-800 backdrop-blur-sm\">\r\n           <CardHeader className=\"border-b border-white/5 pb-4\">\r\n             <CardTitle className=\"text-sm font-medium text-slate-200 flex items-center gap-2\">\r\n               <Truck size={16} className=\"text-slate-400\" />\r\n               Vehicle Health Issues (Top 5)\r\n             </CardTitle>\r\n           </CardHeader>\r\n           <CardContent className=\"pt-0\">\r\n             <div className=\"divide-y divide-white/5\">\r\n                {vehicleHealthSummary.slice(0, 5).map((v) => (\r\n                    <div key={v.vehicle_plate} className=\"py-4 flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <div className=\"w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-300\">\r\n                                {v.vehicle_plate.slice(0, 2)}\r\n                            </div>\r\n                            <div>\r\n                                <div className=\"text-white font-medium text-sm\">{v.vehicle_plate}</div>\r\n                                <div className=\"text-xs text-slate-500 mt-0.5\">{v.openTickets} tickets pending</div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                             <div className=\"text-slate-300 font-bold text-sm\">฿{v.totalCost.toLocaleString()}</div>\r\n                             <div className=\"text-[10px] text-slate-500 mt-0.5\">Total Repair Cost</div>\r\n                        </div>\r\n                    </div>\r\n                ))}\r\n                {vehicleHealthSummary.length === 0 && (\r\n                    <div className=\"py-8 text-center text-slate-500 text-sm\">สภาพรถปกติทุกคัน</div>\r\n                )}\r\n             </div>\r\n           </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\month-filter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\performance-charts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\predictive-maintenance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\profitability-section.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2454,2457],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2454,2457],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4571,4574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4571,4574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { \r\n  BarChart, \r\n  Bar, \r\n  XAxis, \r\n  YAxis, \r\n  CartesianGrid, \r\n  Tooltip, \r\n  ResponsiveContainer,\r\n  Cell,\r\n  PieChart,\r\n  Pie\r\n} from 'recharts'\r\nimport { Coins, TrendingUp, Truck } from \"lucide-react\"\r\n\r\ntype VehicleProfitData = {\r\n    plate: string\r\n    revenue: number\r\n    driverCost: number\r\n    fuelCost: number\r\n    maintenanceCost: number\r\n    totalCost: number\r\n    netProfit: number\r\n}\r\n\r\ntype Props = {\r\n    data: VehicleProfitData[]\r\n    financials: {\r\n        revenue: number\r\n        cost: {\r\n            total: number\r\n            driver: number\r\n            fuel: number\r\n            maintenance: number\r\n        }\r\n    }\r\n}\r\n\r\nexport function ProfitabilitySection({ data, financials }: Props) {\r\n    // Sort by profit for the chart\r\n    const topPerformers = [...data].sort((a, b) => b.netProfit - a.netProfit).slice(0, 5)\r\n    \r\n    const costBreakdownData = [\r\n        { name: 'Driver Payout', value: financials.cost.driver, color: '#10b981' },\r\n        { name: 'Fuel', value: financials.cost.fuel, color: '#3b82f6' },\r\n        { name: 'Maintenance', value: financials.cost.maintenance, color: '#f59e0b' }\r\n    ]\r\n\r\n    return (\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n            <Card className=\"lg:col-span-2 bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl\">\r\n                <CardHeader className=\"border-b border-white/5\">\r\n                    <CardTitle className=\"text-white flex items-center gap-2\">\r\n                        <TrendingUp className=\"text-emerald-400\" size={18} />\r\n                        กำไรรายคัน (Profit per Vehicle)\r\n                    </CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"pt-6 h-[400px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <BarChart data={topPerformers} layout=\"vertical\">\r\n                            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#334155\" horizontal={false} />\r\n                            <XAxis type=\"number\" stroke=\"#94a3b8\" />\r\n                            <YAxis dataKey=\"plate\" type=\"category\" stroke=\"#94a3b8\" width={100} />\r\n                            <Tooltip \r\n                                contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155' }}\r\n                                formatter={(value: any) => [`฿${Number(value).toLocaleString()}`, 'Net Profit']}\r\n                            />\r\n                            <Bar dataKey=\"netProfit\" radius={[0, 4, 4, 0]}>\r\n                                {topPerformers.map((entry, index) => (\r\n                                    <Cell key={`cell-${index}`} fill={entry.netProfit > 0 ? '#10b981' : '#ef4444'} />\r\n                                ))}\r\n                            </Bar>\r\n                        </BarChart>\r\n                    </ResponsiveContainer>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl\">\r\n                <CardHeader className=\"border-b border-white/5\">\r\n                    <CardTitle className=\"text-white flex items-center gap-2\">\r\n                        <Coins className=\"text-blue-400\" size={18} />\r\n                        สัดส่วนต้นทุน (Cost Structure)\r\n                    </CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"pt-6\">\r\n                    <div className=\"h-[250px]\">\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <PieChart>\r\n                                <Pie\r\n                                    data={costBreakdownData}\r\n                                    cx=\"50%\"\r\n                                    cy=\"50%\"\r\n                                    innerRadius={60}\r\n                                    outerRadius={80}\r\n                                    paddingAngle={5}\r\n                                    dataKey=\"value\"\r\n                                >\r\n                                    {costBreakdownData.map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={entry.color} />\r\n                                    ))}\r\n                                </Pie>\r\n                                <Tooltip \r\n                                    contentStyle={{ backgroundColor: '#0f172a', border: '1px solid #334155' }}\r\n                                    formatter={(value: any) => [`฿${Number(value).toLocaleString()}`, 'Cost']}\r\n                                />\r\n                            </PieChart>\r\n                        </ResponsiveContainer>\r\n                    </div>\r\n                    \r\n                    <div className=\"space-y-4 mt-4\">\r\n                        {costBreakdownData.map((item) => (\r\n                            <div key={item.name} className=\"flex items-center justify-between\">\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: item.color }} />\r\n                                    <span className=\"text-xs text-slate-400\">{item.name}</span>\r\n                                </div>\r\n                                <span className=\"text-xs font-bold text-slate-200\">\r\n                                    {financials.cost.total > 0 ? ((item.value / financials.cost.total) * 100).toFixed(1) : 0}%\r\n                                </span>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"lg:col-span-3 bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-xl overflow-hidden\">\r\n                <CardHeader className=\"border-b border-white/5 bg-slate-900/80\">\r\n                    <CardTitle className=\"text-white text-sm font-bold flex items-center gap-2\">\r\n                        <Truck className=\"text-slate-400\" size={16} />\r\n                        ตารางสรุปรายรับ-รายจ่าย รายคัน (Vehicle Performance Ledger)\r\n                    </CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"p-0\">\r\n                    <div className=\"overflow-x-auto\">\r\n                        <table className=\"w-full text-left text-xs\">\r\n                            <thead className=\"bg-slate-800/50 text-slate-400 uppercase font-bold border-b border-slate-700\">\r\n                                <tr>\r\n                                    <th className=\"p-4\">ทะเบียนรถ</th>\r\n                                    <th className=\"p-4 text-right\">รายรับ (Revenue)</th>\r\n                                    <th className=\"p-4 text-right\">คนขับ (Driver)</th>\r\n                                    <th className=\"p-4 text-right\">น้ำมัน (Fuel)</th>\r\n                                    <th className=\"p-4 text-right\">ซ่อมบำรุง (Maint.)</th>\r\n                                    <th className=\"p-4 text-right font-bold text-white\">กำไรสุทธิ (Net Profit)</th>\r\n                                    <th className=\"p-4 text-center\">Margin</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody>\r\n                                {data.slice(0, 10).map((item) => (\r\n                                    <tr key={item.plate} className=\"border-b border-slate-800 hover:bg-white/5 transition-colors\">\r\n                                        <td className=\"p-4 font-bold text-slate-200\">{item.plate}</td>\r\n                                        <td className=\"p-4 text-right\">฿{item.revenue.toLocaleString()}</td>\r\n                                        <td className=\"p-4 text-right text-slate-400\">฿{item.driverCost.toLocaleString()}</td>\r\n                                        <td className=\"p-4 text-right text-slate-400\">฿{item.fuelCost.toLocaleString()}</td>\r\n                                        <td className=\"p-4 text-right text-slate-400\">฿{item.maintenanceCost.toLocaleString()}</td>\r\n                                        <td className={`p-4 text-right font-bold ${item.netProfit > 0 ? 'text-emerald-400' : 'text-red-400'}`}>\r\n                                            ฿{item.netProfit.toLocaleString()}\r\n                                        </td>\r\n                                        <td className=\"p-4 text-center\">\r\n                                            <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${\r\n                                                item.revenue > 0 && (item.netProfit / item.revenue) > 0.2 ? 'bg-emerald-500/20 text-emerald-400' :\r\n                                                item.revenue > 0 && (item.netProfit / item.revenue) > 0.1 ? 'bg-blue-500/10 text-blue-400' :\r\n                                                'bg-red-500/10 text-red-400'\r\n                                            }`}>\r\n                                                {item.revenue > 0 ? ((item.netProfit / item.revenue) * 100).toFixed(1) : 0}%\r\n                                            </span>\r\n                                        </td>\r\n                                    </tr>\r\n                                ))}\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\revenue-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\route-performance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\route-risk.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\safety-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\status-distribution.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\subcontractor-performance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\summary-cards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\analytics\\workforce-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\billing\\attachment-list.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadAttachments'. Either include it or remove the dependency array.","line":23,"column":8,"nodeType":"ArrayExpression","endLine":23,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [billingNoteId, loadAttachments]","fix":{"range":[900,915],"text":"[billingNoteId, loadAttachments]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1806,1809],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1806,1809],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":70,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2478,2481],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2478,2481],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Paperclip, Trash2, Download, Loader2, FileText, Upload } from \"lucide-react\"\r\nimport { getAttachments, uploadAttachment, deleteAttachment, Attachment } from \"@/lib/actions/attachment-actions\"\r\nimport { createClient } from \"@/utils/supabase/client\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface AttachmentListProps {\r\n    billingNoteId: string;\r\n    readonly?: boolean;\r\n}\r\n\r\nexport function AttachmentList({ billingNoteId, readonly = false }: AttachmentListProps) {\r\n    const [attachments, setAttachments] = useState<Attachment[]>([])\r\n    const [loading, setLoading] = useState(true)\r\n    const [uploading, setUploading] = useState(false)\r\n\r\n    useEffect(() => {\r\n        loadAttachments()\r\n    }, [billingNoteId])\r\n\r\n    const loadAttachments = async () => {\r\n        setLoading(true)\r\n        const data = await getAttachments(billingNoteId)\r\n        setAttachments(data)\r\n        setLoading(false)\r\n    }\r\n\r\n    const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (!event.target.files || event.target.files.length === 0) return\r\n        \r\n        const file = event.target.files[0]\r\n        setUploading(true)\r\n\r\n        try {\r\n            const formData = new FormData()\r\n            formData.append('billingNoteId', billingNoteId)\r\n            formData.append('file', file)\r\n\r\n            const result = await uploadAttachment(formData)\r\n            \r\n            if (!result.success) {\r\n                throw new Error(result.error)\r\n            }\r\n\r\n            toast.success(\"อัปโหลดไฟล์เรียบร้อย\")\r\n            loadAttachments()\r\n        } catch (error: any) {\r\n            console.error(\"Upload failed:\", error)\r\n            toast.error(error.message || \"อัปโหลดล้มเหลว\")\r\n        } finally {\r\n            setUploading(false)\r\n            // Reset input\r\n            event.target.value = ''\r\n        }\r\n    }\r\n\r\n    const handleDelete = async (attachment: Attachment) => {\r\n        if (!confirm(\"ต้องการลบไฟล์นี้หรือไม่?\")) return\r\n\r\n        try {\r\n            const { success, error } = await deleteAttachment(attachment.Attachment_ID, attachment.File_Path)\r\n            if (!success) throw new Error(error)\r\n            \r\n            toast.success(\"ลบไฟล์เรียบร้อย\")\r\n            loadAttachments()\r\n        } catch (error: any) {\r\n            toast.error(\"ลบไฟล์ล้มเหลว\")\r\n        }\r\n    }\r\n\r\n    const handleDownload = async (path: string) => {\r\n        const supabase = createClient()\r\n        const { data } = supabase.storage.from('billing-documents').getPublicUrl(path)\r\n        window.open(data.publicUrl, '_blank')\r\n    }\r\n\r\n    return (\r\n        <Card className=\"mt-6 bg-slate-900/50 border-slate-800\">\r\n            <CardHeader className=\"flex flex-row items-center justify-between py-4\">\r\n                <CardTitle className=\"text-lg font-medium text-white flex items-center gap-2\">\r\n                    <Paperclip className=\"w-5 h-5 text-indigo-400\" />\r\n                    เอกสารแนบ (Attachments)\r\n                </CardTitle>\r\n                {!readonly && (\r\n                    <div className=\"relative\">\r\n                        <input\r\n                            type=\"file\"\r\n                            onChange={handleFileUpload}\r\n                            className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\r\n                            disabled={uploading}\r\n                        />\r\n                        <Button disabled={uploading} variant=\"outline\" className=\"border-slate-700 hover:bg-slate-800\">\r\n                            {uploading ? <Loader2 className=\"w-4 h-4 animate-spin mr-2\" /> : <Upload className=\"w-4 h-4 mr-2\" />}\r\n                            {uploading ? \"กำลังอัปโหลด...\" : \"เพิ่มไฟล์แนบ\"}\r\n                        </Button>\r\n                    </div>\r\n                )}\r\n            </CardHeader>\r\n            <CardContent>\r\n                {loading ? (\r\n                    <div className=\"text-center py-4 text-slate-500\">Loading...</div>\r\n                ) : attachments.length === 0 ? (\r\n                    <div className=\"text-center py-8 text-slate-500 border border-dashed border-slate-800 rounded-lg\">\r\n                        ไม่มีเอกสารแนบ\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"space-y-2\">\r\n                        {attachments.map((file) => (\r\n                            <div key={file.Attachment_ID} className=\"flex items-center justify-between p-3 bg-slate-800 rounded-lg group hover:bg-slate-800/80 transition-colors\">\r\n                                <div className=\"flex items-center gap-3 overflow-hidden\">\r\n                                    <div className=\"p-2 bg-slate-700 rounded text-slate-300\">\r\n                                        <FileText className=\"w-5 h-5\" />\r\n                                    </div>\r\n                                    <div className=\"truncate\">\r\n                                        <p className=\"text-sm font-medium text-white truncate max-w-[200px] md:max-w-md\">{file.File_Name}</p>\r\n                                        <p className=\"text-xs text-slate-400\">{new Date(file.Uploaded_At).toLocaleString('th-TH')}</p>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDownload(file.File_Path)} className=\"text-slate-400 hover:text-white\">\r\n                                        <Download className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                    {!readonly && (\r\n                                        <Button size=\"icon\" variant=\"ghost\" onClick={() => handleDelete(file)} className=\"text-slate-400 hover:text-red-400\">\r\n                                            <Trash2 className=\"w-4 h-4\" />\r\n                                        </Button>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\billing\\billing-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":5,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[158,161],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3365,3368],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3365,3368],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4313,4316],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4313,4316],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Printer, Mail, Paperclip, Send, Loader2, X } from \"lucide-react\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { AttachmentList } from \"./attachment-list\"\r\nimport { sendBillingEmail } from \"@/lib/actions/email-actions\"\r\nimport { toast } from \"sonner\"\r\nimport { getAttachments } from \"@/lib/actions/attachment-actions\"\r\n\r\ninterface BillingActionsProps {\r\n    billingNoteId: string;\r\n    customerEmail?: string;\r\n    customerName: string;\r\n    trigger?: React.ReactNode;\r\n    hidePrint?: boolean;\r\n}\r\n\r\nexport function BillingActions({ billingNoteId, customerEmail = \"\", customerName, trigger, hidePrint = false }: BillingActionsProps) {\r\n    const [isEmailOpen, setIsEmailOpen] = useState(false)\r\n    const [isAttachmentsOpen, setIsAttachmentsOpen] = useState(false)\r\n    \r\n    // Email Form\r\n    const [emailTo, setEmailTo] = useState(customerEmail)\r\n    const [subject, setSubject] = useState(`ใบวางบิล / Billing Note #${billingNoteId}`)\r\n    const [message, setMessage] = useState(`เรียน ${customerName},\\n\\nทางบริษัทขอส่งใบวางบิลเลขที่ ${billingNoteId} ดังแนบ\\n\\nขอบคุณครับ`)\r\n    const [sending, setSending] = useState(false)\r\n\r\n    useEffect(() => {\r\n        // Append link to message on client side to avoid hydration mismatch\r\n        const appUrl = process.env.NEXT_PUBLIC_APP_URL || window.location.origin\r\n        const link = `${appUrl}/billing/print/${billingNoteId}`\r\n        \r\n        setMessage(prev => {\r\n            // Prevent duplicate appending\r\n            if (prev.includes(\"สามารถดูเอกสารออนไลน์ได้ที่:\")) return prev\r\n            return `${prev}\\n\\nสามารถดูเอกสารออนไลน์ได้ที่: ${link}`\r\n        })\r\n    }, [billingNoteId])\r\n\r\n    // Handle Print\r\n    const handlePrint = () => {\r\n        window.print()\r\n    }\r\n\r\n    // Handle Send Email\r\n    const handleSendEmail = async () => {\r\n        if (!emailTo) return toast.error(\"กรุณาระบุอีเมล\")\r\n        \r\n        setSending(true)\r\n        try {\r\n            const appUrl = process.env.NEXT_PUBLIC_APP_URL || window.location.origin\r\n            \r\n            // 1. Fetch Billing Note HTML\r\n            let billingHtml = \"\"\r\n            try {\r\n                // Fetch from current origin to avoid CORS, but use appUrl for links in the HTML\r\n                const res = await fetch(`/billing/print/${billingNoteId}`)\r\n                if (res.ok) {\r\n                    const text = await res.text()\r\n                    // Fix relative paths (css, js, images) to be absolute so they load in attachment\r\n                    // Use the Public URL for these links so they work for the recipient\r\n                    billingHtml = text\r\n                        .replace(/href=\"\\//g, `href=\"${appUrl}/`)\r\n                        .replace(/src=\"\\//g, `src=\"${appUrl}/`)\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Failed to fetch billing html\", e)\r\n            }\r\n\r\n            // 2. Fetch current attachments\r\n            const attachments = await getAttachments(billingNoteId)\r\n            const emailAttachments: any[] = attachments?.map(a => ({\r\n                filename: a.File_Name,\r\n                path: `${process.env.NEXT_PUBLIC_SUPABASE_URL!}/storage/v1/object/public/billing-documents/${a.File_Path}`\r\n            })) || []\r\n\r\n            // 3. Add Billing Note As Attachment (Default)\r\n            if (billingHtml) {\r\n                emailAttachments.push({\r\n                    filename: `BillingNote-${billingNoteId}.html`,\r\n                    content: billingHtml // Pass content string\r\n                })\r\n            }\r\n\r\n            const { success, error } = await sendBillingEmail({\r\n                to: emailTo,\r\n                subject: subject,\r\n                html: message.replace(/\\n/g, '<br/>'),\r\n                attachments: emailAttachments\r\n            })\r\n\r\n            if (!success) throw new Error(error)\r\n            \r\n            toast.success(\"ส่งอีเมลเรียบร้อย\")\r\n            setIsEmailOpen(false)\r\n        } catch (error: any) {\r\n            console.error(error)\r\n            toast.error(\"ส่งอีเมลไม่สำเร็จ: \" + error.message)\r\n        } finally {\r\n            setSending(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-4 w-full\">\r\n            <div className=\"flex justify-end gap-2 print:hidden\">\r\n                <Button variant=\"outline\" onClick={() => setIsAttachmentsOpen(!isAttachmentsOpen)} className=\"border-slate-300\">\r\n                    <Paperclip className=\"w-4 h-4 mr-2\" />\r\n                    {isAttachmentsOpen ? \"ซ่อนไฟล์แนบ\" : \"ไฟล์แนบ\"}\r\n                </Button>\r\n                {trigger ? (\r\n                    <div onClick={() => setIsEmailOpen(true)}>\r\n                        {trigger}\r\n                    </div>\r\n                ) : (\r\n                    <Button variant=\"outline\" onClick={() => setIsEmailOpen(true)} className=\"border-slate-300\">\r\n                        <Mail className=\"w-4 h-4 mr-2\" />\r\n                        ส่งอีเมล\r\n                    </Button>\r\n                )}\r\n                {!hidePrint && (\r\n                    <Button onClick={handlePrint} className=\"bg-blue-600 hover:bg-blue-700 text-white\">\r\n                        <Printer className=\"w-4 h-4 mr-2\" />\r\n                        พิมพ์ / Print\r\n                    </Button>\r\n                )}\r\n            </div>\r\n\r\n            {/* Attachments Section (Collapsible) */}\r\n            {isAttachmentsOpen && (\r\n                <div className=\"print:hidden animate-in slide-in-from-top-2 fade-in\">\r\n                    <AttachmentList billingNoteId={billingNoteId} />\r\n                </div>\r\n            )}\r\n\r\n            {/* Email Dialog */}\r\n            <Dialog open={isEmailOpen} onOpenChange={setIsEmailOpen}>\r\n                <DialogContent className=\"max-w-md\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>ส่งใบวางบิลทางอีเมล</DialogTitle>\r\n                        <DialogDescription>\r\n                            ส่งเอกสารและไฟล์แนบไปยังลูกค้า\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"grid gap-4 py-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label className=\"text-slate-200\">ถึง (Email)</Label>\r\n                            <Input \r\n                                value={emailTo} \r\n                                onChange={e => setEmailTo(e.target.value)} \r\n                                className=\"bg-slate-950 border-slate-700 text-slate-100 placeholder:text-slate-500\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <Label className=\"text-slate-200\">หัวข้อ (Subject)</Label>\r\n                            <Input \r\n                                value={subject} \r\n                                onChange={e => setSubject(e.target.value)} \r\n                                className=\"bg-slate-950 border-slate-700 text-slate-100 placeholder:text-slate-500\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <Label className=\"text-slate-200\">ข้อความ</Label>\r\n                            <Textarea \r\n                                value={message} \r\n                                onChange={e => setMessage(e.target.value)} \r\n                                rows={8}\r\n                                className=\"bg-slate-950 border-slate-700 text-slate-100 placeholder:text-slate-500 min-h-[150px]\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setIsEmailOpen(false)}>ยกเลิก</Button>\r\n                        <Button onClick={handleSendEmail} disabled={sending}>\r\n                            {sending && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\r\n                            <Send className=\"w-4 h-4 mr-2\" />\r\n                            ส่งอีเมล\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\billing\\invoice-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Select' is defined but never used.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Select"},"fix":{"range":[318,325],"text":""},"desc":"Remove unused variable \"Select\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectContent' is defined but never used.","line":10,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SelectContent"},"fix":{"range":[324,339],"text":""},"desc":"Remove unused variable \"SelectContent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectItem' is defined but never used.","line":10,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SelectItem"},"fix":{"range":[339,351],"text":""},"desc":"Remove unused variable \"SelectItem\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectTrigger' is defined but never used.","line":10,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SelectTrigger"},"fix":{"range":[351,366],"text":""},"desc":"Remove unused variable \"SelectTrigger\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SelectValue' is defined but never used.","line":10,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":71,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"SelectValue"},"fix":{"range":[309,411],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Save' is defined but never used.","line":25,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Save"},"fix":{"range":[978,984],"text":""},"desc":"Remove unused variable \"Save\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Trash2' is defined but never used.","line":25,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Trash2"},"fix":{"range":[984,992],"text":""},"desc":"Remove unused variable \"Trash2\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1193,1196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1193,1196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1469,1472],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1469,1472],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setVatRate' is assigned a value but never used.","line":43,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3602,3605],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3602,3605],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":274,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":274,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13597,13600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13597,13600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { \r\n  Table, \r\n  TableBody, \r\n  TableCell, \r\n  TableHead, \r\n  TableHeader, \r\n  TableRow \r\n} from \"@/components/ui/table\"\r\nimport { Calendar } from \"@/components/ui/calendar\"\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\"\r\nimport { CustomerAutocomplete } from \"@/components/customer-autocomplete\"\r\nimport { getBillableJobsAction } from \"@/app/billing/invoices/actions\"\r\nimport { createInvoiceAction } from \"@/app/billing/invoices/actions\"\r\nimport { CalendarIcon, Loader2, Save, Trash2, Calculator } from \"lucide-react\"\r\nimport { format } from \"date-fns\"\r\nimport { th } from \"date-fns/locale\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport function InvoiceForm({ customers }: { customers: any[] }) {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [fetchingJobs, setFetchingJobs] = useState(false)\r\n  \r\n  // Data State\r\n  const [customerId, setCustomerId] = useState(\"\")\r\n  const [availableJobs, setAvailableJobs] = useState<any[]>([])\r\n  const [selectedJobIds, setSelectedJobIds] = useState<string[]>([])\r\n  \r\n  // Invoice Details\r\n  const [issueDate, setIssueDate] = useState<Date>(new Date())\r\n  const [dueDate, setDueDate] = useState<Date>(new Date(new Date().setDate(new Date().getDate() + 30)))\r\n  const [vatRate, setVatRate] = useState(7)\r\n  const [whtRate, setWhtRate] = useState(0)\r\n  const [notes, setNotes] = useState(\"\")\r\n\r\n  // Fetch Jobs when Customer Changes\r\n  useEffect(() => {\r\n    if (customerId) {\r\n        setFetchingJobs(true)\r\n        getBillableJobsAction(customerId).then(jobs => {\r\n            setAvailableJobs(jobs || [])\r\n            setFetchingJobs(false)\r\n            // Auto Select All? Maybe not.\r\n            setSelectedJobIds([])\r\n        })\r\n    } else {\r\n        setAvailableJobs([])\r\n        setSelectedJobIds([])\r\n    }\r\n  }, [customerId])\r\n\r\n  // Calculation\r\n  const selectedJobs = availableJobs.filter(j => selectedJobIds.includes(j.Job_ID))\r\n  \r\n  const subtotal = selectedJobs.reduce((sum, job) => sum + (Number(job.Price_Cust_Total) || 0), 0)\r\n  const vatAmount = subtotal * (vatRate / 100)\r\n  const grandTotal = subtotal + vatAmount\r\n  const whtAmount = subtotal * (whtRate / 100)\r\n  const netTotal = grandTotal - whtAmount\r\n\r\n  const handleSubmit = async () => {\r\n    if (!customerId || selectedJobs.length === 0) return\r\n\r\n    setLoading(true)\r\n    try {\r\n        const result = await createInvoiceAction({\r\n            Customer_ID: customerId,\r\n            Issue_Date: issueDate.toISOString(),\r\n            Due_Date: dueDate.toISOString(),\r\n            Subtotal: subtotal,\r\n            VAT_Rate: vatRate,\r\n            VAT_Amount: vatAmount,\r\n            Grand_Total: grandTotal,\r\n            WHT_Rate: whtRate,\r\n            WHT_Amount: whtAmount,\r\n            Net_Total: netTotal,\r\n            Status: 'Draft',\r\n            Notes: notes,\r\n            Items_JSON: selectedJobs, // Snapshot\r\n            Created_By: 'System' // Should be user ID\r\n        })\r\n\r\n        if (!result || !result.success) {\r\n            console.error(result?.error)\r\n            alert(\"Error creating invoice: \" + ((result?.error as any)?.message || JSON.stringify(result?.error || 'Unknown error')))\r\n        } else {\r\n            router.push('/billing/invoices')\r\n            router.refresh()\r\n        }\r\n    } catch (e) {\r\n        alert(\"Exception: \" + e)\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n        {/* Customer & Dates */}\r\n        <Card className=\"bg-slate-900 border-slate-800\">\r\n            <CardContent className=\"p-6 grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-300\">ลูกค้า (Customer)</Label>\r\n                    <CustomerAutocomplete \r\n                        value={customerId}\r\n                        onChange={setCustomerId}\r\n                        customers={customers}\r\n                        onSelect={(c) => setCustomerId(c.Customer_ID)}\r\n                        className=\"bg-slate-800 border-slate-700\"\r\n                    />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-300\">วันที่ออกเอกสาร (Issue Date)</Label>\r\n                    <DateCallbackSelect date={issueDate} setDate={setIssueDate} />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-300\">วันครบกำหนด (Due Date)</Label>\r\n                    <DateCallbackSelect date={dueDate} setDate={setDueDate} />\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n\r\n        {/* Job Selection */}\r\n        <Card className=\"bg-slate-900 border-slate-800\">\r\n            <CardContent className=\"p-0\">\r\n                <div className=\"p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50\">\r\n                    <h3 className=\"font-semibold text-slate-200 flex items-center gap-2\">\r\n                        <Calculator className=\"w-4 h-4 text-purple-400\" />\r\n                        รายการงานที่วางบิลได้ ({availableJobs.length})\r\n                    </h3>\r\n                    <div className=\"text-xs text-slate-400\">\r\n                        เลือก {selectedJobs.length} รายการ\r\n                    </div>\r\n                </div>\r\n                \r\n                {fetchingJobs ? (\r\n                    <div className=\"p-8 flex justify-center text-slate-500 gap-2\">\r\n                        <Loader2 className=\"animate-spin\" /> กำลังโหลดรายการงาน...\r\n                    </div>\r\n                ) : availableJobs.length === 0 ? (\r\n                    <div className=\"p-8 text-center text-slate-500\">\r\n                        {customerId ? \"ไม่มีงานที่รอวางบิลสำหรับลูกค้านี้\" : \"กรุณาเลือกลูกค้าก่อน\"}\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"max-h-[400px] overflow-y-auto\">\r\n                        <Table>\r\n                            <TableHeader className=\"bg-slate-800 sticky top-0 z-10\">\r\n                                <TableRow className=\"border-slate-700\">\r\n                                    <TableHead className=\"w-[50px]\">\r\n                                        <Checkbox \r\n                                            checked={selectedJobIds.length === availableJobs.length && availableJobs.length > 0}\r\n                                            onCheckedChange={(checked) => {\r\n                                                if (checked) setSelectedJobIds(availableJobs.map(j => j.Job_ID))\r\n                                                else setSelectedJobIds([])\r\n                                            }}\r\n                                            className=\"border-slate-500 data-[state=checked]:bg-purple-600 data-[state=checked]:border-purple-600\"\r\n                                        />\r\n                                    </TableHead>\r\n                                    <TableHead className=\"text-slate-300\">Job ID</TableHead>\r\n                                    <TableHead className=\"text-slate-300\">วันที่</TableHead>\r\n                                    <TableHead className=\"text-slate-300\">เส้นทาง</TableHead>\r\n                                    <TableHead className=\"text-right text-slate-300\">ราคา</TableHead>\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {availableJobs.map((job) => (\r\n                                    <TableRow key={job.Job_ID} className=\"border-slate-800 hover:bg-slate-800/30\">\r\n                                        <TableCell>\r\n                                            <Checkbox \r\n                                                checked={selectedJobIds.includes(job.Job_ID)}\r\n                                                onCheckedChange={(checked) => {\r\n                                                    if (checked) setSelectedJobIds([...selectedJobIds, job.Job_ID])\r\n                                                    else setSelectedJobIds(selectedJobIds.filter(id => id !== job.Job_ID))\r\n                                                }}\r\n                                                className=\"border-slate-600 data-[state=checked]:bg-purple-600 data-[state=checked]:border-purple-600\"\r\n                                            />\r\n                                        </TableCell>\r\n                                        <TableCell className=\"font-mono text-xs\">{job.Job_ID}</TableCell>\r\n                                        <TableCell>{new Date(job.Plan_Date).toLocaleDateString('th-TH')}</TableCell>\r\n                                        <TableCell className=\"max-w-[200px] truncate\" title={job.Route_Name}>{job.Route_Name}</TableCell>\r\n                                        <TableCell className=\"text-right font-medium\">\r\n                                            {Number(job.Price_Cust_Total).toLocaleString()}\r\n                                        </TableCell>\r\n                                    </TableRow>\r\n                                ))}\r\n                            </TableBody>\r\n                        </Table>\r\n                    </div>\r\n                )}\r\n            </CardContent>\r\n        </Card>\r\n\r\n        {/* Totals & Actions */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n            <div className=\"md:col-span-2 space-y-4\">\r\n                 <div className=\"space-y-2\">\r\n                    <Label className=\"text-slate-300\">หมายเหตุ (Notes)</Label>\r\n                    <Input \r\n                        value={notes} \r\n                        onChange={(e) => setNotes(e.target.value)} \r\n                        className=\"bg-slate-900 border-slate-800\" \r\n                        placeholder=\"ระบุหมายเหตุ...\"\r\n                    />\r\n                 </div>\r\n            </div>\r\n            <Card className=\"bg-slate-900 border-slate-800 shadow-xl\">\r\n                <CardContent className=\"p-6 space-y-4\">\r\n                    <div className=\"flex justify-between text-sm text-slate-400\">\r\n                        <span>รวมราคา ({selectedJobs.length} รายการ)</span>\r\n                        <span>{subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n                    \r\n                    <div className=\"flex items-center justify-between text-sm\">\r\n                        <span className=\"text-slate-400\">VAT {vatRate}%</span>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            {/* Toggle VAT? For now assumed on, edit rate 0-7 */}\r\n                        </div>\r\n                        <span>{vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between text-sm\">\r\n                         <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-slate-400\">หัก ณ ที่จ่าย</span>\r\n                            <select \r\n                                value={whtRate} \r\n                                onChange={(e) => setWhtRate(Number(e.target.value))}\r\n                                className=\"h-6 text-xs bg-slate-800 border-slate-700 rounded text-white\"\r\n                            >\r\n                                <option value=\"0\">0%</option>\r\n                                <option value=\"1\">1% (ขนส่ง)</option>\r\n                                <option value=\"3\">3% (บริการ)</option>\r\n                                <option value=\"5\">5% (ค่าเช่า)</option>\r\n                            </select>\r\n                         </div>\r\n                         <span className=\"text-red-400\">-{whtAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>\r\n                    </div>\r\n\r\n                    <div className=\"border-t border-slate-800 pt-4 flex justify-between items-end\">\r\n                        <div className=\"text-xs text-slate-500\">\r\n                            ยอดชำระสุทธิ (Net Total) <br/>\r\n                            <span className=\"text-[10px]\">(Grand Total: {grandTotal.toLocaleString()})</span>\r\n                        </div>\r\n                        <div className=\"text-xl font-bold text-purple-400\">\r\n                            {netTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}\r\n                        </div>\r\n                    </div>\r\n\r\n                    <Button \r\n                        onClick={handleSubmit} \r\n                        disabled={loading || selectedJobs.length === 0}\r\n                        className=\"w-full bg-purple-600 hover:bg-purple-700\"\r\n                    >\r\n                        {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n                        สร้างใบกำกับภาษี (Create Invoice)\r\n                    </Button>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction DateCallbackSelect({ date, setDate }: { date: Date | undefined, setDate: (d: any) => void }) {\r\n    return (\r\n        <Popover>\r\n        <PopoverTrigger asChild>\r\n          <Button\r\n            variant={\"outline\"}\r\n            className={cn(\r\n              \"w-full justify-start text-left font-normal bg-slate-800 border-slate-700 hover:bg-slate-700\",\r\n              !date && \"text-muted-foreground\"\r\n            )}\r\n          >\r\n            <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n            {date ? format(date, \"PPP\", { locale: th }) : <span>เลือกวันที่</span>}\r\n          </Button>\r\n        </PopoverTrigger>\r\n        <PopoverContent className=\"w-auto p-0 bg-slate-900 border-slate-800\">\r\n          <Calendar\r\n            mode=\"single\"\r\n            selected={date}\r\n            onSelect={setDate}\r\n            initialFocus\r\n            className=\"bg-slate-900 text-white\"\r\n          />\r\n        </PopoverContent>\r\n      </Popover>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\billing\\print-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\chat\\chat-window.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[423,426],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[423,426],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[448,451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[448,451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2911,2914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2911,2914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":262,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9758,9761],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9758,9761],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'scrollToBottom', 'supabase', and 'updateContactList'. Either include them or remove the dependency array.","line":215,"column":6,"nodeType":"ArrayExpression","endLine":215,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [scrollToBottom, selectedDriverId, supabase, updateContactList]","fix":{"range":[7829,7847],"text":"[scrollToBottom, selectedDriverId, supabase, updateContactList]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchMessages' and 'markAllAsRead'. Either include them or remove the dependency array.","line":224,"column":6,"nodeType":"ArrayExpression","endLine":224,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMessages, markAllAsRead, selectedDriverId]","fix":{"range":[8074,8092],"text":"[fetchMessages, markAllAsRead, selectedDriverId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect, useRef, useCallback, useMemo } from 'react'\r\nimport { createClient } from '@/utils/supabase/client'\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Send, Search, MessageSquare, Check, CheckCheck } from \"lucide-react\"\r\nimport { ChatMessage } from '@/lib/supabase/chat'\r\n\r\ninterface ChatWindowProps {\r\n  initialContacts: any[]\r\n  initialDrivers: any[]\r\n}\r\n\r\nfunction formatTime(dateStr: string) {\r\n  return new Date(dateStr).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })\r\n}\r\n\r\nfunction formatDate(dateStr: string) {\r\n  const d = new Date(dateStr)\r\n  const today = new Date()\r\n  const yesterday = new Date(today)\r\n  yesterday.setDate(yesterday.getDate() - 1)\r\n  \r\n  if (d.toDateString() === today.toDateString()) return 'วันนี้'\r\n  if (d.toDateString() === yesterday.toDateString()) return 'เมื่อวาน'\r\n  return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' })\r\n}\r\n\r\nfunction groupMessagesByDate(messages: ChatMessage[]) {\r\n  const groups: { date: string; messages: ChatMessage[] }[] = []\r\n  let currentDate = ''\r\n  for (const msg of messages) {\r\n    const date = new Date(msg.created_at).toDateString()\r\n    if (date !== currentDate) {\r\n      currentDate = date\r\n      groups.push({ date: msg.created_at, messages: [msg] })\r\n    } else {\r\n      groups[groups.length - 1].messages.push(msg)\r\n    }\r\n  }\r\n  return groups\r\n}\r\n\r\nexport function ChatWindow({ initialContacts, initialDrivers }: ChatWindowProps) {\r\n  const [selectedDriverId, setSelectedDriverId] = useState<string | null>(null)\r\n  const [messages, setMessages] = useState<ChatMessage[]>([])\r\n  const [inputMessage, setInputMessage] = useState('')\r\n  const [contacts, setContacts] = useState(initialContacts)\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [isSending, setIsSending] = useState(false)\r\n  const messagesEndRef = useRef<HTMLDivElement>(null)\r\n  const chatContainerRef = useRef<HTMLDivElement>(null)\r\n  \r\n  const supabase = createClient()\r\n\r\n  // Sync contacts with props when branch changes (server refresh)\r\n  useEffect(() => {\r\n    setContacts(initialContacts)\r\n  }, [initialContacts])\r\n\r\n  // Auto-scroll to bottom\r\n  const scrollToBottom = useCallback((behavior: ScrollBehavior = 'smooth') => {\r\n    setTimeout(() => {\r\n      messagesEndRef.current?.scrollIntoView({ behavior })\r\n    }, 50)\r\n  }, [])\r\n\r\n  // Filtered contacts with search\r\n  const filteredContacts = useMemo(() => {\r\n    const all = contacts.length > 0 ? contacts : initialDrivers.map(d => ({\r\n      driver_id: d.Driver_ID,\r\n      driver_name: d.Driver_Name || 'Unknown',\r\n      last_message: 'เริ่มแชทเลย',\r\n      unread: 0,\r\n      updated_at: new Date().toISOString()\r\n    }))\r\n    \r\n    if (!searchQuery.trim()) return all\r\n    const q = searchQuery.toLowerCase()\r\n    return all.filter((c: any) => \r\n      (c.driver_name || c.Driver_Name || '').toLowerCase().includes(q) ||\r\n      (c.driver_id || c.Driver_ID || '').toLowerCase().includes(q)\r\n    )\r\n  }, [contacts, initialDrivers, searchQuery])\r\n\r\n  // Active driver info\r\n  const activeDriver = selectedDriverId \r\n    ? (contacts.find(c => c.driver_id === selectedDriverId) || initialDrivers.find(d => d.Driver_ID === selectedDriverId))\r\n    : null\r\n\r\n  // Fetch messages\r\n  const fetchMessages = useCallback(async (driverId: string) => {\r\n    const { data, error } = await supabase\r\n      .from('chat_messages')\r\n      .select('*')\r\n      .eq('driver_id', driverId)\r\n      .order('created_at', { ascending: true })\r\n    \r\n    if (!error && data) {\r\n      setMessages(data)\r\n      scrollToBottom('instant')\r\n    }\r\n  }, [supabase, scrollToBottom])\r\n\r\n  // Send message  \r\n  const sendMessage = useCallback(async () => {\r\n    if (!inputMessage.trim() || !selectedDriverId || isSending) return\r\n    \r\n    const messageText = inputMessage.trim()\r\n    setInputMessage('')\r\n    setIsSending(true)\r\n\r\n    // Optimistic update\r\n    const optimisticMsg: ChatMessage = {\r\n      id: Date.now(),\r\n      driver_id: selectedDriverId,\r\n      driver_name: activeDriver?.driver_name || activeDriver?.Driver_Name || 'Unknown',\r\n      sender: 'admin',\r\n      message: messageText,\r\n      created_at: new Date().toISOString(),\r\n      read: false,\r\n    }\r\n    setMessages(prev => [...prev, optimisticMsg])\r\n    scrollToBottom()\r\n\r\n    const { error } = await supabase\r\n      .from('chat_messages')\r\n      .insert({\r\n        driver_id: selectedDriverId,\r\n        sender: 'admin',\r\n        message: messageText,\r\n        read: false,\r\n        created_at: new Date().toISOString(),\r\n        driver_name: activeDriver?.driver_name || activeDriver?.Driver_Name || 'Unknown'\r\n      })\r\n\r\n    if (error) {\r\n      // Remove optimistic message on error\r\n      setMessages(prev => prev.filter(m => m.id !== optimisticMsg.id))\r\n      setInputMessage(messageText) // Restore input\r\n    }\r\n    setIsSending(false)\r\n  }, [inputMessage, selectedDriverId, isSending, activeDriver, supabase, scrollToBottom])\r\n\r\n  // Mark messages as read\r\n  const markAllAsRead = useCallback(async (driverId: string) => {\r\n    await supabase.from('chat_messages').update({ read: true })\r\n      .eq('driver_id', driverId).eq('sender', 'driver').eq('read', false)\r\n    \r\n    // Update unread count in contacts\r\n    setContacts(prev => prev.map(c => \r\n      c.driver_id === driverId ? { ...c, unread: 0 } : c\r\n    ))\r\n  }, [supabase])\r\n\r\n  // Update contact list on new message\r\n  const updateContactList = useCallback((newMsg: ChatMessage) => {\r\n    setContacts(prev => {\r\n      const existing = prev.find(c => c.driver_id === newMsg.driver_id)\r\n      if (existing) {\r\n        return prev.map(c => c.driver_id === newMsg.driver_id ? {\r\n          ...c,\r\n          last_message: newMsg.sender === 'admin' ? `คุณ: ${newMsg.message}` : newMsg.message,\r\n          unread: (newMsg.sender === 'driver' && newMsg.driver_id !== selectedDriverId) ? c.unread + 1 : c.unread,\r\n          updated_at: newMsg.created_at\r\n        } : c).sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime())\r\n      } else {\r\n        return [{\r\n          driver_id: newMsg.driver_id,\r\n          driver_name: newMsg.driver_name,\r\n          last_message: newMsg.message,\r\n          unread: newMsg.sender === 'driver' ? 1 : 0,\r\n          updated_at: newMsg.created_at\r\n        }, ...prev]\r\n      }\r\n    })\r\n  }, [selectedDriverId])\r\n\r\n  // Real-time subscription\r\n  useEffect(() => {\r\n    const channel = supabase\r\n      .channel('chat_realtime')\r\n      .on(\r\n        'postgres_changes',\r\n        { event: 'INSERT', schema: 'public', table: 'chat_messages' },\r\n        (payload) => {\r\n          const newMsg = payload.new as ChatMessage\r\n          \r\n          if (newMsg.driver_id === selectedDriverId) {\r\n            // Only add if not optimistic (check by comparing message text and sender)\r\n            setMessages(prev => {\r\n              const isDuplicate = prev.some(m => \r\n                m.sender === newMsg.sender && m.message === newMsg.message && \r\n                Math.abs(new Date(m.created_at).getTime() - new Date(newMsg.created_at).getTime()) < 5000\r\n              )\r\n              return isDuplicate ? prev.map(m => \r\n                (m.sender === newMsg.sender && m.message === newMsg.message && m.id !== newMsg.id) ? newMsg : m\r\n              ) : [...prev, newMsg]\r\n            })\r\n            scrollToBottom()\r\n            \r\n            if (newMsg.sender === 'driver') {\r\n              supabase.from('chat_messages').update({ read: true }).eq('id', newMsg.id)\r\n            }\r\n          }\r\n          \r\n          updateContactList(newMsg)\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => { supabase.removeChannel(channel) }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedDriverId])\r\n\r\n  // On driver select\r\n  useEffect(() => {\r\n    if (selectedDriverId) {\r\n      fetchMessages(selectedDriverId)\r\n      markAllAsRead(selectedDriverId)\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [selectedDriverId])\r\n\r\n  // Message groups\r\n  const messageGroups = useMemo(() => groupMessagesByDate(messages), [messages])\r\n\r\n  // Total unread\r\n  const totalUnread = useMemo(() => contacts.reduce((s, c) => s + (c.unread || 0), 0), [contacts])\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-0 h-[calc(100vh-220px)] border border-white/10 rounded-xl overflow-hidden\">\r\n      {/* Contacts Sidebar */}\r\n      <div className=\"lg:col-span-1 bg-slate-900/70 border-r border-white/10 flex flex-col\">\r\n        {/* Sidebar Header */}\r\n        <div className=\"p-4 border-b border-white/10\">\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <h3 className=\"text-white font-bold text-sm\">รายชื่อ</h3>\r\n            {totalUnread > 0 && (\r\n              <span className=\"px-2 py-0.5 rounded-full bg-blue-500 text-[10px] text-white font-medium\">\r\n                {totalUnread} ใหม่\r\n              </span>\r\n            )}\r\n          </div>\r\n          <div className=\"relative\">\r\n            <Search size={14} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500\" />\r\n            <Input \r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              placeholder=\"ค้นหาคนขับ...\" \r\n              className=\"bg-slate-800/50 border-slate-700 pl-9 h-9 text-sm\" \r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Contact List */}\r\n        <div className=\"flex-1 overflow-y-auto\">\r\n          {filteredContacts.length === 0 ? (\r\n            <div className=\"text-center py-8 text-slate-600 text-sm\">ไม่พบผลลัพธ์</div>\r\n          ) : (\r\n            filteredContacts.map((c: any) => {\r\n              const id = c.driver_id || c.Driver_ID\r\n              const name = c.driver_name || c.Driver_Name || 'Unknown'\r\n              const isSelected = selectedDriverId === id\r\n              return (\r\n                <div \r\n                  key={id}\r\n                  onClick={() => setSelectedDriverId(id)}\r\n                  className={`flex items-center gap-3 p-3.5 px-4 cursor-pointer transition-all border-b border-white/5 ${\r\n                    isSelected \r\n                      ? 'bg-blue-600/15 border-l-2 border-l-blue-500' \r\n                      : 'hover:bg-white/5 border-l-2 border-l-transparent'\r\n                  }`}\r\n                >\r\n                  <div className=\"relative shrink-0\">\r\n                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm ${\r\n                      isSelected ? 'bg-gradient-to-br from-blue-500 to-indigo-600' : 'bg-slate-700'\r\n                    }`}>\r\n                      {name.charAt(0)}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <div className=\"flex justify-between items-center\">\r\n                      <p className={`font-medium text-sm truncate ${isSelected ? 'text-white' : 'text-slate-300'}`}>{name}</p>\r\n                      {c.updated_at && (\r\n                        <span className=\"text-[10px] text-slate-600 shrink-0 ml-2\">\r\n                          {formatTime(c.updated_at)}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex justify-between items-center mt-0.5\">\r\n                      <p className=\"text-xs text-slate-500 truncate pr-2\">{c.last_message || 'เริ่มแชทเลย'}</p>\r\n                      {(c.unread || 0) > 0 && (\r\n                        <span className=\"flex h-5 min-w-5 items-center justify-center rounded-full bg-blue-500 text-[10px] text-white font-medium px-1 shrink-0\">\r\n                          {c.unread}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )\r\n            })\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Chat Area */}\r\n      <div className=\"lg:col-span-2 bg-slate-950/50 flex flex-col\">\r\n        {selectedDriverId && activeDriver ? (\r\n          <>\r\n            {/* Chat Header */}\r\n            <div className=\"p-4 border-b border-white/10 bg-slate-900/50\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold\">\r\n                  {(activeDriver.driver_name || activeDriver.Driver_Name || '?').charAt(0)}\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"text-white font-bold text-sm\">{activeDriver.driver_name || activeDriver.Driver_Name}</h3>\r\n                  <p className=\"text-[10px] text-slate-500\">ID: {selectedDriverId}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Messages */}\r\n            <div ref={chatContainerRef} className=\"flex-1 overflow-y-auto p-4 space-y-1\">\r\n              {messages.length === 0 ? (\r\n                <div className=\"text-center py-12 text-slate-600\">\r\n                  <MessageSquare size={32} className=\"mx-auto mb-2 opacity-30\" />\r\n                  <p className=\"text-sm\">เริ่มสนทนากับ {activeDriver.driver_name || activeDriver.Driver_Name}</p>\r\n                </div>\r\n              ) : (\r\n                messageGroups.map((group, gi) => (\r\n                  <div key={gi}>\r\n                    {/* Date Separator */}\r\n                    <div className=\"flex items-center justify-center my-4\">\r\n                      <span className=\"px-3 py-1 rounded-full bg-slate-800/80 text-[10px] text-slate-500\">\r\n                        {formatDate(group.date)}\r\n                      </span>\r\n                    </div>\r\n                    \r\n                    {/* Messages in this date */}\r\n                    <div className=\"space-y-1.5\">\r\n                      {group.messages.map((msg, mi) => {\r\n                        const isAdmin = msg.sender === 'admin'\r\n                        const showAvatar = !isAdmin && (mi === 0 || group.messages[mi-1]?.sender === 'admin')\r\n                        \r\n                        return (\r\n                          <div key={msg.id} className={`flex ${isAdmin ? 'justify-end' : 'justify-start'} items-end gap-2`}>\r\n                            {!isAdmin && (\r\n                              <div className=\"w-6 h-6 shrink-0\">\r\n                                {showAvatar && (\r\n                                  <div className=\"w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-[10px] text-white\">\r\n                                    {(msg.driver_name || '?').charAt(0)}\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n                            <div className={`max-w-[65%] rounded-2xl py-2 px-3.5 ${\r\n                              isAdmin \r\n                                ? 'bg-blue-600 text-white rounded-br-sm' \r\n                                : 'bg-slate-800 text-slate-200 rounded-bl-sm'\r\n                            }`}>\r\n                              <p className=\"text-sm leading-relaxed break-words\">{msg.message}</p>\r\n                              <div className={`flex items-center gap-1 mt-0.5 ${isAdmin ? 'justify-end' : ''}`}>\r\n                                <span className=\"text-[10px] opacity-50\">\r\n                                  {formatTime(msg.created_at)}\r\n                                </span>\r\n                                {isAdmin && (\r\n                                  msg.read \r\n                                    ? <CheckCheck size={12} className=\"opacity-70 text-cyan-300\" />\r\n                                    : <Check size={12} className=\"opacity-40\" />\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        )\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              )}\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            {/* Message Input */}\r\n            <div className=\"p-3 border-t border-white/10 bg-slate-900/30\">\r\n              <div className=\"flex gap-2\">\r\n                <Input \r\n                  value={inputMessage}\r\n                  onChange={(e) => setInputMessage(e.target.value)}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && !e.shiftKey) {\r\n                      e.preventDefault()\r\n                      sendMessage()\r\n                    }\r\n                  }}\r\n                  placeholder=\"พิมพ์ข้อความ...\" \r\n                  className=\"bg-slate-800/50 border-slate-700/50 focus:border-blue-500/50 h-10\" \r\n                  disabled={isSending}\r\n                />\r\n                <Button \r\n                  onClick={sendMessage} \r\n                  disabled={!inputMessage.trim() || isSending}\r\n                  className=\"bg-blue-600 hover:bg-blue-500 disabled:opacity-30 h-10 w-10 p-0 shrink-0\"\r\n                >\r\n                  <Send size={16} />\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </>\r\n        ) : (\r\n          <div className=\"flex-1 flex flex-col items-center justify-center text-slate-600\">\r\n            <div className=\"w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4\">\r\n              <MessageSquare size={28} className=\"opacity-40\" />\r\n            </div>\r\n            <p className=\"text-sm font-medium\">เลือกคนขับเพื่อเริ่มสนทนา</p>\r\n            <p className=\"text-xs mt-1 opacity-50\">{filteredContacts.length} คนขับ</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\customer-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":4,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Search"},"fix":{"range":[99,107],"text":""},"desc":"Remove unused variable \"Search\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[131,178],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'query'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [query, value]","fix":{"range":[1928,1935],"text":"[query, value]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { Check, ChevronsUpDown, Search } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nimport { Customer } from \"@/lib/supabase/customers\"\r\n\r\ninterface CustomerAutocompleteProps {\r\n  value: string\r\n  onChange: (value: string) => void\r\n  customers: Customer[]\r\n  onSelect: (customer: Customer) => void\r\n  className?: string\r\n}\r\n\r\nexport function CustomerAutocomplete({\r\n  value,\r\n  onChange,\r\n  customers,\r\n  onSelect,\r\n  className,\r\n}: CustomerAutocompleteProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [query, setQuery] = useState(\"\")\r\n  const wrapperRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Filter customers based on query or show all if empty\r\n  const filteredCustomers =\r\n    query === \"\"\r\n      ? customers\r\n      : customers.filter((customer) =>\r\n          customer.Customer_Name.toLowerCase().includes(query.toLowerCase())\r\n        )\r\n\r\n  // Handle click outside to close dropdown\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n        setOpen(false)\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleClickOutside)\r\n    return () => {\r\n      document.removeEventListener(\"mousedown\", handleClickOutside)\r\n    }\r\n  }, [])\r\n\r\n  // Sync internal query with external value when value changes externally\r\n  useEffect(() => {\r\n    if (value && value !== query) {\r\n        // Only update if not currently typing? \r\n        // Actually, if value is set by parent (e.g. edit mode), we want to show it.\r\n        // But if user is typing, we don't want to overwrite.\r\n        // Simplified: allow parent to control, but query is for filtering.\r\n    }\r\n  }, [value])\r\n\r\n  const handleSelect = (customer: Customer) => {\r\n    onChange(customer.Customer_Name)\r\n    onSelect(customer)\r\n    setQuery(customer.Customer_Name)\r\n    setOpen(false)\r\n  }\r\n\r\n  const handleInputFocus = () => {\r\n    setOpen(true)\r\n    // If input matches value, maybe clear query filtering to show all?\r\n    // Or just show matches.\r\n    if (!query && value) {\r\n        setQuery(value)\r\n    }\r\n  }\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const newVal = e.target.value\r\n    setQuery(newVal)\r\n    onChange(newVal) // Allow free text\r\n    setOpen(true)\r\n  }\r\n\r\n  return (\r\n    <div ref={wrapperRef} className={cn(\"relative\", className)}>\r\n      <div className=\"relative\">\r\n        <Input\r\n          ref={inputRef}\r\n          value={value}\r\n          onChange={handleInputChange}\r\n          onFocus={handleInputFocus}\r\n          placeholder=\"พิมพ์เพื่อค้นหาลูกค้า...\"\r\n          className=\"pr-10 bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\"\r\n        />\r\n        <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400\">\r\n             {/* Icon or toggle */}\r\n             <ChevronsUpDown className=\"w-4 h-4 opacity-50\" />\r\n        </div>\r\n      </div>\r\n\r\n      {open && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto\">\r\n          {filteredCustomers.length === 0 ? (\r\n            <div className=\"p-2 text-sm text-slate-400 text-center\">\r\n               ไม่พบลูกค้าที่ตรงกัน (ใช้ชื่อนี้เป็นลูกค้าใหม่)\r\n            </div>\r\n          ) : (\r\n            <ul className=\"py-1\">\r\n              {filteredCustomers.map((customer, index) => (\r\n                <li\r\n                  key={`${customer.Customer_Name}-${index}`}\r\n                  className={cn(\r\n                    \"px-3 py-2 text-sm text-slate-200 cursor-pointer hover:bg-slate-700 flex items-center justify-between\",\r\n                    value === customer.Customer_Name && \"bg-slate-700 font-medium text-white\"\r\n                  )}\r\n                  onClick={() => handleSelect(customer)}\r\n                >\r\n                  <span>{customer.Customer_Name}</span>\r\n                  {value === customer.Customer_Name && (\r\n                    <Check className=\"w-4 h-4 text-emerald-500\" />\r\n                  )}\r\n                </li>\r\n              ))}\r\n            </ul>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\dashboard\\branch-filter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\dashboard\\charts\\job-status-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\dashboard\\charts\\weekly-shipment-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\dashboard\\metric-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\driver-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[300,303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[300,303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\driver-autocomplete.tsx:61:11\n  59 |   useEffect(() => {\n  60 |       if (selectedDriver && !open) {\n> 61 |           setQuery(selectedDriver.Driver_Name || \"\")\n     |           ^^^^^^^^ Avoid calling setState() directly within an effect\n  62 |       } else if (!value && !open) {\n  63 |           setQuery(\"\")\n  64 |       }","line":61,"column":11,"nodeType":null,"endLine":61,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { Check, ChevronsUpDown, User } from \"lucide-react\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface Driver {\r\n  Driver_ID: string\r\n  Driver_Name: string | null\r\n  [key: string]: any\r\n}\r\n\r\ninterface DriverAutocompleteProps {\r\n  value?: string // Driver_ID\r\n  onChange: (value: string) => void\r\n  drivers: Driver[]\r\n  onSelect?: (driver: Driver) => void\r\n  className?: string\r\n  placeholder?: string\r\n  disabled?: boolean\r\n}\r\n\r\nexport function DriverAutocomplete({\r\n  value,\r\n  onChange,\r\n  drivers,\r\n  onSelect,\r\n  className,\r\n  placeholder = \"ค้นหาคนขับ...\",\r\n  disabled = false\r\n}: DriverAutocompleteProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [query, setQuery] = useState(\"\")\r\n  const wrapperRef = useRef<HTMLDivElement>(null)\r\n\r\n  // Find selected driver object for display\r\n  const selectedDriver = drivers.find(d => d.Driver_ID === value)\r\n\r\n  // Filter based on query\r\n  const filteredDrivers =\r\n    query === \"\"\r\n      ? drivers\r\n      : drivers.filter((d) =>\r\n          (d.Driver_Name?.toLowerCase() || \"\").includes(query.toLowerCase())\r\n        )\r\n\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n        setOpen(false)\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleClickOutside)\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside)\r\n  }, [])\r\n\r\n  // Sync query with value\r\n  useEffect(() => {\r\n      if (selectedDriver && !open) {\r\n          setQuery(selectedDriver.Driver_Name || \"\")\r\n      } else if (!value && !open) {\r\n          setQuery(\"\")\r\n      }\r\n  }, [value, selectedDriver, open])\r\n\r\n  const handleSelect = (driver: Driver) => {\r\n    onChange(driver.Driver_ID)\r\n    if (onSelect) onSelect(driver)\r\n    setQuery(driver.Driver_Name || \"\")\r\n    setOpen(false)\r\n  }\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      setQuery(e.target.value)\r\n      if (!open) setOpen(true)\r\n      // Note: We don't call onChange(e.target.value) here because value is ID, input is Name.\r\n      // We only call onChange when a valid driver is selected.\r\n      // Or we could clear the ID if input changes? \r\n      // Let's clear ID if user types something new to avoid mismatch.\r\n      if (value) {\r\n           // If user modifies text, they might be searching for a new one.\r\n           // But if they just fix a typo?\r\n           // Safest is: onChange('') to clear ID, forcing selection.\r\n           // But that might flicker.\r\n           // Let's keep ID for now, but if they select from list, it updates.\r\n      }\r\n  }\r\n\r\n  return (\r\n    <div ref={wrapperRef} className={cn(\"relative\", className)}>\r\n       <div className=\"relative\">\r\n        <Input\r\n          value={query}\r\n          onChange={handleInputChange}\r\n          onFocus={() => !disabled && setOpen(true)}\r\n          disabled={disabled}\r\n          placeholder={placeholder}\r\n          className={cn(\"pr-10 bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\", className)}\r\n        />\r\n        <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none\">\r\n             <ChevronsUpDown className=\"w-4 h-4 opacity-50\" />\r\n        </div>\r\n      </div>\r\n\r\n      {open && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto\">\r\n          {filteredDrivers.length === 0 ? (\r\n            <div className=\"p-2 text-sm text-slate-400 text-center\">\r\n               ไม่พบข้อมูล\r\n            </div>\r\n          ) : (\r\n            <div className=\"py-1\">\r\n              {filteredDrivers.map((driver, index) => (\r\n                <button\r\n                  key={`${driver.Driver_ID}-${index}`}\r\n                  onClick={() => handleSelect(driver)}\r\n                  type=\"button\"\r\n                  className={cn(\r\n                    \"w-full text-left px-3 py-2 text-sm cursor-pointer hover:bg-slate-700 flex items-center justify-between text-slate-200\",\r\n                    value === driver.Driver_ID && \"bg-slate-700 font-medium text-white\"\r\n                  )}\r\n                >\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <User size={14} className=\"text-indigo-400\" />\r\n                    <span>{driver.Driver_Name}</span>\r\n                  </div>\r\n                  {value === driver.Driver_ID && (\r\n                    <Check className=\"w-4 h-4 text-emerald-500\" />\r\n                  )}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\drivers\\driver-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\drivers\\driver-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[705,708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[705,708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1782,1785],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1782,1785],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":63,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":63,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[1987,2000],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":66,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":66,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[2073,2086],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2680,2683],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2680,2683],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { createDriver, updateDriver } from \"@/app/drivers/actions\"\r\nimport { Loader2 } from \"lucide-react\"\r\nimport { Driver } from \"@/lib/supabase/drivers\"\r\nimport { Subcontractor } from \"@/types/subcontractor\"\r\nimport { Branch } from \"@/lib/supabase/branches\"\r\n\r\ntype DriverDialogProps = {\r\n  mode?: 'create' | 'edit'\r\n  driver?: Partial<Driver>\r\n  vehicles?: any[]\r\n  subcontractors?: Subcontractor[]\r\n  branches?: Branch[]\r\n  trigger?: React.ReactNode\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n}\r\n\r\nexport function DriverDialog({\r\n  mode = 'create',\r\n  driver,\r\n  vehicles = [],\r\n  subcontractors = [],\r\n  branches = [],\r\n  trigger,\r\n  open,\r\n  onOpenChange\r\n}: DriverDialogProps) {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [internalOpen, setInternalOpen] = useState(false)\r\n  \r\n  const isControlled = open !== undefined\r\n  const show = isControlled ? open : internalOpen\r\n  const setShow = isControlled ? onOpenChange! : setInternalOpen\r\n\r\n  const [formData, setFormData] = useState({\r\n    Driver_ID: driver?.Driver_ID || '',\r\n    Driver_Name: driver?.Driver_Name || '',\r\n    Mobile_No: driver?.Mobile_No || '',\r\n    Password: driver?.Password || '',\r\n    Vehicle_Plate: driver?.Vehicle_Plate || '',\r\n    Active_Status: driver?.Active_Status || 'Active',\r\n    License_Expiry: driver?.License_Expiry || '',\r\n    Sub_ID: driver?.Sub_ID || '',\r\n    Branch_ID: (driver as any)?.Branch_ID || ''\r\n  })\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setLoading(true)\r\n\r\n    try {\r\n      let result;\r\n      if (mode === 'create') {\r\n        // @ts-ignore\r\n        result = await createDriver(formData)\r\n      } else {\r\n        // @ts-ignore\r\n        result = await updateDriver(driver.Driver_ID, formData)\r\n      }\r\n      \r\n      if (!result.success) {\r\n        throw new Error(result.message || 'Operation failed')\r\n      }\r\n\r\n      setShow(false)\r\n      if (!isControlled) {\r\n        setFormData({\r\n            Driver_ID: '',\r\n            Driver_Name: '',\r\n            Mobile_No: '',\r\n            Password: '',\r\n            Vehicle_Plate: '',\r\n            Active_Status: 'Active',\r\n            License_Expiry: '',\r\n            Sub_ID: '',\r\n            Branch_ID: ''\r\n        })\r\n      }\r\n      router.refresh()\r\n    } catch (error: any) {\r\n      console.error(error)\r\n      alert(error.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={show} onOpenChange={setShow}>\r\n      {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}\r\n      <DialogContent className=\"sm:max-w-[425px] bg-slate-900/95 border-white/10 text-white\">\r\n        <DialogHeader>\r\n          <DialogTitle>{mode === 'create' ? 'เพิ่มคนขับ' : 'แก้ไขข้อมูลคนขับ'}</DialogTitle>\r\n        </DialogHeader>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n          {branches.length > 0 && (\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Branch_ID\" className=\"text-yellow-400\">เลือกสาขา (Super Admin)</Label>\r\n                <select\r\n                    id=\"Branch_ID\"\r\n                    value={formData.Branch_ID}\r\n                    onChange={(e) => setFormData({ ...formData, Branch_ID: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-yellow-500/50 bg-yellow-500/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-yellow-500\"\r\n                    required={mode === 'create'}\r\n                >\r\n                    <option value=\"\" className=\"bg-slate-900\">-- เลือกสาขา --</option>\r\n                    {branches.map((b) => (\r\n                        <option key={b.Branch_ID} value={b.Branch_ID} className=\"bg-slate-900\">\r\n                        {b.Branch_Name} ({b.Branch_ID})\r\n                        </option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Driver_ID\">รหัสพนักงาน (ID)</Label>\r\n            <Input\r\n              id=\"Driver_ID\"\r\n              value={formData.Driver_ID}\r\n              onChange={(e) => setFormData({ ...formData, Driver_ID: e.target.value })}\r\n              placeholder=\"DRV-001\"\r\n              required\r\n              disabled={mode === 'edit'}\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Driver_Name\">ชื่อ-นามสกุล</Label>\r\n            <Input\r\n              id=\"Driver_Name\"\r\n              value={formData.Driver_Name}\r\n              onChange={(e) => setFormData({ ...formData, Driver_Name: e.target.value })}\r\n              placeholder=\"นาย ขับรถ ดี\"\r\n              required\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Mobile_No\">เบอร์โทรศัพท์</Label>\r\n            <Input\r\n              id=\"Mobile_No\"\r\n              value={formData.Mobile_No}\r\n              onChange={(e) => setFormData({ ...formData, Mobile_No: e.target.value })}\r\n              placeholder=\"081-234-5678\"\r\n              required\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"License_Expiry\">วันหมดอายุใบขับขี่</Label>\r\n             <Input\r\n                id=\"License_Expiry\"\r\n                type=\"date\"\r\n                value={formData.License_Expiry}\r\n                onChange={(e) => setFormData({ ...formData, License_Expiry: e.target.value })}\r\n                className=\"bg-white/5 border-white/10\"\r\n             />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Password\">รหัสผ่าน (สำหรับเข้าสู่ระบบ)</Label>\r\n            <Input\r\n              id=\"Password\"\r\n              type=\"text\"\r\n              value={formData.Password}\r\n              onChange={(e) => setFormData({ ...formData, Password: e.target.value })}\r\n              placeholder=\"ตั้งรหัสผ่าน\"\r\n              required={mode === 'create'}\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Sub_ID\">สังกัดบริษัทรถร่วม (Subcontractor)</Label>\r\n            <select\r\n                id=\"Sub_ID\"\r\n                value={formData.Sub_ID}\r\n                onChange={(e) => setFormData({ ...formData, Sub_ID: e.target.value })}\r\n                className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n            >\r\n                <option value=\"\" className=\"bg-slate-900\">อิสระ / รถบริษัท (Independent)</option>\r\n                {subcontractors.map((s) => (\r\n                    <option key={s.Sub_ID} value={s.Sub_ID} className=\"bg-slate-900\">\r\n                      {s.Sub_Name} ({s.Sub_ID})\r\n                    </option>\r\n                ))}\r\n            </select>\r\n          </div>\r\n\r\n        <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Vehicle_Plate\">รถประจำ</Label>\r\n            <select\r\n                id=\"Vehicle_Plate\"\r\n                value={formData.Vehicle_Plate}\r\n                onChange={(e) => setFormData({ ...formData, Vehicle_Plate: e.target.value })}\r\n                className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n            >\r\n                <option value=\"\" className=\"bg-slate-900\">ไม่ระบุ / ไม่มีรถประจำ</option>\r\n                {vehicles.map((v) => (\r\n                    <option key={v.vehicle_plate} value={v.vehicle_plate} className=\"bg-slate-900\">\r\n                      {v.vehicle_plate} {v.brand ? `(${v.brand})` : ''}\r\n                    </option>\r\n                ))}\r\n            </select>\r\n        </div>\r\n\r\n          {mode === 'edit' && (\r\n             <div className=\"space-y-2\">\r\n              <Label htmlFor=\"Active_Status\">สถานะ</Label>\r\n              <select\r\n                id=\"Active_Status\"\r\n                value={formData.Active_Status}\r\n                onChange={(e) => setFormData({ ...formData, Active_Status: e.target.value })}\r\n                className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n              >\r\n                 <option value=\"Active\" className=\"text-black\">Active</option>\r\n                 <option value=\"Inactive\" className=\"text-black\">Inactive</option>\r\n              </select>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex justify-end gap-2 mt-6\">\r\n            <Button type=\"button\" variant=\"ghost\" onClick={() => setShow(false)}>\r\n              ยกเลิก\r\n            </Button>\r\n            <Button type=\"submit\" disabled={loading} className=\"bg-gradient-to-r from-blue-500 to-indigo-600\">\r\n              {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              {mode === 'create' ? 'เพิ่มคนขับ' : 'บันทึก'}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\drivers\\drivers-content.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":151,"column":23,"nodeType":"JSXOpeningElement","endLine":151,"endColumn":123,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\fuel\\fuel-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[606,609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[606,609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[625,628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[625,628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { MoreHorizontal, Pencil, Trash2, Loader2 } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { deleteFuelLog, updateFuelLogStatus } from \"@/app/fuel/actions\"\r\nimport { FuelLog } from \"@/lib/supabase/fuel\"\r\nimport { FuelDialog } from \"./fuel-dialog\"\r\nimport { CheckCircle2, XCircle } from \"lucide-react\"\r\n\r\ninterface FuelActionsProps {\r\n  log: FuelLog\r\n  drivers: any[]\r\n  vehicles: any[]\r\n}\r\n\r\nexport function FuelActions({ log, drivers, vehicles }: FuelActionsProps) {\r\n  const [loading, setLoading] = useState(false)\r\n  const [showEditDialog, setShowEditDialog] = useState(false)\r\n\r\n  const handleDelete = async () => {\r\n    if (!confirm(\"คุณแน่ใจหรือไม่ที่จะลบรายการนี้?\")) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      const result = await deleteFuelLog(log.Log_ID)\r\n      if (!result.success) {\r\n        alert(result.message)\r\n      }\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert(\"เกิดข้อผิดพลาดในการลบ\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleStatusUpdate = async (status: string) => {\r\n    setLoading(true)\r\n    try {\r\n      const result = await updateFuelLogStatus(log.Log_ID, status)\r\n      if (!result.success) {\r\n        alert(result.message)\r\n      }\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert(\"เกิดข้อผิดพลาดในการอัปเดตสถานะ\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button variant=\"ghost\" className=\"h-8 w-8 p-0 text-slate-400 hover:text-white\">\r\n            <span className=\"sr-only\">Open menu</span>\r\n            {loading ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <MoreHorizontal className=\"h-4 w-4\" />}\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\" className=\"bg-slate-900 border-slate-800 text-slate-200\">\r\n          <DropdownMenuLabel>การจัดการ</DropdownMenuLabel>\r\n          \r\n          <DropdownMenuItem \r\n            className=\"cursor-pointer hover:bg-slate-800 hover:text-emerald-400 focus:bg-slate-800 focus:text-emerald-400\"\r\n            onClick={() => handleStatusUpdate('Approved')}\r\n          >\r\n            <CheckCircle2 className=\"mr-2 h-4 w-4\" />\r\n            อนุมัติ\r\n          </DropdownMenuItem>\r\n\r\n          <DropdownMenuItem \r\n            className=\"cursor-pointer hover:bg-slate-800 hover:text-red-400 focus:bg-slate-800 focus:text-red-400\"\r\n            onClick={() => handleStatusUpdate('Rejected')}\r\n          >\r\n            <XCircle className=\"mr-2 h-4 w-4\" />\r\n            ไม่อนุมัติ\r\n          </DropdownMenuItem>\r\n\r\n          <DropdownMenuItem \r\n            className=\"cursor-pointer hover:bg-slate-800 hover:text-white focus:bg-slate-800 focus:text-white\"\r\n            onClick={() => setShowEditDialog(true)}\r\n          >\r\n            <Pencil className=\"mr-2 h-4 w-4\" />\r\n            แก้ไขข้อมูล\r\n          </DropdownMenuItem>\r\n          <DropdownMenuItem \r\n            onClick={handleDelete}\r\n            className=\"text-red-400 focus:text-red-400 cursor-pointer hover:bg-red-950/20 focus:bg-red-950/20\"\r\n          >\r\n            <Trash2 className=\"mr-2 h-4 w-4\" />\r\n            ลบรายการ\r\n          </DropdownMenuItem>\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      <FuelDialog \r\n        open={showEditDialog} \r\n        onOpenChange={setShowEditDialog}\r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        initialData={log}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\fuel\\fuel-analytics-dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\fuel\\fuel-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[822,825],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[822,825],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { updateFuelLog, createFuelLog } from \"@/app/fuel/actions\"\r\nimport { Loader2 } from \"lucide-react\"\r\nimport { ImageUpload } from \"@/components/ui/image-upload\"\r\n\r\ninterface Driver {\r\n  Driver_ID: string;\r\n  Driver_Name: string;\r\n}\r\n\r\ninterface Vehicle {\r\n  Vehicle_Plate: string;\r\n}\r\n\r\ntype FuelDialogProps = {\r\n  drivers: Driver[]\r\n  vehicles: Vehicle[]\r\n  trigger?: React.ReactNode\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n  initialData?: any // Keeping loose for now as refactor is minimal\r\n}\r\n\r\nexport function FuelDialog({\r\n  drivers,\r\n  vehicles,\r\n  trigger,\r\n  open,\r\n  onOpenChange,\r\n  initialData\r\n}: FuelDialogProps) {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [internalOpen, setInternalOpen] = useState(false)\r\n  \r\n  const isControlled = open !== undefined\r\n  const show = isControlled ? open : internalOpen\r\n  const setShow = isControlled ? onOpenChange! : setInternalOpen\r\n\r\n  const [formData, setFormData] = useState<{\r\n    Date_Time: string\r\n    Driver_ID: string\r\n    Vehicle_Plate: string\r\n    Liter: string\r\n    Price: string\r\n    Total_Amount: number\r\n    Mileage: string\r\n    Station_Name: string\r\n    Fuel_Type?: string\r\n    Photo_Url?: string\r\n  }>({\r\n    Date_Time: new Date().toISOString().slice(0, 16),\r\n    Driver_ID: '',\r\n    Vehicle_Plate: '',\r\n    Liter: '',\r\n    Price: '',\r\n    Total_Amount: 0,\r\n    Mileage: '',\r\n    Station_Name: '',\r\n    Photo_Url: ''\r\n  })\r\n\r\n  useEffect(() => {\r\n    if (initialData) {\r\n      setFormData({\r\n        Date_Time: initialData.Date_Time ? new Date(initialData.Date_Time).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16),\r\n        Driver_ID: initialData.Driver_ID || '',\r\n        Vehicle_Plate: initialData.Vehicle_Plate || '',\r\n        Liter: initialData.Liters?.toString() || '',\r\n        Price: (initialData.Price_Total && initialData.Liters) ? (initialData.Price_Total / initialData.Liters).toFixed(2) : '',\r\n        Total_Amount: initialData.Price_Total || 0,\r\n        Mileage: initialData.Odometer?.toString() || '',\r\n        Station_Name: initialData.Station_Name || '',\r\n        Photo_Url: initialData.Photo_Url || ''\r\n      })\r\n    }\r\n  }, [initialData, show])\r\n\r\n  // Auto calculate total (Only if user is typing, might conflict with initial load if not careful)\r\n  // We can add a check if focused or just rely on manual input\r\n  useEffect(() => {\r\n    const liter = parseFloat(formData.Liter) || 0\r\n    const price = parseFloat(formData.Price) || 0\r\n    // Only update total if values are valid numbers\r\n    if (liter > 0 && price > 0) {\r\n        setFormData(prev => ({ ...prev, Total_Amount: liter * price }))\r\n    }\r\n  }, [formData.Liter, formData.Price])\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setLoading(true)\r\n\r\n    try {\r\n      const payload = {\r\n        ...formData,\r\n        Liter: parseFloat(formData.Liter),\r\n        Price: parseFloat(formData.Price),\r\n        Mileage: parseInt(formData.Mileage),\r\n        Date_Time: new Date(formData.Date_Time).toISOString(),\r\n        Station_Name: formData.Station_Name || ''\r\n      }\r\n\r\n      if (initialData) {\r\n        await updateFuelLog(initialData.Log_ID, payload)\r\n      } else {\r\n        await createFuelLog(payload)\r\n      }\r\n      \r\n      setShow(false)\r\n      if (!isControlled && !initialData) {\r\n        setFormData({\r\n            Date_Time: new Date().toISOString().slice(0, 16),\r\n            Driver_ID: '',\r\n            Vehicle_Plate: '',\r\n            Liter: '',\r\n            Price: '',\r\n            Total_Amount: 0,\r\n            Mileage: '',\r\n            Station_Name: '',\r\n            Photo_Url: ''\r\n        })\r\n      }\r\n      router.refresh()\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert('เกิดข้อผิดพลาด กรุณาลองใหม่')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={show} onOpenChange={setShow}>\r\n      {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}\r\n      <DialogContent className=\"sm:max-w-[425px] bg-slate-900/95 border-white/10 text-white\">\r\n        <DialogHeader>\r\n          <DialogTitle>{initialData ? 'แก้ไขข้อมูลการเติมน้ำมัน' : 'บันทึกการเติมน้ำมัน'}</DialogTitle>\r\n        </DialogHeader>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n          <div className=\"flex flex-col items-center mb-4 gap-2\">\r\n             <ImageUpload \r\n                value={formData.Photo_Url} \r\n                onChange={(url) => setFormData({ ...formData, Photo_Url: url })}\r\n             />\r\n             {formData.Photo_Url && (\r\n                <Button \r\n                    type=\"button\" \r\n                    variant=\"outline\" \r\n                    size=\"sm\"\r\n                    onClick={async () => {\r\n                        if (!formData.Photo_Url) return\r\n                        setLoading(true)\r\n                        try {\r\n                            const { parseFuelReceipt } = await import('@/lib/ocr/fuel-receipt-parser')\r\n                            const result = await parseFuelReceipt(formData.Photo_Url)\r\n                            \r\n                            setFormData(prev => ({\r\n                                ...prev,\r\n                                Date_Time: result.date ? `${result.date}T${result.time || '12:00'}` : prev.Date_Time,\r\n                                Liter: result.liters?.toString() || prev.Liter,\r\n                                Price: result.pricePerLiter?.toString() || prev.Price,\r\n                                Total_Amount: result.totalAmount || prev.Total_Amount,\r\n                                Station_Name: result.stationName || prev.Station_Name\r\n                            }))\r\n                            alert('สแกนข้อมูลเรียบร้อย! กรุณาตรวจสอบความถูกต้อง')\r\n                        } catch (e) {\r\n                            console.error(e)\r\n                            alert('ไม่สามารถอ่านข้อมูลได้')\r\n                        } finally {\r\n                            setLoading(false)\r\n                        }\r\n                    }}\r\n                    disabled={loading}\r\n                    className=\"text-xs flex items-center gap-1\"\r\n                >\r\n                    {loading ? <Loader2 className=\"w-3 h-3 animate-spin\"/> : <span className=\"text-emerald-400\">⚡</span>}\r\n                    สแกนใบเสร็จ\r\n                </Button>\r\n             )}\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Date_Time\">วัน-เวลา</Label>\r\n            <Input\r\n              id=\"Date_Time\"\r\n              type=\"datetime-local\"\r\n              value={formData.Date_Time}\r\n              onChange={(e) => setFormData({ ...formData, Date_Time: e.target.value })}\r\n              required\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Driver_ID\">คนขับ</Label>\r\n                <select\r\n                    id=\"Driver_ID\"\r\n                    value={formData.Driver_ID}\r\n                    onChange={(e) => setFormData({ ...formData, Driver_ID: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                    required\r\n                >\r\n                    <option value=\"\" className=\"bg-slate-900\">เลือกคนขับ</option>\r\n                    {drivers.map((d) => (\r\n                        <option key={d.Driver_ID} value={d.Driver_ID} className=\"bg-slate-900\">\r\n                        {d.Driver_Name}\r\n                        </option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Vehicle_Plate\">ทะเบียนรถ</Label>\r\n                <select\r\n                    id=\"Vehicle_Plate\"\r\n                    value={formData.Vehicle_Plate}\r\n                    onChange={(e) => setFormData({ ...formData, Vehicle_Plate: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                    required\r\n                >\r\n                    <option value=\"\" className=\"bg-slate-900\">เลือกทะเบียน</option>\r\n                    {vehicles.map((v) => (\r\n                        <option key={v.Vehicle_Plate} value={v.Vehicle_Plate} className=\"bg-slate-900\">\r\n                        {v.Vehicle_Plate}\r\n                        </option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Station_Name\">สถานีบริการ / ปั๊ม</Label>\r\n                <Input\r\n                    id=\"Station_Name\"\r\n                    value={formData.Station_Name}\r\n                    onChange={(e) => setFormData({ ...formData, Station_Name: e.target.value })}\r\n                    placeholder=\"เช่น ปตท. สาขา...\"\r\n                    className=\"bg-white/5 border-white/10\"\r\n                />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n                 <Label htmlFor=\"Mileage\">เลขไมล์</Label>\r\n                 <Input\r\n                    id=\"Mileage\"\r\n                    type=\"number\"\r\n                    value={formData.Mileage}\r\n                    onChange={(e) => setFormData({ ...formData, Mileage: e.target.value })}\r\n                    placeholder=\"km\"\r\n                    required\r\n                    className=\"bg-white/5 border-white/10\"\r\n                 />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-3 gap-4\">\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Liter\">จำนวน (ลิตร)</Label>\r\n                <Input\r\n                id=\"Liter\"\r\n                type=\"number\"\r\n                step=\"0.01\"\r\n                value={formData.Liter}\r\n                onChange={(e) => setFormData({ ...formData, Liter: e.target.value })}\r\n                required\r\n                className=\"bg-white/5 border-white/10\"\r\n                />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Price\">ราคา/ลิตร</Label>\r\n                <Input\r\n                id=\"Price\"\r\n                type=\"number\"\r\n                step=\"0.01\"\r\n                value={formData.Price}\r\n                onChange={(e) => setFormData({ ...formData, Price: e.target.value })}\r\n                required\r\n                className=\"bg-white/5 border-white/10\"\r\n                />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Total_Amount\">รวมเงิน</Label>\r\n                <Input\r\n                id=\"Total_Amount\"\r\n                value={formData.Total_Amount.toFixed(2)}\r\n                readOnly\r\n                className=\"bg-white/5 border-white/10 text-emerald-400 font-bold\"\r\n                />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex justify-end gap-2 mt-6\">\r\n            <Button type=\"button\" variant=\"ghost\" onClick={() => setShow(false)}>\r\n              ยกเลิก\r\n            </Button>\r\n            <Button type=\"submit\" disabled={loading} className=\"bg-gradient-to-r from-emerald-500 to-teal-600\">\r\n              {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              {initialData ? 'บันทึกการแก้ไข' : 'บันทึก'}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\jobs\\job-history-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[470,473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[470,473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[489,492],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[489,492],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[509,512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[509,512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[526,529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[526,529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { \r\n  ExternalLink, \r\n  Banknote, \r\n  FileText\r\n} from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { JobDialog } from \"@/components/planning/job-dialog\"\r\nimport { JobSummaryDialog } from \"@/components/jobs/job-summary-dialog\"\r\nimport { syncJobToAccounting } from \"@/app/settings/accounting/actions\"\r\n\r\n\r\nimport { Job } from \"@/types/database\"\r\n\r\ntype Props = {\r\n  job: Job\r\n  drivers: any[]\r\n  vehicles: any[]\r\n  customers: any[]\r\n  routes: any[]\r\n  canViewPrice?: boolean\r\n  canDelete?: boolean\r\n}\r\n\r\nexport function JobHistoryActions({ job, drivers, vehicles, customers, routes, canViewPrice = true, canDelete = true }: Props) {\r\n  const [open, setOpen] = useState(false)\r\n  const [showSummary, setShowSummary] = useState(false)\r\n  const [syncing, setSyncing] = useState(false)\r\n\r\n  const handleSyncToAccounting = async () => {\r\n    if (!confirm(`ยืนยันการส่งข้อมูลงาน ${job.Job_ID} ไปยังระบบบัญชี?`)) return;\r\n\r\n    setSyncing(true)\r\n    try {\r\n        const result = await syncJobToAccounting(job)\r\n        if (result.success) {\r\n            alert(`สำเร็จ: ${result.message}`)\r\n        } else {\r\n            alert(`ผิดพลาด: ${result.message}`)\r\n        }\r\n    } catch {\r\n        alert(\"เกิดข้อผิดพลาดในการเชื่อมต่อ\")\r\n    } finally {\r\n        setSyncing(false)\r\n    }\r\n  }\r\n\r\n  // Status check for showing report\r\n  const isFinished = ['Delivered', 'Completed', 'Complete', 'Picked Up', 'In Transit'].includes(job.Job_Status || '')\r\n\r\n  return (\r\n    <div className=\"flex items-center justify-end gap-1\">\r\n      {/* 1. View Summary / Report Button - The Unified Entry Point */}\r\n      {isFinished && (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            className=\"h-8 w-8 p-0 text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 hover:bg-emerald-500/10\"\r\n            onClick={() => setShowSummary(true)}\r\n            title=\"ดูสรุปงานและใบรายงาน\"\r\n          >\r\n            <FileText className=\"h-4 w-4\" aria-hidden=\"true\" />\r\n          </Button>\r\n      )}\r\n\r\n      {/* 2. Job Details / Edit Button */}\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"sm\"\r\n        className=\"h-8 w-8 p-0 text-muted-foreground hover:text-foreground\"\r\n        onClick={() => setOpen(true)}\r\n        title=\"ดูรายละเอียด/แก้ไข\"\r\n      >\r\n        <ExternalLink className=\"h-4 w-4\" />\r\n      </Button>\r\n\r\n      {/* 3. Sync to Accounting */}\r\n      {canViewPrice && (\r\n      <Button\r\n        variant=\"ghost\"\r\n        size=\"sm\"\r\n        className=\"h-8 w-8 p-0 text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 hover:bg-emerald-500/10\"\r\n        onClick={handleSyncToAccounting}\r\n        disabled={syncing}\r\n        title=\"ส่งเข้าบัญชี\"\r\n      >\r\n        <Banknote className={`h-4 w-4 ${syncing ? 'animate-pulse' : ''}`} />\r\n      </Button>\r\n      )}\r\n\r\n      <JobDialog\r\n        mode=\"edit\"\r\n        open={open}\r\n        onOpenChange={setOpen}\r\n        job={job}\r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        customers={customers}\r\n        routes={routes}\r\n        canViewPrice={canViewPrice}\r\n        canDelete={canDelete}\r\n      />\r\n\r\n      <JobSummaryDialog\r\n        open={showSummary}\r\n        onOpenChange={setShowSummary}\r\n        job={job}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\jobs\\job-summary-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[854,857],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[854,857],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1030,1033],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1030,1033],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\jobs\\job-summary-dialog.tsx:48:7\n  46 |   useEffect(() => {\n  47 |     if (open && jobId) {\n> 48 |       setLoadingGps(true)\n     |       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  49 |       getJobGPSData(jobId, driverName, planDate)\n  50 |         .then(data => setGpsData(data as any))\n  51 |         .finally(() => setLoadingGps(false))","line":48,"column":7,"nodeType":null,"endLine":48,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1378,1381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1378,1381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1754,1757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1754,1757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1836,1839],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1836,1839],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":275,"column":37,"nodeType":"JSXOpeningElement","endLine":275,"endColumn":138,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":323,"column":37,"nodeType":"JSXOpeningElement","endLine":323,"endColumn":134,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { \r\n  Dialog, \r\n  DialogContent, \r\n  DialogTitle, \r\n  DialogDescription,\r\n} from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { \r\n  ClipboardList, \r\n  MapPin, \r\n  Truck, \r\n  User, \r\n  Calendar, \r\n  CheckCircle2, \r\n  ExternalLink,\r\n  Package,\r\n  FileText\r\n} from \"lucide-react\"\r\nimport Image from \"next/image\"\r\nimport { Job } from \"@/lib/supabase/jobs\"\r\nimport { useEffect, useState } from \"react\"\r\nimport dynamic from \"next/dynamic\"\r\nimport { getJobGPSData } from \"@/lib/actions/gps-actions\"\r\n\r\nconst LeafletMap = dynamic(() => import('@/components/maps/leaflet-map'), { \r\n    ssr: false,\r\n    loading: () => <div className=\"h-[200px] w-full bg-slate-900 animate-pulse rounded-xl\" />\r\n})\r\n\r\ntype JobSummaryDialogProps = {\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  job: Job | any\r\n}\r\n\r\nexport function JobSummaryDialog({ open, onOpenChange, job }: JobSummaryDialogProps) {\r\n  const [gpsData, setGpsData] = useState<{ route: [number, number][], latest: any } | null>(null)\r\n  const [loadingGps, setLoadingGps] = useState(false)\r\n\r\n  const jobId = job?.Job_ID\r\n  const driverName = job?.Driver_Name\r\n  const planDate = job?.Plan_Date\r\n\r\n  useEffect(() => {\r\n    if (open && jobId) {\r\n      setLoadingGps(true)\r\n      getJobGPSData(jobId, driverName, planDate)\r\n        .then(data => setGpsData(data as any))\r\n        .finally(() => setLoadingGps(false))\r\n    }\r\n  }, [open, jobId, driverName, planDate])\r\n\r\n  if (!job) return null\r\n\r\n  const pickupPhotos = job.Pickup_Photo_Url ? job.Pickup_Photo_Url.split(',').filter(Boolean) : []\r\n  const podPhotos = job.Photo_Proof_Url ? job.Photo_Proof_Url.split(',').filter(Boolean) : []\r\n  const signature = job.Signature_Url || (job as any).signature_url\r\n  const pickupSignature = job.Pickup_Signature_Url || (job as any).pickup_signature_url\r\n\r\n  // Timeline Logic\r\n  const steps = [\r\n    { key: 'New', label: 'สร้างงาน', icon: <Calendar size={18} /> },\r\n    { key: 'Assigned', label: 'จัดรถแล้ว', icon: <User size={18} /> },\r\n    { key: 'Picked Up', label: 'รับของแล้ว', icon: <Package size={18} /> },\r\n    { key: 'In Transit', label: 'กำลังส่ง', icon: <Truck size={18} /> },\r\n    { key: 'Completed', label: 'เสร็จสิ้น', icon: <CheckCircle2 size={18} /> },\r\n  ]\r\n\r\n  const getCurrentStepIndex = () => {\r\n    const status = job.Job_Status\r\n    if (['Delivered', 'Completed', 'Complete'].includes(status)) return 4\r\n    if (status === 'In Transit') return 3\r\n    if (status === 'Picked Up') return 2\r\n    if (status === 'Assigned') return 1\r\n    return 0\r\n  }\r\n\r\n  const currentStepIndex = getCurrentStepIndex()\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[95vh] overflow-y-auto bg-slate-950 border-slate-800 text-slate-200 p-0\">\r\n        <DialogTitle className=\"sr-only\">Job Summary - {job.Job_ID}</DialogTitle>\r\n        <DialogDescription className=\"sr-only\">\r\n          Detailed summary for job {job.Job_ID} including timeline, photos, and signatures.\r\n        </DialogDescription>\r\n        \r\n        {/* Banner / Header */}\r\n        <div className=\"bg-gradient-to-r from-indigo-900/40 to-slate-900 p-6 border-b border-slate-800 sticky top-0 z-10 backdrop-blur-md\">\r\n            <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                    <div className=\"flex items-center gap-2 text-indigo-400 mb-1\">\r\n                        <ClipboardList size={18} />\r\n                        <span className=\"text-xs font-bold uppercase tracking-wider\">สรุปผลการดำเนินงาน / Job Summary</span>\r\n                    </div>\r\n                    <h2 className=\"text-2xl font-bold text-white\">{job.Job_ID}</h2>\r\n                </div>\r\n                <div className=\"flex flex-col items-end gap-2\">\r\n                    <span className={`px-3 py-1 rounded-full text-xs font-bold border ${\r\n                        currentStepIndex === 4 \r\n                        ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30' \r\n                        : 'bg-indigo-500/20 text-indigo-400 border-indigo-500/30'\r\n                    }`}>\r\n                        {job.Job_Status}\r\n                    </span>\r\n                    <p className=\"text-xs text-slate-500\">{job.Plan_Date}</p>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Premium Stepper (Horizontal) */}\r\n            <div className=\"mt-8 relative px-4\">\r\n                <div className=\"absolute top-1/2 left-8 right-8 h-0.5 bg-slate-800 -translate-y-1/2 z-0\" />\r\n                <div \r\n                    className=\"absolute top-1/2 left-8 h-0.5 bg-indigo-500 -translate-y-1/2 z-0 transition-all duration-500\" \r\n                    style={{ width: `${(currentStepIndex / 4) * (100 - 16)}%` }}\r\n                />\r\n                \r\n                <div className=\"flex justify-between relative z-10\">\r\n                    {steps.map((step, idx) => {\r\n                        const isCompleted = idx <= currentStepIndex\r\n                        const isCurrent = idx === currentStepIndex\r\n                        return (\r\n                            <div key={step.key} className=\"flex flex-col items-center group\">\r\n                                <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 border-2 ${\r\n                                    isCurrent \r\n                                    ? 'bg-indigo-500 border-indigo-400 text-white scale-110 shadow-[0_0_15px_rgba(99,102,241,0.5)]' \r\n                                    : isCompleted \r\n                                    ? 'bg-slate-900 border-indigo-500 text-indigo-400' \r\n                                    : 'bg-slate-950 border-slate-800 text-slate-600'\r\n                                }`}>\r\n                                    {step.icon}\r\n                                </div>\r\n                                <span className={`text-[10px] mt-2 font-medium transition-colors ${\r\n                                    isCompleted ? 'text-indigo-400' : 'text-slate-600'\r\n                                }`}>\r\n                                    {step.label}\r\n                                </span>\r\n                            </div>\r\n                        )\r\n                    })}\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div className=\"p-6 space-y-8 pb-12\">\r\n            {/* Grid 1: Basic Info */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <section className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-white font-bold border-l-4 border-indigo-500 pl-3\">\r\n                        <User size={18} className=\"text-indigo-400\" />\r\n                        <span>ข้อมูลทั่วไป</span>\r\n                    </div>\r\n                    <div className=\"bg-slate-900/50 rounded-xl p-4 border border-slate-800 grid grid-cols-2 gap-y-4\">\r\n                        <div>\r\n                            <p className=\"text-[10px] uppercase text-slate-500 mb-1\">ลูกค้า (Customer)</p>\r\n                            <p className=\"text-sm font-medium\">{job.Customer_Name}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] uppercase text-slate-500 mb-1\">เส้นทาง (Route)</p>\r\n                            <p className=\"text-sm font-medium\">{job.Route_Name || '-'}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] uppercase text-slate-500 mb-1\">ทะเบียนรถ (Vehicle)</p>\r\n                            <p className=\"text-sm font-medium\">{job.Vehicle_Plate || '-'}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-[10px] uppercase text-slate-500 mb-1\">คนขับ (Driver)</p>\r\n                            <p className=\"text-sm font-medium\">{job.Driver_Name || '-'}</p>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n\r\n                <section className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-2 text-white font-bold border-l-4 border-indigo-500 pl-3\">\r\n                        <MapPin size={18} className=\"text-emerald-400\" />\r\n                        <span>สถานที่และเวลา</span>\r\n                    </div>\r\n                    <div className=\"bg-slate-900/50 rounded-xl p-4 border border-slate-800 space-y-4\">\r\n                        <div className=\"flex gap-3\">\r\n                            <div className=\"mt-1\"><div className=\"w-2 h-2 rounded-full bg-indigo-500 ring-4 ring-indigo-500/20\" /></div>\r\n                            <div>\r\n                                <p className=\"text-[10px] uppercase text-slate-500\">ต้นทาง (Origin)</p>\r\n                                <p className=\"text-xs text-slate-300\">{job.Origin_Location || '-'}</p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"flex gap-3\">\r\n                            <div className=\"mt-1\"><MapPin size={14} className=\"text-emerald-500\" /></div>\r\n                            <div>\r\n                                <p className=\"text-[10px] uppercase text-slate-500\">ปลายทาง (Destination)</p>\r\n                                <p className=\"text-xs text-white font-medium\">{job.Dest_Location || '-'}</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n            </div>\r\n\r\n            {/* Map Section */}\r\n            <section className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between text-white font-bold border-l-4 border-amber-500 pl-3\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <MapPin size={18} className=\"text-amber-400\" />\r\n                        <span>แผนที่ติดตามงาน (Live Tracking Map)</span>\r\n                    </div>\r\n                    {gpsData?.latest && (\r\n                        <span className=\"text-[10px] text-slate-500\">Update: {new Date(gpsData.latest.timestamp).toLocaleTimeString('th-TH')}</span>\r\n                    )}\r\n                </div>\r\n                <div className=\"h-[300px] rounded-2xl overflow-hidden border border-slate-800 shadow-inner bg-slate-900 flex items-center justify-center\">\r\n                    {loadingGps ? (\r\n                        <div className=\"flex flex-col items-center gap-3\">\r\n                            <Truck className=\"h-8 w-8 text-slate-700 animate-bounce\" />\r\n                            <span className=\"text-[10px] text-slate-600 uppercase tracking-widest\">กำลังดึงพิกัด...</span>\r\n                        </div>\r\n                    ) : (gpsData?.latest || (gpsData?.route && gpsData.route.length > 0)) ? (\r\n                        <LeafletMap \r\n                            height=\"300px\"\r\n                            center={gpsData?.latest ? [gpsData.latest.lat, gpsData.latest.lng] : (gpsData?.route?.[0] as [number, number])}\r\n                            zoom={14}\r\n                            routeHistory={gpsData?.route as [number, number][]}\r\n                            drivers={gpsData?.latest ? [{\r\n                                id: job.Driver_Name,\r\n                                name: job.Driver_Name,\r\n                                lat: gpsData.latest.lat,\r\n                                lng: gpsData.latest.lng,\r\n                                status: job.Job_Status as string\r\n                            }] : []}\r\n                        />\r\n                    ) : (\r\n                        <div className=\"flex flex-col items-center gap-2 text-slate-600\">\r\n                             <MapPin size={32} />\r\n                             <p className=\"text-xs\">ไม่พบข้อมูลพิกัดสำหรับงานนี้</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </section>\r\n\r\n            {/* Grid 2: Media Section (Photos) */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\r\n                {/* Pickup Section */}\r\n                <section className=\"space-y-4\">\r\n                     <div className=\"flex items-center justify-between text-white font-bold border-l-4 border-cyan-500 pl-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Package size={18} className=\"text-cyan-400\" />\r\n                            <span>จุดรับสินค้า (Pickup Info)</span>\r\n                        </div>\r\n                        <span className=\"text-[10px] text-slate-500\">{pickupPhotos.length} รูป</span>\r\n                    </div>\r\n                    \r\n                    <div className=\"space-y-4\">\r\n                        {pickupPhotos.length > 0 ? (\r\n                            <div className=\"grid grid-cols-2 gap-2\">\r\n                                {pickupPhotos.map((url: string, i: number) => (\r\n                                    <div key={i} className=\"aspect-video relative rounded-lg overflow-hidden border border-slate-800 bg-slate-900 group cursor-pointer\" onClick={() => window.open(url, '_blank')}>\r\n                                        <Image src={url} alt=\"Pickup\" fill className=\"object-cover group-hover:scale-110 transition-transform duration-500\" />\r\n                                        <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center\">\r\n                                            <ExternalLink size={20} className=\"text-white\" />\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"h-24 border border-dashed border-slate-800 rounded-xl flex items-center justify-center text-slate-600 text-xs italic\">\r\n                                ไม่มีรูปที่จุดรับ\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Signature */}\r\n                        <div className=\"bg-white/5 rounded-xl p-3 border border-slate-800\">\r\n                             <p className=\"text-[10px] uppercase text-slate-500 mb-2\">ลายเซ็น ณ จุดรับ</p>\r\n                             <div className=\"h-24 relative flex items-center justify-center bg-white/5 rounded bg-slate-100\">\r\n                                {pickupSignature ? (\r\n                                    // eslint-disable-next-line @next/next/no-img-element\r\n                                    <img src={pickupSignature} alt=\"Pickup Signature\" className=\"max-h-full max-w-full object-contain\" />\r\n                                ) : (\r\n                                    <span className=\"text-slate-400 text-[10px] italic\">ไม่มีข้อมูลลายเซ็น</span>\r\n                                )}\r\n                             </div>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n\r\n                 {/* Delivery Section */}\r\n                 <section className=\"space-y-4\">\r\n                     <div className=\"flex items-center justify-between text-white font-bold border-l-4 border-emerald-500 pl-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <CheckCircle2 size={18} className=\"text-emerald-400\" />\r\n                            <span>การส่งสินค้า (POD Info)</span>\r\n                        </div>\r\n                        <span className=\"text-[10px] text-slate-500\">{podPhotos.length} รูป</span>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-4\">\r\n                         {podPhotos.length > 0 ? (\r\n                            <div className=\"grid grid-cols-2 gap-2\">\r\n                                {podPhotos.map((url: string, i: number) => (\r\n                                    <div key={i} className={`aspect-video relative rounded-lg overflow-hidden border border-slate-800 bg-slate-900 group cursor-pointer ${i === 0 && 'col-span-2 aspect-[21/9]'}`} onClick={() => window.open(url, '_blank')}>\r\n                                        <Image src={url} alt=\"POD\" fill className=\"object-cover group-hover:scale-110 transition-transform duration-500\" />\r\n                                        {i === 0 && (\r\n                                            <div className=\"absolute top-2 left-2 bg-blue-600 text-[10px] px-2 py-0.5 rounded font-bold text-white shadow-lg\">\r\n                                                DIGITAL REPORT\r\n                                            </div>\r\n                                        )}\r\n                                        <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center\">\r\n                                            <ExternalLink size={20} className=\"text-white\" />\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"h-24 border border-dashed border-slate-800 rounded-xl flex items-center justify-center text-slate-600 text-xs italic\">\r\n                                ไม่มีรูปที่จุดส่ง\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Signature */}\r\n                        <div className=\"bg-white/5 rounded-xl p-3 border border-slate-800\">\r\n                             <p className=\"text-[10px] uppercase text-slate-500 mb-2\">ลายเซ็นผู้รับสินค้า</p>\r\n                             <div className=\"h-24 relative flex items-center justify-center bg-white/5 rounded bg-slate-100\">\r\n                                {signature ? (\r\n                                    // eslint-disable-next-line @next/next/no-img-element\r\n                                    <img src={signature} alt=\"Delivery Signature\" className=\"max-h-full max-w-full object-contain\" />\r\n                                ) : (\r\n                                    <span className=\"text-slate-400 text-[10px] italic\">ไม่มีข้อมูลลายเซ็น</span>\r\n                                )}\r\n                             </div>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n            </div>\r\n        </div>\r\n\r\n        {/* Action Footer */}\r\n        <div className=\"sticky bottom-0 bg-slate-900/80 backdrop-blur-md p-4 border-t border-slate-800 flex justify-between items-center gap-3\">\r\n             <Button variant=\"ghost\" onClick={() => onOpenChange(false)} className=\"text-slate-400 hover:text-white\">\r\n                ปิดหน้าต่าง\r\n             </Button>\r\n             <div className=\"flex gap-2\">\r\n                <Button variant=\"outline\" className=\"gap-2 border-slate-700 text-slate-300\" onClick={() => window.print()}>\r\n                    <FileText size={16} />\r\n                    พิมพ์รายงาน\r\n                </Button>\r\n                {podPhotos.length > 0 && (\r\n                    <Button className=\"gap-2 bg-indigo-600 hover:bg-indigo-500 text-white\" onClick={() => window.open(podPhotos[0], '_blank')}>\r\n                        <ExternalLink size={16} />\r\n                        ดูใบงานตัวจริง\r\n                    </Button>\r\n                )}\r\n             </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\jobs\\pod-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[347,350],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[347,350],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[484,487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[484,487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[589,592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[589,592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Image as ImageIcon, ExternalLink } from \"lucide-react\"\r\nimport Image from \"next/image\"\r\n\r\ntype PODDialogProps = {\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  job: any\r\n}\r\n\r\nexport function PODDialog({ open, onOpenChange, job }: PODDialogProps) {\r\n\r\n\r\n  const photos = (job.Photo_Proof_Url || (job as any).photo_proof_url || \"\").split(',').filter(Boolean)\r\n  const signature = job.Signature_Url || (job as any).signature_url\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto bg-background border-border text-foreground\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <ImageIcon className=\"w-5 h-5 text-primary\" />\r\n            หลักฐานการส่งสินค้า (POD) - {job.Job_ID}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-6\">\r\n          {/* Photos Grid */}\r\n          <div>\r\n            <h3 className=\"text-sm font-medium text-muted-foreground mb-3\">รูปภาพสินค้า / สถานที่ส่ง ({photos.length})</h3>\r\n            {photos.length > 0 ? (\r\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                {photos.map((url: string, index: number) => (\r\n                  <div \r\n                    key={index} \r\n                    className=\"group relative aspect-square rounded-lg overflow-hidden border border-border bg-muted cursor-pointer hover:border-primary transition-all\"\r\n                    onClick={() => window.open(url, '_blank')}\r\n                  >\r\n                    <Image \r\n                      src={url} \r\n                      alt={`POD ${index + 1}`} \r\n                      fill \r\n                      className=\"object-cover group-hover:scale-110 transition-transform duration-300\"\r\n                    />\r\n                    <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100\">\r\n                      <ExternalLink className=\"w-6 h-6 text-white\" />\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"text-center py-8 bg-muted/50 rounded-lg border border-dashed border-border text-muted-foreground\">\r\n                ไม่มีรูปภาพ\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Signature */}\r\n          <div>\r\n             <h3 className=\"text-sm font-medium text-muted-foreground mb-3\">ลายเซ็นผู้รับ</h3>\r\n             {signature ? (\r\n               <div className=\"relative h-40 w-full md:w-80 border border-border rounded-lg bg-white/5 mx-auto md:mx-0\">\r\n                  <Image \r\n                      src={signature} \r\n                      alt=\"Signature\" \r\n                      fill \r\n                      className=\"object-contain p-4 invert dark:invert-0\" \r\n                  />\r\n               </div>\r\n             ) : (\r\n                <div className=\"text-center py-8 bg-muted/50 rounded-lg border border-dashed border-border text-muted-foreground w-full md:w-80\">\r\n                  ไม่มีลายเซ็น\r\n                </div>\r\n             )}\r\n          </div>\r\n\r\n          {/* Metadata */}\r\n          <div className=\"grid grid-cols-2 gap-4 p-4 bg-muted/50 rounded-lg text-sm\">\r\n             <div>\r\n                <p className=\"text-muted-foreground\">ผู้ส่ง (Driver)</p>\r\n                <p className=\"text-foreground font-medium\">{job.Driver_Name || '-'}</p>\r\n             </div>\r\n             <div>\r\n                <p className=\"text-muted-foreground\">ทะเบียนรถ</p>\r\n                <p className=\"text-foreground font-medium\">{job.Vehicle_Plate || '-'}</p>\r\n             </div>\r\n             <div>\r\n                <p className=\"text-muted-foreground\">เวลาส่ง (Delivery Date)</p>\r\n                <p className=\"text-foreground font-medium\">\r\n                    {job.Delivery_Date ? new Date(job.Delivery_Date).toLocaleString('th-TH') : '-'}\r\n                </p>\r\n             </div>\r\n             <div>\r\n                <p className=\"text-muted-foreground\">สถานะ</p>\r\n                <span className={`inline-block px-2 py-0.5 rounded text-xs font-medium ${\r\n                    job.Job_Status === 'Completed' || job.Job_Status === 'Delivered' \r\n                    ? 'bg-emerald-500/20 text-emerald-600 dark:text-emerald-400' \r\n                    : 'bg-muted text-muted-foreground'\r\n                }`}>\r\n                    {job.Job_Status}\r\n                </span>\r\n             </div>\r\n          </div>\r\n          \r\n          <div className=\"flex justify-end pt-4 border-t border-border\">\r\n            <Button variant=\"secondary\" onClick={() => onOpenChange(false)}>\r\n                ปิดหน้าต่าง\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\layout\\dashboard-layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\layout\\header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\layout\\sidebar-profile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\layout\\sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\location-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Search' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Search"},"fix":{"range":[78,85],"text":""},"desc":"Remove unused variable \"Search\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":4,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Check"},"fix":{"range":[92,99],"text":""},"desc":"Remove unused variable \"Check\"."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\location-autocomplete.tsx:55:10\n  53 |   useEffect(() => {\n  54 |      if (value && !query) {\n> 55 |          setQuery(value)\n     |          ^^^^^^^^ Avoid calling setState() directly within an effect\n  56 |      }\n  57 |   }, [value])\n  58 |","line":55,"column":10,"nodeType":null,"endLine":55,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'query'. Either include it or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [query, value]","fix":{"range":[1717,1724],"text":"[query, value]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { Search, MapPin, Check } from \"lucide-react\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface LocationAutocompleteProps {\r\n  value?: string\r\n  onChange: (value: string) => void\r\n  locations: string[]\r\n  className?: string\r\n  placeholder?: string\r\n}\r\n\r\nexport function LocationAutocomplete({\r\n  value,\r\n  onChange,\r\n  locations = [],\r\n  className,\r\n  placeholder = \"ค้นหาสถานที่...\"\r\n}: LocationAutocompleteProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [query, setQuery] = useState(\"\")\r\n  const wrapperRef = useRef<HTMLDivElement>(null)\r\n\r\n  // Filter based on query\r\n  const filteredLocations =\r\n    query === \"\"\r\n      ? locations\r\n      : locations.filter((loc) => \r\n          loc && loc.toLowerCase().includes(query.toLowerCase())\r\n        ).sort((a, b) => {\r\n            const aStarts = a.toLowerCase().startsWith(query.toLowerCase())\r\n            const bStarts = b.toLowerCase().startsWith(query.toLowerCase())\r\n            if (aStarts && !bStarts) return -1\r\n            if (!aStarts && bStarts) return 1\r\n            return 0\r\n        })\r\n\r\n  // Close when clicking outside\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n        setOpen(false)\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleClickOutside)\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside)\r\n  }, [])\r\n\r\n  // Update query when value changes from outside\r\n  useEffect(() => {\r\n     if (value && !query) {\r\n         setQuery(value)\r\n     }\r\n  }, [value])\r\n\r\n  const handleSelect = (location: string) => {\r\n    onChange(location)\r\n    setQuery(location)\r\n    setOpen(false)\r\n  }\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      setQuery(e.target.value)\r\n      onChange(e.target.value)\r\n      setOpen(true)\r\n  }\r\n\r\n  return (\r\n    <div ref={wrapperRef} className={cn(\"relative\", className)}>\r\n      <div className=\"relative\">\r\n        <Input\r\n          value={open ? query : (value || \"\")}\r\n          onChange={handleInputChange}\r\n          onFocus={() => setOpen(true)}\r\n          onClick={() => setOpen(true)}\r\n          placeholder={placeholder}\r\n          className={cn(\"bg-slate-900 border-slate-700 text-white\", className)}\r\n        />\r\n      </div>\r\n\r\n      {open && (\r\n        <div className=\"absolute z-[9999] w-full mt-1 bg-slate-800 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto\">\r\n          {filteredLocations.length === 0 ? (\r\n            <div className=\"px-3 py-2 text-sm text-slate-500 text-center\">\r\n                ไม่พบข้อมูล\r\n            </div>\r\n          ) : (\r\n            <div className=\"py-1\">\r\n                {filteredLocations.map((loc, index) => (\r\n                <button\r\n                    key={index}\r\n                    onClick={() => handleSelect(loc)}\r\n                    className={cn(\r\n                        \"w-full text-left px-3 py-2 text-sm hover:bg-slate-700 flex items-center justify-between transition-colors\",\r\n                         value === loc ? \"text-white bg-slate-700\" : \"text-slate-200\"\r\n                    )}\r\n                    type=\"button\"\r\n                >\r\n                    <div className=\"flex items-center gap-2 overflow-hidden\">\r\n                        <MapPin size={14} className=\"text-slate-400 flex-shrink-0\" />\r\n                        <span className=\"truncate\">{loc}</span>\r\n                    </div>\r\n                </button>\r\n                ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\maintenance\\maintenance-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XCircle' is defined but never used.","line":4,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":70,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[110,119],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[725,728],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[725,728],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[744,747],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[744,747],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { MoreVertical, Pencil, Trash2, Loader2, CheckCircle2, XCircle } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuSub,\r\n  DropdownMenuSubTrigger,\r\n  DropdownMenuSubContent,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { deleteRepairTicket, updateRepairTicket } from \"@/app/maintenance/actions\"\r\nimport { MaintenanceDialog } from \"./maintenance-dialog\"\r\nimport { RepairTicket } from \"@/lib/supabase/maintenance\"\r\n\r\ninterface MaintenanceActionsProps {\r\n  ticket: RepairTicket\r\n  drivers: any[]\r\n  vehicles: any[]\r\n}\r\n\r\nexport function MaintenanceActions({ ticket, drivers, vehicles }: MaintenanceActionsProps) {\r\n  const [loading, setLoading] = useState(false)\r\n  const [showEditDialog, setShowEditDialog] = useState(false)\r\n\r\n  const handleDelete = async () => {\r\n    if (!confirm(\"คุณแน่ใจหรือไม่ที่จะลบใบแจ้งซ่อมนี้?\")) return\r\n\r\n    setLoading(true)\r\n    try {\r\n      const result = await deleteRepairTicket(ticket.Ticket_ID)\r\n      if (!result.success) {\r\n        alert(result.message)\r\n      }\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert(\"เกิดข้อผิดพลาดในการลบ\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleStatusUpdate = async (status: string) => {\r\n    setLoading(true)\r\n    try {\r\n      // For quick status update, we just send the status and required ID\r\n      const result = await updateRepairTicket(ticket.Ticket_ID, { ...ticket, Status: status })\r\n      if (!result.success) {\r\n        alert(result.message)\r\n      }\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert(\"เกิดข้อผิดพลาดในการอัปเดตสถานะ\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button variant=\"ghost\" className=\"h-8 w-8 p-0 text-slate-400 hover:text-white\">\r\n            <span className=\"sr-only\">Open menu</span>\r\n            {loading ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <MoreVertical className=\"h-4 w-4\" />}\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\" className=\"bg-slate-900 border-slate-800 text-slate-200\">\r\n          <DropdownMenuLabel>การจัดการ</DropdownMenuLabel>\r\n          <DropdownMenuItem \r\n            className=\"cursor-pointer hover:bg-slate-800 hover:text-white focus:bg-slate-800 focus:text-white\"\r\n            onClick={() => setShowEditDialog(true)}\r\n          >\r\n            <Pencil className=\"mr-2 h-4 w-4\" />\r\n            แก้ไขข้อมูล\r\n          </DropdownMenuItem>\r\n          \r\n          <DropdownMenuSub>\r\n            <DropdownMenuSubTrigger className=\"hover:bg-slate-800 hover:text-white focus:bg-slate-800 focus:text-white cursor-pointer\">\r\n              <CheckCircle2 className=\"mr-2 h-4 w-4\" />\r\n              อัปเดตสถานะ\r\n            </DropdownMenuSubTrigger>\r\n            <DropdownMenuSubContent className=\"bg-slate-900 border-slate-800 text-slate-200\">\r\n              <DropdownMenuItem onClick={() => handleStatusUpdate('Pending')} className=\"cursor-pointer hover:bg-slate-800\">\r\n                รอดำเนินการ\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleStatusUpdate('In Progress')} className=\"cursor-pointer hover:bg-slate-800 text-blue-400\">\r\n                อนุมัติ / กำลังซ่อม\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleStatusUpdate('Rejected')} className=\"cursor-pointer hover:bg-slate-800 text-red-400\">\r\n                ไม่อนุมัติ / ปฏิเสธ\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem onClick={() => handleStatusUpdate('Completed')} className=\"cursor-pointer hover:bg-slate-800 text-emerald-400\">\r\n                เสร็จสิ้น\r\n              </DropdownMenuItem>\r\n            </DropdownMenuSubContent>\r\n          </DropdownMenuSub>\r\n\r\n          <DropdownMenuSeparator className=\"bg-slate-800\" />\r\n          \r\n          <DropdownMenuItem \r\n            onClick={handleDelete}\r\n            className=\"text-red-400 focus:text-red-400 cursor-pointer hover:bg-red-950/20 focus:bg-red-950/20\"\r\n          >\r\n            <Trash2 className=\"mr-2 h-4 w-4\" />\r\n            ลบรายการ\r\n          </DropdownMenuItem>\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      <MaintenanceDialog \r\n        open={showEditDialog} \r\n        onOpenChange={setShowEditDialog}\r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        initialData={ticket}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\maintenance\\maintenance-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[638,641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[638,641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[657,660],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[657,660],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[769,772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[769,772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":62,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":17}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { createRepairTicket, updateRepairTicket } from \"@/app/maintenance/actions\"\r\nimport { Loader2 } from \"lucide-react\"\r\nimport { ImageUpload } from \"@/components/ui/image-upload\"\r\n\r\ntype MaintenanceDialogProps = {\r\n  drivers: any[]\r\n  vehicles: any[]\r\n  trigger?: React.ReactNode\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n  initialData?: any\r\n}\r\n\r\nexport function MaintenanceDialog({\r\n  drivers,\r\n  vehicles,\r\n  trigger,\r\n  open,\r\n  onOpenChange,\r\n  initialData\r\n}: MaintenanceDialogProps) {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [internalOpen, setInternalOpen] = useState(false)\r\n  \r\n  const isControlled = open !== undefined\r\n  const show = isControlled ? open : internalOpen\r\n  const setShow = isControlled ? onOpenChange! : setInternalOpen\r\n\r\n  const [formData, setFormData] = useState({\r\n    Date_Report: new Date().toISOString().slice(0, 16),\r\n    Driver_ID: '',\r\n    Vehicle_Plate: '',\r\n    Issue_Type: 'Engine',\r\n    Issue_Desc: '',\r\n    Priority: 'Medium',\r\n    Photo_Url: '',\r\n    Status: 'Pending',\r\n    Cost_Total: 0,\r\n    Remark: ''\r\n  })\r\n\r\n  useEffect(() => {\r\n    if (initialData) {\r\n      let photoUrl = initialData.Photo_Url || '';\r\n      try {\r\n        if (photoUrl.startsWith('[') && photoUrl.endsWith(']')) {\r\n            const parsed = JSON.parse(photoUrl);\r\n            if (Array.isArray(parsed) && parsed.length > 0) {\r\n                photoUrl = parsed[0]\r\n            }\r\n        }\r\n      } catch (e) {}\r\n\r\n      setFormData({\r\n        Date_Report: initialData.Date_Report ? new Date(initialData.Date_Report).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16),\r\n        Driver_ID: initialData.Driver_ID || '',\r\n        Vehicle_Plate: initialData.Vehicle_Plate || '',\r\n        Issue_Type: initialData.Issue_Type || 'Engine',\r\n        Issue_Desc: initialData.Issue_Desc || '',\r\n        Priority: initialData.Priority || 'Medium',\r\n        Photo_Url: photoUrl,\r\n        Status: initialData.Status || 'Pending',\r\n        Cost_Total: initialData.Cost_Total || 0,\r\n        Remark: initialData.Remark || ''\r\n      })\r\n    }\r\n  }, [initialData, show])\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setLoading(true)\r\n\r\n    try {\r\n      const payload = {\r\n        ...formData,\r\n        Date_Report: new Date(formData.Date_Report).toISOString()\r\n      }\r\n\r\n      if (initialData) {\r\n        await updateRepairTicket(initialData.Ticket_ID, payload)\r\n      } else {\r\n        await createRepairTicket(payload)\r\n      }\r\n      \r\n      setShow(false)\r\n      if (!isControlled && !initialData) {\r\n        setFormData({\r\n            Date_Report: new Date().toISOString().slice(0, 16),\r\n            Driver_ID: '',\r\n            Vehicle_Plate: '',\r\n            Issue_Type: 'Engine',\r\n            Issue_Desc: '',\r\n            Priority: 'Medium',\r\n            Photo_Url: '',\r\n            Status: 'Pending',\r\n            Cost_Total: 0,\r\n            Remark: ''\r\n        })\r\n      }\r\n      router.refresh()\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert('เกิดข้อผิดพลาด กรุณาลองใหม่')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={show} onOpenChange={setShow}>\r\n      {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}\r\n      <DialogContent className=\"sm:max-w-[425px] bg-slate-900/95 border-white/10 text-white max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>{initialData ? 'แก้ไขข้อมูลการซ่อม' : 'แจ้งซ่อมบำรุง'}</DialogTitle>\r\n        </DialogHeader>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4 mt-4\">\r\n          \r\n          <div className=\"flex justify-center mb-4\">\r\n             <ImageUpload \r\n                value={formData.Photo_Url} \r\n                onChange={(url) => setFormData({ ...formData, Photo_Url: url })}\r\n             />\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Date_Report\">วัน-เวลาที่แจ้ง</Label>\r\n            <Input\r\n              id=\"Date_Report\"\r\n              type=\"datetime-local\"\r\n              value={formData.Date_Report}\r\n              onChange={(e) => setFormData({ ...formData, Date_Report: e.target.value })}\r\n              required\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Driver_ID\">ผู้แจ้ง</Label>\r\n                <select\r\n                    id=\"Driver_ID\"\r\n                    value={formData.Driver_ID}\r\n                    onChange={(e) => setFormData({ ...formData, Driver_ID: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                    required\r\n                >\r\n                    <option value=\"\" className=\"bg-slate-900\">เลือกคนขับ</option>\r\n                    {drivers.map((d) => (\r\n                        <option key={d.Driver_ID} value={d.Driver_ID} className=\"bg-slate-900\">\r\n                        {d.Driver_Name}\r\n                        </option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Vehicle_Plate\">ทะเบียนรถ</Label>\r\n                <select\r\n                    id=\"Vehicle_Plate\"\r\n                    value={formData.Vehicle_Plate}\r\n                    onChange={(e) => setFormData({ ...formData, Vehicle_Plate: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                    required\r\n                >\r\n                    <option value=\"\" className=\"bg-slate-900\">เลือกทะเบียน</option>\r\n                    {vehicles.map((v) => (\r\n                        <option key={v.Vehicle_Plate} value={v.Vehicle_Plate} className=\"bg-slate-900\">\r\n                        {v.Vehicle_Plate}\r\n                        </option>\r\n                    ))}\r\n                </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Issue_Type\">ประเภทปัญหา</Label>\r\n                <select\r\n                    id=\"Issue_Type\"\r\n                    value={formData.Issue_Type}\r\n                    onChange={(e) => setFormData({ ...formData, Issue_Type: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                >\r\n                    <option value=\"Engine\" className=\"bg-slate-900\">เครื่องยนต์</option>\r\n                    <option value=\"Tire\" className=\"bg-slate-900\">ยาง</option>\r\n                    <option value=\"Battery\" className=\"bg-slate-900\">แบตเตอรี่</option>\r\n                    <option value=\"Body\" className=\"bg-slate-900\">ตัวถัง</option>\r\n                    <option value=\"Other\" className=\"bg-slate-900\">อื่นๆ</option>\r\n                </select>\r\n            </div>\r\n             <div className=\"space-y-2\">\r\n                <Label htmlFor=\"Priority\">ความสำคัญ</Label>\r\n                <select\r\n                    id=\"Priority\"\r\n                    value={formData.Priority}\r\n                    onChange={(e) => setFormData({ ...formData, Priority: e.target.value })}\r\n                    className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                >\r\n                    <option value=\"Low\" className=\"bg-slate-900\">Low</option>\r\n                    <option value=\"Medium\" className=\"bg-slate-900\">Medium</option>\r\n                    <option value=\"High\" className=\"bg-slate-900\">High</option>\r\n                </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"Issue_Desc\">รายละเอียดปัญหา</Label>\r\n            <Textarea\r\n              id=\"Issue_Desc\"\r\n              value={formData.Issue_Desc}\r\n              onChange={(e) => setFormData({ ...formData, Issue_Desc: e.target.value })}\r\n              placeholder=\"รายละเอียด...\"\r\n              required\r\n              className=\"bg-white/5 border-white/10\"\r\n            />\r\n          </div>\r\n\r\n          {initialData && (\r\n             <div className=\"pt-4 border-t border-white/10 space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"Status\">สถานะ</Label>\r\n                        <select\r\n                            id=\"Status\"\r\n                            value={formData.Status}\r\n                            onChange={(e) => setFormData({ ...formData, Status: e.target.value })}\r\n                            className=\"flex h-10 w-full rounded-md border border-white/10 bg-white/5 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-indigo-500\"\r\n                        >\r\n                            <option value=\"Pending\" className=\"bg-slate-900\">รอดำเนินการ</option>\r\n                            <option value=\"In Progress\" className=\"bg-slate-900\">กำลังซ่อม</option>\r\n                            <option value=\"Completed\" className=\"bg-slate-900\">เสร็จสิ้น</option>\r\n                            <option value=\"Cancelled\" className=\"bg-slate-900\">ยกเลิก</option>\r\n                        </select>\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <Label htmlFor=\"Cost_Total\">ค่าใช้จ่าย</Label>\r\n                         <Input\r\n                            id=\"Cost_Total\"\r\n                            type=\"number\"\r\n                            value={formData.Cost_Total}\r\n                            onChange={(e) => setFormData({ ...formData, Cost_Total: parseFloat(e.target.value) || 0 })}\r\n                            className=\"bg-white/5 border-white/10\"\r\n                         />\r\n                    </div>\r\n                </div>\r\n                 <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"Remark\">หมายเหตุ / การแก้ไข</Label>\r\n                    <Textarea\r\n                        id=\"Remark\"\r\n                        value={formData.Remark}\r\n                        onChange={(e) => setFormData({ ...formData, Remark: e.target.value })}\r\n                        placeholder=\"บันทึกการซ่อม...\"\r\n                        className=\"bg-white/5 border-white/10\"\r\n                    />\r\n                </div>\r\n             </div>\r\n          )}\r\n\r\n          <div className=\"flex justify-end gap-2 mt-6\">\r\n            <Button type=\"button\" variant=\"ghost\" onClick={() => setShow(false)}>\r\n              ยกเลิก\r\n            </Button>\r\n            <Button type=\"submit\" disabled={loading} className=\"bg-gradient-to-r from-amber-500 to-orange-600\">\r\n              {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n              {initialData ? 'บันทึกการแก้ไข' : 'แจ้งซ่อม'}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\maintenance\\maintenance-schedule-dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\maps\\job-map-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\maps\\leaflet-map.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\bottom-nav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\camera-input.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":84,"column":21,"nodeType":"JSXOpeningElement","endLine":84,"endColumn":107,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\fuel-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\job-action-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Navigation' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Navigation"},"fix":{"range":[112,123],"text":""},"desc":"Remove unused variable \"Navigation\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Package' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Package"},"fix":{"range":[122,135],"text":""},"desc":"Remove unused variable \"Package\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Truck' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Truck"},"fix":{"range":[147,158],"text":""},"desc":"Remove unused variable \"Truck\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[200,215],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[389,392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[389,392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":33,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { \r\n  Navigation, \r\n  Package, \r\n  MapPin, \r\n  Truck, \r\n  CheckSquare, \r\n  Camera, \r\n  Loader2,\r\n  ArrowRight\r\n} from \"lucide-react\"\r\nimport { updateJobStatus } from \"@/app/mobile/jobs/actions\"\r\nimport { useRouter } from \"next/navigation\"\r\n\r\ninterface JobActionButtonProps {\r\n  job: any\r\n}\r\n\r\nexport function JobActionButton({ job }: JobActionButtonProps) {\r\n  const [loading, setLoading] = useState(false)\r\n  const router = useRouter()\r\n\r\n  const handleStatusUpdate = async (newStatus: string) => {\r\n    setLoading(true)\r\n    try {\r\n        const result = await updateJobStatus(job.Job_ID, newStatus)\r\n        if (!result.success) {\r\n            alert(result.message)\r\n        }\r\n    } catch (e) {\r\n        alert(\"เกิดข้อผิดพลาด\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  // POD Flow\r\n  const handlePOD = () => {\r\n    // Navigate to camera/POD page (to be implemented or simple alert for now)\r\n    // Assuming we have a camera page or we just complete it directly for this demo\r\n    // The user mentioned \"บันทึกส่งงาน (POD)\" existing, so we simulate that\r\n    router.push(`/mobile/jobs/${job.Job_ID}/complete`)\r\n  }\r\n\r\n  if (job.Job_Status === 'Completed') {\r\n    return (\r\n        <div className=\"text-center p-4 bg-emerald-500/10 rounded-xl text-emerald-400 font-medium flex items-center justify-center gap-2\">\r\n            <CheckSquare /> งานเสร็จสิ้นแล้ว\r\n        </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n        {/* Status Stepper visualization (Optional but helpful) */}\r\n        \r\n        {/* Dynamic Buttons */}\r\n        {(() => {\r\n            switch(job.Job_Status) {\r\n                case 'Assigned': \r\n                case 'New': // Handle potential variations\r\n                    return (\r\n                        <Button \r\n                            onClick={() => handleStatusUpdate('Accepted')}\r\n                            disabled={loading}\r\n                            className=\"w-full h-14 text-lg bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/20 gap-2 font-bold\"\r\n                        >\r\n                            {loading ? <Loader2 className=\"animate-spin\" /> : <CheckSquare />}\r\n                            กดรับงาน\r\n                        </Button>\r\n                    )\r\n                \r\n                case 'Accepted':\r\n                    return (\r\n                        <Button \r\n                            onClick={() => handleStatusUpdate('Arrived Pickup')}\r\n                            disabled={loading}\r\n                            className=\"w-full h-14 text-lg bg-amber-600 hover:bg-amber-700 shadow-lg shadow-amber-500/20 gap-2 font-bold\"\r\n                        >\r\n                            {loading ? <Loader2 className=\"animate-spin\" /> : <MapPin />}\r\n                            ถึงจุดรับสินค้า\r\n                        </Button>\r\n                    )\r\n\r\n                case 'Arrived Pickup':\r\n                    return (\r\n                        <Button \r\n                            onClick={() => router.push(`/mobile/jobs/${job.Job_ID}/pickup`)}\r\n                            disabled={loading}\r\n                            className=\"w-full h-14 text-lg bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 gap-2 font-bold\"\r\n                        >\r\n                            <Camera />\r\n                            ถ่ายรูปรับสินค้า / ออกเดินทาง\r\n                        </Button>\r\n                    )\r\n\r\n                case 'In Transit':\r\n                    return (\r\n                        <Button \r\n                            onClick={() => handleStatusUpdate('Arrived Dropoff')}\r\n                            disabled={loading}\r\n                            className=\"w-full h-14 text-lg bg-purple-600 hover:bg-purple-700 shadow-lg shadow-purple-500/20 gap-2 font-bold\"\r\n                        >\r\n                            {loading ? <Loader2 className=\"animate-spin\" /> : <MapPin />}\r\n                            ถึงจุดส่งสินค้า\r\n                        </Button>\r\n                    )\r\n\r\n                case 'Arrived Dropoff':\r\n                    return (\r\n                         <Button \r\n                            onClick={handlePOD} // Opens POD page\r\n                            disabled={loading}\r\n                            className=\"w-full h-14 text-lg bg-emerald-600 hover:bg-emerald-700 shadow-lg shadow-emerald-500/20 gap-2 font-bold\"\r\n                        >\r\n                            <Camera />\r\n                            บันทึกส่งงาน (POD)\r\n                        </Button>\r\n                    )\r\n\r\n                default:\r\n                    return (\r\n                        <Button \r\n                            disabled={true}\r\n                            className=\"w-full h-14 text-lg bg-slate-700 text-slate-400\"\r\n                        >\r\n                            ไม่ทราบสถานะ ({job.Job_Status})\r\n                        </Button>\r\n                    )\r\n            }\r\n        })()}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\job-filter.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[33,44],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SheetClose' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SheetClose"},"fix":{"range":[377,392],"text":""},"desc":"Remove unused variable \"SheetClose\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":17,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[451,454],"text":""},"desc":"Remove unused variable \"X\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetHeader,\r\n  SheetTitle,\r\n  SheetTrigger,\r\n  SheetFooter,\r\n  SheetClose\r\n} from \"@/components/ui/sheet\"\r\nimport { Filter, Calendar, X } from \"lucide-react\"\r\n\r\nexport function MobileJobFilter() {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParams = useSearchParams()\r\n\r\n  const [date, setDate] = useState(searchParams.get(\"date\") || \"\")\r\n  const [status, setStatus] = useState(searchParams.get(\"status\") || \"All\")\r\n  const [isOpen, setIsOpen] = useState(false)\r\n\r\n  // Apply filters\r\n  const handleApply = () => {\r\n    const params = new URLSearchParams()\r\n    if (date) params.set(\"date\", date)\r\n    if (status && status !== \"All\") params.set(\"status\", status)\r\n    \r\n    router.replace(`${pathname}?${params.toString()}`)\r\n    setIsOpen(false)\r\n  }\r\n\r\n  // Clear filters\r\n  const handleClear = () => {\r\n    setDate(\"\")\r\n    setStatus(\"All\")\r\n    router.replace(pathname)\r\n    setIsOpen(false)\r\n  }\r\n\r\n  const activeFilterCount = (date ? 1 : 0) + (status !== \"All\" ? 1 : 0)\r\n\r\n  return (\r\n    <Sheet open={isOpen} onOpenChange={setIsOpen}>\r\n      <SheetTrigger asChild>\r\n        <Button \r\n            variant=\"outline\" \r\n            size=\"sm\" \r\n            className={`gap-2 border-slate-700 bg-slate-900 text-slate-300 hover:text-white ${\r\n                activeFilterCount > 0 ? 'border-blue-500 text-blue-400' : ''\r\n            }`}\r\n        >\r\n          <Filter size={14} />\r\n          ตัวกรอง\r\n          {activeFilterCount > 0 && (\r\n              <span className=\"flex items-center justify-center w-5 h-5 ml-1 text-[10px] font-bold text-white bg-blue-600 rounded-full\">\r\n                  {activeFilterCount}\r\n              </span>\r\n          )}\r\n        </Button>\r\n      </SheetTrigger>\r\n      <SheetContent side=\"bottom\" className=\"h-auto rounded-t-xl border-t border-slate-700 bg-slate-900 text-white px-4 py-6\">\r\n        <SheetHeader className=\"mb-6 text-left\">\r\n          <SheetTitle className=\"text-white flex justify-between items-center\">\r\n            <span>ตัวกรองงาน</span>\r\n            {activeFilterCount > 0 && (\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={handleClear} className=\"h-8 text-xs text-slate-400 hover:text-white\">\r\n                    ล้างค่า\r\n                </Button>\r\n            )}\r\n          </SheetTitle>\r\n        </SheetHeader>\r\n        \r\n        <div className=\"space-y-6 pb-6\">\r\n            {/* Date Filter */}\r\n            <div className=\"space-y-2\">\r\n                <Label htmlFor=\"date\" className=\"text-slate-300\">วันที่</Label>\r\n                <div className=\"relative\">\r\n                    <Input \r\n                        id=\"date\" \r\n                        type=\"date\" \r\n                        value={date}\r\n                        onChange={(e) => setDate(e.target.value)}\r\n                        className=\"bg-slate-800 border-slate-700 text-white pl-10 h-12\"\r\n                    />\r\n                    <Calendar className=\"absolute left-3 top-3.5 text-slate-400\" size={18} />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Status Filter */}\r\n            <div className=\"space-y-2\">\r\n                <Label className=\"text-slate-300\">สถานะงาน</Label>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                    {['All', 'Assigned', 'In Transit', 'Completed', 'Cancelled'].map((s) => (\r\n                        <button\r\n                            key={s}\r\n                            onClick={() => setStatus(s)}\r\n                            className={`px-4 py-2 rounded-full text-sm border transition-colors ${\r\n                                status === s \r\n                                    ? 'bg-blue-600 border-blue-600 text-white' \r\n                                    : 'bg-transparent border-slate-700 text-slate-400 hover:border-slate-500'\r\n                            }`}\r\n                        >\r\n                            {s === 'All' ? 'ทั้งหมด' : s}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <SheetFooter>\r\n             <Button onClick={handleApply} className=\"w-full h-12 text-base bg-blue-600 hover:bg-blue-700 mb-2\">\r\n                ดูผลลัพธ์\r\n             </Button>\r\n        </SheetFooter>\r\n      </SheetContent>\r\n    </Sheet>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\location-tracker.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\location-tracker.tsx:19:7\n  17 |     // Check if geolocation is supported\n  18 |     if (!(\"geolocation\" in navigator)) {\n> 19 |       setStatus(\"error\")\n     |       ^^^^^^^^^ Avoid calling setState() directly within an effect\n  20 |       return\n  21 |     }\n  22 |","line":19,"column":7,"nodeType":null,"endLine":19,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useRef, useState } from \"react\"\r\nimport { saveGPSLog } from \"@/lib/supabase/gps\"\r\n\r\nconst UPDATE_INTERVAL = 30000 // Update every 30 seconds\r\nconst MIN_DISTANCE = 0.0001 // Approx 10-15 meters difference to trigger update\r\n\r\nexport function LocationTracker({ driverId }: { driverId?: string }) {\r\n  const [status, setStatus] = useState<\"idle\" | \"tracking\" | \"error\">(\"idle\")\r\n  const lastUpdateRef = useRef<number>(0)\r\n  const lastPosRef = useRef<{ lat: number; lng: number } | null>(null)\r\n  \r\n  useEffect(() => {\r\n    if (!driverId) return // No driver logged in\r\n\r\n    // Check if geolocation is supported\r\n    if (!(\"geolocation\" in navigator)) {\r\n      setStatus(\"error\")\r\n      return\r\n    }\r\n\r\n    setStatus(\"tracking\")\r\n\r\n    const watchId = navigator.geolocation.watchPosition(\r\n        async (position) => {\r\n            const now = Date.now()\r\n            const { latitude, longitude, speed } = position.coords\r\n            \r\n            // Throttle updates: Only send if enough time passed OR significant distance moved\r\n            const timeDiff = now - lastUpdateRef.current\r\n            const isTime = timeDiff > UPDATE_INTERVAL\r\n            \r\n            const isDistance = lastPosRef.current \r\n                ? Math.abs(latitude - lastPosRef.current.lat) + Math.abs(longitude - lastPosRef.current.lng) > MIN_DISTANCE\r\n                : true\r\n\r\n            if (isTime || isDistance) {\r\n                // Update refs\r\n                lastUpdateRef.current = now\r\n                lastPosRef.current = { lat: latitude, lng: longitude }\r\n\r\n                // Send to Server\r\n                await saveGPSLog({\r\n                    driverId: driverId,\r\n                    lat: latitude,\r\n                    lng: longitude,\r\n                    speed: speed || 0,\r\n                    // battery: we can't easily get battery in web without experimental API\r\n                })\r\n                \r\n                console.log(\"📍 GPS Updated:\", latitude, longitude)\r\n            }\r\n        },\r\n        (error) => {\r\n            console.error(\"GPS Error:\", error)\r\n            setStatus(\"error\")\r\n        },\r\n        {\r\n            enableHighAccuracy: true,\r\n            timeout: 20000,\r\n            maximumAge: 10000\r\n        }\r\n    )\r\n\r\n    return () => {\r\n        if (watchId) navigator.geolocation.clearWatch(watchId)\r\n    }\r\n  }, [driverId])\r\n\r\n  if (status === \"error\") return null // Don't show anything on error\r\n\r\n  // Optional: Show a small indicator that tracking is active (Debug mode or always)\r\n  return (\r\n    <div className=\"fixed top-2 right-2 z-50 pointer-events-none\">\r\n       {status === \"tracking\" && (\r\n           <span className=\"flex h-2 w-2 relative\">\r\n             <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75\"></span>\r\n             <span className=\"relative inline-flex rounded-full h-2 w-2 bg-emerald-500\"></span>\r\n           </span>\r\n       )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\maintenance-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\mobile-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\notifications-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\permission-requester.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":4,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[74,82],"text":""},"desc":"Remove unused variable \"MapPin\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":4,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[82,85],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\permission-requester.tsx:15:7\n  13 |     // Check Notification Permission\n  14 |     if (\"Notification\" in window && Notification.permission === \"default\") {\n> 15 |       setPermissionType(\"notifications\")\n     |       ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  16 |       setShowPrompt(true)\n  17 |     } \n  18 |     // Check Geolocation Permission (Optional, usually handled by browser on usage)","line":15,"column":7,"nodeType":null,"endLine":15,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Bell, MapPin, X } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\n\r\nexport function PermissionRequester() {\r\n  const [showPrompt, setShowPrompt] = useState(false)\r\n  const [permissionType, setPermissionType] = useState<\"notifications\" | \"geolocation\" | null>(null)\r\n\r\n  useEffect(() => {\r\n    // Check Notification Permission\r\n    if (\"Notification\" in window && Notification.permission === \"default\") {\r\n      setPermissionType(\"notifications\")\r\n      setShowPrompt(true)\r\n    } \r\n    // Check Geolocation Permission (Optional, usually handled by browser on usage)\r\n    else if (\"geolocation\" in navigator) {\r\n        navigator.permissions.query({ name: \"geolocation\" }).then((result) => {\r\n            if (result.state === \"prompt\") {\r\n                // We don't force prompt for geo immediately, let LocationTracker handle it,\r\n                // but we could if we wanted to be aggressive.\r\n                // For now, focus on Notifications as requested.\r\n            }\r\n        })\r\n    }\r\n  }, [])\r\n\r\n  const requestPermission = async () => {\r\n    if (permissionType === \"notifications\") {\r\n      try {\r\n        const result = await Notification.requestPermission()\r\n        if (result === \"granted\") {\r\n          console.log(\"Notification permission granted.\")\r\n          // Here you would normally subscribe the user to push service\r\n        }\r\n        setShowPrompt(false)\r\n      } catch (error) {\r\n        console.error(\"Error requesting notification permission:\", error)\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!showPrompt) return null\r\n\r\n  return (\r\n    <div className=\"fixed bottom-20 left-4 right-4 z-50 animate-in slide-in-from-bottom-5\">\r\n      <Card className=\"bg-slate-900 border-indigo-500/50 shadow-lg shadow-indigo-500/20\">\r\n        <CardContent className=\"p-4 flex items-start gap-4 relaltive\">\r\n            <button \r\n                onClick={() => setShowPrompt(false)}\r\n                className=\"absolute top-2 right-2 text-slate-500 hover:text-white\"\r\n            >\r\n                {/* <X size={16} /> */}\r\n            </button>\r\n            <div className=\"w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center flex-shrink-0 text-indigo-400\">\r\n                <Bell size={20} />\r\n            </div>\r\n            <div className=\"flex-1\">\r\n                <h3 className=\"font-semibold text-white mb-1\">เปิดการแจ้งเตือน</h3>\r\n                <p className=\"text-xs text-slate-400 mb-3\">\r\n                    เพื่อไม่ให้พลาดงานใหม่และการอัปเดตสถานะงาน\r\n                </p>\r\n                <div className=\"flex gap-2\">\r\n                    <Button \r\n                        size=\"sm\" \r\n                        variant=\"secondary\" \r\n                        className=\"flex-1 bg-slate-800 text-slate-300 hover:bg-slate-700\"\r\n                        onClick={() => setShowPrompt(false)}\r\n                    >\r\n                        ไว้ทีหลัง\r\n                    </Button>\r\n                    <Button \r\n                        size=\"sm\" \r\n                        className=\"flex-1 bg-indigo-600 hover:bg-indigo-700 text-white\"\r\n                        onClick={requestPermission}\r\n                    >\r\n                        อนุญาต\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\pickup-report.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":91,"column":21,"nodeType":"JSXOpeningElement","endLine":91,"endColumn":90,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":104,"column":21,"nodeType":"JSXOpeningElement","endLine":104,"endColumn":94,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\pod-report.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":94,"column":21,"nodeType":"JSXOpeningElement","endLine":94,"endColumn":87,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":107,"column":21,"nodeType":"JSXOpeningElement","endLine":107,"endColumn":94,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\profile-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\pwa-install-hint.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[277,280],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[277,280],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { motion, AnimatePresence } from \"framer-motion\"\r\nimport { Share, X, PlusSquare } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\n\r\ndeclare global {\r\n  interface Window {\r\n    MSStream?: any\r\n  }\r\n  interface Navigator {\r\n    standalone?: boolean\r\n  }\r\n}\r\n\r\nexport function PWAInstallHint() {\r\n  const [show, setShow] = useState(false)\r\n\r\n  useEffect(() => {\r\n    // Check if it's iOS Safari and NOT already in standalone mode\r\n    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream\r\n    const isStandalone = window.navigator.standalone === true\r\n    const hasDismissed = localStorage.getItem('pwa_hint_dismissed')\r\n\r\n    if (isIOS && !isStandalone && !hasDismissed) {\r\n      // Show after a short delay\r\n      const timer = setTimeout(() => setShow(true), 3000)\r\n      return () => clearTimeout(timer)\r\n    }\r\n  }, [])\r\n\r\n  const dismiss = () => {\r\n    setShow(false)\r\n    localStorage.setItem('pwa_hint_dismissed', 'true')\r\n  }\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {show && (\r\n        <motion.div\r\n          initial={{ y: 100, opacity: 0 }}\r\n          animate={{ y: 0, opacity: 1 }}\r\n          exit={{ y: 100, opacity: 0 }}\r\n          className=\"fixed bottom-6 left-4 right-4 z-[100] bg-card/95 backdrop-blur-xl border border-border rounded-2xl shadow-2xl p-4 flex flex-col gap-3 transition-colors duration-300\"\r\n        >\r\n          <div className=\"flex items-start justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"w-10 h-10 bg-primary rounded-xl flex items-center justify-center\">\r\n                <PlusSquare className=\"text-primary-foreground w-6 h-6\" />\r\n              </div>\r\n              <div className=\"flex-1\">\r\n                <h3 className=\"text-foreground font-bold text-sm\">ติดตั้งแอป LOGIS Driver</h3>\r\n                <p className=\"text-muted-foreground text-xs\">ติดตั้งลงบนหน้าจอหลักเพื่อการใช้งานที่รวดเร็ว</p>\r\n              </div>\r\n            </div>\r\n            <Button variant=\"ghost\" size=\"icon\" onClick={dismiss} className=\"text-muted-foreground h-8 w-8\">\r\n              <X size={18} />\r\n            </Button>\r\n          </div>\r\n\r\n          <div className=\"bg-muted/50 rounded-xl p-3 text-xs text-muted-foreground space-y-2\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"w-5 h-5 flex items-center justify-center bg-primary/10 rounded text-primary text-[10px] font-bold\">1</span>\r\n              <span>กดปุ่ม <Share className=\"inline w-3 h-3 text-primary\" /> (แชร์) ด้านล่างของ Safari</span>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"w-5 h-5 flex items-center justify-center bg-primary/10 rounded text-primary text-[10px] font-bold\">2</span>\r\n              <span>เลื่อนลงมาแล้วกด <span className=\"text-foreground font-semibold\">&quot;เพิ่มลงในหน้าจอโฮม&quot;</span></span>\r\n            </div>\r\n          </div>\r\n        </motion.div>\r\n      )}\r\n    </AnimatePresence>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\signature-pad.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":6,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Check"},"fix":{"range":[176,183],"text":""},"desc":"Remove unused variable \"Check\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useRef, useState } from \"react\"\r\nimport SignatureCanvas from \"react-signature-canvas\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Eraser, Check } from \"lucide-react\"\r\n\r\ntype Props = {\r\n  onSave: (blob: Blob | null) => void\r\n}\r\n\r\nexport function SignaturePad({ onSave }: Props) {\r\n  const sigCanvas = useRef<SignatureCanvas>(null)\r\n  const [isEmpty, setIsEmpty] = useState(true)\r\n\r\n  const clear = () => {\r\n    sigCanvas.current?.clear()\r\n    setIsEmpty(true)\r\n    onSave(null) // Notify parent it's cleared\r\n  }\r\n\r\n  const save = async () => {\r\n    if (sigCanvas.current) {\r\n        if (sigCanvas.current.isEmpty()) {\r\n            onSave(null)\r\n            setIsEmpty(true)\r\n        } else {\r\n            // Use getCanvas() instead of trimmed for reliability\r\n            // Convert to Base64 then Blob to ensure compatibility\r\n            try {\r\n                const dataURL = sigCanvas.current.getCanvas().toDataURL(\"image/png\")\r\n                const blob = await (await fetch(dataURL)).blob()\r\n                onSave(blob)\r\n                setIsEmpty(false)\r\n            } catch (e) {\r\n                console.error(\"Signature save error:\", e)\r\n            }\r\n        }\r\n    }\r\n  }\r\n\r\n  const handleEnd = () => {\r\n      // Short timeout to ensure canvas updates\r\n      setTimeout(() => save(), 100) \r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"border-2 border-dashed border-slate-700 rounded-xl bg-slate-900 overflow-hidden touch-none relative\">\r\n        <SignatureCanvas\r\n          ref={sigCanvas}\r\n          penColor=\"white\"\r\n          backgroundColor=\"transparent\"\r\n          canvasProps={{\r\n            className: \"w-full h-48 cursor-crosshair block\",\r\n          }}\r\n          onBegin={() => setIsEmpty(false)}\r\n          onEnd={handleEnd}\r\n        />\r\n        {isEmpty && (\r\n           <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none text-slate-600\">\r\n              เซ็นชื่อที่นี่\r\n           </div>\r\n        )}\r\n      </div>\r\n      \r\n      <div className=\"flex gap-2\">\r\n        <Button \r\n            type=\"button\" \r\n            variant=\"outline\" \r\n            className=\"flex-1 border-slate-700 text-slate-300 hover:bg-slate-800\"\r\n            onClick={clear}\r\n        >\r\n          <Eraser size={16} className=\"mr-2\" /> ล้าง\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\sync-manager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\vehicle-check-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\mobile\\vehicle-check-report.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":96,"column":25,"nodeType":"JSXOpeningElement","endLine":96,"endColumn":93,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":110,"column":21,"nodeType":"JSXOpeningElement","endLine":110,"endColumn":94,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\notifications\\notification-dropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\planning\\create-job-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[227,230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[227,230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[246,249],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[246,249],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[266,269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[266,269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[283,286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[283,286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { JobDialog } from \"@/components/planning/job-dialog\"\r\nimport { Plus } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\n\r\ntype Props = {\r\n  drivers: any[]\r\n  vehicles: any[]\r\n  customers: any[]\r\n  routes: any[]\r\n}\r\n\r\nexport function CreateJobButton({ drivers, vehicles, customers, routes }: Props) {\r\n  const [open, setOpen] = useState(false)\r\n\r\n  return (\r\n    <>\r\n      <Button \r\n        size=\"lg\" \r\n        className=\"gap-2 bg-indigo-600 hover:bg-indigo-700 text-white\"\r\n        onClick={() => setOpen(true)}\r\n      >\r\n        <Plus size={20} />\r\n        สร้างงานใหม่\r\n      </Button>\r\n\r\n      <JobDialog\r\n        mode=\"create\"\r\n        open={open}\r\n        onOpenChange={setOpen}\r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        customers={customers}\r\n        routes={routes}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\planning\\job-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[349,352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[349,352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[363,366],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[363,366],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":94,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":97,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[380,383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[380,383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { deleteJob } from \"@/app/planning/actions\"\r\nimport { Pencil, Trash2 } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { JobDialog } from \"./job-dialog\"\r\n\r\nexport function JobActions({ job, drivers, vehicles }: { job: any, drivers: any[], vehicles: any[] }) {\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [showEdit, setShowEdit] = useState(false)\r\n\r\n  const handleDelete = async () => {\r\n    if (!confirm('ยืนยันการลบงานนี้?')) return\r\n    \r\n    setLoading(true)\r\n    try {\r\n      await deleteJob(job.Job_ID)\r\n      router.refresh()\r\n    } catch (error) {\r\n      console.error(error)\r\n      alert('ลบไม่สำเร็จ')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex justify-end gap-2\">\r\n      <JobDialog \r\n        mode=\"edit\" \r\n        job={job} \r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        open={showEdit}\r\n        onOpenChange={setShowEdit}\r\n      />\r\n      <Button \r\n        variant=\"ghost\" \r\n        size=\"icon\" \r\n        className=\"h-8 w-8 hover:bg-blue-500/20 text-blue-400\"\r\n        onClick={() => setShowEdit(true)}\r\n      >\r\n        <Pencil size={16} />\r\n      </Button>\r\n      <Button \r\n        variant=\"ghost\" \r\n        size=\"icon\" \r\n        className=\"h-8 w-8 hover:bg-red-500/20 text-red-400\"\r\n        onClick={handleDelete}\r\n        disabled={loading}\r\n      >\r\n        <Trash2 size={16} />\r\n      </Button>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\planning\\job-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2887,2890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2887,2890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":191,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5956,5959],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5956,5959],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":191,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":191,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5973,5976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5973,5976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { updateJob, createBulkJobs, deleteJob } from \"@/app/planning/actions\"\r\nimport { CustomerAutocomplete } from \"@/components/customer-autocomplete\"\r\nimport { LocationAutocomplete } from \"@/components/location-autocomplete\"\r\nimport { VehicleAutocomplete } from \"@/components/vehicle-autocomplete\"\r\nimport { DriverAutocomplete } from \"@/components/driver-autocomplete\"\r\nimport { ZONES } from \"@/lib/constants\"\r\nimport { useBranch } from \"@/components/providers/branch-provider\"\r\nimport { Driver } from \"@/lib/supabase/drivers\"\r\nimport { Vehicle } from \"@/lib/supabase/vehicles\"\r\nimport { Customer } from \"@/lib/supabase/customers\"\r\n\r\nexport type JobAssignment = {\r\n  Vehicle_Type: string\r\n  Vehicle_Plate: string\r\n  Driver_ID: string\r\n  Sub_ID?: string\r\n  Show_Price_To_Driver?: boolean\r\n  Cost_Driver_Total?: number\r\n  Price_Cust_Total?: number\r\n}\r\n\r\nexport type Job = {\r\n  Job_ID: string\r\n  Plan_Date?: string | null\r\n  Pickup_Date?: string | null\r\n  Delivery_Date?: string | null\r\n  Customer_Name?: string | null\r\n  Route_Name?: string | null\r\n  Driver_ID?: string | null\r\n  Vehicle_Plate?: string | null\r\n  Vehicle_Type?: string | null\r\n  Cargo_Type?: string | null\r\n  Notes?: string | null\r\n  Price_Cust_Total?: number | string | null\r\n  Cost_Driver_Total?: number | string | null\r\n  Job_Status?: string | null\r\n  Weight_Kg?: number | null\r\n  Volume_Cbm?: number | null\r\n  Zone?: string | null\r\n  Branch_ID?: string | null\r\n  origins?: LocationPoint[] | string | null\r\n  destinations?: LocationPoint[] | string | null\r\n  extra_costs?: ExtraCost[] | string | null\r\n  original_origins_json?: string | null\r\n  original_destinations_json?: string | null\r\n  extra_costs_json?: string | null\r\n  assignments?: JobAssignment[] | null\r\n  Sub_ID?: string | null\r\n  Show_Price_To_Driver?: boolean | null\r\n}\r\nimport { \r\n  Loader2, \r\n  Plus, \r\n  X, \r\n  MapPin, \r\n  Truck,\r\n  User, \r\n  Package,\r\n  Building2,\r\n  Calendar,\r\n  Banknote,\r\n  FileText,\r\n  Trash2,\r\n\r\n  Link as LinkIcon,\r\n  Check,\r\n  Eye,\r\n  EyeOff\r\n} from \"lucide-react\"\r\n\r\ntype LocationPoint = {\r\n  name: string\r\n  lat: string\r\n  lng: string\r\n}\r\n\r\ntype ExtraCost = {\r\n  type: string\r\n  cost_driver: number   // จ่ายให้รถ\r\n  charge_cust: number   // เก็บจากลูกค้า\r\n}\r\n\r\ntype JobDialogProps = {\r\n  mode?: 'create' | 'edit'\r\n  job?: Job\r\n  drivers?: Driver[]\r\n  vehicles?: Vehicle[]\r\n  customers?: Customer[]\r\n  routes?: any[]\r\n  trigger?: React.ReactNode\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n  canViewPrice?: boolean\r\n  canDelete?: boolean\r\n}\r\n\r\n// Common expense types\r\nconst EXPENSE_TYPES = [\r\n  \"ค่าแรงยกของ\",\r\n  \"ค่าพาเลท\",\r\n  \"ค่าทางด่วน\",\r\n  \"ค่าล่วงเวลา\",\r\n  \"ค่าจอดรถ\",\r\n  \"ค่าน้ำมันเพิ่ม\",\r\n  \"อื่นๆ\"\r\n]\r\n\r\nfunction generateJobId() {\r\n  const now = new Date()\r\n  const year = now.getFullYear()\r\n  const month = String(now.getMonth() + 1).padStart(2, '0')\r\n  const day = String(now.getDate()).padStart(2, '0')\r\n  const random = String(Math.floor(Math.random() * 1000000)).padStart(6, '0')\r\n  return `JOB-${year}${month}${day}-${random}`\r\n}\r\n\r\nexport function JobDialog({\r\n  mode = 'create',\r\n  job,\r\n  drivers = [],\r\n  vehicles = [],\r\n  customers = [],\r\n  routes = [],\r\n  trigger,\r\n  open: controlledOpen,\r\n  onOpenChange: setControlledOpen,\r\n  canViewPrice = true,\r\n  canDelete = true\r\n}: JobDialogProps) {\r\n  const { branches, isAdmin } = useBranch()\r\n  const router = useRouter()\r\n  const [loading, setLoading] = useState(false)\r\n  const [open, setOpen] = useState(false)\r\n  const [activeTab, setActiveTab] = useState<'info' | 'location' | 'assign' | 'price'>('info')\r\n  \r\n  const isControlled = controlledOpen !== undefined\r\n  const show = isControlled ? controlledOpen : open\r\n  const setShow = isControlled ? setControlledOpen! : setOpen\r\n  const [copied, setCopied] = useState(false)\r\n\r\n  // Form State\r\n  const [formData, setFormData] = useState({\r\n    Job_ID: job?.Job_ID || generateJobId(),\r\n    Plan_Date: job?.Pickup_Date || job?.Plan_Date || new Date().toISOString().split('T')[0],\r\n    Delivery_Date: job?.Delivery_Date || new Date().toISOString().split('T')[0],\r\n    Customer_Name: job?.Customer_Name || '',\r\n    Route_Name: job?.Route_Name || '', // Not used directly in UI but kept for compatibility\r\n    \r\n    // Legacy single assignment fields (will be syncing with first assignment or ignored in multi-mode)\r\n    Driver_ID: job?.Driver_ID || '',\r\n    Vehicle_Plate: job?.Vehicle_Plate || '',\r\n    Vehicle_Type: job?.Vehicle_Type || '4-Wheel',\r\n\r\n    Cargo_Type: job?.Cargo_Type || '',\r\n    Notes: job?.Notes || '',\r\n    Price_Cust_Total: job?.Price_Cust_Total || 0,\r\n    Cost_Driver_Total: job?.Cost_Driver_Total || 0,\r\n    Job_Status: job?.Job_Status || 'New',\r\n    Weight_Kg: job?.Weight_Kg || 0,\r\n    Volume_Cbm: job?.Volume_Cbm || 0,\r\n    Zone: job?.Zone || '',\r\n    Branch_ID: job?.Branch_ID || ''\r\n  })\r\n\r\n  // Multi-Assignment State\r\n  const [assignments, setAssignments] = useState<JobAssignment[]>(\r\n    job?.assignments && job.assignments.length > 0\r\n      ? job.assignments\r\n      : [{ \r\n          Vehicle_Type: '4-Wheel', \r\n          Vehicle_Plate: '', \r\n          Driver_ID: '', \r\n          Sub_ID: '', \r\n          Show_Price_To_Driver: true,\r\n          Cost_Driver_Total: job?.Cost_Driver_Total ? Number(job.Cost_Driver_Total) : 0,\r\n          Price_Cust_Total: job?.Price_Cust_Total ? Number(job.Price_Cust_Total) : 0\r\n        }]\r\n  )\r\n\r\n  // Helper to safely parse JSON or return existing array\r\n  const parseJson = (val: any, defaultVal: any) => {\r\n    if (!val) return defaultVal\r\n    if (Array.isArray(val)) return val\r\n    if (typeof val === 'string') {\r\n      try {\r\n        return JSON.parse(val)\r\n      } catch {\r\n        return defaultVal\r\n      }\r\n    }\r\n    return defaultVal\r\n  }\r\n\r\n  // Multi-point origins\r\n  const [origins, setOrigins] = useState<LocationPoint[]>(\r\n    parseJson(job?.origins || job?.original_origins_json, [{ name: '', lat: '', lng: '' }])\r\n  )\r\n\r\n  // Multi-point destinations\r\n  const [destinations, setDestinations] = useState<LocationPoint[]>(\r\n    parseJson(job?.destinations || job?.original_destinations_json, [{ name: '', lat: '', lng: '' }])\r\n  )\r\n\r\n  // Extra costs\r\n  const [extraCosts, setExtraCosts] = useState<ExtraCost[]>(\r\n    parseJson(job?.extra_costs || job?.extra_costs_json, [])\r\n  )\r\n\r\n  // Generate new ID on dialog open (create mode)\r\n  useEffect(() => {\r\n    if (show && mode === 'create') {\r\n      setFormData(prev => ({ ...prev, Job_ID: generateJobId() }))\r\n    }\r\n  }, [show, mode])\r\n\r\n  // Sync initial assignment state from job prop if editing\r\n  useEffect(() => {\r\n    if (show && mode === 'edit' && job) {\r\n        setAssignments([{\r\n            Vehicle_Type: job.Vehicle_Type || '4-Wheel',\r\n            Vehicle_Plate: job.Vehicle_Plate || '',\r\n            Driver_ID: job.Driver_ID || '',\r\n            Sub_ID: job.Sub_ID || '',\r\n            Show_Price_To_Driver: job.Show_Price_To_Driver !== false,\r\n            Cost_Driver_Total: job.Cost_Driver_Total ? Number(job.Cost_Driver_Total) : 0,\r\n            Price_Cust_Total: job.Price_Cust_Total ? Number(job.Price_Cust_Total) : 0\r\n        }])\r\n    } else if (show && mode === 'create') {\r\n        // Reset to one empty assignment\r\n        setAssignments([{ \r\n            Vehicle_Type: '4-Wheel', \r\n            Vehicle_Plate: '', \r\n            Driver_ID: '', \r\n            Sub_ID: '', \r\n            Show_Price_To_Driver: true,\r\n            Cost_Driver_Total: formData.Cost_Driver_Total ? Number(formData.Cost_Driver_Total) : 0,\r\n            Price_Cust_Total: formData.Price_Cust_Total ? Number(formData.Price_Cust_Total) : 0\r\n        }])\r\n    }\r\n  }, [show, mode, job, formData.Cost_Driver_Total, formData.Price_Cust_Total])\r\n\r\n  const handleCopyTrackingLink = () => {\r\n    const origin = window.location.origin\r\n    const url = `${origin}/track/${formData.Job_ID}`\r\n    navigator.clipboard.writeText(url)\r\n    setCopied(true)\r\n    setTimeout(() => setCopied(false), 2000)\r\n  }\r\n\r\n  \r\n\r\n\r\n  const addOrigin = () => setOrigins([...origins, { name: '', lat: '', lng: '' }])\r\n  const removeOrigin = (index: number) => {\r\n    if (origins.length > 1) setOrigins(origins.filter((_, i) => i !== index))\r\n  }\r\n  const updateOrigin = (index: number, field: keyof LocationPoint, value: string) => {\r\n    const updated = [...origins]\r\n    updated[index][field] = value\r\n    setOrigins(updated)\r\n  }\r\n\r\n  const addDestination = () => setDestinations([...destinations, { name: '', lat: '', lng: '' }])\r\n  const removeDestination = (index: number) => {\r\n    if (destinations.length > 1) setDestinations(destinations.filter((_, i) => i !== index))\r\n  }\r\n  const updateDestination = (index: number, field: keyof LocationPoint, value: string) => {\r\n    const updated = [...destinations]\r\n    updated[index][field] = value\r\n    setDestinations(updated)\r\n  }\r\n\r\n  const addAssignment = () => {\r\n    setAssignments([...assignments, { \r\n        Vehicle_Type: '4-Wheel', \r\n        Vehicle_Plate: '', \r\n        Driver_ID: '', \r\n        Sub_ID: '', \r\n        Show_Price_To_Driver: true,\r\n        Cost_Driver_Total: formData.Cost_Driver_Total ? Number(formData.Cost_Driver_Total) : 0,\r\n        Price_Cust_Total: formData.Price_Cust_Total ? Number(formData.Price_Cust_Total) : 0\r\n    }])\r\n  }\r\n\r\n  const removeAssignment = (index: number) => {\r\n    if (assignments.length > 1) {\r\n        setAssignments(assignments.filter((_, i) => i !== index))\r\n    }\r\n  }\r\n\r\n  const updateAssignment = (index: number, field: keyof JobAssignment, value: string | boolean | number) => {\r\n    const newAssignments = [...assignments]\r\n    newAssignments[index] = { ...newAssignments[index], [field]: value } as JobAssignment\r\n    setAssignments(newAssignments)\r\n    \r\n    // Sync first assignment to main form data for backward compatibility / validation\r\n    if (index === 0 && (typeof value === 'string' || typeof value === 'number')) {\r\n        setFormData(prev => ({ ...prev, [field]: value }))\r\n    }\r\n  }\r\n\r\n  const addExtraCost = () => setExtraCosts([...extraCosts, { type: EXPENSE_TYPES[0], cost_driver: 0, charge_cust: 0 }])\r\n  const removeExtraCost = (index: number) => setExtraCosts(extraCosts.filter((_, i) => i !== index))\r\n  const updateExtraCost = (index: number, field: keyof ExtraCost, value: string | number) => {\r\n    const updated = [...extraCosts]\r\n    if (field === 'cost_driver' || field === 'charge_cust') {\r\n      updated[index][field] = Number(value)\r\n    } else {\r\n      updated[index][field] = value as string\r\n    }\r\n    setExtraCosts(updated)\r\n  }\r\n\r\n\r\n  const validateForm = () => {\r\n    const errors: string[] = []\r\n\r\n    if (!formData.Customer_Name) errors.push(\"กรุณาระบุชื่อลูกค้า\")\r\n    if (!origins[0].name) errors.push(\"กรุณาระบุต้นทางอย่างน้อย 1 แห่ง\")\r\n    if (!destinations[0].name) errors.push(\"กรุณาระบุปลายทางอย่างน้อย 1 แห่ง\")\r\n    \r\n    // Check assignments\r\n    if (mode === 'create') {\r\n        assignments.forEach((a, i) => {\r\n            if (!a.Vehicle_Plate && !a.Driver_ID) {\r\n                errors.push(`กรุณาระบุข้อมูลรถหรือคนขับ สำหรับรถคันที่ ${i + 1}`)\r\n            }\r\n        })\r\n    }\r\n    \r\n    return errors\r\n  }\r\n\r\n  const handleDelete = async () => {\r\n    if (!job?.Job_ID) return\r\n    if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?')) return\r\n    \r\n    setLoading(true)\r\n    try {\r\n        const result = await deleteJob(job.Job_ID)\r\n        if (!result.success) throw new Error(result.message)\r\n        setShow(false)\r\n        router.refresh()\r\n    } catch (e) {\r\n        const error = e as Error\r\n        console.error(error)\r\n        alert(error.message || 'ลบงานไม่สำเร็จ')\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleCustomerSelect = (customer: Customer) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      Customer_Name: customer.Customer_Name\r\n    }))\r\n\r\n    // Autofill Origin if empty\r\n    if (customer.Origin_Location && origins.length === 1 && !origins[0].name) {\r\n       setOrigins([{ name: customer.Origin_Location, lat: '', lng: '' }])\r\n    }\r\n    \r\n    // Autofill Destination if empty\r\n    if (customer.Dest_Location && destinations.length === 1 && !destinations[0].name) {\r\n       setDestinations([{ name: customer.Dest_Location, lat: '', lng: '' }])\r\n    }\r\n  }\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    \r\n    // Validation\r\n    const errors = validateForm()\r\n    if (errors.length > 0) {\r\n        alert(errors.join('\\n'))\r\n        return\r\n    }\r\n\r\n    setLoading(true)\r\n\r\n    try {\r\n      // Base data common to all jobs\r\n      const baseData = {\r\n        ...formData,\r\n        Plan_Date: formData.Plan_Date, // Ensure Plan_Date is used\r\n        Origin_Location: origins.map(o => o.name).join(' → '),\r\n        Dest_Location: destinations.map(d => d.name).join(' → '),\r\n        Route_Name: `${origins[0]?.name || ''} → ${destinations[destinations.length-1]?.name || ''}`,\r\n        // Serialize complex fields\r\n        original_origins_json: JSON.stringify(origins),\r\n        original_destinations_json: JSON.stringify(destinations),\r\n        extra_costs_json: JSON.stringify(extraCosts),\r\n      }\r\n\r\n      if (mode === 'create') {\r\n        // Prepare array for bulk creation\r\n        const jobsToCreate = assignments.map((assignment, index: number) => ({\r\n            ...baseData,\r\n            // If multiple assignments, append suffix to ensure unique Job_ID (e.g. JOB-001-1, JOB-001-2)\r\n            Job_ID: assignments.length > 1 ? `${baseData.Job_ID}-${index + 1}` : baseData.Job_ID,\r\n            // Per-job assignment details\r\n            Vehicle_Type: assignment.Vehicle_Type,\r\n            Vehicle_Plate: assignment.Vehicle_Plate,\r\n            Driver_ID: assignment.Driver_ID,\r\n            Sub_ID: assignment.Sub_ID,\r\n            Show_Price_To_Driver: assignment.Show_Price_To_Driver,\r\n            // Use individual costs if they differ from shared baseData\r\n            Price_Cust_Total: assignment.Price_Cust_Total ?? baseData.Price_Cust_Total,\r\n            Cost_Driver_Total: assignment.Cost_Driver_Total ?? baseData.Cost_Driver_Total,\r\n            Driver_Name: drivers.find(d => d.Driver_ID === assignment.Driver_ID)?.Driver_Name || '',\r\n        }))\r\n\r\n        const result = await createBulkJobs(jobsToCreate)\r\n        if (!result.success) throw new Error(result.message)\r\n\r\n      } else {\r\n        // For update, we only support updating specific fields of the SINGLE job being edited.\r\n        // We take the FIRST assignment if user modified it in the list (though UI might show multiple, \r\n        // editing usually focuses on one ID).\r\n        // If we strictly want to support \"Split Job\" during edit, that's complex logic (Delete 1 -> Create N?).\r\n        // For now, we update the CURRENT Job_ID with the details from the first assignment (or formData which is synced).\r\n        \r\n        const assignment = assignments[0]\r\n        const updateData = {\r\n            ...baseData,\r\n            Vehicle_Type: assignment.Vehicle_Type,\r\n            Vehicle_Plate: assignment.Vehicle_Plate,\r\n            Driver_ID: assignment.Driver_ID,\r\n            Sub_ID: assignment.Sub_ID,\r\n            Show_Price_To_Driver: assignment.Show_Price_To_Driver,\r\n            Price_Cust_Total: assignment.Price_Cust_Total ?? baseData.Price_Cust_Total,\r\n            Cost_Driver_Total: assignment.Cost_Driver_Total ?? baseData.Cost_Driver_Total,\r\n            Driver_Name: drivers.find(d => d.Driver_ID === assignment.Driver_ID)?.Driver_Name || '',\r\n        }\r\n\r\n        if (!job?.Job_ID) throw new Error('ไม่พบรหัสงานสำหรับการแก้ไข')\r\n        const result = await updateJob(job.Job_ID, updateData)\r\n        if (!result.success) throw new Error(result.message)\r\n      }\r\n      \r\n      setShow(false)\r\n      router.refresh()\r\n    } catch (e) {\r\n      const error = e as Error\r\n      console.error(error)\r\n      alert(error.message || 'เกิดข้อผิดพลาด กรุณาลองใหม่')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n\r\n  const tabs = [\r\n    { id: 'info', label: 'ข้อมูลงาน', icon: <FileText className=\"w-4 h-4\" /> },\r\n    { id: 'location', label: 'สถานที่', icon: <MapPin className=\"w-4 h-4\" /> },\r\n    { id: 'assign', label: 'มอบหมาย', icon: <Truck className=\"w-4 h-4\" /> },\r\n    ...(canViewPrice ? [{ id: 'price', label: 'ราคา', icon: <Banknote className=\"w-4 h-4\" /> }] as const : []),\r\n  ] as const\r\n\r\n  return (\r\n    <Dialog open={show} onOpenChange={setShow}>\r\n      {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}\r\n      <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto bg-background border-border text-foreground\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"text-xl\">\r\n            {mode === 'create' ? 'สร้างงานใหม่' : 'แก้ไขงาน'}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        {/* Tabs */}\r\n        <div className=\"flex gap-1 p-1 bg-muted/50 rounded-lg mb-4\">\r\n          {tabs.map(tab => (\r\n            <button\r\n              key={tab.id}\r\n              type=\"button\"\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${\r\n                activeTab === tab.id \r\n                  ? 'bg-primary text-primary-foreground' \r\n                  : 'text-muted-foreground hover:text-foreground hover:bg-muted'\r\n              }`}\r\n            >\r\n              {tab.icon}\r\n              <span className=\"hidden sm:inline\">{tab.label}</span>\r\n            </button>\r\n          ))}\r\n        </div>\r\n        \r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          {/* Tab: ข้อมูลงาน */}\r\n          {activeTab === 'info' && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Job ID</Label>\r\n                  <Input\r\n                    value={formData.Job_ID}\r\n                    disabled\r\n                    className=\"bg-muted/50 border-input text-muted-foreground\"\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">สร้างอัตโนมัติ</p>\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={handleCopyTrackingLink}\r\n                    className=\"w-full mt-1 border-primary/30 text-primary hover:bg-primary/10\"\r\n                  >\r\n                    {copied ? <Check className=\"w-3 h-3 mr-2\" /> : <LinkIcon className=\"w-3 h-3 mr-2\" />}\r\n                    {copied ? 'คัดลอกแล้ว' : 'Copy Tracking Link'}\r\n                  </Button>\r\n                </div>\r\n                \r\n                <div className=\"space-y-2\">\r\n                   <Label>โซนพื้นที่ (Zone)</Label>\r\n                   <Select \r\n                      value={formData.Zone} \r\n                      onValueChange={(val) => setFormData({ ...formData, Zone: val })}\r\n                   >\r\n                    <SelectTrigger className=\"bg-background border-input\">\r\n                        <SelectValue placeholder=\"เลือกโซน (Optional)\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        {ZONES.map((z) => (\r\n                            <SelectItem key={z.id} value={z.id}>{z.name}</SelectItem>\r\n                        ))}\r\n                    </SelectContent>\r\n                   </Select>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                   <Label>สถานะงาน</Label>\r\n                   <Select \r\n                      value={formData.Job_Status} \r\n                      onValueChange={(val) => setFormData({ ...formData, Job_Status: val })}\r\n                   >\r\n                    <SelectTrigger className=\"bg-background border-input\">\r\n                        <SelectValue placeholder=\"เลือกสถานะ\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        <SelectItem value=\"New\">งานใหม่ (New)</SelectItem>\r\n                        <SelectItem value=\"Assigned\">มอบหมายแล้ว (Assigned)</SelectItem>\r\n                        <SelectItem value=\"In Transit\">กำลังขนส่ง (In Transit)</SelectItem>\r\n                        <SelectItem value=\"Delivered\">ส่งสินค้าแล้ว (Delivered)</SelectItem>\r\n                        <SelectItem value=\"Completed\">เสร็จสิ้น/ปิดงาน (Completed)</SelectItem>\r\n                        <SelectItem value=\"Cancelled\">ยกเลิก (Cancelled)</SelectItem>\r\n                    </SelectContent>\r\n                   </Select>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1\">\r\n                    <Calendar className=\"w-3 h-3\" /> วันที่รับ\r\n                  </Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={formData.Plan_Date}\r\n                    onChange={(e) => setFormData({ ...formData, Plan_Date: e.target.value })}\r\n                    required\r\n                    className=\"bg-background border-input\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1\">\r\n                    <Calendar className=\"w-3 h-3\" /> วันที่ส่ง\r\n                  </Label>\r\n                  <Input\r\n                    type=\"date\"\r\n                    value={formData.Delivery_Date}\r\n                    onChange={(e) => setFormData({ ...formData, Delivery_Date: e.target.value })}\r\n                    required\r\n                    className=\"bg-background border-input\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {isAdmin && branches.length > 0 && (\r\n                <div className=\"p-4 bg-yellow-500/5 border border-yellow-500/20 rounded-lg\">\r\n                    <Label className=\"text-yellow-500 font-bold mb-2 block font-medium\">สาขาสำหรับงานนี้ (Super Admin Only)</Label>\r\n                    <Select \r\n                      value={formData.Branch_ID || \"none\"} \r\n                      onValueChange={(val) => setFormData({ ...formData, Branch_ID: val === \"none\" ? \"\" : val })}\r\n                    >\r\n                      <SelectTrigger className=\"bg-background border-yellow-500/30\">\r\n                        <SelectValue placeholder=\"-- ใช้สาขาปัจจุบัน --\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"none\">-- ใช้สาขาปัจจุบัน --</SelectItem>\r\n                        {branches.map(b => (\r\n                          <SelectItem key={b.Branch_ID} value={b.Branch_ID}>\r\n                            {b.Branch_Name} ({b.Branch_ID})\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                    <p className=\"text-[10px] text-muted-foreground mt-1\">\r\n                      หากไม่เลือก จะใช้สาขาที่ท่านกำลังเลือกอยู่ที่แถบด้านบน (Header)\r\n                    </p>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1\">\r\n                    <Building2 className=\"w-3 h-3\" /> ลูกค้า\r\n                  </Label>\r\n                   <CustomerAutocomplete\r\n                    value={formData.Customer_Name}\r\n                    onChange={(val) => setFormData(prev => ({ ...prev, Customer_Name: val }))}\r\n                    customers={customers}\r\n                    onSelect={handleCustomerSelect}\r\n                    className=\"bg-slate-800 border-slate-700\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1\">\r\n                    <Package className=\"w-3 h-3\" /> สินค้า\r\n                  </Label>\r\n                  <Input\r\n                    value={formData.Cargo_Type}\r\n                    onChange={(e) => setFormData({ ...formData, Cargo_Type: e.target.value })}\r\n                    placeholder=\"ประเภทสินค้า\"\r\n                    className=\"bg-slate-800 border-slate-700\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                 <div className=\"space-y-2\">\r\n                    <Label className=\"text-emerald-600 dark:text-emerald-400\">น้ำหนัก (kg)</Label>\r\n                    <Input\r\n                        type=\"number\"\r\n                        value={formData.Weight_Kg}\r\n                        onChange={(e) => setFormData({ ...formData, Weight_Kg: Number(e.target.value) })}\r\n                        placeholder=\"0.0\"\r\n                        className=\"bg-background border-emerald-500/30 text-emerald-600 dark:text-emerald-400\"\r\n                    />\r\n                 </div>\r\n                 <div className=\"space-y-2\">\r\n                    <Label className=\"text-emerald-600 dark:text-emerald-400\">ปริมาตร (CBM)</Label>\r\n                    <Input\r\n                        type=\"number\"\r\n                        value={formData.Volume_Cbm}\r\n                        onChange={(e) => setFormData({ ...formData, Volume_Cbm: Number(e.target.value) })}\r\n                        placeholder=\"0.0\"\r\n                        step=\"0.01\"\r\n                        className=\"bg-background border-emerald-500/30 text-emerald-600 dark:text-emerald-400\"\r\n                    />\r\n                 </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Tab: สถานที่ */}\r\n          {/* Tab: สถานที่ */}\r\n          {activeTab === 'location' && (\r\n            <div className=\"space-y-6\">\r\n              \r\n              {/* Derive Unique Locations for Autocomplete */}\r\n              {(() => {\r\n                 // Separate lists for Origin and Destination as requested\r\n                 const originLocations = Array.from(new Set(\r\n                    routes.map((r) => r.Origin).filter(Boolean)\r\n                 )) as string[]\r\n\r\n                 const destinationLocations = Array.from(new Set(\r\n                    routes.map((r) => r.Destination).filter(Boolean)\r\n                 )) as string[]\r\n                 \r\n                 return (\r\n                   <>\r\n                    {/* Origins */}\r\n                    <div className=\"space-y-3\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                        <Label className=\"text-emerald-600 dark:text-emerald-400 flex items-center gap-2\">\r\n                            <MapPin className=\"w-4 h-4\" /> จุดต้นทาง <span className=\"text-muted-foreground text-xs\">({originLocations.length})</span>\r\n                        </Label>\r\n                        <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={addOrigin} className=\"border-emerald-500/50 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-500/10 hover:text-emerald-700 dark:hover:text-emerald-300\">\r\n                            <Plus className=\"w-4 h-4 mr-1\" /> เพิ่มจุด\r\n                        </Button>\r\n                        </div>\r\n                        {origins.map((origin, index) => (\r\n                        <div key={index} className=\"grid grid-cols-12 gap-2 p-3 bg-muted/30 rounded-lg\">\r\n                            <div className=\"col-span-1 flex items-center justify-center text-muted-foreground\">\r\n                                {index + 1}\r\n                            </div>\r\n                            <div className=\"col-span-11 grid grid-cols-1 gap-2\">\r\n                                <LocationAutocomplete\r\n                                    placeholder=\"ชื่อโรงงาน/สถานที่\"\r\n                                    value={origin.name}\r\n                                    onChange={(val) => updateOrigin(index, 'name', val)}\r\n                                    locations={originLocations}\r\n                                    className=\"bg-background border-input\"\r\n                                />\r\n                                <div className=\"grid grid-cols-2 gap-2\">\r\n                                    <Input\r\n                                        placeholder=\"Latitude\"\r\n                                        value={origin.lat}\r\n                                        onChange={(e) => updateOrigin(index, 'lat', e.target.value)}\r\n                                        className=\"bg-background border-input text-xs\"\r\n                                    />\r\n                                    <Input\r\n                                        placeholder=\"Longitude\"\r\n                                        value={origin.lng}\r\n                                        onChange={(e) => updateOrigin(index, 'lng', e.target.value)}\r\n                                        className=\"bg-background border-input text-xs\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"col-span-12 flex justify-end\">\r\n                                <Button \r\n                                    type=\"button\" \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\"\r\n                                    onClick={() => removeOrigin(index)}\r\n                                    disabled={origins.length === 1}\r\n                                    className=\"text-destructive hover:text-destructive hover:bg-destructive/10 h-6 text-xs\"\r\n                                >\r\n                                    ลบ\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {/* Destinations */}\r\n                    <div className=\"space-y-3\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                        <Label className=\"text-indigo-600 dark:text-indigo-400 flex items-center gap-2\">\r\n                            <MapPin className=\"w-4 h-4\" /> จุดปลายทาง <span className=\"text-muted-foreground text-xs\">({destinationLocations.length})</span>\r\n                        </Label>\r\n                        <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={addDestination} className=\"border-indigo-500/50 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-500/10 hover:text-indigo-700 dark:hover:text-indigo-300\">\r\n                            <Plus className=\"w-4 h-4 mr-1\" /> เพิ่มจุด\r\n                        </Button>\r\n                        </div>\r\n                        {destinations.map((dest, index) => (\r\n                        <div key={index} className=\"grid grid-cols-12 gap-2 p-3 bg-muted/30 rounded-lg\">\r\n                            <div className=\"col-span-1 flex items-center justify-center text-muted-foreground\">\r\n                                {index + 1}\r\n                            </div>\r\n                            <div className=\"col-span-11 grid grid-cols-1 gap-2\">\r\n                                <LocationAutocomplete\r\n                                    placeholder=\"ชื่อลูกค้า/สถานที่ส่ง\"\r\n                                    value={dest.name}\r\n                                    onChange={(val) => updateDestination(index, 'name', val)}\r\n                                    locations={destinationLocations}\r\n                                    className=\"bg-background border-input\"\r\n                                />\r\n                                <div className=\"grid grid-cols-2 gap-2\">\r\n                                    <Input\r\n                                        placeholder=\"Latitude\"\r\n                                        value={dest.lat}\r\n                                        onChange={(e) => updateDestination(index, 'lat', e.target.value)}\r\n                                        className=\"bg-background border-input text-xs\"\r\n                                    />\r\n                                    <Input\r\n                                        placeholder=\"Longitude\"\r\n                                        value={dest.lng}\r\n                                        onChange={(e) => updateDestination(index, 'lng', e.target.value)}\r\n                                        className=\"bg-background border-input text-xs\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n                            <div className=\"col-span-12 flex justify-end\">\r\n                                <Button \r\n                                    type=\"button\" \r\n                                    size=\"sm\" \r\n                                    variant=\"ghost\"\r\n                                    onClick={() => removeDestination(index)}\r\n                                    disabled={destinations.length === 1}\r\n                                    className=\"text-destructive hover:text-destructive hover:bg-destructive/10 h-6 text-xs\"\r\n                                >\r\n                                    ลบ\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                        ))}\r\n                    </div>\r\n                   </>\r\n                 )\r\n              })()}\r\n            </div>\r\n          )}\r\n\r\n          {/* Tab: มอบหมาย */}\r\n          {activeTab === 'assign' && (\r\n            <div className=\"space-y-4\">\r\n              {/* Assignment List */}\r\n              {assignments.map((assignment, index: number) => (\r\n                <div key={index} className=\"p-4 bg-slate-800/50 rounded-lg border border-slate-700 relative group\">\r\n                    {/* Header with Remove Button */}\r\n                    <div className=\"flex justify-between items-center mb-3\">\r\n                        <Label className=\"text-indigo-400 font-medium\">\r\n                            รถคันที่ {index + 1}\r\n                        </Label>\r\n                        {assignments.length > 1 && (\r\n                            <Button\r\n                                type=\"button\"\r\n                                size=\"sm\"\r\n                                variant=\"ghost\"\r\n                                onClick={() => removeAssignment(index)}\r\n                                className=\"text-red-400 hover:text-red-300 hover:bg-red-500/10 h-6 px-2 text-xs\"\r\n                            >\r\n                                <X className=\"w-3 h-3 mr-1\" /> ลบ\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4 mb-4\">\r\n                        <div className=\"space-y-2\">\r\n                        <Label className=\"flex items-center gap-1 text-xs text-muted-foreground\">\r\n                            <Truck className=\"w-3 h-3\" /> ประเภทรถ\r\n                        </Label>\r\n                        <select\r\n                            value={assignment.Vehicle_Type}\r\n                            onChange={(e) => updateAssignment(index, 'Vehicle_Type', e.target.value)}\r\n                            className=\"w-full h-10 px-3 rounded-md bg-background border border-input text-foreground text-sm\"\r\n                        >\r\n                            <option value=\"\">ทั้งหมด (ไม่ระบุ)</option>\r\n                            {/* Unique Vehicle Types from Data */}\r\n                            {Array.from(new Set(vehicles.map((v) => v.vehicle_type).filter((t): t is string => !!t))).map((type) => (\r\n                            <option key={type} value={type}>{type}</option>\r\n                            ))}\r\n                        </select>\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                        <Label className=\"flex items-center gap-1 text-xs text-muted-foreground\">\r\n                            <Truck className=\"w-3 h-3\" /> ทะเบียนรถ\r\n                        </Label>\r\n                        <VehicleAutocomplete\r\n                            value={assignment.Vehicle_Plate}\r\n                            onChange={(val) => updateAssignment(index, 'Vehicle_Plate', val)}\r\n                            vehicles={assignment.Vehicle_Type \r\n                                ? vehicles.filter((v) => v.vehicle_type === assignment.Vehicle_Type) \r\n                                : vehicles\r\n                            }\r\n                            onSelect={(v) => {\r\n                                // Auto-fill driver and other vehicle details\r\n                                const newAssignments = [...assignments]\r\n                                const current = newAssignments[index]\r\n                                \r\n                                // Find assigned driver if any\r\n                                const assignedDriver = v.driver_id ? drivers.find(d => d.Driver_ID === v.driver_id) : null\r\n                                \r\n                                newAssignments[index] = {\r\n                                    ...current,\r\n                                    Vehicle_Plate: v.vehicle_plate,\r\n                                    Vehicle_Type: v.vehicle_type || current.Vehicle_Type,\r\n                                    Sub_ID: v.sub_id || current.Sub_ID,\r\n                                    Driver_ID: assignedDriver ? assignedDriver.Driver_ID : current.Driver_ID\r\n                                }\r\n                                setAssignments(newAssignments)\r\n                            }}\r\n                            placeholder=\"พิมพ์ทะเบียนรถ...\"\r\n                            className=\"bg-background border-input text-sm\"\r\n                        />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                        <Label className=\"flex items-center gap-1 text-xs text-slate-400\">\r\n                           <User className=\"w-3 h-3\" /> คนขับ\r\n                        </Label>\r\n                        <DriverAutocomplete\r\n                            value={assignment.Driver_ID}\r\n                            onChange={(val) => updateAssignment(index, 'Driver_ID', val)}\r\n                            drivers={drivers}\r\n                            onSelect={(d) => {\r\n                                // Auto-fill vehicle and other driver details\r\n                                const newAssignments = [...assignments]\r\n                                const current = newAssignments[index]\r\n                                \r\n                                // Find assigned vehicle if any\r\n                                const assignedVehicle = d.Vehicle_Plate ? vehicles.find(v => v.vehicle_plate === d.Vehicle_Plate) : null\r\n                                \r\n                                newAssignments[index] = {\r\n                                    ...current,\r\n                                    Driver_ID: d.Driver_ID,\r\n                                    Sub_ID: d.Sub_ID || current.Sub_ID,\r\n                                    Vehicle_Plate: assignedVehicle ? assignedVehicle.vehicle_plate : (d.Vehicle_Plate || current.Vehicle_Plate),\r\n                                    Vehicle_Type: assignedVehicle ? assignedVehicle.vehicle_type : (d.Vehicle_Type || current.Vehicle_Type),\r\n                                    // Use driver default if explicitly set, otherwise keep current\r\n                                    Show_Price_To_Driver: d.Show_Price_Default ?? current.Show_Price_To_Driver\r\n                                }\r\n                                setAssignments(newAssignments)\r\n                            }}\r\n                            className=\"bg-slate-800 border-slate-700 text-sm\"\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                        <div className=\"space-y-1\">\r\n                            <Label className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\r\n                                <Banknote className=\"w-3 h-3\" /> ค่าจ้างรถ (บาท)\r\n                            </Label>\r\n                            <Input\r\n                                type=\"number\"\r\n                                value={assignment.Cost_Driver_Total}\r\n                                onChange={(e) => updateAssignment(index, 'Cost_Driver_Total', Number(e.target.value))}\r\n                                className=\"h-8 text-xs bg-slate-900 border-slate-700\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"space-y-1\">\r\n                            <Label className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\r\n                                <Banknote className=\"w-3 h-3\" /> ราคาลูกค้า (บาท)\r\n                            </Label>\r\n                            <Input\r\n                                type=\"number\"\r\n                                value={assignment.Price_Cust_Total}\r\n                                onChange={(e) => updateAssignment(index, 'Price_Cust_Total', Number(e.target.value))}\r\n                                className=\"h-8 text-xs bg-slate-900 border-slate-700\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {canViewPrice && (\r\n                    <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg border border-border\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            {assignment.Show_Price_To_Driver ? (\r\n                                <Eye className=\"w-4 h-4 text-emerald-600 dark:text-emerald-400\" />\r\n                            ) : (\r\n                                <EyeOff className=\"w-4 h-4 text-muted-foreground\" />\r\n                            )}\r\n                            <span className=\"text-sm font-medium\">โชว์ค่าเที่ยวให้คนขับเห็น</span>\r\n                        </div>\r\n                        <label className=\"relative inline-flex items-center cursor-pointer\">\r\n                            <input \r\n                                type=\"checkbox\" \r\n                                checked={assignment.Show_Price_To_Driver} \r\n                                onChange={(e) => updateAssignment(index, 'Show_Price_To_Driver', e.target.checked)}\r\n                                className=\"sr-only peer\" \r\n                            />\r\n                            <div className=\"w-11 h-6 bg-slate-200 dark:bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600\"></div>\r\n                        </label>\r\n                    </div>\r\n                    )}\r\n\r\n                    {/* Capacity & Zone Check UI */}\r\n                    {(() => {\r\n                        const selectedVehicle = vehicles.find((v) => v.vehicle_plate === assignment.Vehicle_Plate)\r\n                        if (!selectedVehicle) return null\r\n\r\n                        const maxWeight = selectedVehicle.max_weight_kg || 0\r\n                        const maxVolume = selectedVehicle.max_volume_cbm || 0\r\n                        \r\n                        const jobWeight = formData.Weight_Kg || 0\r\n                        const jobVolume = formData.Volume_Cbm || 0\r\n                        \r\n                        const jobZone = formData.Zone\r\n                        const vehicleZone = selectedVehicle.preferred_zone\r\n\r\n                        const weightPercent = maxWeight > 0 ? (jobWeight / maxWeight) * 100 : 0\r\n                        const volumePercent = maxVolume > 0 ? (jobVolume / maxVolume) * 100 : 0\r\n                        \r\n                        const isOverweight = weightPercent > 100\r\n                        const isOverVolume = volumePercent > 100\r\n                        \r\n                        // Zone Mismatch Logic\r\n                        const isZoneMismatch = jobZone && vehicleZone && jobZone !== vehicleZone\r\n\r\n                        if (!maxWeight && !maxVolume && !isZoneMismatch) return null\r\n\r\n                        return (\r\n                            <div className=\"mt-3 p-3 bg-card rounded-lg border border-border space-y-3\">\r\n                                {/* Zone Warning */}\r\n                                {isZoneMismatch && (\r\n                                    <div className=\"flex items-start gap-2 p-2 rounded bg-amber-500/10 border border-amber-500/20 mb-2\">\r\n                                        <div className=\"min-w-[4px] h-full bg-amber-500 rounded-full\" />\r\n                                        <div>\r\n                                            <p className=\"text-xs font-bold text-amber-600 dark:text-amber-400\">Zone Mismatch</p>\r\n                                            <p className=\"text-[10px] text-muted-foreground\">\r\n                                                งานโซน: <span className=\"text-foreground\">{ZONES.find(z => z.id === jobZone)?.name || jobZone}</span> <br/>\r\n                                                รถประจำโซน: <span className=\"text-foreground\">{ZONES.find(z => z.id === vehicleZone)?.name || vehicleZone}</span>\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {(maxWeight > 0 || maxVolume > 0) && (\r\n                                    <div className=\"flex items-center gap-2 mb-1\">\r\n                                        <span className=\"text-xs font-semibold text-muted-foreground\">ตรวจสอบการบรรทุก (Capacity)</span>\r\n                                        {(isOverweight || isOverVolume) && (\r\n                                            <span className=\"text-[10px] bg-red-500/20 text-red-600 dark:text-red-400 px-1.5 py-0.5 rounded-full font-bold animate-pulse\">\r\n                                                OVERLOAD\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                )}\r\n                                \r\n                                {maxWeight > 0 && (\r\n                                    <div className=\"space-y-1\">\r\n                                        <div className=\"flex justify-between text-[10px]\">\r\n                                            <span className={isOverweight ? \"text-red-600 dark:text-red-400\" : \"text-muted-foreground\"}>\r\n                                                น้ำหนัก: {jobWeight.toLocaleString()} / {maxWeight.toLocaleString()} kg\r\n                                            </span>\r\n                                            <span className={isOverweight ? \"text-red-600 dark:text-red-400 font-bold\" : \"text-muted-foreground\"}>\r\n                                                {weightPercent.toFixed(1)}%\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"h-1.5 w-full bg-muted rounded-full overflow-hidden\">\r\n                                            <div \r\n                                                className={`h-full rounded-full transition-all ${isOverweight ? 'bg-red-500' : 'bg-emerald-500'}`} \r\n                                                style={{ width: `${Math.min(weightPercent, 100)}%` }}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {maxVolume > 0 && (\r\n                                    <div className=\"space-y-1\">\r\n                                        <div className=\"flex justify-between text-[10px]\">\r\n                                            <span className={isOverVolume ? \"text-red-600 dark:text-red-400\" : \"text-muted-foreground\"}>\r\n                                                ปริมาตร: {jobVolume.toLocaleString()} / {maxVolume.toLocaleString()} m³\r\n                                            </span>\r\n                                            <span className={isOverVolume ? \"text-red-600 dark:text-red-400 font-bold\" : \"text-muted-foreground\"}>\r\n                                                {volumePercent.toFixed(1)}%\r\n                                            </span>\r\n                                        </div>\r\n                                        <div className=\"h-1.5 w-full bg-muted rounded-full overflow-hidden\">\r\n                                            <div \r\n                                                className={`h-full rounded-full transition-all ${isOverVolume ? 'bg-red-500' : 'bg-blue-500'}`} \r\n                                                style={{ width: `${Math.min(volumePercent, 100)}%` }}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )\r\n                    })()}\r\n                </div>\r\n              ))}\r\n\r\n              {/* Add Vehicle Button */}\r\n              <Button \r\n                type=\"button\" \r\n                variant=\"outline\" \r\n                onClick={addAssignment}\r\n                className=\"w-full border-dashed border-slate-600 hover:bg-slate-800 text-slate-400 hover:text-white\"\r\n              >\r\n                <Plus className=\"w-4 h-4 mr-2\" /> เพิ่มรถอีกคัน\r\n              </Button>\r\n\r\n               <div className=\"space-y-2 pt-2\">\r\n                <Label className=\"flex items-center gap-1\">\r\n                   หมายเหตุ (ทุกคัน)\r\n                </Label>\r\n                <Textarea\r\n                  value={formData.Notes}\r\n                  onChange={(e) => setFormData({ ...formData, Notes: e.target.value })}\r\n                  placeholder=\"รายละเอียดเพิ่มเติม\"\r\n                  className=\"bg-slate-800 border-slate-700\"\r\n                  rows={3}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Tab: ราคา */}\r\n          {activeTab === 'price' && (\r\n            <div className=\"space-y-6\">\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>ราคาลูกค้า (บาท)</Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={formData.Price_Cust_Total}\r\n                    onChange={(e) => setFormData({ ...formData, Price_Cust_Total: Number(e.target.value) })}\r\n                    className=\"bg-background border-input\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                   <Label>ค่าจ้างรถ (บาท)</Label>\r\n                   <Input\r\n                    type=\"number\"\r\n                    value={formData.Cost_Driver_Total}\r\n                    onChange={(e) => setFormData({ ...formData, Cost_Driver_Total: Number(e.target.value) })}\r\n                    className=\"bg-background border-input\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"space-y-3\">\r\n                 <div className=\"flex items-center justify-between\">\r\n                  <Label className=\"flex items-center gap-2\">\r\n                    <Banknote className=\"w-4 h-4\" /> ค่าใช้จ่ายเพิ่มเติม\r\n                  </Label>\r\n                  <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={addExtraCost} className=\"border-border hover:bg-muted\">\r\n                    <Plus className=\"w-4 h-4 mr-1\" /> เพิ่มรายการ\r\n                  </Button>\r\n                </div>\r\n                {extraCosts.map((cost, index) => (\r\n                  <div key={index} className=\"grid grid-cols-12 gap-2 p-3 bg-muted/30 rounded-lg items-end\">\r\n                    <div className=\"col-span-4 space-y-1\">\r\n                        <Label className=\"text-xs text-muted-foreground\">รายการ</Label>\r\n                        <select\r\n                            value={cost.type}\r\n                            onChange={(e) => updateExtraCost(index, 'type', e.target.value)}\r\n                            className=\"w-full h-9 px-2 rounded-md bg-background border border-input text-foreground text-sm\"\r\n                        >\r\n                            {EXPENSE_TYPES.map(t => <option key={t} value={t}>{t}</option>)}\r\n                        </select>\r\n                    </div>\r\n                    <div className=\"col-span-3 space-y-1\">\r\n                        <Label className=\"text-xs text-muted-foreground\">จ่ายรถ</Label>\r\n                        <Input\r\n                            type=\"number\"\r\n                            value={cost.cost_driver}\r\n                            onChange={(e) => updateExtraCost(index, 'cost_driver', e.target.value)}\r\n                            className=\"bg-background border-input h-9\"\r\n                        />\r\n                    </div>\r\n                     <div className=\"col-span-3 space-y-1\">\r\n                        <Label className=\"text-xs text-muted-foreground\">เก็บลูกค้า</Label>\r\n                        <Input\r\n                            type=\"number\"\r\n                            value={cost.charge_cust}\r\n                            onChange={(e) => updateExtraCost(index, 'charge_cust', e.target.value)}\r\n                            className=\"bg-background border-input h-9\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"col-span-2 flex justify-end\">\r\n                         <Button \r\n                            type=\"button\" \r\n                            size=\"icon\" \r\n                            variant=\"ghost\"\r\n                            onClick={() => removeExtraCost(index)}\r\n                            className=\"text-destructive hover:text-destructive hover:bg-destructive/10 h-9 w-9\"\r\n                        >\r\n                            <X size={16} />\r\n                        </Button>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n\r\n                <div className=\"p-3 bg-muted rounded-lg flex justify-between items-center text-sm\">\r\n                    <span className=\"text-muted-foreground\">รวมกำไรเบื้องต้น</span>\r\n                    <span className=\"font-bold text-emerald-600 dark:text-emerald-400\">\r\n                        {(\r\n                            (Number(formData.Price_Cust_Total || 0) + extraCosts.reduce((sum, c) => sum + Number(c.charge_cust || 0), 0)) - \r\n                            (Number(formData.Cost_Driver_Total || 0) + extraCosts.reduce((sum, c) => sum + Number(c.cost_driver || 0), 0))\r\n                        ).toLocaleString()} บาท\r\n                    </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex justify-between pt-4 border-t border-border\">\r\n            {mode === 'edit' && canDelete && (\r\n                <Button \r\n                    type=\"button\" \r\n                    variant=\"ghost\" \r\n                    onClick={handleDelete}\r\n                    className=\"text-destructive hover:text-destructive hover:bg-destructive/10\"\r\n                >\r\n                    <Trash2 className=\"w-4 h-4 mr-2\" /> ลบงาน\r\n                </Button>\r\n            )}\r\n            <div className={`flex gap-3 ${mode === 'create' ? 'w-full justify-end' : ''}`}>\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => setShow(false)} className=\"border-border hover:bg-muted text-muted-foreground hover:text-foreground\">\r\n                ยกเลิก\r\n                </Button>\r\n                <Button type=\"submit\" disabled={loading} className=\"bg-primary hover:bg-primary/90 text-primary-foreground\">\r\n                    {loading && <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />}\r\n                    {mode === 'create' ? 'สร้างงาน' : 'บันทึกการแก้ไข'}\r\n                </Button>\r\n            </div>\r\n          </div>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\planning\\recent-job-item.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[157,160],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[157,160],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[173,176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[173,176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[192,195],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[192,195],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[212,215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[212,215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[229,232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[229,232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Package } from \"lucide-react\"\r\nimport { JobDialog } from \"./job-dialog\"\r\n\r\ntype Props = {\r\n  job: any\r\n  drivers: any[]\r\n  vehicles: any[]\r\n  customers: any[]\r\n  routes: any[]\r\n  canViewPrice?: boolean\r\n  canDelete?: boolean\r\n}\r\n\r\nexport function RecentJobItem({ job, drivers, vehicles, customers, routes, canViewPrice = true, canDelete = true }: Props) {\r\n  const [open, setOpen] = useState(false)\r\n\r\n  return (\r\n    <>\r\n      <div \r\n        onClick={() => setOpen(true)}\r\n        className=\"p-4 hover:bg-muted/50 transition-colors cursor-pointer group\"\r\n      >\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center group-hover:bg-indigo-500/30 transition-colors\">\r\n              <Package className=\"w-5 h-5 text-indigo-600 dark:text-indigo-400\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-foreground font-medium group-hover:text-primary transition-colors\">{job.Job_ID}</p>\r\n              <p className=\"text-sm text-muted-foreground\">{job.Customer_Name || \"-\"}</p>\r\n            </div>\r\n          </div>\r\n          <div className=\"text-right\">\r\n            <span className={`px-2 py-1 rounded-full text-xs font-medium ${\r\n              job.Job_Status === 'Complete' || job.Job_Status === 'Delivered' \r\n                ? 'bg-emerald-500/20 text-emerald-600 dark:text-emerald-400'\r\n                : job.Job_Status === 'In Transit' || job.Job_Status === 'Picked Up'\r\n                ? 'bg-blue-500/20 text-blue-600 dark:text-blue-400'\r\n                : 'bg-amber-500/20 text-amber-600 dark:text-amber-400'\r\n            }`}>\r\n              {job.Job_Status}\r\n            </span>\r\n            <p className=\"text-xs text-muted-foreground mt-1\">{new Date(job.Plan_Date).toLocaleDateString('th-TH')}</p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <JobDialog\r\n        mode=\"edit\"\r\n        open={open}\r\n        onOpenChange={setOpen}\r\n        job={job}\r\n        drivers={drivers}\r\n        vehicles={vehicles}\r\n        customers={customers}\r\n        routes={routes}\r\n        canViewPrice={canViewPrice}\r\n        canDelete={canDelete}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\providers\\branch-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\providers\\theme-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\providers\\theme-watcher.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'appleMeta' is never reassigned. Use 'const' instead.","line":22,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":22,"endColumn":18,"fix":{"range":[662,754],"text":"const appleMeta = document.querySelector('meta[name=\"apple-mobile-web-app-status-bar-style\"]')"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useTheme } from \"next-themes\"\r\nimport { useEffect } from \"react\"\r\n\r\nexport function ThemeWatcher() {\r\n  const { resolvedTheme } = useTheme()\r\n\r\n  useEffect(() => {\r\n    const themeColor = resolvedTheme === \"dark\" ? \"#0f172a\" : \"#ffffff\"\r\n    \r\n    // Update theme-color meta tag\r\n    let metaTag = document.querySelector('meta[name=\"theme-color\"]')\r\n    if (!metaTag) {\r\n      metaTag = document.createElement('meta')\r\n      metaTag.setAttribute('name', 'theme-color')\r\n      document.head.appendChild(metaTag)\r\n    }\r\n    metaTag.setAttribute('content', themeColor)\r\n\r\n    // Update apple-mobile-web-app-status-bar-style if needed\r\n    let appleMeta = document.querySelector('meta[name=\"apple-mobile-web-app-status-bar-style\"]')\r\n    if (appleMeta) {\r\n      appleMeta.setAttribute('content', resolvedTheme === \"dark\" ? \"black-translucent\" : \"default\")\r\n    }\r\n    \r\n    // Update body background for PWA aesthetic\r\n    document.body.style.backgroundColor = resolvedTheme === \"dark\" ? \"#0f172a\" : \"#ffffff\"\r\n  }, [resolvedTheme])\r\n\r\n  return null\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\reports\\report-builder.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3349,3352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3349,3352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5675,5678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5675,5678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\route-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Check"},"fix":{"range":[78,84],"text":""},"desc":"Remove unused variable \"Check\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronsUpDown' is defined but never used.","line":4,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronsUpDown"},"fix":{"range":[83,99],"text":""},"desc":"Remove unused variable \"ChevronsUpDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[139,186],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[370,373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[370,373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { Check, ChevronsUpDown, Search, MapPin } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface Route {\r\n  Route_Name: string\r\n  Origin: string\r\n  Destination: string\r\n  [key: string]: any\r\n}\r\n\r\ninterface RouteAutocompleteProps {\r\n  value?: string\r\n  onChange?: (value: string) => void\r\n  routes: Route[]\r\n  onSelect: (route: Route) => void\r\n  className?: string\r\n  placeholder?: string\r\n}\r\n\r\nexport function RouteAutocomplete({\r\n  value,\r\n  onChange,\r\n  routes = [],\r\n  onSelect,\r\n  className,\r\n  placeholder = \"ค้นหาเส้นทาง...\"\r\n}: RouteAutocompleteProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [query, setQuery] = useState(\"\")\r\n  const wrapperRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Filter routes based on query\r\n  const filteredRoutes =\r\n    query === \"\"\r\n      ? routes\r\n      : routes.filter((route) => {\r\n          const searchLower = query.toLowerCase()\r\n          return (\r\n            route.Route_Name.toLowerCase().includes(searchLower) ||\r\n            (route.Origin && route.Origin.toLowerCase().includes(searchLower)) ||\r\n            (route.Destination && route.Destination.toLowerCase().includes(searchLower))\r\n          )\r\n        })\r\n\r\n  // Close when clicking outside\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n        setOpen(false)\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleClickOutside)\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside)\r\n  }, [])\r\n\r\n  const handleSelect = (route: Route) => {\r\n    if (onChange) onChange(route.Route_Name)\r\n    onSelect(route)\r\n    setQuery(\"\")\r\n    setOpen(false)\r\n  }\r\n\r\n  return (\r\n    <div ref={wrapperRef} className={cn(\"relative\", className)}>\r\n      <div className=\"relative\">\r\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400\" />\r\n        <Input\r\n          ref={inputRef}\r\n          value={open ? query : (value || \"\")}\r\n          onChange={(e) => {\r\n            setQuery(e.target.value)\r\n            if (!open) setOpen(true)\r\n            if (onChange && !open) onChange(e.target.value) // Allow free typing if needed, mostly for search\r\n          }}\r\n          onFocus={() => {\r\n            setOpen(true)\r\n            // When focusing, if there's a value, keep it as query or clear it? \r\n            // Usually for autocomplete, users might want to search new things.\r\n            // Let's keep it empty or pre-fill? \r\n            // Strategy: If value exists, maybe don't clear, but here we want search behavior.\r\n            // Let's start with empty query on focus to show all options, \r\n            // UNLESS user generates input.\r\n          }}\r\n          onClick={() => setOpen(true)}\r\n          placeholder={placeholder}\r\n          className=\"pl-9 bg-slate-800 border-slate-700 text-white w-full\"\r\n        />\r\n      </div>\r\n\r\n      {open && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-auto\">\r\n          {filteredRoutes.length === 0 ? (\r\n            <div className=\"p-2 text-sm text-slate-400 text-center\">\r\n              ไม่พบข้อมูลเส้นทาง\r\n            </div>\r\n          ) : (\r\n            <div className=\"py-1\">\r\n              {filteredRoutes.map((route, index) => (\r\n                <button\r\n                  key={index}\r\n                  onClick={() => handleSelect(route)}\r\n                  className=\"w-full text-left px-3 py-2 text-sm hover:bg-slate-700 flex flex-col gap-1 transition-colors\"\r\n                >\r\n                  <span className=\"font-medium text-white\">{route.Route_Name}</span>\r\n                  <div className=\"flex items-center gap-1 text-xs text-slate-400\">\r\n                    <MapPin size={10} />\r\n                    <span>{route.Origin || \"?\"}</span>\r\n                    <span>→</span>\r\n                    <MapPin size={10} />\r\n                    <span>{route.Destination || \"?\"}</span>\r\n                  </div>\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\tracking\\share-tracking-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\tracking\\tracking-map.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MapPin' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"MapPin"},"fix":{"range":[58,95],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport dynamicImport from 'next/dynamic'\r\nimport { MapPin } from \"lucide-react\"\r\n\r\n// Dynamically import LeafletMap to avoid SSR issues with 'window'\r\nconst LeafletMap = dynamicImport(() => import('@/components/maps/leaflet-map'), { \r\n  ssr: false,\r\n  loading: () => <div className=\"h-[300px] w-full bg-slate-800 animate-pulse rounded-xl flex items-center justify-center text-slate-500\">กำลังโหลดแผนที่...</div>\r\n})\r\n\r\ninterface TrackingMapProps {\r\n  lastLocation: {\r\n    lat: number\r\n    lng: number\r\n    timestamp: string\r\n  }\r\n  driverName: string\r\n  status: string\r\n}\r\n\r\nexport function TrackingMap({ lastLocation, driverName, status }: TrackingMapProps) {\r\n  return (\r\n    <LeafletMap \r\n        center={[lastLocation.lat, lastLocation.lng]}\r\n        zoom={15}\r\n        focusPosition={[lastLocation.lat, lastLocation.lng]}\r\n        drivers={[{\r\n            id: driverName,\r\n            name: driverName,\r\n            lat: lastLocation.lat,\r\n            lng: lastLocation.lng,\r\n            status: status,\r\n            lastUpdate: new Date(lastLocation.timestamp).toLocaleTimeString('th-TH')\r\n        }]}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\excel-export.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[135,138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[135,138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport * as XLSX from \"xlsx\"\r\n\r\ninterface ExcelExportProps {\r\n  data: any[]\r\n  filename?: string\r\n  title?: string\r\n  trigger?: React.ReactNode\r\n}\r\n\r\nexport function ExcelExport({ \r\n  data, \r\n  filename = \"export\", \r\n  trigger \r\n}: ExcelExportProps) {\r\n\r\n  const handleExport = () => {\r\n    if (!data || data.length === 0) return\r\n\r\n    const wb = XLSX.utils.book_new()\r\n    const ws = XLSX.utils.json_to_sheet(data)\r\n\r\n    XLSX.utils.book_append_sheet(wb, ws, \"Sheet1\")\r\n    XLSX.writeFile(wb, `${filename}.xlsx`)\r\n  }\r\n\r\n  return (\r\n    <div onClick={handleExport}>\r\n      {trigger || <Button variant=\"outline\">Export to Excel</Button>}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\excel-import.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[509,512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[509,512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[584,587],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[584,587],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1037,1040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1037,1040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1583,1586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1583,1586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1772,1775],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1772,1775],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3034,3037],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3034,3037],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":197,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7009,7012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7009,7012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\n\r\nimport { Upload, FileSpreadsheet, Loader2, Download, AlertCircle } from \"lucide-react\"\r\nimport * as XLSX from \"xlsx\"\r\n\r\ninterface ExcelImportProps {\r\n  trigger: React.ReactNode\r\n  title: string\r\n  description?: string\r\n  onImport: (data: any[]) => Promise<{ success: boolean; message: string }>\r\n  templateData?: any[]\r\n  templateFilename?: string\r\n}\r\n\r\nexport function ExcelImport({\r\n  trigger,\r\n  title,\r\n  description = \"อัปโหลดไฟล์ Excel (.xlsx, .xls) เพื่อนำเข้าข้อมูล\",\r\n  onImport,\r\n  templateData,\r\n  templateFilename = \"template.xlsx\",\r\n}: ExcelImportProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [loading, setLoading] = useState(false)\r\n  const [file, setFile] = useState<File | null>(null)\r\n  const [previewData, setPreviewData] = useState<any[]>([])\r\n  const [error, setError] = useState<string | null>(null)\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const selectedFile = e.target.files?.[0]\r\n    if (!selectedFile) return\r\n\r\n    setFile(selectedFile)\r\n    setError(null)\r\n    setLoading(true)\r\n\r\n    try {\r\n      const data = await parseExcel(selectedFile)\r\n      setPreviewData(data)\r\n      if (data.length === 0) {\r\n        setError(\"ไม่พบข้อมูลในไฟล์\")\r\n      }\r\n    } catch (err: any) {\r\n      console.error(err)\r\n      setError(\"ไม่สามารถอ่านไฟล์ได้: \" + err.message)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const parseExcel = (file: File): Promise<any[]> => {\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader()\r\n      reader.onload = (e) => {\r\n        try {\r\n          const data = e.target?.result\r\n          const workbook = XLSX.read(data, { type: \"binary\" })\r\n          const sheetName = workbook.SheetNames[0]\r\n          const sheet = workbook.Sheets[sheetName]\r\n          const jsonData = XLSX.utils.sheet_to_json(sheet)\r\n          // Fix: Ensure data is plain objects by stripping any non-serializable properties (e.g. prototypes)\r\n          const plainData = JSON.parse(JSON.stringify(jsonData))\r\n          resolve(plainData)\r\n        } catch (error) {\r\n          reject(error)\r\n        }\r\n      }\r\n      reader.onerror = (error) => reject(error)\r\n      reader.readAsBinaryString(file)\r\n    })\r\n  }\r\n\r\n  const handleImport = async () => {\r\n    if (!previewData.length) return\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const result = await onImport(previewData)\r\n      if (result.success) {\r\n        setOpen(false)\r\n        setFile(null)\r\n        setPreviewData([])\r\n        // Optional: Show success toast/alert\r\n        alert(result.message || \"นำเข้าข้อมูลสำเร็จ\")\r\n      } else {\r\n        setError(result.message)\r\n      }\r\n    } catch (err: any) {\r\n      setError(err.message || \"เกิดข้อผิดพลาดในการนำเข้า\")\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const downloadTemplate = () => {\r\n    if (!templateData) return\r\n    const ws = XLSX.utils.json_to_sheet(templateData)\r\n    const wb = XLSX.utils.book_new()\r\n    XLSX.utils.book_append_sheet(wb, ws, \"Template\")\r\n    XLSX.writeFile(wb, templateFilename)\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>{trigger}</DialogTrigger>\r\n      <DialogContent className=\"sm:max-w-xl bg-slate-900 border-slate-800 text-white\">\r\n        <DialogHeader>\r\n          <DialogTitle>{title}</DialogTitle>\r\n          <DialogDescription className=\"text-slate-400\">{description}</DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"grid gap-4 py-4\">\r\n          {templateData && (\r\n            <div className=\"flex justify-end\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={downloadTemplate}\r\n                className=\"gap-2 border-slate-700 hover:bg-slate-800 text-slate-300\"\r\n              >\r\n                <Download size={14} /> โหลดแบบฟอร์ม (Template)\r\n              </Button>\r\n            </div>\r\n          )}\r\n\r\n          <div\r\n            className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${\r\n              file ? \"border-blue-500/50 bg-blue-500/5\" : \"border-slate-700 hover:border-slate-500 hover:bg-slate-800/50\"\r\n            }`}\r\n            onClick={() => fileInputRef.current?.click()}\r\n          >\r\n            <input\r\n              ref={fileInputRef}\r\n              type=\"file\"\r\n              accept=\".xlsx, .xls\"\r\n              className=\"hidden\"\r\n              onChange={handleFileChange}\r\n            />\r\n            <div className=\"flex flex-col items-center gap-2\">\r\n              {file ? (\r\n                <>\r\n                  <FileSpreadsheet className=\"w-10 h-10 text-blue-400\" />\r\n                  <p className=\"font-medium text-blue-400\">{file.name}</p>\r\n                  <p className=\"text-xs text-slate-500\">\r\n                    {previewData.length > 0 ? `พบข้อมูล ${previewData.length} รายการ` : \"กำลังอ่านไฟล์...\"}\r\n                  </p>\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Upload className=\"w-10 h-10 text-slate-500\" />\r\n                  <p className=\"text-slate-300\">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่</p>\r\n                  <p className=\"text-xs text-slate-500\">รองรับไฟล์ .xlsx, .xls</p>\r\n                </>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <div className=\"bg-red-900/20 border border-red-900/50 text-red-400 p-3 rounded-md flex items-start gap-2 text-sm\">\r\n              <AlertCircle className=\"h-4 w-4 mt-0.5 shrink-0\" />\r\n              <div>\r\n                <p className=\"font-semibold\">ผิดพลาด</p>\r\n                <p>{error}</p>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {previewData.length > 0 && !error && (\r\n             <div className=\"max-h-[200px] overflow-auto rounded-md border border-slate-800\">\r\n                <table className=\"w-full text-xs text-left\">\r\n                    <thead className=\"bg-slate-800 text-slate-300 sticky top-0\">\r\n                        <tr>\r\n                            {Object.keys(previewData[0]).slice(0, 5).map(key => (\r\n                                <th key={key} className=\"p-2\">{key}</th>\r\n                            ))}\r\n                            {Object.keys(previewData[0]).length > 5 && <th className=\"p-2\">...</th>}\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y divide-slate-800\">\r\n                        {previewData.slice(0, 5).map((row, i) => (\r\n                            <tr key={i} className=\"hover:bg-slate-800/50\">\r\n                                {Object.values(row).slice(0, 5).map((val: any, j) => (\r\n                                    <td key={j} className=\"p-2 text-slate-400\">{String(val)}</td>\r\n                                ))}\r\n                                {Object.values(row).length > 5 && <td className=\"p-2 text-slate-500\">...</td>}\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </table>\r\n                {previewData.length > 5 && (\r\n                    <p className=\"text-xs text-center p-2 text-slate-500 bg-slate-900 border-t border-slate-800\">\r\n                        ...และอีก {previewData.length - 5} รายการ\r\n                    </p>\r\n                )}\r\n             </div>\r\n          )}\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button variant=\"ghost\" onClick={() => setOpen(false)}>\r\n            ยกเลิก\r\n          </Button>\r\n          <Button\r\n            onClick={handleImport}\r\n            disabled={!file || loading || previewData.length === 0}\r\n            className=\"bg-blue-600 hover:bg-blue-700\"\r\n          >\r\n            {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n            นำเข้าข้อมูล\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\image-upload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\search-input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\textarea.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":5,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":5,"endColumn":31,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[77,164],"text":"type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport interface TextareaProps\r\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\r\n\r\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\r\n  ({ className, ...props }, ref) => {\r\n    return (\r\n      <textarea\r\n        className={cn(\r\n          \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n          className\r\n        )}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nTextarea.displayName = \"Textarea\"\r\n\r\nexport { Textarea }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\ui\\theme-toggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\utils\\auto-print.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\vehicle-autocomplete.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[307,310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[307,310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\Armdd\\TMS_ePOD\\src\\components\\vehicle-autocomplete.tsx:59:10\n  57 |      // If value exists but query is empty, set query to value to show it\n  58 |      if (value && !query) {\n> 59 |          setQuery(value)\n     |          ^^^^^^^^ Avoid calling setState() directly within an effect\n  60 |      }\n  61 |      // If value is cleared, clear query\n  62 |      if (!value && query) {","line":59,"column":10,"nodeType":null,"endLine":59,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'query'. Either include it or remove the dependency array.","line":65,"column":6,"nodeType":"ArrayExpression","endLine":65,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [query, value]","fix":{"range":[1779,1786],"text":"[query, value]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useEffect } from \"react\"\r\nimport { Check, ChevronsUpDown, Truck } from \"lucide-react\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface Vehicle {\r\n  vehicle_plate: string\r\n  vehicle_type: string | null\r\n  [key: string]: any\r\n}\r\n\r\ninterface VehicleAutocompleteProps {\r\n  value?: string\r\n  onChange: (value: string) => void\r\n  vehicles: Vehicle[]\r\n  onSelect: (vehicle: Vehicle) => void\r\n  className?: string\r\n  placeholder?: string\r\n  disabled?: boolean\r\n}\r\n\r\nexport function VehicleAutocomplete({\r\n  value,\r\n  onChange,\r\n  vehicles,\r\n  onSelect,\r\n  className,\r\n  placeholder = \"ค้นหาทะเบียนรถ...\",\r\n  disabled = false\r\n}: VehicleAutocompleteProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [query, setQuery] = useState(\"\")\r\n  const wrapperRef = useRef<HTMLDivElement>(null)\r\n\r\n  // Filter based on query\r\n  const filteredVehicles =\r\n    query === \"\"\r\n      ? vehicles\r\n      : vehicles.filter((v) =>\r\n          v.vehicle_plate.toLowerCase().includes(query.toLowerCase())\r\n        )\r\n\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {\r\n        setOpen(false)\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleClickOutside)\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside)\r\n  }, [])\r\n\r\n  // Update query when value changes from outside (e.g. initial load)\r\n  useEffect(() => {\r\n     // If value exists but query is empty, set query to value to show it\r\n     if (value && !query) {\r\n         setQuery(value)\r\n     }\r\n     // If value is cleared, clear query\r\n     if (!value && query) {\r\n         setQuery(\"\")\r\n     }\r\n  }, [value])\r\n\r\n  const handleSelect = (vehicle: Vehicle) => {\r\n    onChange(vehicle.vehicle_plate)\r\n    onSelect(vehicle)\r\n    setQuery(vehicle.vehicle_plate)\r\n    setOpen(false)\r\n  }\r\n\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      setQuery(e.target.value)\r\n      onChange(e.target.value)\r\n      setOpen(true)\r\n  }\r\n\r\n  return (\r\n    <div ref={wrapperRef} className={cn(\"relative\", className)}>\r\n      <div className=\"relative\">\r\n        <Input\r\n          value={open ? query : (value || \"\")}\r\n          onChange={handleInputChange}\r\n          onFocus={() => !disabled && setOpen(true)}\r\n        //   onClick={() => !disabled && setOpen(true)}\r\n          disabled={disabled}\r\n          placeholder={placeholder}\r\n          className={cn(\"pr-10 bg-slate-800 border-slate-700 text-white placeholder:text-slate-500\", className)}\r\n        />\r\n        <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none\">\r\n             <ChevronsUpDown className=\"w-4 h-4 opacity-50\" />\r\n        </div>\r\n      </div>\r\n\r\n      {open && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-slate-800 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto\">\r\n          {filteredVehicles.length === 0 ? (\r\n            <div className=\"p-2 text-sm text-slate-400 text-center\">\r\n               ไม่พบข้อมูล\r\n            </div>\r\n          ) : (\r\n            <div className=\"py-1\">\r\n              {filteredVehicles.map((vehicle, index) => (\r\n                <button\r\n                  key={`${vehicle.vehicle_plate}-${index}`}\r\n                  onClick={() => handleSelect(vehicle)}\r\n                  type=\"button\"\r\n                  className={cn(\r\n                    \"w-full text-left px-3 py-2 text-sm cursor-pointer hover:bg-slate-700 flex items-center justify-between text-slate-200\",\r\n                    value === vehicle.vehicle_plate && \"bg-slate-700 font-medium text-white\"\r\n                  )}\r\n                >\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Truck size={14} className=\"text-indigo-400\" />\r\n                    <span>{vehicle.vehicle_plate}</span>\r\n                    <span className=\"text-xs text-slate-500\">({vehicle.vehicle_type})</span>\r\n                  </div>\r\n                  {value === vehicle.vehicle_plate && (\r\n                    <Check className=\"w-4 h-4 text-emerald-500\" />\r\n                  )}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\vehicles\\vehicle-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\components\\vehicles\\vehicle-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\attachment-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2853,2856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2853,2856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient, createAdminClient } from \"@/utils/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\n\r\nexport interface Attachment {\r\n    Attachment_ID: string;\r\n    Billing_Note_ID: string;\r\n    File_Name: string;\r\n    File_Path: string;\r\n    File_Type: string;\r\n    Uploaded_At: string;\r\n}\r\n\r\nexport async function getAttachments(billingNoteId: string) {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n        .from('Billing_Attachments')\r\n        .select('*')\r\n        .eq('Billing_Note_ID', billingNoteId)\r\n        .order('Uploaded_At', { ascending: false })\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching attachments:\", error)\r\n        return []\r\n    }\r\n\r\n    return data as Attachment[]\r\n}\r\n\r\nexport async function uploadAttachment(formData: FormData) {\r\n    const billingNoteId = formData.get('billingNoteId') as string\r\n    const file = formData.get('file') as File\r\n\r\n    if (!billingNoteId || !file) {\r\n        return { success: false, error: \"ข้อมูลไม่ครบถ้วน\" }\r\n    }\r\n\r\n    // Use Admin Client to bypass RLS for Storage and DB\r\n    const supabase = createAdminClient()\r\n    const fileExt = file.name.split('.').pop()\r\n    const fileName = `${billingNoteId}/${Date.now()}.${fileExt}`\r\n    const filePath = fileName\r\n\r\n    try {\r\n        // 1. Upload to Storage\r\n        // Convert File to Buffer for reliable server-side upload if needed, \r\n        // but Supabase JS client handles File objects nicely in Node environments usually.\r\n        // However, standard File object in Next.js server actions might be web-standard File.\r\n        const arrayBuffer = await file.arrayBuffer()\r\n        const buffer = Buffer.from(arrayBuffer)\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n            .from('billing-documents')\r\n            .upload(filePath, buffer, {\r\n                contentType: file.type,\r\n                upsert: true\r\n            })\r\n\r\n        if (uploadError) {\r\n             console.error(\"Storage Error:\", uploadError)\r\n             return { success: false, error: \"อัปโหลดไฟล์ไม่สำเร็จ: \" + uploadError.message }\r\n        }\r\n\r\n        // 2. Save to DB\r\n        const { error: dbError } = await supabase\r\n            .from('Billing_Attachments')\r\n            .insert([{\r\n                Billing_Note_ID: billingNoteId,\r\n                File_Name: file.name,\r\n                File_Path: filePath,\r\n                File_Type: file.type || 'application/octet-stream',\r\n            }])\r\n\r\n        if (dbError) {\r\n            console.error(\"DB Error:\", dbError)\r\n            // Cleanup storage if DB fails? Maybe.\r\n            return { success: false, error: \"บันทึกข้อมูลไม่สำเร็จ: \" + dbError.message }\r\n        }\r\n\r\n        revalidatePath(`/billing/customer/history`)\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"Upload Exception:\", e)\r\n        return { success: false, error: e.message }\r\n    }\r\n}\r\n\r\nexport async function saveAttachment(attachment: Omit<Attachment, 'Attachment_ID' | 'Uploaded_At'>) {\r\n    const supabase = await createClient()\r\n// ... (rest of old function)\r\n    const { error } = await supabase\r\n        .from('Billing_Attachments')\r\n        .insert([attachment])\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(`/billing/customer/history`)\r\n    return { success: true }\r\n}\r\n\r\nexport async function deleteAttachment(id: string, filePath: string) {\r\n    const supabase = await createClient()\r\n    \r\n    // 1. Delete from Storage\r\n    const { error: storageError } = await supabase\r\n        .storage\r\n        .from('billing-documents')\r\n        .remove([filePath])\r\n\r\n    if (storageError) {\r\n        console.error(\"Error removing file from storage:\", storageError)\r\n        // Continue to delete DB record anyway? Maybe warn user.\r\n    }\r\n\r\n    // 2. Delete from DB\r\n    const { error: dbError } = await supabase\r\n        .from('Billing_Attachments')\r\n        .delete()\r\n        .eq('Attachment_ID', id)\r\n\r\n    if (dbError) {\r\n        return { success: false, error: dbError.message }\r\n    }\r\n\r\n    revalidatePath(`/billing/customer/history`)\r\n    return { success: true }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\auth-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\branch-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\chat-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\email-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1381,1384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1381,1384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { Resend } from 'resend';\r\n\r\n// Initialize Resend conditionally or lazily\r\nconst resend = new Resend(process.env.RESEND_API_KEY || 're_123'); // Default dummy key to prevent crash on init, but check before send\r\n\r\ninterface EmailAttachment {\r\n    filename: string;\r\n    path?: string; // URL\r\n    content?: Buffer | string;\r\n}\r\n\r\ninterface SendBillingEmailProps {\r\n    to: string;\r\n    subject: string;\r\n    html: string;\r\n    attachments?: EmailAttachment[];\r\n}\r\n\r\nexport async function sendBillingEmail({ to, subject, html, attachments }: SendBillingEmailProps) {\r\n    if (!process.env.RESEND_API_KEY) {\r\n        console.error(\"RESEND_API_KEY is missing in environment variables\");\r\n        return { success: false, error: \"RESEND_API_KEY is not configured\" };\r\n    }\r\n\r\n    try {\r\n        const { data, error } = await resend.emails.send({\r\n            from: 'Billing <billing@resend.dev>', // Change this to your verify domain if available\r\n            to: [to],\r\n            // cc: 'billing@mycompany.com', // Optional: Auto CC yourself\r\n            subject: subject,\r\n            html: html,\r\n            attachments: attachments\r\n        });\r\n\r\n        if (error) {\r\n            console.error(\"Resend Error:\", error);\r\n            return { success: false, error: error.message };\r\n        }\r\n\r\n        return { success: true, data };\r\n    } catch (e: any) {\r\n        console.error(\"Sending Email Failed:\", e);\r\n        return { success: false, error: e.message };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\gps-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1650,1653],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1650,1653],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1686,1689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1686,1689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/utils/supabase/server\"\r\n\r\nexport async function getJobGPSData(jobId: string, driverName: string, date: string) {\r\n    const supabase = await createClient()\r\n    \r\n    try {\r\n        // 1. Fetch Job Route History (Breadcrumbs)\r\n        // We use the driver Name/ID and the specific date of the job\r\n        const startDate = `${date}T00:00:00`\r\n        const endDate = `${date}T23:59:59`\r\n\r\n        const { data: routeData } = await supabase\r\n            .from('gps_logs')\r\n            .select('latitude, longitude, timestamp')\r\n            .eq('job_id', jobId) // Try specific job first\r\n            .order('timestamp', { ascending: true })\r\n        \r\n        // If no job-specific logs, fallback to driver logs for that day\r\n        let finalRoute = routeData\r\n        if (!finalRoute || finalRoute.length === 0) {\r\n            const { data: driverData } = await supabase\r\n                .from('gps_logs')\r\n                .select('latitude, longitude, timestamp')\r\n                .eq('driver_id', driverName)\r\n                .gte('timestamp', startDate)\r\n                .lte('timestamp', endDate)\r\n                .order('timestamp', { ascending: true })\r\n            finalRoute = driverData\r\n        }\r\n\r\n        // 2. Fetch Latest Location\r\n        const { data: latestData } = await supabase\r\n            .from('gps_logs')\r\n            .select('*')\r\n            .eq('driver_id', driverName)\r\n            .order('timestamp', { ascending: false })\r\n            .limit(1)\r\n\r\n        const latest = latestData?.[0]\r\n\r\n        return {\r\n            route: finalRoute?.map(r => [r.latitude || (r as any).Latitude, r.longitude || (r as any).Longitude]) || [],\r\n            latest: latest ? {\r\n                lat: latest.latitude || latest.Latitude,\r\n                lng: latest.longitude || latest.Longitude,\r\n                timestamp: latest.timestamp || latest.Timestamp\r\n            } : null\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Failed to fetch GPS data for job summary:\", e)\r\n        return { route: [], latest: null }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\notification-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\permission-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[688,691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[688,691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1629,1632],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1629,1632],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { isSuperAdmin } from '@/lib/permissions'\r\n\r\nexport type RolePermission = {\r\n    Role: string\r\n    Permissions: Record<string, boolean>\r\n    Updated_At?: string\r\n    Updated_By?: string\r\n}\r\n\r\nexport async function getRolePermissions() {\r\n    try {\r\n        const supabase = await createClient()\r\n        const { data, error } = await supabase\r\n            .from('Master_Role_Permissions')\r\n            .select('*')\r\n            .order('Role')\r\n\r\n        if (error) throw error\r\n        return { success: true, data: data as RolePermission[] }\r\n    } catch (error: any) {\r\n        console.error('Error fetching role permissions:', error)\r\n        return { success: false, error: error.message }\r\n    }\r\n}\r\n\r\nexport async function updateRolePermissions(role: string, permissions: Record<string, boolean>) {\r\n    try {\r\n        // Security check: Only Super Admin can update permissions\r\n        const isSuper = await isSuperAdmin()\r\n        if (!isSuper) {\r\n            return { success: false, error: 'Unauthorized: Only Super Admin can manage permissions' }\r\n        }\r\n\r\n        const supabase = await createClient()\r\n        const { error } = await supabase\r\n            .from('Master_Role_Permissions')\r\n            .upsert({\r\n                Role: role,\r\n                Permissions: permissions,\r\n                Updated_At: new Date().toISOString()\r\n            })\r\n\r\n        if (error) throw error\r\n\r\n        revalidatePath('/settings/roles')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error updating role permissions:', error)\r\n        return { success: false, error: error.message }\r\n    }\r\n}\r\n\r\nexport async function getPermissionForRole(role: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        const { data, error } = await supabase\r\n            .from('Master_Role_Permissions')\r\n            .select('Permissions')\r\n            .eq('Role', role)\r\n            .single()\r\n\r\n        if (error) return {}\r\n        return data.Permissions as Record<string, boolean>\r\n    } catch {\r\n        return {}\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\pod-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\report-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1915,1918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1915,1918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2485,2488],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2485,2488],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { jsPDF } from \"jspdf\"\r\nimport \"jspdf-autotable\"\r\nimport { createClient } from \"@/utils/supabase/server\"\r\nimport { uploadFileToDrive } from \"@/lib/google-drive\"\r\n\r\nexport async function generateJobPDF(jobId: string) {\r\n    console.log(`Generating PDF for Job: ${jobId}...`)\r\n    \r\n    try {\r\n        const supabase = await createClient()\r\n        \r\n        // 1. Fetch comprehensive job data\r\n        const { data: job, error } = await supabase\r\n            .from('Jobs_Main')\r\n            .select('*')\r\n            .eq('Job_ID', jobId)\r\n            .single()\r\n            \r\n        if (error || !job) throw new Error(\"Job not found\")\r\n\r\n        // 2. Initialize PDF\r\n        const doc = new jsPDF()\r\n        const primaryColor = [30, 41, 59] // Slate 800\r\n        const accentColor = [79, 70, 229] // Indigo 600\r\n\r\n        // Header\r\n        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2])\r\n        doc.rect(0, 0, 210, 40, 'F')\r\n        \r\n        doc.setTextColor(255, 255, 255)\r\n        doc.setFontSize(22)\r\n        doc.text(\"DELIVERY SUMMARY REPORT\", 15, 20)\r\n        \r\n        doc.setFontSize(10)\r\n        doc.text(`Job ID: ${job.Job_ID}`, 15, 30)\r\n        doc.text(`Generated: ${new Date().toLocaleString('th-TH')}`, 15, 35)\r\n\r\n        // Job Details Table\r\n        const detailsData = [\r\n            [\"Customer\", job.Customer_Name || \"-\"],\r\n            [\"Origin\", job.Location_Origin_Name || job.Origin_Location || \"-\"],\r\n            [\"Destination\", job.Location_Destination_Name || job.Dest_Location || \"-\"],\r\n            [\"Vehicle\", job.Vehicle_Plate || \"-\"],\r\n            [\"Driver\", job.Driver_Name || \"-\"],\r\n            [\"Status\", job.Job_Status || \"-\"],\r\n            [\"Plan Date\", job.Plan_Date || \"-\"],\r\n            [\"Pickup Time\", job.Actual_Pickup_Time || \"-\"],\r\n            [\"Delivery Time\", job.Actual_Delivery_Time || \"-\"],\r\n        ]\r\n\r\n        ;(doc as any).autoTable({\r\n            startY: 50,\r\n            head: [['Field', 'Value']],\r\n            body: detailsData,\r\n            theme: 'striped',\r\n            headStyles: { fillStyle: accentColor },\r\n            styles: { fontSize: 10, cellPadding: 3 }\r\n        })\r\n\r\n        // Photos Section (Basic implementation - embedding images in PDF requires base64)\r\n        // Since fetching and converting all images might be heavy, for now we will \r\n        // provide links in metadata but let's try to embed at least the signature.\r\n        \r\n        let finalY = (doc as any).lastAutoTable.finalY + 20\r\n\r\n        // Signatures\r\n        if (job.Signature_Url || job.Pickup_Signature_Url) {\r\n            doc.setFontSize(12)\r\n            doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2])\r\n            doc.text(\"SIGNATURES\", 15, finalY)\r\n            finalY += 10\r\n\r\n            // Helper to get image as base64 (Simplified for logic)\r\n            // Note: In real server environment, we'd use fetch + buffer -> base64\r\n            // Since we can't easily fetch external images right now, we'll add links\r\n            doc.setFontSize(8)\r\n            if (job.Pickup_Signature_Url) {\r\n                doc.text(\"Pickup Signature:\", 15, finalY)\r\n                doc.setTextColor(accentColor[0], accentColor[1], accentColor[2])\r\n                doc.text(\"(View Signature Link)\", 15, finalY + 5)\r\n                doc.setTextColor(0, 0, 0)\r\n            }\r\n            if (job.Signature_Url) {\r\n                doc.text(\"POD Signature:\", 100, finalY)\r\n                doc.setTextColor(accentColor[0], accentColor[1], accentColor[2])\r\n                doc.text(\"(View Signature Link)\", 100, finalY + 5)\r\n                doc.setTextColor(0, 0, 0)\r\n            }\r\n        }\r\n\r\n        // 3. Convert to Buffer\r\n        const pdfArrayBuffer = doc.output('arraybuffer')\r\n        const pdfBuffer = Buffer.from(pdfArrayBuffer)\r\n\r\n        // 4. Upload to Google Drive\r\n        const fileName = `Report_${jobId}_${Date.now()}.pdf`\r\n        const uploadResult = await uploadFileToDrive(pdfBuffer, fileName, 'application/pdf', 'POD_Reports')\r\n\r\n        console.log(`PDF Generated & Uploaded: ${uploadResult.directLink}`)\r\n\r\n        // 5. Update Job with PDF Link\r\n        await supabase\r\n            .from('Jobs_Main')\r\n            .update({ Photo_Proof_Url: job.Photo_Proof_Url ? `${job.Photo_Proof_Url},${uploadResult.directLink}` : uploadResult.directLink })\r\n            .eq('Job_ID', jobId)\r\n\r\n        return { success: true, url: uploadResult.directLink }\r\n\r\n    } catch (e) {\r\n        console.error(\"PDF Generation Failed:\", e)\r\n        return { success: false, error: String(e) }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\role-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RolePermissions' is defined but never used.","line":4,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RolePermissions"},"fix":{"range":[85,102],"text":""},"desc":"Remove unused variable \"RolePermissions\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/utils/supabase/server\"\r\nimport { Role, RolePermissions } from \"@/types/role\"\r\nimport { revalidatePath } from \"next/cache\"\r\n\r\nexport async function getRoles() {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n        .from(\"Master_Roles\")\r\n        .select(\"*\")\r\n        .order(\"Role_ID\", { ascending: true })\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching roles:\", error)\r\n        return []\r\n    }\r\n\r\n    return data as Role[]\r\n}\r\n\r\nexport async function getRoleById(id: number) {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n        .from(\"Master_Roles\")\r\n        .select(\"*\")\r\n        .eq(\"Role_ID\", id)\r\n        .single()\r\n\r\n    if (error) return null\r\n\r\n    return data as Role\r\n}\r\n\r\nexport async function createRole(role: Omit<Role, \"Role_ID\">) {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n        .from(\"Master_Roles\")\r\n        .insert([role])\r\n        .select()\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(\"/settings/roles\")\r\n    return { success: true, data }\r\n}\r\n\r\nexport async function updateRole(id: number, role: Partial<Role>) {\r\n    const supabase = await createClient()\r\n    const { error } = await supabase\r\n        .from(\"Master_Roles\")\r\n        .update(role)\r\n        .eq(\"Role_ID\", id)\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(\"/settings/roles\")\r\n    return { success: true }\r\n}\r\n\r\nexport async function deleteRole(id: number) {\r\n    const supabase = await createClient()\r\n    const { error } = await supabase\r\n        .from(\"Master_Roles\")\r\n        .delete()\r\n        .eq(\"Role_ID\", id)\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(\"/settings/roles\")\r\n    return { success: true }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\subcontractor-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\tracking-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2865,2868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2865,2868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2955,2958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2955,2958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/utils/supabase/server\"\r\n\r\nexport interface PublicJobDetails {\r\n    jobId: string\r\n    trackingCode: string\r\n    status: string\r\n    customerName: string\r\n    origin: string\r\n    destination: string\r\n    driverName: string\r\n    driverPhone: string\r\n    vehiclePlate: string\r\n    planDate: string\r\n    pickupDate: string | null\r\n    deliveryDate: string | null\r\n    pickupPhotos: string[]\r\n    podPhotos: string[]\r\n    signature: string | null\r\n    pickupSignature: string | null\r\n    lastLocation?: {\r\n        lat: number\r\n        lng: number\r\n        timestamp: string\r\n    } | null\r\n}\r\n\r\nexport async function getPublicJobDetails(jobId: string): Promise<PublicJobDetails | null> {\r\n    const supabase = await createClient()\r\n\r\n    // Query Jobs_Main with all relevant columns\r\n    const { data: job, error } = await supabase\r\n        .from('Jobs_Main')\r\n        .select('*')\r\n        .eq('Job_ID', jobId)\r\n        .single()\r\n    \r\n    if (error || !job) {\r\n        console.error(\"Error fetching job:\", error)\r\n        return null\r\n    }\r\n\r\n    // Process Photos\r\n    const pickupPhotos = job.Pickup_Photo_Url ? job.Pickup_Photo_Url.split(',').filter(Boolean) : []\r\n    const podPhotos = job.Photo_Proof_Url ? job.Photo_Proof_Url.split(',').filter(Boolean) : []\r\n\r\n    // Fetch latest location for the vehicle/driver associated with this job\r\n    let lastLocation = null\r\n    if (['In Transit', 'Picked Up'].includes(job.Job_Status)) {\r\n        const { data: gpsData } = await supabase\r\n            .from('gps_logs')\r\n            .select('*')\r\n            .eq('driver_id', job.Driver_Name) // Assuming Driver_Name is the foreign key or ID in some cases, but usually we need Driver_ID. \r\n            // Let's check if Driver_ID is available in job.\r\n            .order('timestamp', { ascending: false })\r\n            .limit(1)\r\n        \r\n        const log = gpsData?.[0]\r\n        if (log) {\r\n            lastLocation = {\r\n                lat: log.latitude || log.Latitude,\r\n                lng: log.longitude || log.Longitude,\r\n                timestamp: log.timestamp || log.Timestamp\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        jobId: job.Job_ID,\r\n        trackingCode: job.Job_ID,\r\n        status: job.Job_Status || 'Pending',\r\n        customerName: job.Customer_Name || 'Unknown',\r\n        origin: job.Location_Origin_Name || job.Origin_Location || '-',\r\n        destination: job.Location_Destination_Name || job.Dest_Location || '-',\r\n        driverName: job.Driver_Name || '-',\r\n        driverPhone: '-', \r\n        vehiclePlate: job.Vehicle_Plate || '-',\r\n        planDate: job.Plan_Date || '-',\r\n        pickupDate: job.Actual_Pickup_Time || null,\r\n        deliveryDate: job.Actual_Delivery_Time || null,\r\n        pickupPhotos,\r\n        podPhotos,\r\n        signature: job.Signature_Url || (job as any).signature_url || null,\r\n        pickupSignature: job.Pickup_Signature_Url || (job as any).pickup_signature_url || null,\r\n        lastLocation\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\upload-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\user-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3944,3947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3944,3947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/utils/supabase/server\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { getSession } from \"@/lib/session\"\r\nimport argon2 from \"argon2\"\r\n\r\nimport { StandardRole } from \"@/types/role\"\r\n\r\nexport interface UserData {\r\n    Username: string;\r\n    Password?: string;\r\n    Name: string;\r\n    Branch_ID: string;\r\n    Role_ID?: number;\r\n    Role: StandardRole; \r\n    Active_Status: string;\r\n    Customer_ID?: string | null;\r\n    Permissions?: Record<string, boolean>;\r\n}\r\n\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\n\r\nexport async function getUsers(providedBranchId?: string) {\r\n    const supabase = await createClient()\r\n    \r\n    let query = supabase\r\n        .from(\"Master_Users\")\r\n        .select(`\r\n            *,\r\n            Master_Customers ( Customer_Name )\r\n        `)\r\n    \r\n    // Filter by Branch\r\n    const isAdmin = await isSuperAdmin()\r\n    const branchId = providedBranchId || await getUserBranchId()\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        query = query.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data, error } = await query.order(\"Username\")\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching users:\", error)\r\n        return []\r\n    }\r\n\r\n    return data\r\n}\r\n\r\nconst ROLE_MAP: Record<string, number> = {\r\n    'Super Admin': 1,\r\n    'Admin': 2,\r\n    'Dispatcher': 3,\r\n    'Dispatcher (Dispatch)': 3,\r\n    'Accountant': 4,\r\n    'Staff': 5,\r\n    'Driver': 6,\r\n    'Customer': 7\r\n}\r\n\r\nexport async function createUser(user: UserData) {\r\n    const { createAdminClient } = await import(\"@/utils/supabase/server\")\r\n    const supabase = createAdminClient()\r\n    \r\n    // Check if username exists\r\n    const { data: existing } = await supabase\r\n        .from(\"Master_Users\")\r\n        .select(\"Username\")\r\n        .eq(\"Username\", user.Username)\r\n        .single()\r\n        \r\n    if (existing) {\r\n        return { success: false, error: \"ชื่อผู้ใช้นี้มีอยู่ในระบบแล้ว\" }\r\n    }\r\n\r\n    const session = await getSession()\r\n    if (!session) return { success: false, error: \"Not authenticated\" }\r\n\r\n    if (user.Role === \"Super Admin\" && session.roleId !== 1) {\r\n        return { success: false, error: \"คุณไม่มีสิทธิ์สร้างผู้ใช้งานระดับ Super Admin\" }\r\n    }\r\n\r\n    const hashedPassword = await argon2.hash(user.Password || \"123456\")\r\n\r\n    const roleId = ROLE_MAP[user.Role] || 5 // Default to Staff\r\n\r\n    const { error } = await supabase\r\n        .from(\"Master_Users\")\r\n        .insert([{\r\n            Username: user.Username,\r\n            Password: hashedPassword,\r\n            Name: user.Name,\r\n            Branch_ID: user.Branch_ID,\r\n            Role: user.Role,\r\n            Role_ID: roleId,\r\n            Customer_ID: user.Customer_ID || null,\r\n            Permissions: user.Permissions || {},\r\n            Active_Status: 'Active'\r\n        }])\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(\"/settings/users\")\r\n    return { success: true }\r\n}\r\n\r\nexport async function updateUser(username: string, updates: Partial<UserData>) {\r\n    const { createAdminClient } = await import(\"@/utils/supabase/server\")\r\n    const supabase = createAdminClient()\r\n    \r\n    const session = await getSession()\r\n    if (!session) return { success: false, error: \"Not authenticated\" }\r\n\r\n    // Check target user's current role\r\n    const { data: targetUser } = await supabase\r\n        .from(\"Master_Users\")\r\n        .select(\"Role\")\r\n        .eq(\"Username\", username)\r\n        .single()\r\n\r\n    if (targetUser?.Role === \"Super Admin\" && session.roleId !== 1) {\r\n        return { success: false, error: \"คุณไม่มีสิทธิ์แก้ไขข้อมูลของ Super Admin\" }\r\n    }\r\n\r\n    if (targetUser?.Role === \"Admin\" && session.roleId !== 1) {\r\n        return { success: false, error: \"คุณไม่มีสิทธิ์แก้ไขข้อมูลของ Admin\" }\r\n    }\r\n\r\n    const updatePayload: any = {\r\n        Name: updates.Name,\r\n        Branch_ID: updates.Branch_ID,\r\n        Active_Status: updates.Active_Status,\r\n        Customer_ID: updates.Customer_ID,\r\n        Permissions: updates.Permissions,\r\n        Role: updates.Role\r\n    }\r\n\r\n    if (updates.Role) {\r\n        updatePayload.Role_ID = ROLE_MAP[updates.Role] || 5\r\n    }\r\n\r\n    if (updates.Password) {\r\n        updatePayload.Password = await argon2.hash(updates.Password)\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from(\"Master_Users\")\r\n        .update(updatePayload)\r\n        .eq(\"Username\", username)\r\n\r\n    if (error) {\r\n        console.error(\"Update user error:\", error)\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    console.log(`User ${username} updated successfully. Permissions:`, !!updatePayload.Permissions)\r\n    revalidatePath(\"/settings/users\")\r\n    return { success: true }\r\n}\r\n\r\nexport async function getCurrentUserRole() {\r\n    const session = await getSession()\r\n    if (!session) return { roleId: 3, username: null } // Default to Staff\r\n    return {\r\n        roleId: session.roleId,\r\n        username: session.username\r\n    }\r\n}\r\n\r\nexport async function deleteUser(username: string) {\r\n    const { createAdminClient } = await import(\"@/utils/supabase/server\")\r\n    const supabase = createAdminClient()\r\n    \r\n    const session = await getSession()\r\n    if (!session) return { success: false, error: \"Not authenticated\" }\r\n\r\n    // Check target user's current role\r\n    const { data: targetUser } = await supabase\r\n        .from(\"Master_Users\")\r\n        .select(\"Role\")\r\n        .eq(\"Username\", username)\r\n        .single()\r\n\r\n    if (targetUser?.Role === \"Super Admin\" && session.roleId !== 1) {\r\n        return { success: false, error: \"คุณไม่มีสิทธิ์ลบข้อมูลของ Super Admin\" }\r\n    }\r\n\r\n    if (targetUser?.Role === \"Admin\" && session.roleId !== 1) {\r\n        return { success: false, error: \"คุณไม่มีสิทธิ์ลบข้อมูลของ Admin\" }\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from(\"Master_Users\")\r\n        .delete()\r\n        .eq(\"Username\", username)\r\n\r\n    if (error) {\r\n        return { success: false, error: error.message }\r\n    }\r\n\r\n    revalidatePath(\"/settings/users\")\r\n    return { success: true }\r\n}\r\n\r\nexport async function createBulkUsers(users: Record<string, unknown>[]) {\r\n    const supabase = await createClient()\r\n    const session = await getSession()\r\n    \r\n    if (!session) return { success: false, message: \"Not authenticated\" }\r\n    \r\n    // Permission check:\r\n    // - Super Admin (1): Can create anyone\r\n    // - Admin (2): Can create Staff/Drivers, cannot create Super Admin\r\n    // - Staff/Manager (3): Can create Staff/Drivers? -> Matching createUser logic which allows creation but restricts Super Admin. \r\n    //   However, usually Role 3 shouldn't create Users. But since they have access to the page, we allow it but restricted.\r\n    \r\n    // Prevent creating Super Admin if not Super Admin\r\n    const hasSuperAdminInList = users.some(u => \r\n        String(u.Role).toLowerCase() === 'super admin' || \r\n        String(u.Role).toLowerCase() === 'superadmin' ||\r\n        String(u.role).toLowerCase() === 'super admin'\r\n    )\r\n\r\n    if (hasSuperAdminInList && session.roleId !== 1) {\r\n         return { success: false, message: \"คุณไม่มีสิทธิ์สร้างผู้ใช้งานระดับ Super Admin\" }\r\n    }\r\n\r\n    // Optional: Prevent creating Admin if not Super Admin (Logic from deleteUser/updateUser implies strictness)\r\n    // For now, we allow it but maybe warn? Or just stick to the checks we have.\r\n    // The previous check was (session.roleId > 2), we remove it to allow Role 3.\r\n\r\n    // Normalize keys\r\n    const normalizeData = (row: Record<string, unknown>) => {\r\n        const normalized: Record<string, unknown> = {}\r\n        const getValue = (keys: string[]) => {\r\n            const rowKeys = Object.keys(row)\r\n            for (const key of keys) {\r\n                const foundKey = rowKeys.find(k => k.toLowerCase().replace(/\\s+/g, '') === key.toLowerCase().replace(/\\s+/g, ''))\r\n                if (foundKey && row[foundKey] !== undefined && row[foundKey] !== null) {\r\n                    return row[foundKey]\r\n                }\r\n            }\r\n            return undefined\r\n        }\r\n\r\n        normalized.Username = getValue(['username', 'user', 'ชื่อผู้ใช้'])\r\n        normalized.Name = getValue(['name', 'fullname', 'ชื่อ', 'ชื่อ-นามสกุล', 'ชื่อนามสกุล'])\r\n        normalized.Branch_ID = getValue(['branch_id', 'branch', 'สาขา'])\r\n        normalized.Role = getValue(['role', 'position', 'ตำแหน่ง', 'บทบาท']) || 'Staff'\r\n        normalized.Password = getValue(['password', 'pass', 'รหัสผ่าน']) || '123456'\r\n        \r\n        return normalized\r\n    }\r\n\r\n    const cleanData = users.map(u => normalizeData(u)).filter(u => u.Username && u.Name) // Filter invalid\r\n\r\n    if (cleanData.length === 0) {\r\n        return { success: false, message: \"ไม่พบข้อมูลที่ถูกต้อง (ต้องมี Username และ Name)\" }\r\n    }\r\n\r\n    // Deduplicate input\r\n    const uniqueData = Array.from(new Map(cleanData.map(item => [item.Username, item])).values())\r\n\r\n    // Hash passwords efficiently\r\n    const hashedData = await Promise.all(uniqueData.map(async (u) => ({\r\n        Username: u.Username,\r\n        Password: await argon2.hash(String(u.Password)),\r\n        Name: u.Name,\r\n        Branch_ID: u.Branch_ID || 'Head Office', // Default branch?\r\n        Role: u.Role,\r\n        Active_Status: 'Active'\r\n    })))\r\n\r\n    // Use upsert or insert? creating users usually shouldn't overwrite existing ones easily to avoid password reset\r\n    // But for bulk import, maybe skip existing?\r\n    \r\n    // Let's use insert with ignoreDuplicates? Supabase js insert doesn't support ignoreDuplicates on some adapters easily without onConflict\r\n    // We will use upsert but preserve password if exists? No, that's too complex for bulk.\r\n    // Let's iterate and check or use onConflict DO NOTHING (ignoreDuplicates: true)\r\n    \r\n    const { error } = await supabase\r\n        .from('Master_Users')\r\n        .upsert(hashedData, { \r\n            onConflict: 'Username', \r\n            ignoreDuplicates: true \r\n        })\r\n\r\n    if (error) {\r\n        console.error(\"Bulk create users error:\", error)\r\n        return { success: false, message: `Failed to import: ${error.message}` }\r\n    }\r\n\r\n    revalidatePath(\"/settings/users\")\r\n    return { success: true, message: `นำเข้าสำเร็จ ${uniqueData.length} รายการ (ข้ามรายการที่ซ้ำ)` }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\actions\\vehicle-type-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\google-drive.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\ocr\\fuel-receipt-parser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\session.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":32,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'server-only'\r\nimport { SignJWT, jwtVerify } from 'jose'\r\nimport { cookies } from 'next/headers'\r\n\r\nconst secretKey = process.env.SESSION_SECRET || 'default_secret_key_change_me_in_production'\r\nconst encodedKey = new TextEncoder().encode(secretKey)\r\n\r\nexport type SessionPayload = {\r\n  userId: string\r\n  roleId: number\r\n  branchId: string | null\r\n  customerId: string | null\r\n  permissions: Record<string, boolean>\r\n  username: string\r\n  expiresAt: Date\r\n}\r\n\r\nexport async function encrypt(payload: SessionPayload) {\r\n  return new SignJWT(payload)\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('7d')\r\n    .sign(encodedKey)\r\n}\r\n\r\nexport async function decrypt(session: string | undefined = '') {\r\n  try {\r\n    const { payload } = await jwtVerify(session, encodedKey, {\r\n      algorithms: ['HS256'],\r\n    })\r\n    return payload as unknown as SessionPayload\r\n  } catch (error) {\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function createSession(\r\n  userId: string, \r\n  roleId: number, \r\n  branchId: string | null, \r\n  username: string,\r\n  customerId: string | null = null,\r\n  permissions: Record<string, boolean> = {}\r\n) {\r\n  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)\r\n  const session = await encrypt({ \r\n    userId, \r\n    roleId, \r\n    branchId, \r\n    username, \r\n    customerId, \r\n    permissions,\r\n    expiresAt \r\n  })\r\n  const cookieStore = await cookies()\r\n\r\n  cookieStore.set('session', session, {\r\n    httpOnly: true,\r\n    secure: process.env.NODE_ENV === 'production',\r\n    expires: expiresAt,\r\n    sameSite: 'lax',\r\n    path: '/',\r\n  })\r\n}\r\n\r\nexport async function getSession() {\r\n  const cookieStore = await cookies()\r\n  const session = cookieStore.get('session')?.value\r\n  const payload = await decrypt(session)\r\n\r\n  if (!payload) {\r\n    return null\r\n  }\r\n\r\n  return payload\r\n}\r\n\r\nexport async function deleteSession() {\r\n    const cookieStore = await cookies()\r\n  cookieStore.delete('session')\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\analytics.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'fuelQuery' is never reassigned. Use 'const' instead.","line":642,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":642,"endColumn":18,"fix":{"range":[23905,24140],"text":"const fuelQuery = supabase\r\n        .from('Fuel_Logs')\r\n        .select('Vehicle_Plate, Price_Total')\r\n        .gte('Date_Time', `${firstDay}T00:00:00`)\r\n        .lte('Date_Time', `${lastDay}T23:59:59`)\r\n        .eq('Status', 'Approved')"}},{"ruleId":"prefer-const","severity":2,"message":"'maintenanceQuery' is never reassigned. Use 'const' instead.","line":652,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":652,"endColumn":25,"fix":{"range":[24238,24489],"text":"const maintenanceQuery = supabase\r\n        .from('Repair_Tickets')\r\n        .select('Vehicle_Plate, Cost_Total')\r\n        .gte('Date_Report', `${firstDay}T00:00:00`)\r\n        .lte('Date_Report', `${lastDay}T23:59:59`)\r\n        .eq('Status', 'Completed')"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":2,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\n\r\n// Date helpers to avoid extra dependencies\r\nconst subDays = (date: Date, days: number) => new Date(date.getTime() - days * 24 * 60 * 60 * 1000)\r\nconst differenceInDays = (d1: Date, d2: Date) => Math.floor(Math.abs(d1.getTime() - d2.getTime()) / (24 * 60 * 60 * 1000))\r\n\r\n// Helper to get vehicle plates for a branch\r\nasync function getBranchPlates(branchId: string) {\r\n    const supabase = await createClient()\r\n    const { data } = await supabase\r\n        .from('master_vehicles')\r\n        .select('vehicle_plate')\r\n        .eq('branch_id', branchId)\r\n    return data?.map(v => v.vehicle_plate) || []\r\n}\r\n\r\n// 1. Financial Stats\r\nexport async function getFinancialStats(startDate?: string, endDate?: string, branchId?: string) {\r\n  const supabase = await createClient()\r\n  \r\n  // Default to current month if no date provided\r\n  const now = new Date()\r\n  const firstDay = startDate || new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]\r\n  const lastDay = endDate || new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]\r\n\r\n  // Determine effective branch\r\n  const userBranchId = await getUserBranchId()\r\n  const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n  const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n  // 1.1 Revenue & Driver Cost from Jobs\r\n  let jobsQuery = supabase\r\n    .from('Jobs_Main')\r\n    .select('Price_Cust_Total, Cost_Driver_Total')\r\n    .gte('Plan_Date', firstDay)\r\n    .lte('Plan_Date', lastDay)\r\n    .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n  if (effectiveBranchId) {\r\n      jobsQuery = jobsQuery.eq('Branch_ID', effectiveBranchId)\r\n  }\r\n\r\n  const { data: jobs } = await jobsQuery\r\n\r\n  const revenue = jobs?.reduce((sum, job) => sum + (job.Price_Cust_Total || 0), 0) || 0\r\n  const driverCost = jobs?.reduce((sum, job) => sum + (job.Cost_Driver_Total || 0), 0) || 0\r\n\r\n  // For Fuel and Maintenance, we need vehicle plates if branch filtering is active\r\n  let activePlates: string[] = []\r\n  if (effectiveBranchId) {\r\n      activePlates = await getBranchPlates(effectiveBranchId)\r\n  }\r\n\r\n  // 1.2 Fuel Cost\r\n  let fuelQuery = supabase\r\n    .from('Fuel_Logs')\r\n    .select('Price_Total')\r\n    .gte('Date_Time', `${firstDay}T00:00:00`)\r\n    .lte('Date_Time', `${lastDay}T23:59:59`)\r\n\r\n  if (effectiveBranchId) {\r\n      if (activePlates.length > 0) {\r\n        fuelQuery = fuelQuery.in('Vehicle_Plate', activePlates)\r\n      } else {\r\n        // If no vehicles in branch, no fuel cost\r\n        fuelQuery = fuelQuery.in('Vehicle_Plate', ['NO_MATCH']) \r\n      }\r\n  }\r\n\r\n  const { data: fuel } = await fuelQuery\r\n\r\n  const fuelCost = fuel?.reduce((sum, log) => sum + (log.Price_Total || 0), 0) || 0\r\n\r\n  // 1.3 Maintenance Cost\r\n  let maintenanceQuery = supabase\r\n    .from('Repair_Tickets')\r\n    .select('Cost_Total')\r\n    .gte('Date_Report', `${firstDay}T00:00:00`)\r\n    .lte('Date_Report', `${lastDay}T23:59:59`)\r\n    .neq('Status', 'Cancelled')\r\n\r\n  if (effectiveBranchId) {\r\n       if (activePlates.length > 0) {\r\n        maintenanceQuery = maintenanceQuery.in('Vehicle_Plate', activePlates)\r\n      } else {\r\n        maintenanceQuery = maintenanceQuery.in('Vehicle_Plate', ['NO_MATCH'])\r\n      }\r\n  }\r\n\r\n  const { data: maintenance } = await maintenanceQuery\r\n\r\n  const maintenanceCost = maintenance?.reduce((sum, ticket) => sum + (ticket.Cost_Total || 0), 0) || 0\r\n\r\n  const totalCost = driverCost + fuelCost + maintenanceCost\r\n  const netProfit = revenue - totalCost\r\n  const profitMargin = revenue > 0 ? (netProfit / revenue) * 100 : 0\r\n\r\n  return {\r\n    revenue,\r\n    cost: {\r\n      total: totalCost,\r\n      driver: driverCost,\r\n      fuel: fuelCost,\r\n      maintenance: maintenanceCost\r\n    },\r\n    netProfit,\r\n    profitMargin\r\n  }\r\n}\r\n\r\n// 2. Revenue Trend (Daily for the selected range)\r\nexport async function getRevenueTrend(startDate?: string, endDate?: string, branchId?: string) {\r\n  const supabase = await createClient()\r\n  \r\n  // Default to last 30 days if no range provided\r\n  const today = new Date()\r\n  let start = startDate\r\n  const end = endDate\r\n\r\n  if (!start) {\r\n      const thirtyDaysAgo = new Date(today)\r\n      thirtyDaysAgo.setDate(today.getDate() - 30)\r\n      start = thirtyDaysAgo.toISOString().split('T')[0]\r\n  }\r\n\r\n  // Determine effective branch\r\n  const userBranchId = await getUserBranchId()\r\n  const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n  const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n  let query = supabase\r\n    .from('Jobs_Main')\r\n    .select('Plan_Date, Price_Cust_Total, Cost_Driver_Total, Actual_Delivery_Time')\r\n    .in('Job_Status', ['Completed', 'Delivered'])\r\n    .order('Plan_Date', { ascending: true })\r\n\r\n  if (effectiveBranchId) {\r\n      query = query.eq('Branch_ID', effectiveBranchId)\r\n  }\r\n\r\n  if (start) query = query.gte('Plan_Date', start)\r\n  if (end) query = query.lte('Plan_Date', end)\r\n\r\n  const { data: jobs } = await query\r\n\r\n  // Aggregate by date\r\n  const dailyStats: Record<string, { date: string, revenue: number, cost: number, jobCount: number, onTimeCount: number }> = {}\r\n\r\n  jobs?.forEach(job => {\r\n    const date = job.Plan_Date as string\r\n    if (!dailyStats[date]) {\r\n        dailyStats[date] = { date, revenue: 0, cost: 0, jobCount: 0, onTimeCount: 0 }\r\n    }\r\n    dailyStats[date].revenue += (job.Price_Cust_Total || 0)\r\n    dailyStats[date].cost += (job.Cost_Driver_Total || 0)\r\n    dailyStats[date].jobCount += 1\r\n    \r\n    // On-time check: Is actual completion on the same day as Plan_Date?\r\n    if (job.Actual_Delivery_Time) {\r\n        const actualDate = job.Actual_Delivery_Time.split('T')[0]\r\n        if (actualDate === date) {\r\n            dailyStats[date].onTimeCount += 1\r\n        }\r\n    } else {\r\n        // Fallback for older records: assume on-time if completed\r\n        dailyStats[date].onTimeCount += 1\r\n    }\r\n  })\r\n  \r\n  return Object.values(dailyStats)\r\n}\r\n\r\n// 3. Customer Performance (Top 5)\r\nexport async function getTopCustomers(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    \r\n    // Determine effective branch\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    let query = supabase\r\n        .from('Jobs_Main')\r\n        .select('Customer_Name, Price_Cust_Total')\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n    if (effectiveBranchId) {\r\n        query = query.eq('Branch_ID', effectiveBranchId)\r\n    }\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n\r\n    const { data: jobs } = await query\r\n\r\n    const customerStats: Record<string, { name: string, revenue: number, jobCount: number }> = {}\r\n\r\n    jobs?.forEach(job => {\r\n        const name = job.Customer_Name || 'Unknown'\r\n        if (!customerStats[name]) {\r\n            customerStats[name] = { name, revenue: 0, jobCount: 0 }\r\n        }\r\n        customerStats[name].revenue += (job.Price_Cust_Total || 0)\r\n        customerStats[name].jobCount += 1\r\n    })\r\n\r\n    return Object.values(customerStats)\r\n        .sort((a, b) => b.revenue - a.revenue)\r\n        .slice(0, 5)\r\n}\r\n\r\n// 4. Operational Stats\r\nexport async function getOperationalStats(branchId?: string) {\r\n    const supabase = await createClient()\r\n\r\n    // Determine effective branch\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    // 4.1 Fleet Utilization (Active vs Total Vehicles)\r\n    let vehicleQuery = supabase\r\n        .from('master_vehicles') \r\n        .select('*', { count: 'exact', head: true })\r\n    \r\n    if (effectiveBranchId) {\r\n        vehicleQuery = vehicleQuery.eq('branch_id', effectiveBranchId)\r\n    }\r\n\r\n    const { count: totalVehicles } = await vehicleQuery\r\n\r\n    // Vehicles active today (assigned to a job)\r\n    const today = new Date().toISOString().split('T')[0]\r\n    let activeJobsQuery = supabase\r\n        .from('Jobs_Main')\r\n        .select('Vehicle_Plate')\r\n        .eq('Plan_Date', today)\r\n        .not('Vehicle_Plate', 'is', null)\r\n\r\n    if (effectiveBranchId) {\r\n        activeJobsQuery = activeJobsQuery.eq('Branch_ID', effectiveBranchId)\r\n    }\r\n\r\n    const { data: activeJobs } = await activeJobsQuery\r\n\r\n    const uniqueActiveVehicles = new Set(activeJobs?.map(j => j.Vehicle_Plate)).size\r\n\r\n    // 4.2 On-Time Delivery\r\n    let jobStatsQuery = supabase\r\n        .from('Jobs_Main')\r\n        .select('Job_Status')\r\n    \r\n    if (effectiveBranchId) {\r\n        jobStatsQuery = jobStatsQuery.eq('Branch_ID', effectiveBranchId)\r\n    }\r\n        \r\n    const { data: jobStats } = await jobStatsQuery\r\n        \r\n    const totalJobs = jobStats?.length || 0\r\n    const completedJobs = jobStats?.filter(j => ['Completed', 'Delivered'].includes(j.Job_Status || '')).length || 0\r\n    const onTimeDelivery = totalJobs > 0 ? (completedJobs / totalJobs) * 100 : 0\r\n\r\n    // 4.3 Fuel Efficiency (km/L)\r\n    let activePlates: string[] = []\r\n    if (effectiveBranchId) {\r\n        activePlates = await getBranchPlates(effectiveBranchId)\r\n    }\r\n\r\n    let fuelLogsQuery = supabase\r\n        .from('Fuel_Logs')\r\n        .select('Liters, Odometer, Vehicle_Plate')\r\n        .order('Date_Time', { ascending: true })\r\n\r\n    if (effectiveBranchId) {\r\n        if (activePlates.length > 0) {\r\n            fuelLogsQuery = fuelLogsQuery.in('Vehicle_Plate', activePlates)\r\n        } else {\r\n             fuelLogsQuery = fuelLogsQuery.in('Vehicle_Plate', ['NO_MATCH'])\r\n        }\r\n    }\r\n    \r\n    const { data: fuelLogs } = await fuelLogsQuery\r\n\r\n    let totalDistanceApprox = 0\r\n    let totalFuelUsed = 0\r\n\r\n    if (fuelLogs && fuelLogs.length > 0) {\r\n        // Group by Vehicle\r\n        const vehicleLogs: Record<string, typeof fuelLogs> = {}\r\n        fuelLogs.forEach(log => {\r\n            if (log.Vehicle_Plate && log.Odometer && log.Liters) {\r\n                if (!vehicleLogs[log.Vehicle_Plate]) vehicleLogs[log.Vehicle_Plate] = []\r\n                vehicleLogs[log.Vehicle_Plate].push(log)\r\n            }\r\n        })\r\n\r\n        // Calculate distance for each vehicle\r\n        Object.values(vehicleLogs).forEach(logs => {\r\n            if (logs.length >= 2) {\r\n                const minOdo = logs[0].Odometer\r\n                const maxOdo = logs[logs.length - 1].Odometer\r\n                totalDistanceApprox += (maxOdo - minOdo)\r\n                \r\n                for (let i = 1; i < logs.length; i++) {\r\n                    totalFuelUsed += logs[i].Liters\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    const fuelEfficiency = totalFuelUsed > 0 ? (totalDistanceApprox / totalFuelUsed) : 0\r\n\r\n    return {\r\n        fleet: {\r\n            active: uniqueActiveVehicles || 0,\r\n            total: totalVehicles || 0,\r\n            utilization: totalVehicles ? (uniqueActiveVehicles / totalVehicles) * 100 : 0,\r\n            onTimeDelivery,\r\n            fuelEfficiency\r\n        }\r\n    }\r\n}\r\n\r\n// 5. Job Status Distribution\r\nexport async function getJobStatusDistribution(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    let query = supabase.from('Jobs_Main').select('Job_Status')\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n    if (effectiveBranchId) query = query.eq('Branch_ID', effectiveBranchId)\r\n\r\n    const { data } = await query\r\n\r\n    const distribution: Record<string, number> = {\r\n        'Draft': 0,\r\n        'Pending': 0,\r\n        'Confirmed': 0,\r\n        'In Progress': 0,\r\n        'Delivered': 0,\r\n        'Completed': 0,\r\n        'Cancelled': 0\r\n    }\r\n\r\n    data?.forEach(job => {\r\n        const status = job.Job_Status || 'Draft'\r\n        if (distribution.hasOwnProperty(status)) {\r\n            distribution[status]++\r\n        } else {\r\n            distribution[status] = (distribution[status] || 0) + 1\r\n        }\r\n    })\r\n\r\n    return Object.entries(distribution).map(([name, value]) => ({ name, value }))\r\n}\r\n\r\n// 6. Branch Performance Comparison (Super Admin Only)\r\nexport async function getBranchPerformance(startDate?: string, endDate?: string) {\r\n    const isAdmin = await isSuperAdmin()\r\n    if (!isAdmin) return []\r\n\r\n    const supabase = await createClient()\r\n\r\n    // Get all branches\r\n    const { data: branches } = await supabase.from('master_branches').select('Branch_ID, Branch_Name')\r\n    if (!branches) return []\r\n\r\n    // Fetch jobs for the range\r\n    let query = supabase\r\n        .from('Jobs_Main')\r\n        .select('Branch_ID, Price_Cust_Total, Cost_Driver_Total, Job_Status')\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n\r\n    const { data: jobs } = await query\r\n\r\n    const performance = branches.map(branch => {\r\n        const branchJobs = jobs?.filter(j => j.Branch_ID === branch.Branch_ID) || []\r\n        const revenue = branchJobs.reduce((sum, j) => sum + (j.Price_Cust_Total || 0), 0)\r\n        const driverCost = branchJobs.reduce((sum, j) => sum + (j.Cost_Driver_Total || 0), 0)\r\n        \r\n        return {\r\n            branchId: branch.Branch_ID,\r\n            branchName: branch.Branch_Name,\r\n            revenue,\r\n            jobsCount: branchJobs.length,\r\n            profit: revenue - driverCost // Simple profit (Revenue - Driver Cost)\r\n        }\r\n    })\r\n\r\n    return performance.sort((a, b) => b.revenue - a.revenue)\r\n}\r\n\r\n// 7. Subcontractor vs Internal Fleet Performance\r\nexport async function getSubcontractorPerformance(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    let query = supabase\r\n        .from('Jobs_Main')\r\n        .select('Price_Cust_Total, Cost_Driver_Total, Sub_ID')\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n    if (effectiveBranchId) query = query.eq('Branch_ID', effectiveBranchId)\r\n\r\n    const { data: jobs } = await query\r\n\r\n    const stats = {\r\n        internal: { revenue: 0, cost: 0, count: 0 },\r\n        subcontractor: { revenue: 0, cost: 0, count: 0 }\r\n    }\r\n\r\n    jobs?.forEach(job => {\r\n        const isSub = !!job.Sub_ID\r\n        const target = isSub ? stats.subcontractor : stats.internal\r\n        target.revenue += (job.Price_Cust_Total || 0)\r\n        target.cost += (job.Cost_Driver_Total || 0)\r\n        target.count++\r\n    })\r\n\r\n    return [\r\n        { name: 'รถบริษัท (Internal)', ...stats.internal },\r\n        { name: 'รถซับ (Subcontractor)', ...stats.subcontractor }\r\n    ]\r\n}\r\n\r\n// 8. Growth & Multi-period Comparison\r\nexport async function getExecutiveKPIs(startDate?: string, endDate?: string, branchId?: string) {\r\n    const currentStart = startDate ? new Date(startDate) : subDays(new Date(), 30)\r\n    const currentEnd = endDate ? new Date(endDate) : new Date()\r\n    \r\n    // Calculate duration to find the previous period\r\n    const duration = differenceInDays(currentEnd, currentStart)\r\n    const prevStart = subDays(currentStart, duration + 1)\r\n    const prevEnd = subDays(currentStart, 1)\r\n\r\n    const [currentStats, prevStats] = await Promise.all([\r\n        getFinancialStats(currentStart.toISOString(), currentEnd.toISOString(), branchId),\r\n        getFinancialStats(prevStart.toISOString(), prevEnd.toISOString(), branchId)\r\n    ])\r\n\r\n    const calculateGrowth = (curr: number, prev: number) => {\r\n        if (prev === 0) return curr > 0 ? 100 : 0\r\n        return ((curr - prev) / prev) * 100\r\n    }\r\n\r\n    // Define targets (In a real app, these would come from DB/Settings)\r\n    // Monthly Targets\r\n    const targets = {\r\n        revenue: 250000, \r\n        profitMargin: 15,\r\n        onTimeDelivery: 95\r\n    }\r\n\r\n    return {\r\n        revenue: {\r\n            current: currentStats.revenue,\r\n            previous: prevStats.revenue,\r\n            growth: calculateGrowth(currentStats.revenue, prevStats.revenue),\r\n            target: targets.revenue,\r\n            attainment: (currentStats.revenue / targets.revenue) * 100\r\n        },\r\n        profit: {\r\n            current: currentStats.netProfit,\r\n            previous: prevStats.netProfit,\r\n            growth: calculateGrowth(currentStats.netProfit, prevStats.netProfit),\r\n        },\r\n        margin: {\r\n            current: currentStats.profitMargin,\r\n            previous: prevStats.profitMargin,\r\n            growth: currentStats.profitMargin - prevStats.profitMargin, // Percentage point difference\r\n            target: targets.profitMargin\r\n        }\r\n    }\r\n}\r\n// 9. Route Efficiency (Revenue vs Cost per Route)\r\nexport async function getRouteEfficiency(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    let query = supabase\r\n        .from('Jobs_Main')\r\n        .select('Route_Name, Price_Cust_Total, Cost_Driver_Total')\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n    if (effectiveBranchId) query = query.eq('Branch_ID', effectiveBranchId)\r\n\r\n    const { data: jobs } = await query\r\n\r\n    const routeStats: Record<string, { route: string, revenue: number, cost: number, count: number }> = {}\r\n\r\n    jobs?.forEach(job => {\r\n        const route = job.Route_Name || 'Unknown Route'\r\n        if (!routeStats[route]) {\r\n            routeStats[route] = { route, revenue: 0, cost: 0, count: 0 }\r\n        }\r\n        routeStats[route].revenue += (job.Price_Cust_Total || 0)\r\n        routeStats[route].cost += (job.Cost_Driver_Total || 0)\r\n        routeStats[route].count++\r\n    })\r\n\r\n    return Object.values(routeStats)\r\n        .map(r => ({ ...r, margin: r.revenue > 0 ? ((r.revenue - r.cost) / r.revenue) * 100 : 0 }))\r\n        .sort((a, b) => b.revenue - a.revenue)\r\n}\r\n\r\n// 10. Driver Leaderboard (Efficiency & Volume)\r\nexport async function getDriverLeaderboard(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    let query = supabase\r\n        .from('Jobs_Main')\r\n        .select('Driver_Name, Price_Cust_Total, Cost_Driver_Total, Job_Status, Plan_Date, Actual_Delivery_Time')\r\n        .not('Driver_Name', 'is', null)\r\n\r\n    if (startDate) query = query.gte('Plan_Date', startDate)\r\n    if (endDate) query = query.lte('Plan_Date', endDate)\r\n    if (effectiveBranchId) query = query.eq('Branch_ID', effectiveBranchId)\r\n\r\n    const { data: jobs } = await query\r\n\r\n    const driverStats: Record<string, { \r\n        name: string, \r\n        revenue: number, \r\n        completedJobs: number, \r\n        totalJobs: number,\r\n        onTimeJobs: number,\r\n        lateJobs: number\r\n    }> = {}\r\n\r\n    jobs?.forEach(job => {\r\n        const name = job.Driver_Name!\r\n        if (!driverStats[name]) {\r\n            driverStats[name] = { name, revenue: 0, completedJobs: 0, totalJobs: 0, onTimeJobs: 0, lateJobs: 0 }\r\n        }\r\n        \r\n        const isCompleted = ['Completed', 'Delivered'].includes(job.Job_Status || '')\r\n        if (isCompleted) {\r\n            driverStats[name].revenue += (job.Price_Cust_Total || 0)\r\n            driverStats[name].completedJobs++\r\n            \r\n            // On-time check\r\n            if (job.Actual_Delivery_Time && job.Plan_Date) {\r\n                const actualDate = job.Actual_Delivery_Time.split('T')[0]\r\n                if (actualDate === job.Plan_Date) {\r\n                    driverStats[name].onTimeJobs++\r\n                } else {\r\n                    driverStats[name].lateJobs++\r\n                }\r\n            } else {\r\n                // Fallback: Default to on-time for historical\r\n                driverStats[name].onTimeJobs++\r\n            }\r\n        }\r\n        driverStats[name].totalJobs++\r\n    })\r\n\r\n    return Object.values(driverStats)\r\n        .map(d => ({ \r\n            ...d, \r\n            successRate: d.totalJobs > 0 ? (d.completedJobs / d.totalJobs) * 100 : 0,\r\n            onTimeRate: d.completedJobs > 0 ? (d.onTimeJobs / d.completedJobs) * 100 : 0\r\n        }))\r\n        .sort((a, b) => b.revenue - a.revenue)\r\n        .slice(0, 10)\r\n}\r\n\r\n// 11. Regional / Branch Deep-Dive (Comparison with detailed metrics)\r\nexport async function getRegionalDeepDive(startDate?: string, endDate?: string) {\r\n    const performance = await getBranchPerformance(startDate, endDate)\r\n    \r\n    // Enrich with growth if possible (Comparing current period vs previous)\r\n    const currentStart = startDate ? new Date(startDate) : subDays(new Date(), 30)\r\n    const currentEnd = endDate ? new Date(endDate) : new Date()\r\n    const duration = differenceInDays(currentEnd, currentStart)\r\n    const prevStart = subDays(currentStart, duration + 1)\r\n    const prevEnd = subDays(currentStart, 1)\r\n\r\n    const prevPerformance = await getBranchPerformance(prevStart.toISOString(), prevEnd.toISOString())\r\n\r\n    return performance.map(curr => {\r\n        const prev = prevPerformance.find(p => p.branchId === curr.branchId)\r\n        const revenueGrowth = prev && prev.revenue > 0 ? ((curr.revenue - prev.revenue) / prev.revenue) * 100 : 0\r\n        \r\n        return {\r\n            ...curr,\r\n            revenueGrowth,\r\n            previousRevenue: prev?.revenue || 0\r\n        }\r\n    })\r\n}\r\n// 12. Vehicle Profitability Breakdown\r\nexport async function getVehicleProfitability(startDate?: string, endDate?: string, branchId?: string) {\r\n    const supabase = await createClient()\r\n    \r\n    // Default to current month\r\n    const now = new Date()\r\n    const firstDay = startDate || new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0]\r\n    const lastDay = endDate || new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0]\r\n\r\n    // Determine effective branch\r\n    const userBranchId = await getUserBranchId()\r\n    const targetBranchId = (branchId && branchId !== 'All') ? branchId : userBranchId\r\n    const effectiveBranchId = targetBranchId === 'All' ? null : targetBranchId\r\n\r\n    // 1. Get Revenue & Driver Cost per Vehicle\r\n    let jobsQuery = supabase\r\n        .from('Jobs_Main')\r\n        .select('Vehicle_Plate, Price_Cust_Total, Cost_Driver_Total')\r\n        .gte('Plan_Date', firstDay)\r\n        .lte('Plan_Date', lastDay)\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n        .not('Vehicle_Plate', 'is', null)\r\n\r\n    if (effectiveBranchId) {\r\n        jobsQuery = jobsQuery.eq('Branch_ID', effectiveBranchId)\r\n    }\r\n\r\n    const { data: jobs } = await jobsQuery\r\n\r\n    // 2. Get Fuel Cost per Vehicle\r\n    let fuelQuery = supabase\r\n        .from('Fuel_Logs')\r\n        .select('Vehicle_Plate, Price_Total')\r\n        .gte('Date_Time', `${firstDay}T00:00:00`)\r\n        .lte('Date_Time', `${lastDay}T23:59:59`)\r\n        .eq('Status', 'Approved')\r\n\r\n    const { data: fuel } = await fuelQuery\r\n\r\n    // 3. Get Maintenance Cost per Vehicle\r\n    let maintenanceQuery = supabase\r\n        .from('Repair_Tickets')\r\n        .select('Vehicle_Plate, Cost_Total')\r\n        .gte('Date_Report', `${firstDay}T00:00:00`)\r\n        .lte('Date_Report', `${lastDay}T23:59:59`)\r\n        .eq('Status', 'Completed')\r\n\r\n    const { data: maintenance } = await maintenanceQuery\r\n\r\n    const stats: Record<string, { plate: string, revenue: number, driverCost: number, fuelCost: number, maintenanceCost: number, totalCost: number, netProfit: number }> = {}\r\n\r\n    jobs?.forEach(job => {\r\n        const plate = job.Vehicle_Plate!\r\n        if (!stats[plate]) {\r\n            stats[plate] = { plate, revenue: 0, driverCost: 0, fuelCost: 0, maintenanceCost: 0, totalCost: 0, netProfit: 0 }\r\n        }\r\n        stats[plate].revenue += (job.Price_Cust_Total || 0)\r\n        stats[plate].driverCost += (job.Cost_Driver_Total || 0)\r\n    })\r\n\r\n    fuel?.forEach(f => {\r\n        const plate = f.Vehicle_Plate!\r\n        if (!stats[plate]) {\r\n            stats[plate] = { plate, revenue: 0, driverCost: 0, fuelCost: 0, maintenanceCost: 0, totalCost: 0, netProfit: 0 }\r\n        }\r\n        stats[plate].fuelCost += (f.Price_Total || 0)\r\n    })\r\n\r\n    maintenance?.forEach(m => {\r\n        const plate = m.Vehicle_Plate!\r\n        if (!stats[plate]) {\r\n            stats[plate] = { plate, revenue: 0, driverCost: 0, fuelCost: 0, maintenanceCost: 0, totalCost: 0, netProfit: 0 }\r\n        }\r\n        stats[plate].maintenanceCost += (m.Cost_Total || 0)\r\n    })\r\n\r\n    return Object.values(stats).map(s => {\r\n        const totalCost = s.driverCost + s.fuelCost + s.maintenanceCost\r\n        return {\r\n            ...s,\r\n            totalCost,\r\n            netProfit: s.revenue - totalCost\r\n        }\r\n    }).sort((a, b) => b.netProfit - a.netProfit)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\billing-analytics.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'apQuery' is never reassigned. Use 'const' instead.","line":122,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":122,"endColumn":14,"fix":{"range":[3845,4562],"text":"const apQuery = supabase\r\n    .from('Driver_Payments')\r\n    .select('Total_Amount, Status, Branch_ID') // Assuming Branch_ID exists or linked via jobs? \r\n    // Driver_Payments might not have Branch_ID directly in some schemas. \r\n    // If it doesn't, we might skip branch filter for AP or need join. \r\n    // Based on billing.ts, createDriverPayment doesn't seem to insert Branch_ID explicitly?\r\n    // Let's assume for now we might miss Branch_ID or it exists. \r\n    // Safest is to try select. If error, we'll know.\r\n    // Update: billing.ts doesn't show Branch_ID in Payment interface. \r\n    // We will fetch widely for now or try to filter if possible.\r\n    .neq('Status', 'Cancelled')\r\n    .neq('Status', 'Paid')"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from '@/lib/permissions'\r\nimport { cookies } from 'next/headers'\r\n\r\nexport type BillingAnalytics = {\r\n  accountsReceivable: {\r\n    totalOutstanding: number\r\n    invoiceCount: number\r\n    aging: {\r\n      '0-30': number\r\n      '31-60': number\r\n      '61-90': number\r\n      '90+': number\r\n    }\r\n    recentUnpaid: {\r\n      id: string\r\n      customer: string\r\n      amount: number\r\n      daysOverdue: number\r\n    }[]\r\n  }\r\n  accountsPayable: {\r\n    totalOutstanding: number\r\n    paymentCount: number\r\n  }\r\n  collectionRate: number // Percentage\r\n  revenueVsPayout: {\r\n    month: string\r\n    revenue: number\r\n    payout: number\r\n  }[]\r\n}\r\n\r\nexport async function getBillingAnalytics(\r\n  startDate?: string, \r\n  endDate?: string, \r\n  branchId?: string\r\n): Promise<BillingAnalytics> {\r\n  const supabase = await createClient()\r\n  const userBranchId = await getUserBranchId()\r\n  const isAdmin = await isSuperAdmin()\r\n  const cookieStore = await cookies()\r\n  const selectedBranch = cookieStore.get('selectedBranch')?.value\r\n\r\n  // Determine effective branch ID\r\n  let effectiveBranchId = branchId\r\n  if (!effectiveBranchId) {\r\n    if (isAdmin && selectedBranch && selectedBranch !== 'All') {\r\n      effectiveBranchId = selectedBranch\r\n    } else if (!isAdmin) {\r\n      effectiveBranchId = userBranchId || undefined\r\n    }\r\n  }\r\n\r\n  const now = new Date()\r\n  const dayMs = 86400000\r\n\r\n  // 1. Fetch Accounts Receivable (Billing Notes)\r\n  // We want ALL outstanding invoices regardless of date range for the Balance Sheet view\r\n  // But for Collection Rate, we might filter by date. \r\n  // For the dashboard, \"Outstanding\" usually means everything currently unpaid.\r\n  \r\n  let arQuery = supabase\r\n    .from('Billing_Notes')\r\n    .select('Billing_Note_ID, Customer_Name, Total_Amount, Status, Due_Date, Billing_Date, Branch_ID')\r\n    .neq('Status', 'Cancelled')\r\n    .neq('Status', 'Paid') // Only unpaid\r\n  \r\n  if (effectiveBranchId) {\r\n    arQuery = arQuery.eq('Branch_ID', effectiveBranchId)\r\n  }\r\n\r\n  const { data: unpaidNotes, error: arError } = await arQuery\r\n\r\n  if (arError) console.error('Error fetching AR:', arError)\r\n\r\n  const receivables = unpaidNotes || []\r\n  const totalAr = receivables.reduce((sum, n) => sum + (n.Total_Amount || 0), 0)\r\n  \r\n  // Calculate Aging\r\n  const aging = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0 }\r\n  const recentUnpaid: BillingAnalytics['accountsReceivable']['recentUnpaid'] = []\r\n\r\n  for (const note of receivables) {\r\n    const dueDate = new Date(note.Due_Date || note.Billing_Date || new Date())\r\n    const diffTime = now.getTime() - dueDate.getTime()\r\n    const diffDays = Math.ceil(diffTime / dayMs)\r\n    \r\n    // Categorize by overdue days. Negative means not yet due (0-30 bucket or separate \"Current\"?)\r\n    // Standard aging usually categorizes by \"Days Past Due\". \r\n    // If not due yet, it goes into \"Current\" or 0-30.\r\n    \r\n    // Let's use simple logic:\r\n    // < 0 days (Future): 0-30\r\n    // 0-30 days: 0-30\r\n    // 31-60 days: 31-60\r\n    // ...\r\n    \r\n    const overdue = diffDays > 0 ? diffDays : 0\r\n    \r\n    if (overdue <= 30) aging['0-30'] += (note.Total_Amount || 0)\r\n    else if (overdue <= 60) aging['31-60'] += (note.Total_Amount || 0)\r\n    else if (overdue <= 90) aging['61-90'] += (note.Total_Amount || 0)\r\n    else aging['90+'] += (note.Total_Amount || 0)\r\n\r\n    if (recentUnpaid.length < 5) {\r\n      recentUnpaid.push({\r\n        id: note.Billing_Note_ID,\r\n        customer: note.Customer_Name || 'Unknown',\r\n        amount: note.Total_Amount || 0,\r\n        daysOverdue: diffDays\r\n      })\r\n    }\r\n  }\r\n  \r\n  // Sort recent unpaid by days overdue desc\r\n  recentUnpaid.sort((a, b) => b.daysOverdue - a.daysOverdue)\r\n\r\n  // 2. Fetch Accounts Payable (Driver Payments)\r\n  let apQuery = supabase\r\n    .from('Driver_Payments')\r\n    .select('Total_Amount, Status, Branch_ID') // Assuming Branch_ID exists or linked via jobs? \r\n    // Driver_Payments might not have Branch_ID directly in some schemas. \r\n    // If it doesn't, we might skip branch filter for AP or need join. \r\n    // Based on billing.ts, createDriverPayment doesn't seem to insert Branch_ID explicitly?\r\n    // Let's assume for now we might miss Branch_ID or it exists. \r\n    // Safest is to try select. If error, we'll know.\r\n    // Update: billing.ts doesn't show Branch_ID in Payment interface. \r\n    // We will fetch widely for now or try to filter if possible.\r\n    .neq('Status', 'Cancelled')\r\n    .neq('Status', 'Paid')\r\n  \r\n  // If Driver_Payments has Branch_ID:\r\n  // apQuery = apQuery.eq('Branch_ID', effectiveBranchId) \r\n  // NOTE: Schema check didn't confirm Branch_ID on Driver_Payments. \r\n  // Let's assume we can't filter AP by branch easily without join. \r\n  // For 'All' view it's fine. For Branch view it might be inaccurate if shared drivers.\r\n  \r\n  const { data: unpaidPayments } = await apQuery\r\n  const payables = unpaidPayments || []\r\n  \r\n  // Filter by branch manually if necessary/possible (complex without join). \r\n  // For MVP, we'll calculate total.\r\n  const totalAp = payables.reduce((sum, p) => sum + (p.Total_Amount || 0), 0)\r\n\r\n  // 3. Collection Rate (Paid / (Paid + Unpaid)) for the selected period\r\n  // If no date selected, default to last 30 days\r\n  const start = startDate ? new Date(startDate) : new Date(now.getTime() - 30 * dayMs)\r\n  const end = endDate ? new Date(endDate) : now\r\n  \r\n  let collectionQuery = supabase\r\n    .from('Billing_Notes')\r\n    .select('Total_Amount, Status')\r\n    .gte('Billing_Date', start.toISOString())\r\n    .lte('Billing_Date', end.toISOString())\r\n    .neq('Status', 'Cancelled')\r\n\r\n  if (effectiveBranchId) {\r\n    collectionQuery = collectionQuery.eq('Branch_ID', effectiveBranchId)\r\n  }\r\n  \r\n  const { data: periodNotes } = await collectionQuery\r\n  const totalPeriod = (periodNotes || []).reduce((s, n) => s + (n.Total_Amount || 0), 0)\r\n  const paidPeriod = (periodNotes || []).filter(n => n.Status === 'Paid').reduce((s, n) => s + (n.Total_Amount || 0), 0)\r\n  \r\n  const collectionRate = totalPeriod > 0 ? (paidPeriod / totalPeriod) * 100 : 0\r\n\r\n  // 4. Monthly Revenue vs Payout Trend (Last 6 months)\r\n  // This requires aggregation. We can reuse getFinancialStats logic or do simple fetch.\r\n  // Let's do a simple fetch of last 6 months billing and payments.\r\n  \r\n  const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 5, 1)\r\n  \r\n  // Revenue (Billing Notes)\r\n  let trendRevQuery = supabase\r\n    .from('Billing_Notes')\r\n    .select('Billing_Date, Total_Amount')\r\n    .gte('Billing_Date', sixMonthsAgo.toISOString())\r\n    .neq('Status', 'Cancelled')\r\n    \r\n  if (effectiveBranchId) trendRevQuery = trendRevQuery.eq('Branch_ID', effectiveBranchId)\r\n  const { data: trendRev } = await trendRevQuery\r\n  \r\n  // Payout (Driver Payments)\r\n  const { data: trendPay } = await supabase\r\n    .from('Driver_Payments')\r\n    .select('Payment_Date, Total_Amount')\r\n    .gte('Payment_Date', sixMonthsAgo.toISOString())\r\n    .neq('Status', 'Cancelled')\r\n    \r\n  // Aggregate by month\r\n  const trendMap = new Map<string, { revenue: number, payout: number }>()\r\n  \r\n  // Init last 6 months\r\n  for (let i = 0; i < 6; i++) {\r\n    const d = new Date(now.getFullYear(), now.getMonth() - i, 1)\r\n    const key = d.toISOString().slice(0, 7) // YYYY-MM\r\n    trendMap.set(key, { revenue: 0, payout: 0 })\r\n  }\r\n  \r\n  trendRev?.forEach(n => {\r\n    const key = (n.Billing_Date || '').slice(0, 7)\r\n    if (trendMap.has(key)) {\r\n      const entry = trendMap.get(key)!\r\n      entry.revenue += n.Total_Amount || 0\r\n      trendMap.set(key, entry)\r\n    }\r\n  })\r\n  \r\n  trendPay?.forEach(p => {\r\n    const key = (p.Payment_Date || '').slice(0, 7)\r\n    if (trendMap.has(key)) {\r\n      const entry = trendMap.get(key)!\r\n      entry.payout += p.Total_Amount || 0\r\n      trendMap.set(key, entry)\r\n    }\r\n  })\r\n  \r\n  const revenueVsPayout = Array.from(trendMap.entries())\r\n    .map(([month, data]) => ({ month, ...data }))\r\n    .sort((a, b) => a.month.localeCompare(b.month))\r\n\r\n  return {\r\n    accountsReceivable: {\r\n      totalOutstanding: totalAr,\r\n      invoiceCount: receivables.length,\r\n      aging,\r\n      recentUnpaid: recentUnpaid.slice(0, 5)\r\n    },\r\n    accountsPayable: {\r\n      totalOutstanding: totalAp,\r\n      paymentCount: payables.length,\r\n    },\r\n    collectionRate,\r\n    revenueVsPayout\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\billing.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Billing_Note' is defined but never used.","line":6,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Billing_Note"},"fix":{"range":[210,224],"text":""},"desc":"Remove unused variable \"Billing_Note\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1912,1915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1912,1915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":223,"column":13,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":223,"endColumn":26,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[8176,8189],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":241,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":241,"endColumn":15},{"ruleId":"prefer-const","severity":2,"message":"'customerEmail' is never reassigned. Use 'const' instead.","line":288,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":288,"endColumn":26,"fix":{"range":[10340,10362],"text":"const customerEmail = \"\""}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/utils/supabase/server\"\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\nimport { accountingService } from \"@/services/accounting\"\r\nimport { Job, Billing_Note, Driver_Payment } from \"@/types/database\"\r\n\r\nexport interface BillingNote {\r\n  Billing_Note_ID: string\r\n  Customer_Name: string\r\n  Billing_Date: string\r\n  Due_Date: string | null\r\n  Total_Amount: number\r\n  Status: string\r\n  Created_At: string\r\n  Updated_At: string\r\n  Customer_Email?: string\r\n  Customer_Address?: string\r\n  Customer_Tax_ID?: string\r\n}\r\n\r\nexport async function createBillingNote(\r\n    jobIds: string[], \r\n    customerName: string, \r\n    date: string,\r\n    dueDate?: string\r\n) {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        // 1. Calculate Total Amount\r\n        const { data: jobs, error: jobsError } = await supabase\r\n            .from('Jobs_Main')\r\n            .select('Job_ID, Route_Name, Price_Cust_Total, extra_costs_json, Branch_ID')\r\n            .in('Job_ID', jobIds)\r\n\r\n        if (jobsError) throw new Error(\"Failed to fetch jobs for calculation\")\r\n        \r\n        const totalAmount = jobs?.reduce((sum, job) => {\r\n             const basePrice = job.Price_Cust_Total || 0\r\n             let extra = 0\r\n             \r\n             if (job.extra_costs_json) {\r\n                 try {\r\n                     let costs = job.extra_costs_json\r\n                     if (typeof costs === 'string') {\r\n                        try { costs = JSON.parse(costs) } catch {}\r\n                     }\r\n                     // Handle double stringification if necessary\r\n                     if (typeof costs === 'string') {\r\n                        try { costs = JSON.parse(costs) } catch {}\r\n                     }\r\n                     \r\n                     if (Array.isArray(costs)) {\r\n                         extra = costs.reduce((cHigh: number, c: any) => cHigh + (Number(c.charge_cust) || 0), 0)\r\n                     }\r\n                 } catch (e) {\r\n                     console.error(\"Error parsing extra costs for job\", job, e)\r\n                 }\r\n             }\r\n\r\n             return sum + basePrice + extra\r\n        }, 0) || 0\r\n\r\n        // 2. Generate Billing Note ID (BN-YYYYMM-XXXX)\r\n        const dateObj = new Date()\r\n        const ym = dateObj.toISOString().slice(0, 7).replace('-', '') // 202402\r\n        const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0')\r\n        const billingNoteId = `BN-${ym}-${randomSuffix}`\r\n\r\n        // 3. Insert Billing Note\r\n        // 3. Insert Billing Note\r\n        const userBranchId = await getUserBranchId()\r\n        // Use Branch_ID from the first job if available, otherwise fallback to user's branch\r\n        const branchId = jobs?.[0]?.Branch_ID || userBranchId || 'HQ'\r\n\r\n        const { error: insertError } = await supabase\r\n            .from('Billing_Notes')\r\n            .insert({\r\n                Billing_Note_ID: billingNoteId,\r\n                Customer_Name: customerName,\r\n                Billing_Date: date,\r\n                Due_Date: dueDate || null,\r\n                Total_Amount: totalAmount,\r\n                Status: 'Pending',\r\n                Created_At: new Date().toISOString(),\r\n                Updated_At: new Date().toISOString(),\r\n                Branch_ID: branchId\r\n            })\r\n\r\n        if (insertError) throw insertError\r\n\r\n        // 4. Update Jobs with Billing Note ID\r\n        const { error: updateError } = await supabase\r\n            .from('Jobs_Main')\r\n            .update({ Billing_Note_ID: billingNoteId })\r\n            .in('Job_ID', jobIds)\r\n\r\n        if (updateError) {\r\n             // Rollback (Optional: Delete created billing note if critical)\r\n             console.error(\"Failed to link jobs to billing note\")\r\n             throw updateError\r\n        }\r\n\r\n        // 5. Automatic Sync to Accounting\r\n        try {\r\n            const noteData = {\r\n                Billing_Note_ID: billingNoteId,\r\n                Customer_Name: customerName,\r\n                Billing_Date: date,\r\n                Due_Date: dueDate,\r\n                Total_Amount: totalAmount\r\n            };\r\n            \r\n            // Trigger sync in background\r\n            accountingService.syncBillingNoteToInvoice(noteData, (jobs as unknown as Job[]) || []).then(res => {\r\n                if (!res.success) console.error(\"Auto-sync to accounting failed:\", res.message);\r\n            });\r\n        } catch (e) {\r\n            console.error(\"Error triggering auto-sync:\", e);\r\n        }\r\n\r\n        return { success: true, id: billingNoteId }\r\n\r\n    } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e)\r\n        console.error(\"createBillingNote Error:\", e)\r\n        return { success: false, error: message }\r\n    }\r\n}\r\n\r\nexport async function createDriverPayment(\r\n    jobIds: string[], \r\n    driverName: string, \r\n    date: string\r\n) {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        // 1. Calculate Total Amount\r\n        const { data: jobs, error: jobsError } = await supabase\r\n            .from('Jobs_Main')\r\n            .select('Cost_Driver_Total, Branch_ID')\r\n            .in('Job_ID', jobIds)\r\n\r\n        if (jobsError) throw new Error(\"Failed to fetch jobs for calculation\")\r\n        \r\n        const totalAmount = jobs?.reduce((sum, job) => sum + (job.Cost_Driver_Total || 0), 0) || 0\r\n\r\n        // 2. Generate Driver Payment ID (DP-YYYYMM-XXXX)\r\n        const dateObj = new Date()\r\n        const ym = dateObj.toISOString().slice(0, 7).replace('-', '') // 202402\r\n        const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0')\r\n        const paymentId = `DP-${ym}-${randomSuffix}`\r\n\r\n        // 3. Insert Driver Payment\r\n        const userBranchId = await getUserBranchId()\r\n        // Use Branch_ID from the first job if available, otherwise fallback to user's branch\r\n        const branchId = jobs?.[0]?.Branch_ID || userBranchId || 'HQ'\r\n\r\n        const { error: insertError } = await supabase\r\n            .from('Driver_Payments')\r\n            .insert({\r\n                Driver_Payment_ID: paymentId,\r\n                Driver_Name: driverName,\r\n                Payment_Date: date,\r\n                Total_Amount: totalAmount,\r\n                Status: 'Pending',\r\n                Created_At: new Date().toISOString(),\r\n                Updated_At: new Date().toISOString(),\r\n                Branch_ID: branchId\r\n            })\r\n\r\n        if (insertError) throw insertError\r\n\r\n        // 4. Update Jobs with Driver Payment ID\r\n        const { error: updateError } = await supabase\r\n            .from('Jobs_Main')\r\n            .update({ Driver_Payment_ID: paymentId })\r\n            .in('Job_ID', jobIds)\r\n\r\n        if (updateError) {\r\n             console.error(\"Failed to link jobs to driver payment\")\r\n             throw updateError\r\n        }\r\n\r\n        // 5. Automatic Sync to Accounting\r\n        try {\r\n            const paymentData: Driver_Payment = {\r\n                Driver_Payment_ID: paymentId,\r\n                Driver_Name: driverName,\r\n                Payment_Date: date,\r\n                Total_Amount: totalAmount\r\n            };\r\n            \r\n            // Trigger sync in background\r\n            accountingService.syncDriverPaymentToBill(paymentData, (jobs as unknown as Job[]) || []).then(res => {\r\n                if (!res.success) console.error(\"Auto-sync to accounting (payout) failed:\", res.message);\r\n            });\r\n        } catch (e) {\r\n            console.error(\"Error triggering auto-sync (payout):\", e);\r\n        }\r\n\r\n        return { success: true, id: paymentId }\r\n\r\n    } catch {\r\n        console.error(\"createDriverPayment Error\")\r\n        return { success: false, error: \"เกิดข้อผิดพลาดในการบันทึกข้อมูล\" }\r\n    }\r\n}\r\n\r\nexport async function getBillingNotes() {\r\n    try {\r\n        const supabase = await createClient()\r\n        \r\n        // Filter by Branch\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n        \r\n        let query = supabase.from('Billing_Notes').select('*')\r\n        \r\n        if (branchId && !isAdmin) {\r\n            // @ts-ignore\r\n            // Allow seeing notes for their branch OR legacy notes with no branch assigned\r\n            query = query.or(`Branch_ID.eq.${branchId},Branch_ID.is.null`)\r\n        } else if (!isAdmin && !branchId) {\r\n            console.warn(\"getBillingNotes: No branch ID and not admin. Returning empty.\")\r\n            return []\r\n        }\r\n        \r\n        console.log(`getBillingNotes: Admin=${isAdmin}, Branch=${branchId}`)\r\n\r\n        const { data, error } = await query\r\n            .order('Created_At', { ascending: false })\r\n        \r\n        if (error) {\r\n            console.error(\"Error fetching billing notes:\", error)\r\n            return []\r\n        }\r\n        return data as BillingNote[]\r\n    } catch (e) {\r\n        return []\r\n    }\r\n}\r\n\r\n// Interface moved to top of file\r\n\r\n// ... (in createBillingNote, createDriverPayment, getBillingNotes - unchanged)\r\n\r\nexport async function getBillingNoteByIdWithJobs(id: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        \r\n        // 1. Get Billing Note\r\n        const { data: note, error: noteError } = await supabase\r\n            .from('Billing_Notes')\r\n            .select('*')\r\n            .eq('Billing_Note_ID', id)\r\n            .single()\r\n        \r\n        if (noteError) throw noteError\r\n\r\n        // 2. Get Associated Jobs\r\n        const { data: jobs, error: jobsError } = await supabase\r\n            .from('Jobs_Main')\r\n            .select('*, extra_costs_json')\r\n            .eq('Billing_Note_ID', id)\r\n        \r\n        if (jobsError) throw jobsError\r\n\r\n        // 3. Get Company Profile\r\n        const { data: profileData } = await supabase\r\n            .from('System_Settings')\r\n            .select('value')\r\n            .eq('key', 'company_profile')\r\n            .single()\r\n\r\n        let companyProfile = null\r\n        if (profileData?.value) {\r\n            try {\r\n                companyProfile = typeof profileData.value === 'string' ? JSON.parse(profileData.value) : profileData.value\r\n            } catch (e) {\r\n                console.error(\"Error parsing company profile:\", e)\r\n            }\r\n        }\r\n\r\n        // 4. Get Customer Details\r\n        let customerEmail = \"\"\r\n        let customerAddress = \"\"\r\n        let customerTaxId = \"\"\r\n\r\n        if (note && note.Customer_Name) {\r\n            // Note: Email is not in Master_Customers schema provided by user.\r\n            const { data: customer, error: custError } = await supabase\r\n                .from('Master_Customers')\r\n                .select('Address, Tax_ID') \r\n                .eq('Customer_Name', note.Customer_Name)\r\n                .limit(1) // Safely handle duplicates by taking the first one\r\n                .maybeSingle()\r\n            \r\n            if (custError) {\r\n                console.error(\"Error fetching Customer for Billing:\", custError)\r\n            }\r\n\r\n            if (customer) {\r\n                // customerEmail = customer.Email // Column doesn't exist\r\n                customerAddress = customer.Address\r\n                customerTaxId = customer.Tax_ID\r\n            } else {\r\n                console.warn(`Customer '${note.Customer_Name}' not found in Master_Customers`)\r\n            }\r\n        }\r\n\r\n        const billingNoteWithDetails: BillingNote = {\r\n            ...note as BillingNote,\r\n            Customer_Email: customerEmail,\r\n            Customer_Address: customerAddress,\r\n            Customer_Tax_ID: customerTaxId\r\n        }\r\n\r\n        return { note: billingNoteWithDetails, jobs: jobs || [], company: companyProfile }\r\n\r\n    } catch (e) {\r\n        console.error(\"Error fetching billing note details:\", e)\r\n        return null\r\n    }\r\n}\r\n\r\nexport interface DriverPayment {\r\n    Driver_Payment_ID: string\r\n    Driver_Name: string\r\n    Payment_Date: string\r\n    Total_Amount: number\r\n    Status: string\r\n    Created_At: string\r\n    Updated_At: string\r\n}\r\n\r\nexport async function getDriverPayments() {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        // Filter by Branch\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n\r\n        let query = supabase.from('Driver_Payments').select('*')\r\n\r\n        if (branchId && !isAdmin) {\r\n            query = query.or(`Branch_ID.eq.${branchId},Branch_ID.is.null`)\r\n        } else if (!isAdmin && !branchId) {\r\n            return []\r\n        }\r\n\r\n        const { data, error } = await query\r\n            .order('Created_At', { ascending: false })\r\n        \r\n        if (error) {\r\n            console.error(\"Error fetching driver payments:\", error)\r\n            return []\r\n        }\r\n        return data as DriverPayment[]\r\n    } catch {\r\n        return []\r\n    }\r\n}\r\n\r\nexport async function getDriverPaymentByIdWithJobs(id: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        \r\n        // 1. Get Driver Payment\r\n        const { data: payment, error: paymentError } = await supabase\r\n            .from('Driver_Payments')\r\n            .select('*')\r\n            .eq('Driver_Payment_ID', id)\r\n            .single()\r\n        \r\n        if (paymentError) throw paymentError\r\n\r\n        // 2. Get Associated Jobs\r\n        const { data: jobs, error: jobsError } = await supabase\r\n            .from('Jobs_Main')\r\n            .select('*, extra_costs_json')\r\n            .eq('Driver_Payment_ID', id)\r\n        \r\n        if (jobsError) throw jobsError\r\n\r\n        // 3. Get Company Profile\r\n        const { data: profileData } = await supabase\r\n            .from('System_Settings')\r\n            .select('value')\r\n            .eq('key', 'company_profile')\r\n            .single()\r\n\r\n        let companyProfile = null\r\n        if (profileData?.value) {\r\n            try {\r\n                companyProfile = typeof profileData.value === 'string' ? JSON.parse(profileData.value) : profileData.value\r\n            } catch (e) {\r\n                console.error(\"Error parsing company profile:\", e)\r\n            }\r\n        }\r\n\r\n        // 4. Get Payee Details (Bank Info)\r\n        // Check if Driver_Name is a Subcontractor or Driver\r\n        let bankInfo = {\r\n            Bank_Name: \"\",\r\n            Bank_Account_No: \"\",\r\n            Bank_Account_Name: \"\"\r\n        }\r\n\r\n        // Try as Individual Driver first\r\n        const { data: driver } = await supabase\r\n            .from('Master_Drivers')\r\n            .select('Bank_Name, Bank_Account_No, Bank_Account_Name')\r\n            .eq('Driver_Name', payment.Driver_Name)\r\n            .maybeSingle()\r\n        \r\n        if (driver?.Bank_Account_No) {\r\n            bankInfo = driver\r\n        } else {\r\n            // Try as Subcontractor\r\n            const { data: sub } = await supabase\r\n                .from('Subcontractors')\r\n                .select('Bank_Name, Bank_Account_No, Bank_Account_Name')\r\n                .eq('Sub_Name', payment.Driver_Name)\r\n                .maybeSingle()\r\n            if (sub) bankInfo = sub\r\n        }\r\n\r\n        return { \r\n            payment: payment as DriverPayment, \r\n            jobs: jobs || [], \r\n            company: companyProfile,\r\n            bankInfo\r\n        }\r\n\r\n    } catch (e) {\r\n        console.error(\"Error fetching driver payment details:\", e)\r\n        return null\r\n    }\r\n}\r\n\r\nexport async function updateBillingNoteStatus(id: string, status: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        const { error } = await supabase\r\n            .from('Billing_Notes')\r\n            .update({ \r\n                Status: status,\r\n                Updated_At: new Date().toISOString()\r\n            })\r\n            .eq('Billing_Note_ID', id)\r\n\r\n        if (error) throw error\r\n        return { success: true }\r\n    } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e)\r\n        console.error(\"updateBillingNoteStatus Error:\", e)\r\n        return { success: false, error: message }\r\n    }\r\n}\r\n\r\nexport async function updateDriverPaymentStatus(id: string, status: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        const { error } = await supabase\r\n            .from('Driver_Payments')\r\n            .update({ \r\n                Status: status,\r\n                Updated_At: new Date().toISOString()\r\n            })\r\n            .eq('Driver_Payment_ID', id)\r\n\r\n        if (error) throw error\r\n        return { success: true }\r\n    } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e)\r\n        console.error(\"updateDriverPaymentStatus Error:\", e)\r\n        return { success: false, error: message }\r\n    }\r\n}\r\n\r\nexport async function recallBillingNote(id: string) {\r\n    try {\r\n        const isAdmin = await isSuperAdmin()\r\n        if (!isAdmin) throw new Error(\"Only SuperAdmins can recall billing notes\")\r\n\r\n        const supabase = await createClient()\r\n\r\n        // 1. Unlink jobs\r\n        const { error: unlinkError } = await supabase\r\n            .from('Jobs_Main')\r\n            .update({ Billing_Note_ID: null })\r\n            .eq('Billing_Note_ID', id)\r\n\r\n        if (unlinkError) throw unlinkError\r\n\r\n        // 2. Delete billing note\r\n        const { error: deleteError } = await supabase\r\n            .from('Billing_Notes')\r\n            .delete()\r\n            .eq('Billing_Note_ID', id)\r\n\r\n        if (deleteError) throw deleteError\r\n\r\n        return { success: true }\r\n    } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e)\r\n        console.error(\"recallBillingNote Error:\", e)\r\n        return { success: false, error: message }\r\n    }\r\n}\r\n\r\nexport async function recallDriverPayment(id: string) {\r\n    try {\r\n        const isAdmin = await isSuperAdmin()\r\n        if (!isAdmin) throw new Error(\"Only SuperAdmins can recall payments\")\r\n\r\n        const supabase = await createClient()\r\n\r\n        // 1. Unlink jobs\r\n        const { error: unlinkError } = await supabase\r\n            .from('Jobs_Main')\r\n            .update({ Driver_Payment_ID: null })\r\n            .eq('Driver_Payment_ID', id)\r\n\r\n        if (unlinkError) throw unlinkError\r\n\r\n        // 2. Delete payment\r\n        const { error: deleteError } = await supabase\r\n            .from('Driver_Payments')\r\n            .delete()\r\n            .eq('Driver_Payment_ID', id)\r\n\r\n        if (deleteError) throw deleteError\r\n\r\n        return { success: true }\r\n    } catch (e: unknown) {\r\n        const message = e instanceof Error ? e.message : String(e)\r\n        console.error(\"recallDriverPayment Error:\", e)\r\n        return { success: false, error: message }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\branches.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\chat.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\customers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\debug_schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\drivers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":305,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":305,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9816,9819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9816,9819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\n\r\n// Type matching actual Supabase schema\r\nexport type Driver = {\r\n  Driver_ID: string\r\n  Driver_Name: string | null\r\n  Role: string | null\r\n  Mobile_No: string | null\r\n  Line_User_ID: string | null\r\n  Password: string | null\r\n  Vehicle_Plate: string | null\r\n  Vehicle_Type: string | null\r\n  Max_Weight_kg: number | null\r\n  Max_Volume_cbm: number | null\r\n  Insurance_Expiry: string | null\r\n  Tax_Expiry: string | null\r\n  Act_Expiry: string | null\r\n  Current_Mileage: number | null\r\n  Active_Status: string | null\r\n  License_Expiry: string | null\r\n  Bank_Name?: string | null\r\n  Bank_Account_No?: string | null\r\n  Bank_Account_Name?: string | null\r\n  Sub_ID?: string | null\r\n  Show_Price_Default?: boolean | null\r\n  Branch_ID?: string | null\r\n}\r\n\r\n// Get all drivers from Master_Drivers table\r\nexport async function getAllDriversFromTable(): Promise<Driver[]> {\r\n  try {\r\n    const supabase = await createClient()\r\n    let dbQuery = supabase.from('Master_Drivers').select('*')\r\n    \r\n    // Filter by Branch\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n\r\n    if (branchId && branchId !== 'All') {\r\n        dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n    if (error) return []\r\n    return data || []\r\n  } catch {\r\n    return []\r\n  }\r\n}\r\n\r\n// Get driver by ID\r\nexport async function getDriverById(id: string): Promise<Driver | null> {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('Master_Drivers')\r\n      .select('*')\r\n      .eq('Driver_ID', id)\r\n      .single()\r\n    \r\n    if (error) return null\r\n    return data\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n// Create driver\r\nexport async function createDriver(driverData: Partial<Driver>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('Master_Drivers')\r\n      .insert({\r\n        Driver_ID: driverData.Driver_ID || `DRV-${Date.now()}`,\r\n        Driver_Name: driverData.Driver_Name,\r\n        Mobile_No: driverData.Mobile_No,\r\n        Role: driverData.Role || 'Driver',\r\n        Vehicle_Plate: driverData.Vehicle_Plate,\r\n        Vehicle_Type: driverData.Vehicle_Type,\r\n        Password: driverData.Password,\r\n        Active_Status: driverData.Active_Status || 'Active',\r\n        License_Expiry: driverData.License_Expiry,\r\n        Branch_ID: driverData.Branch_ID || await getUserBranchId()\r\n      })\r\n      .select()\r\n      .single()\r\n    \r\n    if (error) return { success: false, error }\r\n    return { success: true, data }\r\n  } catch (e) {\r\n    return { success: false, error: e }\r\n  }\r\n}\r\n\r\n// Update driver\r\nexport async function updateDriver(id: string, driverData: Partial<Driver>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('Master_Drivers')\r\n      .update({\r\n        Driver_Name: driverData.Driver_Name,\r\n        Mobile_No: driverData.Mobile_No,\r\n        Role: driverData.Role,\r\n        Vehicle_Plate: driverData.Vehicle_Plate,\r\n        Vehicle_Type: driverData.Vehicle_Type,\r\n        Password: driverData.Password,\r\n        Active_Status: driverData.Active_Status,\r\n        License_Expiry: driverData.License_Expiry\r\n      })\r\n      .eq('Driver_ID', id)\r\n      .select()\r\n      .single()\r\n    \r\n    if (error) return { success: false, error }\r\n    return { success: true, data }\r\n  } catch (e) {\r\n    return { success: false, error: e }\r\n  }\r\n}\r\n\r\n// Delete driver\r\nexport async function deleteDriver(id: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { error } = await supabase\r\n      .from('Master_Drivers')\r\n      .delete()\r\n      .eq('Driver_ID', id)\r\n    \r\n    if (error) return { success: false, error }\r\n    return { success: true }\r\n  } catch (e) {\r\n    return { success: false, error: e }\r\n  }\r\n}\r\n\r\n// ดึงรายชื่อคนขับที่ Active\r\nexport async function getActiveDrivers() {\r\n  try {\r\n    const supabase = await createClient()\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n\r\n    let queryBuilder = supabase\r\n      .from('Master_Drivers')\r\n      .select('*')\r\n      .eq('Active_Status', 'Active')\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        queryBuilder = queryBuilder.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data, error } = await queryBuilder.limit(10)\r\n    \r\n    if (error) return []\r\n    return data || []\r\n  } catch {\r\n    return []\r\n  }\r\n}\r\n\r\n// Alias for planning page compatibility\r\nexport async function getAllDrivers(page?: number, limit?: number, query?: string, providedBranchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    let queryBuilder = supabase.from('Master_Drivers').select('*', { count: 'exact' })\r\n    \r\n    const isAdmin = await isSuperAdmin()\r\n    const branchId = providedBranchId || await getUserBranchId()\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        queryBuilder = queryBuilder.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return { data: [], count: 0 }\r\n    }\r\n    \r\n    if (query) {\r\n      queryBuilder = queryBuilder.or(`Driver_Name.ilike.%${query}%,Mobile_No.ilike.%${query}%,Driver_ID.ilike.%${query}%`)\r\n    }\r\n    \r\n    if (page && limit) {\r\n      const from = (page - 1) * limit\r\n      const to = from + limit - 1\r\n      queryBuilder = queryBuilder.range(from, to)\r\n    }\r\n    \r\n    const { data, error, count } = await queryBuilder\r\n    if (error) return { data: [], count: 0 }\r\n    return { data: data || [], count: count || 0 }\r\n  } catch {\r\n    return { data: [], count: 0 }\r\n  }\r\n}\r\n\r\n// Get driver stats for dashboard\r\nexport async function getDriverStats(providedBranchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    let query = supabase.from('Master_Drivers').select('Driver_ID, Role')\r\n\r\n    const isAdmin = await isSuperAdmin()\r\n    const branchId = providedBranchId || await getUserBranchId()\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        query = query.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return { total: 0, active: 0, onJob: 0 }\r\n    }\r\n\r\n    const { data, error } = await query\r\n    if (error) return { total: 0, active: 0, onJob: 0 }\r\n    \r\n    const total = data?.length || 0\r\n    return { total, active: total, onJob: Math.floor(total * 0.3) }\r\n  } catch {\r\n    return { total: 0, active: 0, onJob: 0 }\r\n  }\r\n}\r\n\r\n// คำนวณคะแนนคนขับ\r\nexport async function getDriverScore(driverId: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data: jobs, error } = await supabase\r\n      .from('Jobs_Main')\r\n      .select('Job_Status, Plan_Date')\r\n      .eq('Driver_ID', driverId)\r\n      .gte('Plan_Date', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())\r\n\r\n    if (error || !jobs) return { totalScore: 0, onTimeScore: 0, safetyScore: 0, acceptanceScore: 0 }\r\n\r\n    const totalJobs = jobs.length\r\n    if (totalJobs === 0) return { totalScore: 100, onTimeScore: 100, safetyScore: 100, acceptanceScore: 100 }\r\n\r\n    const cancelled = jobs.filter(j => j.Job_Status === 'Cancelled').length\r\n    const acceptanceRate = ((totalJobs - cancelled) / totalJobs) * 100\r\n    const finishedJobs = jobs.filter(j => ['Completed', 'Delivered', 'Failed'].includes(j.Job_Status || ''))\r\n    const successJobs = jobs.filter(j => ['Completed', 'Delivered'].includes(j.Job_Status || ''))\r\n    const onTimeRate = finishedJobs.length > 0 ? (successJobs.length / finishedJobs.length) * 100 : 100\r\n    const totalScore = (onTimeRate * 0.4) + (100 * 0.3) + (acceptanceRate * 0.3)\r\n\r\n    return {\r\n        totalScore: Math.round(totalScore),\r\n        onTimeScore: Math.round(onTimeRate),\r\n        safetyScore: 100,\r\n        acceptanceScore: Math.round(acceptanceRate)\r\n    }\r\n  } catch {\r\n    return { totalScore: 0, onTimeScore: 0, safetyScore: 0, acceptanceScore: 0 }\r\n  }\r\n}\r\n\r\n// Get driver compliance stats\r\nexport async function getDriverComplianceStats(branchId?: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        let query = supabase.from('Master_Drivers').select('License_Expiry')\r\n\r\n        const userBranchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n        const targetBranchId = isAdmin ? (branchId && branchId !== 'All' ? branchId : null) : userBranchId\r\n\r\n        if (targetBranchId) {\r\n            query = query.eq('Branch_ID', targetBranchId)\r\n        } else if (!isAdmin && !userBranchId) {\r\n            return { valid: 0, expiring: 0, expired: 0, missing: 0 }\r\n        }\r\n\r\n        const { data, error } = await query\r\n        if (error) throw error\r\n\r\n        const now = new Date()\r\n        const thirtyDays = new Date()\r\n        thirtyDays.setDate(now.getDate() + 30)\r\n\r\n        const stats = { valid: 0, expiring: 0, expired: 0, missing: 0 }\r\n        data?.forEach(d => {\r\n            if (!d.License_Expiry) stats.missing++\r\n            else {\r\n                const expiry = new Date(d.License_Expiry)\r\n                if (expiry < now) stats.expired++\r\n                else if (expiry < thirtyDays) stats.expiring++\r\n                else stats.valid++\r\n            }\r\n        })\r\n        return stats\r\n    } catch {\r\n        return { valid: 0, expiring: 0, expired: 0, missing: 0 }\r\n    }\r\n}\r\n\r\n// Get driver efficiency summary\r\nexport async function getDriverEfficiencySummary(branchId?: string) {\r\n    try {\r\n        const { data: drivers } = await getAllDrivers(1, 1000, '')\r\n        const targetDrivers = branchId ? drivers.filter((d: any) => d.Branch_ID === branchId) : drivers\r\n        \r\n        if (!targetDrivers || targetDrivers.length === 0) return { avgSuccess: 0, avgOnTime: 0, totalDrivers: 0 }\r\n        const scores = await Promise.all(targetDrivers.map((d: Driver) => getDriverScore(d.Driver_ID)))\r\n        const total = targetDrivers.length\r\n        \r\n        return {\r\n            avgSuccess: Math.round(scores.reduce((sum, s) => sum + s.acceptanceScore, 0) / total),\r\n            avgOnTime: Math.round(scores.reduce((sum, s) => sum + s.onTimeScore, 0) / total),\r\n            totalDrivers: total\r\n        }\r\n    } catch {\r\n        return { avgSuccess: 0, avgOnTime: 0, totalDrivers: 0 }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\fuel-analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\fuel.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\gps.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":94,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":97,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2674,2677],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2674,2677],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2714,2717],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2714,2717],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\n\r\n// Type matching actual Supabase schema (ProperCase columns!)\r\nexport type GPSLog = {\r\n  Log_ID: string\r\n  Driver_ID: string\r\n  Vehicle_Plate?: string\r\n  Latitude: number\r\n  Longitude: number\r\n  Timestamp: string\r\n  Job_ID?: string\r\n  Battery_Level?: number\r\n  Speed?: number\r\n}\r\n\r\n// บันทึกพิกัด GPS\r\nexport async function saveGPSLog(data: {\r\n  driverId: string\r\n  vehiclePlate?: string\r\n  lat: number\r\n  lng: number\r\n  jobId?: string\r\n  battery?: number\r\n  speed?: number\r\n}) {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Note: GPS_Logs table uses lowercase column names\r\n    const { error } = await supabase\r\n      .from('gps_logs') // Use lowercase table name if possible, or verify match\r\n      .insert({\r\n        driver_id: data.driverId,\r\n        vehicle_plate: data.vehiclePlate,\r\n        latitude: data.lat,\r\n        longitude: data.lng,\r\n        job_id: data.jobId,\r\n        battery_level: data.battery,\r\n        speed: data.speed,\r\n        // timestamp is auto-generated\r\n      })\r\n\r\n    if (error) {\r\n      console.error('Error saving GPS log:', JSON.stringify(error))\r\n      return { success: false, error }\r\n    }\r\n\r\n    return { success: true }\r\n  } catch (e) {\r\n    console.error('Exception saving GPS log:', e)\r\n    return { success: false, error: e }\r\n  }\r\n}\r\n\r\n// ดึงตำแหน่งล่าสุดของ Driver ทุกคน (สำหรับแสดงบน Map)\r\nexport async function getLatestDriverLocations() {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // ดึงข้อมูล GPS ย้อนหลัง 1 ชั่วโมง\r\n    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString()\r\n\r\n    const branchId = await getUserBranchId()\r\n\r\n    const query = supabase\r\n      .from('gps_logs')\r\n      .select(`\r\n        *,\r\n        Master_Drivers ( Driver_Name, Branch_ID )\r\n      `)\r\n      .gte('timestamp', oneHourAgo)\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        // Since we need to filter by a nested field in Master_Drivers, we can't easily do .eq() on the main query for normalized data\r\n        // but for GPS logs, usually the driver_id is what matters. \r\n        // We'll filter the resulting array instead for now to keep it simple, or we'd need a more complex join query.\r\n    }\r\n\r\n    const { data, error } = await query.order('timestamp', { ascending: false })\r\n\r\n    if (error) {\r\n       console.error('Error fetching GPS logs:', JSON.stringify(error))\r\n       return []\r\n    }\r\n\r\n    // Filter to latest record per driver\r\n    const latestLocations = new Map<string, GPSLog & { Driver_Name: string, Master_Drivers?: any }>()\r\n    \r\n    data?.forEach((log: any) => {\r\n        const driverId = log.driver_id || log.Driver_ID\r\n        if (!latestLocations.has(driverId)) {\r\n            latestLocations.set(driverId, {\r\n              ...log,\r\n              Driver_ID: driverId,\r\n              Driver_Name: log.Master_Drivers?.Driver_Name || 'Unknown Driver',\r\n              Latitude: log.latitude || log.Latitude,\r\n              Longitude: log.longitude || log.Longitude,\r\n              Timestamp: log.timestamp || log.Timestamp\r\n            })\r\n        }\r\n    })\r\n\r\n    // Filter by branch manually if needed\r\n    const logs = Array.from(latestLocations.values())\r\n    if (branchId && branchId !== 'All') {\r\n        return logs.filter(l => l.Master_Drivers?.Branch_ID === branchId)\r\n    }\r\n\r\n    return logs\r\n\r\n  } catch (e) {\r\n    console.error('Exception fetching driver locations:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// ดึงประวัติการเดินทางของ Driver ตามวันที่ (สำหรับแสดงเส้นทาง)\r\nexport async function getDriverRouteForDate(driverId: string, date: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Create Start and End timestamps for the day\r\n    const startDate = `${date}T00:00:00`\r\n    const endDate = `${date}T23:59:59`\r\n\r\n    const { data, error } = await supabase\r\n      .from('gps_logs')\r\n      .select('*') // select * to be safe with casing\r\n      .eq('driver_id', driverId)\r\n      .gte('timestamp', startDate)\r\n      .lte('timestamp', endDate)\r\n      .order('timestamp', { ascending: true })\r\n\r\n    if (error) {\r\n      console.error('Error fetching driver route:', JSON.stringify(error))\r\n      return []\r\n    }\r\n\r\n    // Normalize data\r\n    return data?.map(d => ({\r\n        Latitude: d.latitude || d.Latitude,\r\n        Longitude: d.longitude || d.Longitude,\r\n        Timestamp: d.timestamp || d.Timestamp\r\n    })) || []\r\n  } catch (e) {\r\n    console.error('Exception fetching driver route:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// ... (skipping getLatestDriverLocations rework for now as it's less critical than fleet status)\r\n\r\n// ... (previous code)\r\n\r\nexport async function getFleetGPSStatus() {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // 1. Get all drivers\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n\r\n    let driversQuery = supabase\r\n      .from('Master_Drivers')\r\n      .select('Driver_ID, Driver_Name, Vehicle_Plate')\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        driversQuery = driversQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data: drivers, error: driverError } = await driversQuery\r\n\r\n    if (driverError || !drivers) {\r\n        console.error('Error fetching drivers for GPS:', driverError)\r\n        return []\r\n    }\r\n\r\n    // 2. Fetch latest log for EACH driver efficiently (Parallel)\r\n    // This avoids fetching 1000s of logs and prevents \"Failed to fetch\" due to payload size\r\n    const driversWithLocation = await Promise.all(drivers.map(async (driver) => {\r\n        const { data: logs } = await supabase\r\n            .from('gps_logs')\r\n            .select('*')\r\n            .eq('driver_id', driver.Driver_ID)\r\n            .order('timestamp', { ascending: false })\r\n            .limit(1)\r\n        \r\n        const log = logs?.[0]\r\n        \r\n        return {\r\n            Driver_ID: driver.Driver_ID,\r\n            Driver_Name: driver.Driver_Name || 'Unknown',\r\n            Vehicle_Plate: driver.Vehicle_Plate || '-',\r\n            Last_Update: log?.timestamp || log?.Timestamp || null, \r\n            Latitude: log?.latitude || log?.Latitude || null,\r\n            Longitude: log?.longitude || log?.Longitude || null\r\n        }\r\n    }))\r\n\r\n    return driversWithLocation\r\n\r\n  } catch (e) {\r\n    console.error('Error fetching fleet status:', e)\r\n    return []\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\invoices.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[523,526],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[523,526],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1717,1720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1717,1720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3537,3540],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3537,3540],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from \"@/lib/permissions\"\r\n\r\nexport type Invoice = {\r\n  Invoice_ID: string\r\n  Tax_Invoice_ID: string | null\r\n  Customer_ID: string\r\n  Issue_Date: string\r\n  Due_Date: string | null\r\n  Subtotal: number\r\n  VAT_Rate: number\r\n  VAT_Amount: number\r\n  Grand_Total: number\r\n  WHT_Rate: number\r\n  WHT_Amount: number\r\n  Net_Total: number\r\n  Status: 'Draft' | 'Sent' | 'Paid' | 'Void' | 'Overdue'\r\n  Notes: string | null\r\n  Items_JSON: any\r\n  Created_At: string\r\n  Updated_At: string\r\n  Created_By: string | null\r\n  Branch_ID: string | null\r\n  \r\n  // Joins\r\n  Customer_Name?: string\r\n}\r\n\r\nexport async function getInvoices(page = 1, limit = 20, query = '') {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Filter by Branch\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n\r\n    let queryBuilder = supabase\r\n      .from('invoices')\r\n      .select('*, customers(Customer_Name)', { count: 'exact' })\r\n    \r\n    if (branchId && !isAdmin) {\r\n        queryBuilder = queryBuilder.or(`Branch_ID.eq.${branchId},Branch_ID.is.null`)\r\n    } else if (!isAdmin && !branchId) {\r\n        return { data: [], count: 0 }\r\n    }\r\n\r\n    let q = queryBuilder.order('Created_At', { ascending: false })\r\n\r\n    if (query) {\r\n       q = q.or(`Invoice_ID.ilike.%${query}%,Tax_Invoice_ID.ilike.%${query}%`)\r\n    }\r\n\r\n    const { data, error, count } = await q.range((page - 1) * limit, page * limit - 1)\r\n    \r\n    if (error) {\r\n        console.error('Error fetching invoices:', error)\r\n        return { data: [], count: 0 }\r\n    }\r\n\r\n    // Map customer name\r\n    const formattedData = data?.map((inv: any) => ({\r\n        ...inv,\r\n        Customer_Name: inv.customers?.Customer_Name || 'Unknown'\r\n    }))\r\n\r\n    return { data: formattedData, count: count || 0 }\r\n  } catch (error) {\r\n    console.error('Error in getInvoices:', error)\r\n    return { data: [], count: 0 }\r\n  }\r\n}\r\n\r\nexport async function getInvoiceById(id: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('invoices')\r\n      .select('*, customers(*)')\r\n      .eq('Invoice_ID', id)\r\n      .single()\r\n    \r\n    if (error) throw error\r\n    \r\n    // We might need to fetch items if Items_JSON is not enough or if we want latest data?\r\n    // Items_JSON is a snapshot. We should use it for the invoice.\r\n    \r\n    return { success: true, data }\r\n  } catch (error) {\r\n    console.error('Error fetching invoice:', error)\r\n    return { success: false, error }\r\n  }\r\n}\r\n\r\nexport async function createInvoice(invoice: Partial<Invoice>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Auto-assign Branch_ID if missing\r\n    if (!invoice.Branch_ID) {\r\n        invoice.Branch_ID = await getUserBranchId()\r\n    }\r\n\r\n    // Generate ID if not present (simple logic for now)\r\n    if (!invoice.Invoice_ID) {\r\n        // In real app, use a sequence or generate unique ID\r\n        const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')\r\n        const random = Math.floor(Math.random() * 1000)\r\n        invoice.Invoice_ID = `INV-${dateStr}-${random}`\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('invoices')\r\n      .insert(invoice)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw error\r\n\r\n    // Link Jobs to this Invoice\r\n    if (invoice.Items_JSON && Array.isArray(invoice.Items_JSON)) {\r\n        const jobIds = invoice.Items_JSON.map((j: any) => j.Job_ID)\r\n        if (jobIds.length > 0) {\r\n            const { error: updateError } = await supabase\r\n                .from('Jobs_Main')\r\n                .update({ Invoice_ID: data.Invoice_ID })\r\n                .in('Job_ID', jobIds)\r\n            \r\n            if (updateError) {\r\n                console.error('Error linking jobs to invoice:', updateError)\r\n                // Should we rollback? For now, just log.\r\n            }\r\n        }\r\n    }\r\n\r\n    return { success: true, data }\r\n  } catch (error) {\r\n    console.error('Error creating invoice:', error)\r\n    return { success: false, error }\r\n  }\r\n}\r\n\r\nexport async function updateInvoice(id: string, updates: Partial<Invoice>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('invoices')\r\n      .update(updates)\r\n      .eq('Invoice_ID', id)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw error\r\n    return { success: true, data }\r\n  } catch (error) {\r\n    console.error('Error updating invoice:', error)\r\n    return { success: false, error }\r\n  }\r\n}\r\n\r\nexport async function deleteInvoice(id: string) {\r\n    try {\r\n      const supabase = await createClient()\r\n      const { error } = await supabase\r\n        .from('invoices')\r\n        .delete()\r\n        .eq('Invoice_ID', id)\r\n  \r\n      if (error) throw error\r\n      return { success: true }\r\n    } catch (error) {\r\n      console.error('Error deleting invoice:', error)\r\n      return { success: false, error }\r\n    }\r\n  }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\jobs.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[637,640],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[637,640],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[672,675],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[672,675],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[697,700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[697,700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\n\r\nexport type Job = {\r\n  Job_ID: string\r\n  Job_Status: string\r\n  Plan_Date: string | null\r\n  Delivery_Date: string | null\r\n  Customer_ID: string | null\r\n  Customer_Name: string | null\r\n  Route_Name: string | null\r\n  Driver_ID: string | null\r\n  Driver_Name: string | null\r\n  Vehicle_Plate: string | null\r\n  Vehicle_Type: string | null\r\n  Origin_Location: string | null\r\n  Dest_Location: string | null\r\n  Total_Drop: number | null\r\n  Price_Cust_Total: number\r\n  Cost_Driver_Total: number\r\n  Cargo_Type: string | null\r\n  Notes: string | null\r\n  original_origins_json: any\r\n  original_destinations_json: any\r\n  extra_costs_json: any\r\n  Created_At: string | null\r\n  Photo_Proof_Url: string | null\r\n  Signature_Url: string | null\r\n  Pickup_Photo_Url: string | null\r\n  Pickup_Signature_Url: string | null\r\n  Sub_ID: string | null\r\n  Show_Price_To_Driver: boolean\r\n  Weight_Kg?: number | null\r\n  Volume_Cbm?: number | null\r\n  Zone?: string | null\r\n  Invoice_ID?: string | null\r\n}\r\n\r\n// ดึงงานทั้งหมดวันนี้\r\nimport { getUserBranchId, isSuperAdmin, getCustomerId } from \"@/lib/permissions\"\r\n\r\nexport async function getTodayJobs(): Promise<Job[]> {\r\n  try {\r\n    const supabase = await createClient()\r\n    const today = new Date().toISOString().split('T')[0]\r\n    \r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('*')\r\n      .eq('Plan_Date', today)\r\n    \r\n    // Filter by Branch\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !customerId && !branchId) {\r\n        return []\r\n    }\r\n\r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n      .order('Created_At', { ascending: false })\r\n    \r\n    if (error) {\r\n      console.error('Error fetching today jobs:', JSON.stringify(error))\r\n      return []\r\n    }\r\n    \r\n    return data || []\r\n  } catch (e) {\r\n    console.error('Exception fetching today jobs:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// ดึงงานตามสถานะ\r\nexport async function getJobsByStatus(status: string): Promise<Job[]> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n\r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('*')\r\n      .eq('Job_Status', status)\r\n    \r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    } else if (branchId && branchId !== 'All') {\r\n        dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n      .order('Created_At', { ascending: false })\r\n      .limit(100)\r\n    \r\n    if (error) {\r\n      console.error('Error fetching jobs by status:', JSON.stringify(error))\r\n      return []\r\n    }\r\n    \r\n    return data || []\r\n  } catch (e) {\r\n    console.error('Exception fetching jobs by status:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// ดึงงานทั้งหมด (pagination + search + status filter)\r\nexport async function getAllJobs(\r\n  page = 1, \r\n  limit = 50, \r\n  query = '',\r\n  status = '' // Add status parameter\r\n): Promise<{ data: Job[], count: number }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    const offset = (page - 1) * limit\r\n    \r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('*', { count: 'exact' })\r\n    \r\n    // Filter by Branch\r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n    \r\n    if (branchId && branchId !== 'All') {\r\n        dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !customerId && !branchId) {\r\n        return { data: [], count: 0 }\r\n    }\r\n\r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    }\r\n\r\n    dbQuery = dbQuery\r\n      .order('Plan_Date', { ascending: false })\r\n      .order('Created_At', { ascending: false })\r\n\r\n    if (query) {\r\n      dbQuery = dbQuery.or(`Job_ID.ilike.%${query}%,Customer_Name.ilike.%${query}%,Route_Name.ilike.%${query}%`)\r\n    }\r\n\r\n    if (status) {\r\n      dbQuery = dbQuery.eq('Job_Status', status)\r\n    }\r\n\r\n    const { data, error, count } = await dbQuery.range(offset, offset + limit - 1)\r\n    \r\n    if (error) {\r\n      console.error('Error fetching all jobs:', JSON.stringify(error))\r\n      return { data: [], count: 0 }\r\n    }\r\n    \r\n    return { data: data || [], count: count || 0 }\r\n  } catch (e) {\r\n    console.error('Exception fetching all jobs:', e)\r\n    return { data: [], count: 0 }\r\n  }\r\n}\r\n\r\n// นับสถิติงานวันนี้\r\nexport async function getTodayJobStats(branchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const today = new Date().toISOString().split('T')[0]\r\n    const userBranchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n    \r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('Job_Status')\r\n      .eq('Plan_Date', today)\r\n\r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    } else {\r\n        const effectiveBranchId = branchId || userBranchId\r\n        if (effectiveBranchId && effectiveBranchId !== 'All') {\r\n            dbQuery = dbQuery.eq('Branch_ID', effectiveBranchId)\r\n        } else if (!isAdmin && !userBranchId) {\r\n            return { total: 0, delivered: 0, inProgress: 0, pending: 0 }\r\n        }\r\n    }\r\n    \r\n    const { data, error } = await dbQuery\r\n    \r\n    if (error) {\r\n      console.error('Error fetching job stats:', JSON.stringify(error))\r\n      return { total: 0, delivered: 0, inProgress: 0, pending: 0 }\r\n    }\r\n    \r\n    const jobs = data || []\r\n    return {\r\n      total: jobs.length,\r\n      delivered: jobs.filter(j => j.Job_Status === 'Delivered' || j.Job_Status === 'Completed').length,\r\n      inProgress: jobs.filter(j => j.Job_Status === 'In Transit' || j.Job_Status === 'In Progress').length,\r\n      pending: jobs.filter(j => j.Job_Status === 'New' || j.Job_Status === 'Assigned').length,\r\n    }\r\n  } catch (e) {\r\n    console.error('Exception fetching job stats:', e)\r\n    return { total: 0, delivered: 0, inProgress: 0, pending: 0 }\r\n  }\r\n}\r\n\r\n// ยอดเงินวันนี้ (Estimated)\r\nexport async function getTodayFinancials(branchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const today = new Date().toISOString().split('T')[0]\r\n    const userBranchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n\r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('Price_Cust_Total')\r\n      .eq('Plan_Date', today)\r\n\r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    } else {\r\n        const effectiveBranchId = branchId || userBranchId\r\n        if (effectiveBranchId && effectiveBranchId !== 'All') {\r\n            dbQuery = dbQuery.eq('Branch_ID', effectiveBranchId)\r\n        } else if (!isAdmin && !userBranchId) {\r\n            return { revenue: 0 }\r\n        }\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n      .neq('Job_Status', 'Cancelled') // Exclude cancelled jobs\r\n    \r\n    if (error) return { revenue: 0 }\r\n\r\n    const revenue = data?.reduce((sum, job) => sum + (job.Price_Cust_Total || 0), 0) || 0\r\n    return { revenue }\r\n  } catch {\r\n    return { revenue: 0 }\r\n  }\r\n}\r\n\r\n// ดึงงานของ Driver เฉพาะคน\r\n// ดึงงานของ Driver เฉพาะคน\r\n// ดึงงานของ Driver เฉพาะคน (รองรับ Filter)\r\nexport async function getDriverJobs(\r\n  driverId: string, \r\n  options: { startDate?: string, endDate?: string, status?: string } = {}\r\n): Promise<Job[]> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    \r\n    let query = supabase\r\n      .from('Jobs_Main')\r\n      .select('*')\r\n      .eq('Driver_ID', driverId)\r\n\r\n    if (branchId && branchId !== 'All') {\r\n        query = query.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    if (options.startDate) {\r\n        query = query.gte('Plan_Date', options.startDate)\r\n    }\r\n\r\n    if (options.endDate) {\r\n        query = query.lte('Plan_Date', options.endDate)\r\n    }\r\n\r\n    if (options.status && options.status !== 'All') {\r\n        query = query.eq('Job_Status', options.status)\r\n    }\r\n\r\n    const { data, error } = await query\r\n      .order('Plan_Date', { ascending: false })\r\n      .order('Created_At', { ascending: false })\r\n      .limit(100)\r\n    \r\n    if (error) {\r\n      console.error('Error fetching driver jobs:', JSON.stringify(error))\r\n      return []\r\n    }\r\n    \r\n    return data || []\r\n  } catch (e) {\r\n    console.error('Exception fetching driver jobs:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// ดึงรายละเอียดงาน By ID\r\nexport async function getJobById(jobId: string): Promise<Job | null> {\r\n    try {\r\n        const supabase = await createClient()\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n\r\n        let query = supabase\r\n            .from('Jobs_Main')\r\n            .select('*')\r\n            .eq('Job_ID', jobId)\r\n        \r\n        if (branchId && branchId !== 'All') {\r\n            query = query.eq('Branch_ID', branchId)\r\n        } else if (!isAdmin && !branchId) {\r\n            return null\r\n        }\r\n\r\n        const { data, error } = await query\r\n            .single()\r\n        \r\n        if (error) return null\r\n        return data\r\n    } catch (e) {\r\n        console.error(e)\r\n        return null\r\n    }\r\n}\r\n// สถิติยอดจัดส่งย้อนหลัง 7 วัน\r\nexport async function getWeeklyJobStats(branchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const today = new Date()\r\n    const sevenDaysAgo = new Date(today)\r\n    sevenDaysAgo.setDate(today.getDate() - 6)\r\n\r\n    const startDate = sevenDaysAgo.toISOString().split('T')[0]\r\n    const userBranchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const customerId = await getCustomerId()\r\n    \r\n    // ดึงข้อมูล 7 วันล่าสุด\r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('Plan_Date, Job_Status')\r\n      .gte('Plan_Date', startDate)\r\n\r\n    if (customerId) {\r\n        dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n    } else {\r\n        const effectiveBranchId = branchId || userBranchId\r\n        if (effectiveBranchId && effectiveBranchId !== 'All') {\r\n            dbQuery = dbQuery.eq('Branch_ID', effectiveBranchId)\r\n        } else if (!isAdmin && !userBranchId) {\r\n            return []\r\n        }\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n      .order('Plan_Date', { ascending: true })\r\n\r\n    if (error) {\r\n      console.error('Error fetching weekly stats:', JSON.stringify(error))\r\n      return []\r\n    }\r\n\r\n    // Group data by date\r\n    const dailyStats: Record<string, { date: string, total: number, completed: number }> = {}\r\n    \r\n    // Initialize last 7 days with 0\r\n    for (let i = 0; i < 7; i++) {\r\n        const d = new Date(sevenDaysAgo)\r\n        d.setDate(sevenDaysAgo.getDate() + i)\r\n        const dateStr = d.toISOString().split('T')[0]\r\n        const dayName = d.toLocaleDateString('th-TH', { weekday: 'short' }) // Mon, Tue...\r\n        dailyStats[dateStr] = { date: dayName, total: 0, completed: 0 }\r\n    }\r\n\r\n    data?.forEach(job => {\r\n        const dateStr = job.Plan_Date as string // Assuming Plan_Date is string YYYY-MM-DD\r\n        if (dailyStats[dateStr]) {\r\n            dailyStats[dateStr].total += 1\r\n            if (['Delivered', 'Completed'].includes(job.Job_Status)) {\r\n                dailyStats[dateStr].completed += 1\r\n            }\r\n        }\r\n    })\r\n\r\n    return Object.values(dailyStats)\r\n  } catch (e) {\r\n    console.error('Exception fetching weekly stats:', e)\r\n    return []\r\n  }\r\n}\r\n\r\n// สัดส่วนสถานะงาน (ทั้งหมด)\r\nexport async function getJobStatusDistribution(branchId?: string) {\r\n    try {\r\n        const supabase = await createClient()\r\n        const userBranchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n        const customerId = await getCustomerId()\r\n\r\n        let dbQuery = supabase\r\n            .from('Jobs_Main')\r\n            .select('Job_Status')\r\n\r\n        if (customerId) {\r\n            dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n        } else {\r\n            const effectiveBranchId = branchId || userBranchId\r\n            if (effectiveBranchId && effectiveBranchId !== 'All') {\r\n                dbQuery = dbQuery.eq('Branch_ID', effectiveBranchId)\r\n            } else if (!isAdmin && !userBranchId) {\r\n                return []\r\n            }\r\n        }\r\n\r\n        const { data, error } = await dbQuery\r\n\r\n        if (error) return []\r\n\r\n        const statusCounts: Record<string, number> = {}\r\n        data?.forEach(job => {\r\n            const status = job.Job_Status || 'Unknown'\r\n            statusCounts[status] = (statusCounts[status] || 0) + 1\r\n        })\r\n\r\n        // Map colors for common statuses\r\n        const result = Object.entries(statusCounts).map(([name, value]) => ({\r\n            name,\r\n            value,\r\n            fill: getStatusColor(name)\r\n        }))\r\n\r\n        return result\r\n    } catch {\r\n        return []\r\n    }\r\n}\r\n\r\nfunction getStatusColor(status: string) {\r\n    switch (status) {\r\n        case 'Completed': return '#10b981' // emerald-500\r\n        case 'Delivered': return '#10b981'\r\n        case 'In Progress': return '#3b82f6' // blue-500\r\n        case 'In Transit': return '#3b82f6'\r\n        case 'Pending': return '#f59e0b' // amber-500\r\n        case 'New': return '#f59e0b'\r\n        case 'Assigned': return '#8b5cf6' // violet-500\r\n        case 'Failed': return '#ef4444' // red-500\r\n        case 'Cancelled': return '#94a3b8' // slate-400\r\n        default: return '#cbd5e1'\r\n    }\r\n}\r\n// สร้างงานใหม่\r\nexport async function createJob(jobData: Partial<Job>) {\r\n    try {\r\n        const supabase = await createClient()\r\n        \r\n        // Generate Job ID (Format: JOB-YYYYMMDD-XXXX)\r\n        const today = new Date()\r\n        const dateStr = today.toISOString().split('T')[0].replace(/-/g, '')\r\n        const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0')\r\n        const newJobId = `JOB-${dateStr}-${randomSuffix}`\r\n\r\n        const { data, error } = await supabase\r\n            .from('Jobs_Main')\r\n            .insert({\r\n                ...jobData,\r\n                Job_ID: newJobId,\r\n                Job_Status: 'New',\r\n                Branch_ID: await getUserBranchId() || 'HQ',\r\n                Created_At: new Date().toISOString()\r\n            })\r\n            .select()\r\n            .single()\r\n\r\n        if (error) {\r\n            console.error('Error creating job:', JSON.stringify(error))\r\n            return { success: false, error }\r\n        }\r\n\r\n        return { success: true, data }\r\n    } catch (e) {\r\n        console.error('Exception creating job:', e)\r\n        return { success: false, error: e }\r\n    }\r\n}\r\n\r\n// ดึงรายชื่อคนขับทั้งหมด (จากประวัติงาน)\r\nexport async function getAllDrivers() {\r\n    try {\r\n        const supabase = await createClient()\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n\r\n        let query = supabase\r\n            .from('Jobs_Main')\r\n            .select('Driver_ID, Driver_Name, Vehicle_Plate')\r\n            .not('Driver_ID', 'is', null)\r\n        \r\n        if (branchId && branchId !== 'All') {\r\n            query = query.eq('Branch_ID', branchId)\r\n        } else if (!isAdmin && !branchId) {\r\n            return []\r\n        }\r\n\r\n        const { data, error } = await query\r\n        \r\n        if (error) return []\r\n\r\n        // De-duplicate by Driver_ID\r\n        const uniqueDrivers = new Map()\r\n        data?.forEach(item => {\r\n            if (item.Driver_ID && !uniqueDrivers.has(item.Driver_ID)) {\r\n                uniqueDrivers.set(item.Driver_ID, item)\r\n            }\r\n        })\r\n\r\n        return Array.from(uniqueDrivers.values())\r\n    } catch {\r\n        return []\r\n    }\r\n}\r\n\r\n// ดึงรายชื่อรถทั้งหมด\r\nexport async function getAllVehicles() {\r\n    try {\r\n        const supabase = await createClient()\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n\r\n        let query = supabase\r\n            .from('Jobs_Main')\r\n            .select('Vehicle_Plate, Driver_Name')\r\n            .not('Vehicle_Plate', 'is', null)\r\n\r\n        if (branchId && branchId !== 'All') {\r\n            query = query.eq('Branch_ID', branchId)\r\n        } else if (!isAdmin && !branchId) {\r\n            return []\r\n        }\r\n\r\n        const { data, error } = await query\r\n\r\n        if (error) return []\r\n\r\n        const uniqueVehicles = new Map()\r\n        data?.forEach(item => {\r\n            if (item.Vehicle_Plate && !uniqueVehicles.has(item.Vehicle_Plate)) {\r\n                uniqueVehicles.set(item.Vehicle_Plate, item)\r\n            }\r\n        })\r\n\r\n        return Array.from(uniqueVehicles.values())\r\n    } catch {\r\n        return []\r\n    }\r\n}\r\n\r\n// ดึงข้อมูลสำหรับหน้า Billing (Completed/Delivered)\r\nexport async function getJobsForBilling(startDate?: string, endDate?: string): Promise<Job[]> {\r\n    try {\r\n        const supabase = await createClient()\r\n        const customerId = await getCustomerId()\r\n\r\n        const branchId = await getUserBranchId()\r\n        const isAdmin = await isSuperAdmin()\r\n\r\n        let dbQuery = supabase\r\n            .from('Jobs_Main')\r\n            .select('*')\r\n            .in('Job_Status', ['Completed', 'Delivered'])\r\n        \r\n        if (customerId) {\r\n            dbQuery = dbQuery.eq('Customer_ID', customerId)\r\n        } else if (branchId && branchId !== 'All') {\r\n            dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n        } else if (!isAdmin && !branchId) {\r\n            return []\r\n        }\r\n\r\n        let query = dbQuery\r\n            .order('Plan_Date', { ascending: false })\r\n            \r\n        if (startDate) {\r\n            query = query.gte('Plan_Date', startDate)\r\n        }\r\n        if (endDate) {\r\n            query = query.lte('Plan_Date', endDate)\r\n        }\r\n        \r\n        const { data, error } = await query\r\n        \r\n        if (error) {\r\n            console.error('Error fetching billing jobs:', error)\r\n            return []\r\n        }\r\n        \r\n        return data || []\r\n    } catch (e) {\r\n        console.error('Exception fetching billing jobs:', e)\r\n        return []\r\n    }\r\n}\r\n// ดึงข้อมูล Dashboard สำหรับ Driver (Mobile)\r\nexport async function getDriverDashboardStats(driverId: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const today = new Date().toISOString().split('T')[0]\r\n    \r\n    // 1. Get today's jobs for this driver\r\n    const { data: jobs, error } = await supabase\r\n      .from('Jobs_Main')\r\n      .select('*')\r\n      .eq('Driver_ID', driverId)\r\n      .eq('Plan_Date', today)\r\n      .order('Created_At', { ascending: true }) // Order by time to find next job\r\n\r\n    if (error) {\r\n      console.error('Error fetching driver dashboard stats:', error)\r\n      return { \r\n        stats: { total: 0, completed: 0 }, \r\n        gamification: { points: 0, rank: 'Bronze', nextRankPoints: 300, monthlyCompleted: 0 },\r\n        currentJob: null \r\n      }\r\n    }\r\n\r\n    const total = jobs?.length || 0\r\n    const completed = jobs?.filter(j => ['Completed', 'Delivered'].includes(j.Job_Status || '')).length || 0\r\n    \r\n    // Find current active job (In Progress/Transit) OR the first Pending/New job\r\n    // Priority: In Progress > In Transit > Assigned > New\r\n    const currentJob = jobs?.find(j => ['In Progress', 'In Transit'].includes(j.Job_Status || '')) \r\n      || jobs?.find(j => ['Assigned', 'New'].includes(j.Job_Status || '')) \r\n      || null\r\n\r\n    // 2. Gamification Stats (Monthly)\r\n    const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()\r\n    const { count: monthlyCompletedCount } = await supabase\r\n        .from('Jobs_Main')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('Driver_ID', driverId)\r\n        .gte('Plan_Date', startOfMonth)\r\n        .in('Job_Status', ['Completed', 'Delivered'])\r\n\r\n    const points = (monthlyCompletedCount || 0) * 10\r\n    \r\n    // Rank Logic\r\n    let rank = 'Bronze'\r\n    let nextRankPoints = 300\r\n    if (points >= 1200) { rank = 'Platinum'; nextRankPoints = 0 }\r\n    else if (points >= 700) { rank = 'Gold'; nextRankPoints = 1200 }\r\n    else if (points >= 300) { rank = 'Silver'; nextRankPoints = 700 }\r\n\r\n    return {\r\n      stats: { total, completed },\r\n      gamification: {\r\n          points,\r\n          rank,\r\n          nextRankPoints,\r\n          monthlyCompleted: monthlyCompletedCount || 0\r\n      },\r\n      currentJob\r\n    }\r\n  } catch (e) {\r\n    console.error('Exception fetching driver dashboard stats:', e)\r\n     return { \r\n        stats: { total: 0, completed: 0 }, \r\n        gamification: { points: 0, rank: 'Bronze', nextRankPoints: 300, monthlyCompleted: 0 },\r\n        currentJob: null \r\n      }\r\n  }\r\n}\r\n\r\n// Get billable jobs for a customer\r\nexport async function getBillableJobs(customerId: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    const branchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n\r\n    // Get jobs that are Complete/Delivered and NOT yet invoiced\r\n    let dbQuery = supabase\r\n      .from('Jobs_Main')\r\n      .select('*')\r\n      .eq('Customer_ID', customerId)\r\n      .is('Invoice_ID', null) \r\n      .in('Job_Status', ['Complete', 'Delivered'])\r\n\r\n    if (branchId && branchId !== 'All') {\r\n        dbQuery = dbQuery.eq('Branch_ID', branchId)\r\n    } else if (!isAdmin && !branchId) {\r\n        return []\r\n    }\r\n\r\n    const { data, error } = await dbQuery\r\n      .order('Plan_Date', { ascending: true })\r\n\r\n    if (error) {\r\n      console.error('Error fetching billable jobs:', error)\r\n      return []\r\n    }\r\n    \r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Error:', error)\r\n    return []\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\maintenance-schedule.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1891,1894],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1891,1894],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\maintenance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\master-data.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[521,524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[521,524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1198,1201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1198,1201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/client\"\r\n\r\nexport interface ExpenseType {\r\n  id: string\r\n  name: string\r\n  default_amount: number\r\n  is_active: boolean\r\n}\r\n\r\nexport async function getExpenseTypes() {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('Master_Expense_Types')\r\n    .select('*')\r\n    .order('Created_At', { ascending: true })\r\n\r\n  if (error) {\r\n    console.error('Error fetching expense types:', error)\r\n    return []\r\n  }\r\n\r\n  return data.map((item: any) => ({\r\n    id: item.Expense_Type_ID,\r\n    name: item.Expense_Name,\r\n    default_amount: item.Default_Amount,\r\n    is_active: item.Is_Active\r\n  }))\r\n}\r\n\r\nexport async function addExpenseType(name: string, defaultAmount: number) {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('Master_Expense_Types')\r\n    .insert({\r\n        Expense_Name: name,\r\n        Default_Amount: defaultAmount,\r\n        Is_Active: true\r\n    })\r\n    .select()\r\n\r\n  return { success: !error, data, error }\r\n}\r\n\r\nexport async function updateExpenseType(id: string, updates: Partial<ExpenseType>) {\r\n  const supabase = createClient()\r\n  \r\n  const dbUpdates: any = {}\r\n  if (updates.name !== undefined) dbUpdates.Expense_Name = updates.name\r\n  if (updates.default_amount !== undefined) dbUpdates.Default_Amount = updates.default_amount\r\n  if (updates.is_active !== undefined) dbUpdates.Is_Active = updates.is_active\r\n\r\n  const { error } = await supabase\r\n    .from('Master_Expense_Types')\r\n    .update(dbUpdates)\r\n    .eq('Expense_Type_ID', id)\r\n\r\n  return { success: !error, error }\r\n}\r\n\r\nexport async function deleteExpenseType(id: string) {\r\n  const supabase = createClient()\r\n  \r\n  const { error } = await supabase\r\n    .from('Master_Expense_Types')\r\n    .delete()\r\n    .eq('Expense_Type_ID', id)\r\n\r\n  return { success: !error, error }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\pod.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\predictive-analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\routes.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3544,3547],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3544,3547],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4410,4413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4410,4413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4853,4856],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4853,4856],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":173,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4990,4993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4990,4993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":189,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5614,5617],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5614,5617],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":190,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5655,5658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5655,5658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":261,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8881,8884],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8881,8884],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":262,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8917,8920],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8917,8920],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":302,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":302,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10360,10363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10360,10363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin, getUserRole } from \"@/lib/permissions\"\r\n\r\nexport type Route = {\r\n  Route_Name: string\r\n  Origin: string | null\r\n  Map_Link_Origin: string | null\r\n  Destination: string | null\r\n  Map_Link_Destination: string | null\r\n  Distance_KM: number | null\r\n  Branch_ID: string | null\r\n  Created_At?: string\r\n}\r\n\r\nexport type Branch = {\r\n  Branch_ID: string\r\n  Branch_Name: string\r\n}\r\n\r\nexport async function getCurrentUserRole() {\r\n  console.log(\"[DEBUG] getCurrentUserRole: Starting\")\r\n  try {\r\n    const role = await getUserRole()\r\n    console.log(\"[DEBUG] getCurrentUserRole: Role =\", role)\r\n    return role\r\n  } catch (e) {\r\n    console.error(\"[DEBUG] getCurrentUserRole: Error\", e)\r\n    return null\r\n  }\r\n}\r\n\r\n// Get all routes\r\nexport async function getAllRoutes(page?: number, limit?: number, query?: string, branchId?: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    let queryBuilder = supabase.from('Master_Routes').select('*', { count: 'exact' })\r\n    \r\n    if (page && limit) {\r\n      const from = (page - 1) * limit\r\n      const to = from + limit - 1\r\n      queryBuilder = queryBuilder.range(from, to)\r\n    }\r\n    \r\n    if (query) {\r\n      queryBuilder = queryBuilder.or(`Route_Name.ilike.%${query}%,Origin.ilike.%${query}%,Destination.ilike.%${query}%`)\r\n    }\r\n\r\n    // Unified Branch Filtering\r\n    const userBranchId = await getUserBranchId()\r\n    const isAdmin = await isSuperAdmin()\r\n    const effectiveBranchId = branchId || userBranchId\r\n\r\n    if (effectiveBranchId && effectiveBranchId !== 'All') {\r\n        queryBuilder = queryBuilder.eq('Branch_ID', effectiveBranchId)\r\n    } else if (!isAdmin && !effectiveBranchId) {\r\n        return { data: [], count: 0 }\r\n    }\r\n    \r\n    const { data, error, count } = await queryBuilder.order('Route_Name', { ascending: true })\r\n    \r\n    if (error) {\r\n      console.error('Error fetching routes:', error)\r\n      return { data: [], count: 0 }\r\n    }\r\n    \r\n    return { data: data || [], count: count || 0 }\r\n  } catch (e) {\r\n    console.error(e)\r\n    return { data: [], count: 0 }\r\n  }\r\n}\r\n\r\n// Get all branches\r\nexport async function getBranches() {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase.from('Master_Branches').select('Branch_ID, Branch_Name').order('Branch_Name')\r\n    \r\n    if (error) {\r\n       console.error('Error fetching branches:', error)\r\n       return []\r\n    }\r\n    return data || []\r\n  } catch (e) {\r\n    console.error(e)\r\n    return []\r\n  }\r\n}\r\n\r\n// Create route\r\nexport async function createRoute(routeData: Partial<Route>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Route_Name is PK, must be provided\r\n    if (!routeData.Route_Name) {\r\n        return { success: false, error: \"Route Name is required\" }\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('Master_Routes')\r\n      .insert({\r\n        Route_Name: routeData.Route_Name,\r\n        Origin: routeData.Origin,\r\n        Map_Link_Origin: routeData.Map_Link_Origin,\r\n        Destination: routeData.Destination,\r\n        Map_Link_Destination: routeData.Map_Link_Destination,\r\n        Distance_KM: routeData.Distance_KM,\r\n        Branch_ID: routeData.Branch_ID\r\n      })\r\n      .select()\r\n      .single()\r\n    \r\n    if (error) {\r\n        console.error('Error creating route:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n    return { success: true, data }\r\n  } catch (e: any) {\r\n    return { success: false, error: e.message }\r\n  }\r\n}\r\n\r\n// Update route\r\nexport async function updateRoute(originalRouteName: string, routeData: Partial<Route>) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data, error } = await supabase\r\n      .from('Master_Routes')\r\n      .update({\r\n        Route_Name: routeData.Route_Name,\r\n        Origin: routeData.Origin,\r\n        Map_Link_Origin: routeData.Map_Link_Origin,\r\n        Destination: routeData.Destination,\r\n        Map_Link_Destination: routeData.Map_Link_Destination,\r\n        Distance_KM: routeData.Distance_KM,\r\n        Branch_ID: routeData.Branch_ID\r\n      })\r\n      .eq('Route_Name', originalRouteName)\r\n      .select()\r\n      .single()\r\n    \r\n    if (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n    return { success: true, data }\r\n  } catch (e: any) {\r\n    return { success: false, error: e.message }\r\n  }\r\n}\r\n\r\n// Delete route\r\nexport async function deleteRoute(routeName: string) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { error } = await supabase\r\n      .from('Master_Routes')\r\n      .delete()\r\n      .eq('Route_Name', routeName)\r\n    \r\n    if (error) {\r\n      return { success: false, error: error.message }\r\n    }\r\n    return { success: true }\r\n  } catch (e: any) {\r\n    return { success: false, error: e.message }\r\n  }\r\n}\r\n\r\n// Bulk create routes\r\nexport async function createBulkRoutes(routes: any[]) {\r\n    try {\r\n        const supabase = await createClient()\r\n        const currentUserBranch = await getUserBranchId()\r\n        \r\n        // Fetch All Branches to map Name -> ID\r\n        const { data: branches } = await supabase.from('Master_Branches').select('Branch_ID, Branch_Name')\r\n        const branchMap = new Map<string, string>()\r\n        if (branches) {\r\n            branches.forEach(b => {\r\n                branchMap.set(b.Branch_Name.trim(), b.Branch_ID)\r\n                branchMap.set(b.Branch_ID, b.Branch_ID)\r\n            })\r\n        }\r\n\r\n        // Normalize keys\r\n        const normalizeData = (row: any) => {\r\n            const normalized: any = {}\r\n            const getValue = (keys: string[]) => {\r\n                const rowKeys = Object.keys(row)\r\n                for (const key of keys) {\r\n                    const foundKey = rowKeys.find(k => k.toLowerCase().replace(/\\\\s+/g, '') === key.toLowerCase().replace(/\\\\s+/g, ''))\r\n                    if (foundKey && row[foundKey] !== undefined && row[foundKey] !== null) {\r\n                        return row[foundKey]\r\n                    }\r\n                }\r\n                return undefined\r\n            }\r\n    \r\n            normalized.Route_Name = getValue(['route_name', 'name', 'route', 'ชื่อเส้นทาง', 'เส้นทาง'])\r\n            normalized.Origin = getValue(['origin', 'source', 'start', 'ต้นทาง', 'จุดเริ่มต้น'])\r\n            normalized.Destination = getValue(['destination', 'dest', 'end', 'ปลายทาง', 'จุดสิ้นสุด'])\r\n            // Map Links & Distance\r\n            normalized.Map_Link_Origin = getValue(['map_link_origin', 'origin_link', 'link_start', 'ลิ้งค์ต้นทาง'])\r\n            normalized.Map_Link_Destination = getValue(['map_link_destination', 'destination_link', 'link_end', 'ลิ้งค์ปลายทาง'])\r\n            normalized.Distance_KM = getValue(['distance', 'km', 'distance_km', 'ระยะทาง'])\r\n            \r\n            normalized.Branch_ID = getValue(['branch_id', 'branch', 'สาขา'])\r\n            \r\n            return normalized\r\n        }\r\n    \r\n        const cleanData = routes.map(r => normalizeData(r)).filter(r => r.Route_Name)\r\n    \r\n        if (cleanData.length === 0) {\r\n            return { success: false, message: \"ไม่พบข้อมูลที่ถูกต้อง (ต้องมีชื่อเส้นทาง)\" }\r\n        }\r\n\r\n        // Prepare data with Branch ID resolved\r\n        const preparedRoutes = cleanData.map(r => {\r\n             // Resolve Branch ID\r\n             let branchId = currentUserBranch || 'HQ'\r\n             if (r.Branch_ID) {\r\n                 const key = String(r.Branch_ID).trim()\r\n                 if (branchMap.has(key)) {\r\n                     branchId = branchMap.get(key) || 'HQ'\r\n                 } else {\r\n                     const found = branches?.find(b => {\r\n                         const bName = String(b.Branch_Name || '')\r\n                         return bName && (bName.includes(key) || key.includes(bName))\r\n                     })\r\n                     if (found) {\r\n                         branchId = found.Branch_ID\r\n                     }\r\n                 }\r\n             }\r\n\r\n             return {\r\n                Route_Name: r.Route_Name,\r\n                Origin: r.Origin,\r\n                Map_Link_Origin: r.Map_Link_Origin,\r\n                Destination: r.Destination,\r\n                Map_Link_Destination: r.Map_Link_Destination,\r\n                Distance_KM: r.Distance_KM ? parseFloat(r.Distance_KM) : null,\r\n                Branch_ID: branchId\r\n             }\r\n        })\r\n\r\n        // Check for existing routes\r\n        const namesToCheck = preparedRoutes.map(r => r.Route_Name)\r\n        \r\n        const { data: existingRoutes } = await supabase\r\n            .from('Master_Routes')\r\n            .select('Route_Name')\r\n            .in('Route_Name', namesToCheck)\r\n\r\n        const existingNames = new Set(existingRoutes?.map(r => r.Route_Name) || [])\r\n        \r\n        const toInsert: any[] = []\r\n        const toUpdate: any[] = []\r\n\r\n        preparedRoutes.forEach(r => {\r\n            if (existingNames.has(r.Route_Name)) {\r\n                toUpdate.push(r)\r\n            } else {\r\n                toInsert.push(r)\r\n            }\r\n        })\r\n\r\n        // 1. Perform Inserts\r\n        if (toInsert.length > 0) {\r\n            const { error } = await supabase.from('Master_Routes').insert(toInsert)\r\n            if (error) {\r\n                console.error(\"Bulk create routes error (insert):\", error)\r\n                return { success: false, message: `Failed to import new routes: ${error.message}` }\r\n            }\r\n        }\r\n\r\n        // 2. Perform Updates\r\n        if (toUpdate.length > 0) {\r\n            await Promise.all(toUpdate.map(async (r) => {\r\n                await supabase.from('Master_Routes')\r\n                    .update({\r\n                        Origin: r.Origin,\r\n                        Map_Link_Origin: r.Map_Link_Origin,\r\n                        Destination: r.Destination,\r\n                        Map_Link_Destination: r.Map_Link_Destination,\r\n                        Distance_KM: r.Distance_KM,\r\n                        Branch_ID: r.Branch_ID\r\n                    })\r\n                    .eq('Route_Name', r.Route_Name)\r\n            }))\r\n        }\r\n    \r\n        return { \r\n            success: true, \r\n            message: `นำเข้าสำเร็จ: เพิ่มใหม่ ${toInsert.length} รายการ, อัปเดต ${toUpdate.length} รายการ`\r\n        }\r\n\r\n    } catch (e: any) {\r\n        return { success: false, message: e.message }\r\n    }\r\n}\r\n\r\n// Get all unique locations (Origin + Destination) for autocomplete\r\nexport async function getUniqueLocations() {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Fetch unique Origins\r\n    const { data: origins } = await supabase\r\n      .from('Master_Routes')\r\n      .select('Origin')\r\n      .not('Origin', 'is', null)\r\n      \r\n    // Fetch unique Destinations\r\n    const { data: destinations } = await supabase\r\n      .from('Master_Routes')\r\n      .select('Destination')\r\n      .not('Destination', 'is', null)\r\n\r\n    const locationSet = new Set<string>()\r\n    \r\n    if (origins) {\r\n        origins.forEach(o => {\r\n            if (o.Origin) locationSet.add(o.Origin.trim())\r\n        })\r\n    }\r\n    \r\n    if (destinations) {\r\n        destinations.forEach(d => {\r\n            if (d.Destination) locationSet.add(d.Destination.trim())\r\n        })\r\n    }\r\n    \r\n    return Array.from(locationSet).sort()\r\n  } catch (e) {\r\n    console.error(\"Error fetching locations:\", e)\r\n    return []\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\safety-analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\settings.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":38,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/client\"\r\n\r\nexport interface CompanyProfile {\r\n  company_name: string\r\n  company_name_en: string\r\n  tax_id: string\r\n  branch: string\r\n  address: string\r\n  phone: string\r\n  fax: string\r\n  email: string\r\n  website: string\r\n  bank_name: string\r\n  bank_account_name: string\r\n  bank_account_no: string\r\n  logo_url: string\r\n}\r\n\r\nconst SETTING_KEY = 'company_profile'\r\n\r\nexport async function getCompanyProfile(): Promise<CompanyProfile | null> {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('System_Settings')\r\n    .select('value')\r\n    .eq('key', SETTING_KEY)\r\n    .single()\r\n\r\n  if (error) {\r\n    console.error('Error fetching company profile:', error)\r\n    return null\r\n  }\r\n\r\n  // Parse JSON if stored as text, or return distinct object if jsonb\r\n  try {\r\n      return typeof data.value === 'string' ? JSON.parse(data.value) : data.value\r\n  } catch (e) {\r\n      return data.value\r\n  }\r\n}\r\n\r\nexport async function saveCompanyProfile(profile: CompanyProfile) {\r\n  const supabase = createClient()\r\n  \r\n  // Upsert\r\n  const { error } = await supabase\r\n    .from('System_Settings')\r\n    .upsert({ \r\n        key: SETTING_KEY, \r\n        value: JSON.stringify(profile),\r\n        description: 'Company Profile Data'\r\n    }, { onConflict: 'key' })\r\n\r\n  return { success: !error, error }\r\n}\r\n\r\nexport async function uploadCompanyLogo(file: File) {\r\n  const supabase = createClient()\r\n  const fileName = `company-logo-${Date.now()}.${file.name.split('.').pop()}`\r\n\r\n  const { error } = await supabase\r\n    .storage\r\n    .from('company-assets')\r\n    .upload(fileName, file, {\r\n      cacheControl: '3600',\r\n      upsert: false\r\n    })\r\n\r\n  if (error) {\r\n    console.error('Error uploading logo:', error)\r\n    return { success: false, error }\r\n  }\r\n\r\n  const { data: { publicUrl } } = supabase\r\n    .storage\r\n    .from('company-assets')\r\n    .getPublicUrl(fileName)\r\n\r\n  return { success: true, url: publicUrl }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\sos.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\subcontractors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\system_settings.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":18,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/utils/supabase/client\"\r\n\r\nexport async function getSetting<T>(key: string, defaultValue: T): Promise<T> {\r\n  const supabase = createClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('System_Settings')\r\n    .select('value')\r\n    .eq('key', key)\r\n    .single()\r\n\r\n  if (error || !data) {\r\n    return defaultValue\r\n  }\r\n\r\n  try {\r\n      return typeof data.value === 'string' ? JSON.parse(data.value) : data.value\r\n  } catch (e) {\r\n      return data.value as T\r\n  }\r\n}\r\n\r\nexport async function saveSetting<T>(key: string, value: T, description: string = '') {\r\n  const supabase = createClient()\r\n  \r\n  const { error } = await supabase\r\n    .from('System_Settings')\r\n    .upsert({ \r\n        key, \r\n        value: JSON.stringify(value),\r\n        description\r\n    }, { onConflict: 'key' })\r\n\r\n  return { success: !error, error }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\system_settings_server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\users.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2039,2042],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2039,2042],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2904,2907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2904,2907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { getSession } from '@/lib/session'\r\n\r\nexport type UserProfile = {\r\n  Username: string\r\n  First_Name: string | null\r\n  Last_Name: string | null\r\n  Email: string | null\r\n  Role: string | null\r\n  Branch_ID: string | null\r\n  Name?: string | null\r\n  Avatar_Url?: string | null\r\n}\r\n\r\n// Get current user profile\r\nexport async function getUserProfile() {\r\n  try {\r\n    const session = await getSession()\r\n    console.log('[getUserProfile] Session:', session)\r\n    \r\n    if (!session || !session.userId) {\r\n        console.warn('[getUserProfile] No valid session found')\r\n        return null\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    const { data: rawData, error } = await supabase\r\n      .from('Master_Users')\r\n      .select('*')\r\n      .eq('Username', session.userId)\r\n      .single()\r\n    \r\n    if (error) {\r\n      console.error('[getUserProfile] DB Error:', error)\r\n      return null\r\n    }\r\n\r\n    console.log('[getUserProfile] Raw Data from DB:', rawData)\r\n    const data = rawData as UserProfile\r\n    \r\n    // Auto-fill First_Name/Last_Name from Name if they are empty\r\n    if ((!data.First_Name || !data.Last_Name) && data.Name) {\r\n        console.log('[getUserProfile] Auto-filling names from Name:', data.Name)\r\n        const parts = data.Name.trim().split(/\\s+/)\r\n        if (!data.First_Name) data.First_Name = parts[0] || \"\"\r\n        if (!data.Last_Name) data.Last_Name = parts.slice(1).join(\" \") || \"\"\r\n    }\r\n\r\n    return data\r\n  } catch (e) {\r\n    console.error('[getUserProfile] Exception:', e)\r\n    return null\r\n  }\r\n}\r\n\r\n// Update user profile\r\nexport async function updateUserProfile(data: Partial<UserProfile>) {\r\n  try {\r\n    const session = await getSession()\r\n    console.log('[updateUserProfile] Session:', session)\r\n    if (!session || !session.userId) return { success: false, error: 'Not authenticated' }\r\n\r\n    const supabase = await createClient()\r\n\r\n    const updatePayload: any = {\r\n        First_Name: data.First_Name,\r\n        Last_Name: data.Last_Name,\r\n        Email: data.Email,\r\n    }\r\n\r\n    // Sync Name column if First_Name and Last_Name are provided\r\n    if (data.First_Name || data.Last_Name) {\r\n        updatePayload.Name = `${data.First_Name || ''} ${data.Last_Name || ''}`.trim()\r\n    }\r\n\r\n    console.log('[updateUserProfile] Updating with payload:', updatePayload)\r\n\r\n    const { error, count } = await supabase\r\n      .from('Master_Users')\r\n      .update(updatePayload, { count: 'exact' })\r\n      .eq('Username', session.userId)\r\n\r\n    if (error) {\r\n      console.error('[updateUserProfile] DB Error:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n\r\n    console.log('[updateUserProfile] Rows updated:', count)\r\n\r\n    revalidatePath('/settings/profile')\r\n    return { success: true }\r\n  } catch (e: any) {\r\n    console.error('[updateUserProfile] Exception:', e)\r\n    return { success: false, error: e.message || 'Failed to update profile' }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\vehicles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\supabase\\workforce-analytics.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'activeQuery' is never reassigned. Use 'const' instead.","line":65,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":65,"endColumn":18,"fix":{"range":[1975,2184],"text":"const activeQuery = supabase\r\n    .from('Jobs_Main')\r\n    .select('Driver_ID', { count: 'exact', head: true })\r\n    .eq('Plan_Date', today)\r\n    .neq('Job_Status', 'Cancelled')\r\n    .not('Driver_ID', 'is', null)"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'activeQuery' is assigned a value but never used.","line":65,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from '@/utils/supabase/server'\r\nimport { getUserBranchId, isSuperAdmin } from '@/lib/permissions'\r\nimport { cookies } from 'next/headers'\r\nimport { getDriverLeaderboard } from './analytics'\r\n\r\nexport type WorkforceAnalytics = {\r\n  kpis: {\r\n    totalBox: number\r\n    activeToday: number\r\n    licenseExpiring: number\r\n    licenseExpired: number\r\n  }\r\n  topPerformers: {\r\n    name: string\r\n    revenue: number\r\n    jobCount: number\r\n    successRate: number\r\n  }[]\r\n  driversWithIssues: {\r\n    id: string\r\n    name: string\r\n    issue: string // 'License Expired', 'License Expiring Soon', 'Medical Expired'\r\n    daysAuth: number // days until/since expiry\r\n  }[]\r\n}\r\n\r\nexport async function getWorkforceAnalytics(\r\n  startDate?: string,\r\n  endDate?: string,\r\n  branchId?: string\r\n): Promise<WorkforceAnalytics> {\r\n  const supabase = await createClient()\r\n  const userBranchId = await getUserBranchId()\r\n  const isAdmin = await isSuperAdmin()\r\n  const cookieStore = await cookies()\r\n  const selectedBranch = cookieStore.get('selectedBranch')?.value\r\n\r\n  // Determine effective branch ID\r\n  let effectiveBranchId = branchId\r\n  if (!effectiveBranchId) {\r\n    if (isAdmin && selectedBranch && selectedBranch !== 'All') {\r\n      effectiveBranchId = selectedBranch\r\n    } else if (!isAdmin) {\r\n      effectiveBranchId = userBranchId || undefined\r\n    }\r\n  }\r\n\r\n  // 1. Fetch Drivers List for Status & Compliance\r\n  let driverQuery = supabase\r\n    .from('Master_Drivers')\r\n    .select('Driver_ID, Driver_Name, Active_Status, License_Expiry')\r\n  \r\n  if (effectiveBranchId) driverQuery = driverQuery.eq('Branch_ID', effectiveBranchId)\r\n  \r\n  const { data: drivers } = await driverQuery\r\n  const allDrivers = drivers || []\r\n  \r\n  // KPI: Total Drivers\r\n  const totalBox = allDrivers.length // Assuming box means headcount\r\n  \r\n  // KPI: Active Today (Drivers with non-cancelled jobs today)\r\n  const today = new Date().toISOString().split('T')[0]\r\n  let activeQuery = supabase\r\n    .from('Jobs_Main')\r\n    .select('Driver_ID', { count: 'exact', head: true })\r\n    .eq('Plan_Date', today)\r\n    .neq('Job_Status', 'Cancelled')\r\n    .not('Driver_ID', 'is', null) // Only assigned jobs\r\n    \r\n  // if (effectiveBranchId) activeQuery = activeQuery.eq('Branch_ID', effectiveBranchId) // Unused because we query again below\r\n  \r\n  // We need distinct driver IDs. supabase count with head true implies row count. \r\n  // To get distinct active drivers, we need standard select and process.\r\n  let activeDriversCount = 0\r\n  const { data: activeJobs } = await supabase\r\n     .from('Jobs_Main')\r\n     .select('Driver_ID')\r\n     .eq('Plan_Date', today)\r\n     .neq('Job_Status', 'Cancelled')\r\n     .not('Driver_ID', 'is', null)\r\n  \r\n  if (activeJobs) {\r\n      const uniqueDrivers = new Set(activeJobs.map(j => j.Driver_ID))\r\n      activeDriversCount = uniqueDrivers.size\r\n  }\r\n  \r\n  // KPIs: License Compliance\r\n  const now = new Date()\r\n  \r\n  let licenseExpiring = 0\r\n  let licenseExpired = 0\r\n  const driversWithIssues: WorkforceAnalytics['driversWithIssues'] = []\r\n  \r\n  for (const d of allDrivers) {\r\n      if (!d.License_Expiry) continue\r\n      const expiry = new Date(d.License_Expiry)\r\n      const daysUntil = Math.ceil((expiry.getTime() - now.getTime()) / 86400000)\r\n      \r\n      if (daysUntil < 0) {\r\n          licenseExpired++\r\n          driversWithIssues.push({\r\n              id: d.Driver_ID,\r\n              name: d.Driver_Name || 'Unknown',\r\n              issue: 'ใบขับขี่หมดอายุ',\r\n              daysAuth: Math.abs(daysUntil)\r\n          })\r\n      } else if (daysUntil <= 30) {\r\n          licenseExpiring++\r\n          driversWithIssues.push({\r\n              id: d.Driver_ID,\r\n              name: d.Driver_Name || 'Unknown',\r\n              issue: 'ใบขับขี่ใกล้หมดอายุ',\r\n              daysAuth: daysUntil\r\n          })\r\n      }\r\n  }\r\n  \r\n  // Sort issues by urgency (expired first, then expiring soonest)\r\n  driversWithIssues.sort((a, b) => {\r\n      if (a.issue === 'ใบขับขี่หมดอายุ' && b.issue !== 'ใบขับขี่หมดอายุ') return -1\r\n      if (b.issue === 'ใบขับขี่หมดอายุ' && a.issue !== 'ใบขับขี่หมดอายุ') return 1\r\n      return a.daysAuth - b.daysAuth // specific logic might vary but keep simple\r\n  })\r\n  \r\n  // 2. Fetch Top Performers using existing logic\r\n  // We specifically want Revenue and Job Count\r\n  const leaderboard = await getDriverLeaderboard(startDate, endDate, effectiveBranchId)\r\n  \r\n  const topPerformers = leaderboard.map(d => ({\r\n      name: d.name,\r\n      revenue: d.revenue,\r\n      jobCount: d.completedJobs, // Using completed jobs as primary metric\r\n      successRate: d.successRate\r\n  })).slice(0, 5)\r\n\r\n  return {\r\n    kpis: {\r\n        totalBox,\r\n        activeToday: activeDriversCount,\r\n        licenseExpiring,\r\n        licenseExpired\r\n    },\r\n    topPerformers,\r\n    driversWithIssues: driversWithIssues.slice(0, 10)\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\utils\\ai-verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\utils\\export.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34,37],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34,37],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export function exportToCSV(data: any[], filename: string) {\r\n    if (!data || !data.length) return;\r\n\r\n    // Extract headers\r\n    const headers = Object.keys(data[0]);\r\n    \r\n    // Create CSV rows\r\n    const csvContent = [\r\n        headers.join(','), // Header row\r\n        ...data.map(row => \r\n            headers.map(header => {\r\n                const val = row[header];\r\n                // Escape commas and wrap in quotes if string\r\n                if (typeof val === 'string') {\r\n                    return `\"${val.replace(/\"/g, '\"\"')}\"`;\r\n                }\r\n                return val;\r\n            }).join(',')\r\n        )\r\n    ].join('\\n');\r\n\r\n    // Create blob and download link\r\n    const blob = new Blob([\"\\uFEFF\" + csvContent], { type: 'text/csv;charset=utf-8;' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement(\"a\");\r\n    \r\n    link.setAttribute(\"href\", url);\r\n    link.setAttribute(\"download\", `${filename}_${new Date().toISOString().split('T')[0]}.csv`);\r\n    link.style.visibility = 'hidden';\r\n    \r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\utils\\image-compression.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\lib\\utils\\offline-storage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\scripts\\create-storage-bucket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\scripts\\update-storage-bucket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\services\\accounting\\akaunting-provider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\services\\accounting\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\services\\accounting\\mock-provider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\types\\accounting.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\types\\database.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[263,266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[263,266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface Job {\r\n    Job_ID: string;\r\n    Job_Status?: string | null;\r\n    Plan_Date?: string | null;\r\n    Route_Name?: string | null;\r\n    Price_Cust_Total?: string | number | null;\r\n    Cost_Driver_Total?: string | number | null;\r\n    extra_costs_json?: any;\r\n    Customer_Name?: string | null;\r\n    Dest_Location?: string | null;\r\n    Origin_Location?: string | null;\r\n    Driver_Name?: string | null;\r\n    Vehicle_Plate?: string | null;\r\n    Billing_Note_ID?: string | null;\r\n    Driver_Payment_ID?: string | null;\r\n    Branch_ID?: string | null;\r\n    Photo_Proof_Url?: string | null;\r\n    Signature_Url?: string | null;\r\n    Pickup_Photo_Url?: string | null;\r\n    Pickup_Signature_Url?: string | null;\r\n}\r\n\r\nexport interface Billing_Note {\r\n    Billing_Note_ID: string;\r\n    Customer_Name?: string | null;\r\n    Billing_Date?: string | null;\r\n    Due_Date?: string | null;\r\n    Total_Amount?: number | null;\r\n    Customer_Address?: string | null;\r\n}\r\n\r\nexport interface Driver_Payment {\r\n    Driver_Payment_ID: string;\r\n    Driver_Name?: string | null;\r\n    Payment_Date?: string | null;\r\n    Total_Amount?: number | null;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\types\\role.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\types\\subcontractor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\types\\supabase_new.ts","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: File appears to be binary.","line":1,"column":0}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"��N\u0000e\u0000e\u0000d\u0000 \u0000t\u0000o\u0000 \u0000i\u0000n\u0000s\u0000t\u0000a\u0000l\u0000l\u0000 \u0000t\u0000h\u0000e\u0000 \u0000f\u0000o\u0000l\u0000l\u0000o\u0000w\u0000i\u0000n\u0000g\u0000 \u0000p\u0000a\u0000c\u0000k\u0000a\u0000g\u0000e\u0000s\u0000:\u0000\r\u0000\n\u0000s\u0000u\u0000p\u0000a\u0000b\u0000a\u0000s\u0000e\u0000@\u00002\u0000.\u00007\u00006\u0000.\u00001\u00000\u0000\r\u0000\n\u0000","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\utils\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\utils\\supabase\\middleware.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'options' is defined but never used.","line":21,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createServerClient } from '@supabase/ssr'\r\nimport { NextResponse, type NextRequest } from 'next/server'\r\n\r\nexport async function updateSession(request: NextRequest) {\r\n  let response = NextResponse.next({\r\n    request: {\r\n      headers: request.headers,\r\n    },\r\n  })\r\n\r\n  const supabase = createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return request.cookies.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))\r\n          response = NextResponse.next({\r\n            request,\r\n          })\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            response.cookies.set(name, value, options)\r\n          )\r\n        },\r\n      },\r\n    }\r\n  )\r\n\r\n  await supabase.auth.getUser()\r\n\r\n  return response\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Armdd\\TMS_ePOD\\src\\utils\\supabase\\server.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":19,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":26,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createServerClient, type CookieOptions } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\nimport { createClient as createJsClient } from '@supabase/supabase-js'\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get(name: string) {\r\n          return cookieStore.get(name)?.value\r\n        },\r\n        set(name: string, value: string, options: CookieOptions) {\r\n          try {\r\n            cookieStore.set({ name, value, ...options })\r\n          } catch (error) {\r\n            // The `set` method was called from a Server Component.\r\n          }\r\n        },\r\n        remove(name: string, options: CookieOptions) {\r\n          try {\r\n            cookieStore.set({ name, value: '', ...options })\r\n          } catch (error) {\r\n            // The `delete` method was called from a Server Component.\r\n          }\r\n        },\r\n      },\r\n    }\r\n  )\r\n}\r\n\r\nexport function createAdminClient() {\r\n  return createJsClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n  )\r\n}\r\n","usedDeprecatedRules":[]}]